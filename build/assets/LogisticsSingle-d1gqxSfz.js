import{r as h,ag as c,s as x,u as te,a as ae,k as ie,j as e,M as le,B as N,t as y}from"./index-BAM0eJUz.js";import{f as ne,g as re}from"./logisticsApi-Qwzfztbq.js";import{C as H,a as J}from"./Card-CdxfjEr-.js";import{S as u}from"./Seperator-Dj-P5Kp9.js";import{B as ce}from"./Badge-DlwVZlzE.js";import{f as I,L as oe}from"./LogisticsShipmentForm-DIsUV7le.js";import{I as de}from"./InfoToolTip-4w02Xows.js";import{u as xe,L as ue}from"./LiveTrackingMap-CEKkjBtH.js";import"./Label-C8i6KaZe.js";import"./Input-1UBXZqEj.js";import"./projectApi-D7-uwdh2.js";import"./index-C8BdbktQ.js";const me=({organizationId:a,enabled:o=!0,onLocationUpdate:p,onTrackingStarted:s,onTrackingStopped:f})=>{const g=h.useRef(!1);return h.useEffect(()=>{if(!o||!a)return;const v=()=>{g.current||(console.log("ðŸ“¡ Joining organization room:",a),c.emit("join_organization",{organizationId:a}),g.current=!0)};c.connected&&v(),c.on("connect",v);const k=t=>{console.log("ðŸ“ Location update received:",t),x.setQueryData(["logistics","shipment",t.shipmentId],n=>n&&{...n,currentLocation:{latitude:t.latitude,longitude:t.longitude,updatedAt:t.updatedAt},lastLocationUpdate:t.updatedAt}),x.setQueryData(["logistics","active-shipments",a],n=>n&&n.map(d=>d._id===t.shipmentId?{...d,currentLocation:{latitude:t.latitude,longitude:t.longitude,updatedAt:t.updatedAt},lastLocationUpdate:t.updatedAt}:d)),p==null||p(t)},S=t=>{console.log("ðŸš€ Tracking started:",t),x.invalidateQueries({queryKey:["logistics","active-shipments",a]}),x.invalidateQueries({queryKey:["logistics","shipment",t.shipmentId]}),s==null||s(t)},w=t=>{console.log("ðŸ›‘ Tracking stopped:",t),x.setQueryData(["logistics","active-shipments",a],n=>n&&n.filter(d=>d._id!==t.shipmentId)),x.invalidateQueries({queryKey:["logistics","shipment",t.shipmentId]}),x.invalidateQueries({queryKey:["logistics","shipments",a]}),f==null||f(t)},L=t=>{console.log("ðŸ“¦ Bulk location update received:",t.count,"shipments"),x.setQueryData(["logistics","active-shipments",a],()=>t.shipments)};return c.on("location_update",k),c.on("tracking_started",S),c.on("tracking_stopped",w),c.on("bulk_location_update",L),()=>{console.log("ðŸ§¹ Cleaning up logistics WebSocket listeners"),c.off("location_update",k),c.off("tracking_started",S),c.off("tracking_stopped",w),c.off("bulk_location_update",L),c.off("connect",v),g.current=!1}},[a,o,p,s,f]),{socket:c,isConnected:c.connected}},l=({label:a,value:o})=>e.jsxs("div",{className:"text-sm font-medium text-gray-700",children:[e.jsxs("span",{children:[a,":"]})," ",e.jsx("span",{className:"text-gray-900",children:o||"-"})]}),m=({title:a,children:o})=>e.jsxs("section",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xl font-bold text-blue-700 border-b border-blue-200 pb-1",children:a}),o]}),ge=a=>{switch(a){case"pending":return"secondary";case"assigned":return"outline";case"in_transit":case"pickedup":return"default";case"delivered":return"default";case"cancelled":return"secondary";default:return"default"}},Ce=()=>{var E,F,Q,$,R,q,B,U,V,G,K,O,M;const{id:a,organizationId:o}=te(),p=ae(),{data:s,isLoading:f,refetch:g}=ne(a),{mutateAsync:v,isPending:k}=re(),[S,w]=h.useState(null),[L,t]=h.useState(!1),[n,d]=h.useState(!1),[C,P]=h.useState(!1),[A,T]=h.useState(!1),{isUpdating:z}=xe(a,A,()=>{d(!0),T(!1),y({title:"Tracking Active",description:"Location is now being shared live."})}),X=()=>{n?(d(!1),T(!1)):T(!0)},{role:Y,permission:D}=ie(),Z=Y==="owner"||((E=D==null?void 0:D.logistics)==null?void 0:E.edit);me({organizationId:o,enabled:!!s&&["in_transit","pickedup"].includes((s==null?void 0:s.shipmentStatus)||""),onLocationUpdate:r=>{r.shipmentId===a&&(console.log("ðŸ“ Location updated for current shipment:",r),g())},onTrackingStopped:r=>{r.shipmentId===a&&(y({title:"Tracking Stopped",description:`Shipment ${r.status==="delivered"?"delivered":"cancelled"}`}),g())}});const ee=async()=>{var r,j,W;try{await v({fromDept:"logistics",organizationId:o,projectId:s==null?void 0:s.projectId,upiId:(s==null?void 0:s.vehicleDetails.driverUpiId)||null,totalCost:(r=s==null?void 0:s.vehicleDetails)==null?void 0:r.driverCharge}),y({title:"Success",description:"Details sent to Accounts Department"})}catch(b){y({variant:"destructive",title:"Error",description:((W=(j=b==null?void 0:b.response)==null?void 0:j.data)==null?void 0:W.message)||(b==null?void 0:b.message)||"operation failed"})}},_=()=>{const j=`https://houseofram.in/${`${o}/logistics/public/${a}`}`;navigator.clipboard.writeText(j),P(!0),y({title:"Link Copied",description:"Tracking link copied to clipboard"}),setTimeout(()=>P(!1),2e3)};if(f)return e.jsx(le,{});const i=s==null?void 0:s.vehicleDetails;if(!s)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-dolly text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Shipment Found"})]});const se=((F=s==null?void 0:s.currentLocation)==null?void 0:F.latitude)&&((Q=s==null?void 0:s.currentLocation)==null?void 0:Q.longitude);return e.jsxs("div",{className:"max-h-full overflow-y-auto max-w-full space-y-4",children:[e.jsxs("header",{className:"sticky top-0 z-20 bg-white border-b border-gray-200 pb-4 pt-2 mb-6 flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{onClick:()=>p(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-blue-800",children:["Shipment: ",(s==null?void 0:s.shipmentNumber)||"N/A"]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsxs("div",{className:"flex gap-2 items-center space-y-1",children:[e.jsxs(N,{variant:n?"danger":"primary",isLoading:A||n&&z,className:"font-bold",onClick:X,children:[e.jsx("i",{className:`fas ${n?"fa-stop-circle":"fa-play-circle"} mr-2 text-xl`}),e.jsx("span",{children:A?"Connecting GPS...":n?"Stop Sharing":"Start Sharing"})]}),e.jsx(N,{variant:"primary",isLoading:k,onClick:ee,children:"Send To Accounts Dept"}),e.jsx(de,{content:"Click the button to send the details to accounts department",type:"info",position:"bottom"})]}),Z&&e.jsxs(N,{size:"md",variant:"primary",onClick:()=>{w(s),t(!0)},children:[e.jsx("i",{className:"fas fa-edit mr-1"}),"Edit"]})]})]}),e.jsxs("section",{className:"flex w-full gap-2",children:[e.jsx(H,{className:"w-1/2",children:e.jsxs(J,{className:"space-y-8 p-6",children:[e.jsx(m,{title:"Shipment Info",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(l,{label:"Scheduled Date",value:I(s==null?void 0:s.scheduledDate)}),e.jsx(l,{label:"Shipment Status",value:e.jsx(ce,{variant:ge(s==null?void 0:s.shipmentStatus),children:s==null?void 0:s.shipmentStatus})}),(s==null?void 0:s.trackingId)&&e.jsx(l,{label:"Tracking ID",value:e.jsx("span",{className:"font-mono bg-blue-50 px-2 py-1 rounded text-blue-700",children:s.trackingId})}),(s==null?void 0:s.eta)&&e.jsx(l,{label:"ETA",value:`${s.eta} minutes`})]})}),e.jsx(u,{}),e.jsx(m,{title:"Vehicle Info",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:[e.jsx(l,{label:"Vehicle Number",value:i==null?void 0:i.vehicleNumber}),e.jsx(l,{label:"Vehicle Type",value:i==null?void 0:i.vehicleType}),e.jsx(l,{label:"Driver Name",value:($=i==null?void 0:i.driver)==null?void 0:$.name}),e.jsx(l,{label:"Driver Phone",value:(R=i==null?void 0:i.driver)==null?void 0:R.phone}),e.jsx(l,{label:"License Number",value:(q=i==null?void 0:i.driver)==null?void 0:q.licenseNumber}),e.jsx(l,{label:"Driver Charge",value:`â‚¹ ${i==null?void 0:i.driverCharge}`}),e.jsx(l,{label:"Upi Id",value:i==null?void 0:i.driverUpiId})]})}),e.jsx(u,{}),e.jsx(m,{title:"Origin & Destination",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-blue-600 font-bold mb-1",children:"Origin"}),e.jsx(l,{label:"Address",value:(B=s==null?void 0:s.origin)==null?void 0:B.address}),e.jsx(l,{label:"Contact Person",value:(U=s==null?void 0:s.origin)==null?void 0:U.contactPerson}),e.jsx(l,{label:"Contact Phone",value:(V=s==null?void 0:s.origin)==null?void 0:V.contactPhone})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-green-600 font-bold mb-1",children:"Destination"}),e.jsx(l,{label:"Address",value:(G=s==null?void 0:s.destination)==null?void 0:G.address}),e.jsx(l,{label:"Contact Person",value:(K=s==null?void 0:s.destination)==null?void 0:K.contactPerson}),e.jsx(l,{label:"Contact Phone",value:(O=s==null?void 0:s.destination)==null?void 0:O.contactPhone})]})]})}),e.jsx(u,{}),e.jsx(m,{title:"Timing Schedule",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(l,{label:"Actual Pickup Time",value:I(s==null?void 0:s.actualPickupTime)}),e.jsx(l,{label:"Actual Delivery Time",value:I(s==null?void 0:s.actualDeliveryTime)})]})}),((M=s==null?void 0:s.items)==null?void 0:M.length)>0&&e.jsxs(e.Fragment,{children:[e.jsx(u,{}),e.jsx(m,{title:"Shipment Items",children:e.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{className:"text-sm font-semibold text-gray-700",children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Item Name"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Quantity"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-100",children:s.items.map((r,j)=>e.jsxs("tr",{className:"text-sm text-gray-800",children:[e.jsx("td",{className:"px-4 py-2",children:r==null?void 0:r.name}),e.jsx("td",{className:"px-4 py-2",children:r==null?void 0:r.quantity})]},j))})]})})})]}),e.jsxs(e.Fragment,{children:[e.jsx(u,{}),e.jsx(m,{title:"Tracking Link",children:e.jsx("p",{className:"text-sm text-gray-700",children:s.trackingLink||"No Tracking link provided"})})]}),e.jsx(u,{}),e.jsxs(m,{title:"Live Tracking URL",children:[e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("div",{className:"flex-1 bg-slate-50 border border-slate-200 rounded-md px-3 py-2 overflow-hidden",children:e.jsxs("p",{className:"text-sm text-blue-600 font-medium truncate",children:["https://houseofram.in","/",o,"/logistics/public/",a]})}),e.jsxs(N,{size:"sm",variant:C?"primary":"outline",className:"flex-shrink-0 gap-2 h-10",onClick:_,children:[e.jsx("i",{className:`fas ${C?"fa-check":"fa-copy"}`}),C?"Copied":"Copy Link"]})]}),e.jsx("p",{className:"text-[10px] text-gray-500 mt-1 italic",children:"* Share this URL with the driver to start live GPS tracking."})]}),e.jsxs(e.Fragment,{children:[e.jsx(u,{}),e.jsx(m,{title:"Notes",children:e.jsx("p",{className:"text-sm text-gray-700",children:s.notes||"No Notes"})})]})]})}),e.jsxs("div",{className:"flex-1 flex-col  w-1/2 gap-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("h3",{className:"text-xl font-bold text-slate-700 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-satellite-dish"}),"Native Live Tracking"]}),e.jsx("p",{className:"text-[10px] text-slate-400 uppercase font-bold leading-6 tracking-widest",children:"Vertical Living Tracking"})]}),e.jsx(H,{className:"",children:e.jsx(J,{className:"p-6",children:se?e.jsx(e.Fragment,{children:e.jsx(ue,{shipment:s,currentLocation:s.currentLocation,locationHistory:s.locationHistory||[],origin:s.origin,destination:s.destination})}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-center bg-slate-50 rounded-xl border-2 border-dashed border-slate-200",children:[e.jsx("div",{className:"bg-white p-4 rounded-full shadow-sm mb-4",children:e.jsx("i",{className:"fas fa-satellite-dish text-4xl text-blue-400 animate-pulse"})}),e.jsx("h4",{className:"text-lg font-bold text-slate-800",children:"Waiting for GPS Signal"}),e.jsx("p",{className:"text-sm text-slate-500 max-w-xs mx-auto mt-2 mb-6",children:"The driver hasn't started sharing their location yet. Please share the tracking link with the driver."}),e.jsxs("div",{className:"w-full max-w-sm bg-white border border-slate-200 rounded-lg p-3 flex items-center justify-between gap-2",children:[e.jsxs("code",{className:"text-[10px] text-blue-600 truncate font-mono",children:["https://houseofram.in","/",o,"/logistics/public/",a]}),e.jsxs(N,{size:"sm",variant:"outline",onClick:_,className:"h-8 text-xs gap-1",children:[e.jsx("i",{className:"fas fa-copy"})," Copy"]})]})]})})}),e.jsx(u,{className:"my-7"}),e.jsxs("div",{className:"flex-1 mt-4",children:[e.jsxs("div",{className:"flex flex-col mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold text-slate-700 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-external-link-alt"}),"External Application Tracking"]}),e.jsx("p",{className:"text-[10px] text-slate-400 uppercase font-bold tracking-widest",children:"Porter / Rapido / External Link"})]}),s.trackingLink?e.jsx("div",{children:e.jsx("iframe",{src:s.trackingLink,width:"100%",height:"600px"})}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"flex items-center justify-center py-12 text-center bg-slate-50 rounded-lg border-2 border-dashed border-slate-300",children:e.jsxs("div",{children:[e.jsx("i",{className:"fas fa-location text-5xl text-slate-300 mb-4 animate-pulse"}),e.jsx("h4",{className:"text-lg font-semibold text-slate-700",children:"Track the Vehicle by pasting the link"}),e.jsx("p",{className:"text-sm text-slate-500 mt-2",children:"paste the porter or rapido tracking link by clicking edit option"}),e.jsxs("div",{className:"mt-4 flex items-center justify-center gap-2 text-xs text-slate-400",children:[e.jsx("div",{className:"h-2 w-2 bg-slate-400 rounded-full animate-bounce",style:{animationDelay:"0s"}}),e.jsx("div",{className:"h-2 w-2 bg-slate-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}),e.jsx("div",{className:"h-2 w-2 bg-slate-400 rounded-full animate-bounce",style:{animationDelay:"0.4s"}})]})]})})})]})]})]}),L&&e.jsx(oe,{shipment:S,onClose:()=>{t(!1),g()},organizationId:o})]})};export{Ce as default};
