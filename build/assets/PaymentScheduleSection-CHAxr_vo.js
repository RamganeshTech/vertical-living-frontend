import{c as p,d as H,s as y,e as w,g as x,u as J,a as V,r as b,b as W,j as e,M as X,B as u,t as d}from"./index-MXS_gbde.js";import{C as S}from"./Card-L4jLwmC3.js";import{d as Y}from"./dateFormator-BGKi5rfZ.js";const Z=async(n,a)=>(await a.get(`/paymentconfirmation/getschedule/${n}`)).data.data,ee=async({projectId:n,dueDate:a,api:r})=>(await r.put(`/paymentconfirmation/dueDate/${n}`,{dueDate:a})).data.data,te=async({projectId:n,status:a,api:r})=>(await r.put(`/paymentconfirmation/clientapprovalstatus/${n}`,{status:a})).data.data,se=async({projectId:n,notes:a,api:r})=>(await r.put(`/paymentconfirmation/clientnotes/${n}`,{notes:a})).data.data,ae=async({projectId:n,status:a,api:r})=>(await r.put(`/paymentconfirmation/mdapprovalstatus/${n}`,{status:a})).data.data,ne=async({projectId:n,notes:a,api:r})=>(await r.put(`/paymentconfirmation/mdnotes/${n}`,{notes:a})).data.data,re=n=>{const a=["owner","staff","CTO","client"],{role:r}=p(),s=x(r);return H({queryKey:["payment-schedule",n],queryFn:async()=>{if(!r||!a.includes(r))throw new Error("Not allowed to fetch payment schedule");if(!s)throw new Error("API instance missing");return await Z(n,s)},enabled:!!n&&!!r,retry:!1,refetchOnMount:!1})},ie=()=>{const n=["CTO","owner","staff"],{role:a}=p(),r=x(a),s=y();return w({mutationFn:async({projectId:l,dueDate:i})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance missing");return await ee({projectId:l,dueDate:i,api:r})},onSuccess:(l,{projectId:i})=>{s.invalidateQueries({queryKey:["payment-confirmation",i]})}})},oe=()=>{const n=["client","owner","staff","CTO"],{role:a}=p(),r=x(a),s=y();return w({mutationFn:async({projectId:l,status:i})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance missing");return await te({projectId:l,status:i,api:r})},onSuccess:(l,{projectId:i})=>{s.invalidateQueries({queryKey:["payment-schedule",i]})}})},le=()=>{const n=["client","owner","staff","CTO"],{role:a}=p(),r=x(a),s=y();return w({mutationFn:async({projectId:l,notes:i})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance missing");return await se({projectId:l,notes:i,api:r})},onSuccess:(l,{projectId:i})=>{s.invalidateQueries({queryKey:["payment-schedule",i]})}})},ce=()=>{const n=["owner","staff","CTO"],{role:a}=p(),r=x(a),s=y();return w({mutationFn:async({projectId:l,status:i})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance missing");return await ae({projectId:l,status:i,api:r})},onSuccess:(l,{projectId:i})=>{s.invalidateQueries({queryKey:["payment-schedule",i]})}})},de=()=>{const n=["owner","staff","CTO"],{role:a}=p(),r=x(a),s=y();return w({mutationFn:async({projectId:l,notes:i})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance missing");return await ne({projectId:l,notes:i,api:r})},onSuccess:(l,{projectId:i})=>{s.invalidateQueries({queryKey:["payment-schedule",i]})}})},I=["pending","approved","rejected"],xe=()=>{var O,U,R,$;const{projectId:n,organizationId:a}=J(),r=V(),{data:s,isLoading:l,error:i,refetch:C}=re(n),v=oe(),D=le(),N=ce(),E=de(),[A,L]=b.useState(""),[M,Q]=b.useState(""),[P,k]=b.useState(s==null?void 0:s.dueDate),[z,j]=b.useState(!1),F=ie(),{role:q,permission:m}=W(),h=q==="owner"||((O=m==null?void 0:m.paymentconfirmation)==null?void 0:O.create),f=q==="owner"||((U=m==null?void 0:m.paymentconfirmation)==null?void 0:U.edit),K=async()=>{var t,o;try{await F.mutateAsync({projectId:n,dueDate:P}),C(),d({title:"Success",description:"Due date updated successfully."}),j(!1)}catch(c){d({title:"Error",description:((o=(t=c==null?void 0:c.response)==null?void 0:t.data)==null?void 0:o.message)||c.message||"Failed to update due date.",variant:"destructive"})}},T=t=>{v.mutate({projectId:n,status:t},{onSuccess:()=>d({title:"Success",description:"Client approval status updated."}),onError:o=>{var c,g;return d({title:"Error",description:((g=(c=o==null?void 0:o.response)==null?void 0:c.data)==null?void 0:g.message)||o.message||"Failed to update client status",variant:"destructive"})}})},_=t=>{N.mutate({projectId:n,status:t},{onSuccess:()=>d({title:"Success",description:"MD approval status updated."}),onError:o=>{var c,g;return d({title:"Error",description:((g=(c=o==null?void 0:o.response)==null?void 0:c.data)==null?void 0:g.message)||o.message||"Failed to update MD status",variant:"destructive"})}})},B=()=>{D.mutate({projectId:n,notes:A},{onSuccess:()=>d({title:"Success",description:"Client note updated."}),onError:t=>{var o,c;return d({title:"Error",description:((c=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:c.message)||t.message||"Failed to update notes",variant:"destructive"})}})},G=()=>{E.mutate({projectId:n,notes:M},{onSuccess:()=>d({title:"Success",description:"MD note updated."}),onError:t=>{var o,c;return d({title:"Error",description:((c=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:c.message)||t.message||"Failed to update notes",variant:"destructive"})}})};return l?e.jsx("p",{children:e.jsx(X,{})}):i?e.jsxs("div",{className:"max-w-xl mx-auto mt-12 p-6 bg-red-50 border border-red-200 rounded-lg shadow text-center",children:[e.jsx("div",{className:"text-red-600 text-xl font-semibold mb-2",children:"⚠️ Oops! An Error Occurred"}),e.jsx("p",{className:"text-red-500 text-sm mb-4",children:(($=(R=i==null?void 0:i.response)==null?void 0:R.data)==null?void 0:$.message)||(i==null?void 0:i.message)||"Failed to load, please try again"}),e.jsx(u,{onClick:()=>C(),isLoading:l,className:"bg-red-600 text-white hover:bg-red-700",children:"Retry"})]}):e.jsxs("div",{className:"w-full max-w-full max-h-full overflow-y-auto custom-scrollbar mx-auto space-y-6 px-4 py-6",children:[e.jsxs("div",{className:"w-full justify-between flex",children:[e.jsxs("h2",{className:"text-2xl font-bold text-blue-800 flex items-center gap-2",children:[e.jsx("i",{className:"fa-regular fa-calendar-check text-blue-600"}),e.jsx("span",{className:"hidden sm:inline",children:"  Step 2: Payment Schedule Approval"}),e.jsx("span",{className:"inline sm:hidden",children:"  Payment Schedule"})]}),e.jsx(u,{variant:"primary",onClick:()=>r(`/${a}/projectdetails/${n}/paymentconfirmation`),children:"Back"})]}),e.jsx(S,{className:"p-4 border border-gray-200 shadow-sm rounded mb-6",children:e.jsxs("div",{className:"flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("h3",{className:"font-semibold text-blue-700 text-lg flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-calendar-days"})," Payment Due Date"]}),z?e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("input",{type:"date",value:P,onChange:t=>k(t.target.value),className:"border rounded px-3 py-1 text-sm"}),e.jsxs(u,{size:"sm",onClick:K,isLoading:F.isPending,className:"bg-green-600 hover:bg-green-700 text-white px-3 py-1",children:[e.jsx("i",{className:"fa-solid fa-check mr-2"}),"Save"]}),e.jsxs(u,{size:"sm",onClick:()=>{var t;k((t=s==null?void 0:s.dueDate)==null?void 0:t.slice(0,10)),j(!1)},variant:"outline",className:"px-3 py-1",children:[e.jsx("i",{className:"fa-solid fa-xmark mr-1"}),"Cancel"]})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-md font-medium text-gray-800",children:s!=null&&s.dueDate?Y(s==null?void 0:s.dueDate):"Not set"}),(h||f)&&e.jsxs(u,{size:"sm",onClick:()=>j(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1",children:[e.jsx("i",{className:"fa-regular fa-pen-to-square mr-2"}),"Edit"]})]})]})}),e.jsxs(S,{className:"p-5 space-y-4 shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex sm:justify-between sm:items-center sm:flex-row flex-col sm:mb-0  mb-1 items-start",children:[e.jsxs("h3",{className:"text-lg font-semibold text-blue-700 flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-user"})," Client Approval"]}),e.jsx("div",{className:"flex items-center gap-2",children:(h||f)&&I.map(t=>{var o;return e.jsx(u,{isLoading:v.isPending&&((o=v.variables)==null?void 0:o.status)===t,size:"sm",onClick:()=>T(t),className:`text-white text-xs ${s.clientApprovalStatus===t?"bg-blue-800":"bg-blue-600 hover:bg-blue-700"}`,children:t.toUpperCase()},t)})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Current Status:"}),e.jsx("div",{className:"rounded bg-gray-100 px-4 py-2 text-sm text-blue-900 border",children:s.clientApprovalStatus.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mt-4 mb-1",children:"Existing Notes:"}),e.jsx("div",{className:"bg-gray-50 p-3 text-sm rounded border text-gray-800",children:s.clientNotes||"No notes added yet"})]}),e.jsxs("div",{children:[e.jsx("textarea",{className:"w-full mt-3 p-2 border rounded-md text-sm",placeholder:"Add client notes...",value:A,onChange:t=>L(t.target.value),rows:3}),(h||f)&&e.jsxs(u,{onClick:B,isLoading:D.isPending,className:"bg-blue-600 hover:bg-blue-700 text-white mt-2",children:[e.jsx("i",{className:"fa-regular fa-floppy-disk mr-2"}),"Save Client Notes"]})]})]}),e.jsxs(S,{className:"p-5 space-y-4 shadow-md border border-gray-200",children:[e.jsxs("div",{className:"flex sm:justify-between sm:items-center sm:flex-row flex-col sm:mb-0  mb-1 items-start",children:[e.jsxs("h3",{className:"text-lg font-semibold text-blue-700 flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-user-tie"})," MD Approval"]}),e.jsx("div",{className:"flex items-center gap-2",children:(h||f)&&I.map(t=>{var o;return e.jsx(u,{isLoading:N.isPending&&((o=N.variables)==null?void 0:o.status)===t,size:"sm",onClick:()=>_(t),className:`text-white text-xs ${s.mdApprovalStatus===t?"bg-blue-800":"bg-blue-600 hover:bg-blue-700"}`,children:t.toUpperCase()},t)})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Current Status:"}),e.jsx("div",{className:"rounded bg-gray-100 px-4 py-2 text-sm text-blue-900 border",children:s.mdApprovalStatus.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mt-4 mb-1",children:"Existing Notes:"}),e.jsx("div",{className:"bg-gray-50 p-3 text-sm rounded border text-gray-800",children:s.mdNotes||"No notes added yet"})]}),e.jsxs("div",{children:[e.jsx("textarea",{className:"w-full mt-3 p-2 border rounded-md text-sm",placeholder:"Add MD notes...",value:M,onChange:t=>Q(t.target.value),rows:3}),(h||f)&&e.jsxs(u,{onClick:G,isLoading:E.isPending,className:"bg-blue-600 hover:bg-blue-700 text-white mt-2",children:[e.jsx("i",{className:"fa-regular fa-floppy-disk mr-2"}),"Save MD Notes"]})]})]})]})};export{xe as default};
