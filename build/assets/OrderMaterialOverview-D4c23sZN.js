import{q as g,v as P,w as M,x as O,y as u,b as L,e as I,j as e,ag as q,B as N,ah as F,ai as H,aj as R,A as T,ak as U,a5 as $,t as v}from"./index-DffUqezq.js";const B=async({projectId:a,api:r})=>{const{data:t}=await r.get(`/orderingmaterial/getalldetails/${a}`);if(!t.ok)throw new Error(t.message);return t.data},G=a=>{const r=["owner","staff","CTO","worker","client"],{role:t}=g(),l=u(t);return P({queryKey:["ordering-material-history",a],queryFn:async()=>{if(!t||!r.includes(t))throw new Error("Not allowed to fetch ordering material");if(!l)throw new Error("API not available");return await B({projectId:a,api:l})},enabled:!!t&&!!a&&!!l,retry:!1,refetchOnMount:!1})},Q=async({formId:a,projectId:r,deadLine:t,api:l})=>{const{data:s}=await l.put(`/orderingmaterial/deadline/${r}/${a}`,{deadLine:t});if(!s.ok)throw new Error(s.message);return s.data},D=async({projectId:a,api:r})=>{const{data:t}=await r.put(`/orderingmaterial/completionstatus/${a}`);if(!t.ok)throw new Error(t.message);return t.data},K=()=>{const a=["owner","staff","CTO"],{role:r}=g(),t=u(r);return M({mutationFn:async({formId:l,projectId:s,deadLine:n})=>{if(!r||!a.includes(r))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance missing");return await Q({formId:l,projectId:s,deadLine:n,api:t})},onSuccess:(l,s)=>{O.invalidateQueries({queryKey:["ordering-material-history",s.projectId]})}})},z=()=>{const a=["owner","staff","CTO"],{role:r}=g(),t=u(r);return M({mutationFn:async({projectId:l})=>{if(!r||!a.includes(r))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance missing");return await D({projectId:l,api:t})},onSuccess:(l,{projectId:s})=>{O.invalidateQueries({queryKey:["ordering-material-history",s]})}})},Y=()=>{var p,w,b,j,y;const{projectId:a,organizationId:r}=L(),{isMobile:t,openMobileSidebar:l}=I(),{data:s,isLoading:n,isError:m,error:o,refetch:f}=G(a),x=(s==null?void 0:s.selectedUnits)||[],C=(s==null?void 0:s.totalCost)||0,h=x.length>0,{mutateAsync:k,isPending:A}=K(),{mutateAsync:S,isPending:_}=z(),E=async()=>{var i,d;try{await S({projectId:a}),v({description:"Completion status updated successfully",title:"Success"})}catch(c){v({title:"Error",description:((d=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:d.message)||c.message||"Failed to update completion status",variant:"destructive"})}};return n?e.jsx(q,{}):e.jsxs("div",{className:"w-full h-full flex flex-col",children:[e.jsxs("div",{className:"flex-shrink-0 flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4",children:[e.jsxs("h2",{className:"text-2xl sm:text-2xl lg:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[t&&e.jsx("button",{onClick:l,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fa-solid fa-cart-shopping mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Ordering Material"}),e.jsx("span",{className:"sm:hidden",children:"Order Material"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs(N,{isLoading:_,onClick:E,className:"bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto whitespace-nowrap",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark as Complete"]}),e.jsx(F,{projectId:a,stageNumber:8,stagePath:"orderingmaterial"}),!o&&e.jsx(H,{projectId:a,stageNumber:"8",className:"w-full sm:w-fit",isStageCompleted:s==null?void 0:s.status}),e.jsx(R,{stageName:"OrderMaterialHistoryModel",projectId:a,organizationId:r,currentAssignedStaff:(s==null?void 0:s.assignedTo)||null})]})]}),m&&e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"max-w-xl p-4 bg-red-50 border border-red-200 rounded-lg shadow text-center",children:[e.jsx("div",{className:"text-red-600 font-semibold mb-2",children:"⚠️ Error Occurred"}),e.jsx("p",{className:"text-red-500 text-sm mb-4",children:((w=(p=o==null?void 0:o.response)==null?void 0:p.data)==null?void 0:w.message)||"Failed to load ordering material"}),e.jsx(N,{isLoading:n,onClick:()=>f(),className:"bg-red-600 text-white hover:bg-red-700",children:"Retry"})]})}),!m&&e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto space-y-4 sm:space-y-6",children:[e.jsxs(T,{className:"p-4 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(U,{completedAt:(b=s==null?void 0:s.timer)==null?void 0:b.completedAt,stageName:"orderingmaterial",formId:s==null?void 0:s._id,projectId:a,deadLine:(j=s==null?void 0:s.timer)==null?void 0:j.deadLine,startedAt:(y=s==null?void 0:s.timer)==null?void 0:y.startedAt,refetchStageMutate:f,deadLineMutate:k,isPending:A})]}),!m&&e.jsxs("section",{className:"bg-white rounded-3xl shadow-[0_10px_40px_-15px_rgba(0,0,0,0.1)] overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full w-1.5 bg-gradient-to-b from-blue-400 to-indigo-500"}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pl-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Your Orders"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:h?`${x.length} items purchased`:"No orders yet"})]}),h&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"Total:"}),e.jsxs("span",{className:"text-xl font-bold text-blue-600",children:["₹",C.toFixed(2)]})]})]})]}),e.jsx("div",{className:"py-2",children:h?e.jsx("div",{className:"grid gap-5",children:x.map((i,d)=>e.jsx("div",{className:`group relative p-5 bg-white rounded-xl border border-gray-100 hover:border-blue-100 transition-all\r
              shadow-[0_3px_10px_rgba(0,0,0,0.02)] hover:shadow-[0_6px_20px_rgba(0,0,0,0.04)]`,children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-5",children:[e.jsxs("div",{className:"relative w-full md:w-32 h-32 bg-gray-50 rounded-lg overflow-hidden",children:[e.jsx("img",{src:i.image||$,alt:i.customId||"Product image",className:"w-full h-full object-contain p-3"}),e.jsxs("div",{className:"absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold px-2.5 py-1 rounded-full shadow-sm",children:["×",i.quantity]})]}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-1.5",children:i.customId||"Unspecified Product"}),e.jsx("div",{className:"flex items-center gap-2 mb-3",children:e.jsx("span",{className:"px-2.5 py-1 bg-gray-100 text-gray-700 text-xs font-medium rounded-full",children:i.category||"Generic"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"Unit Price"}),e.jsxs("p",{className:"font-medium",children:["₹",i.singleUnitCost.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"Quantity"}),e.jsx("p",{className:"font-medium",children:i.quantity})]})]})]}),e.jsx("div",{className:"mt-4 pt-3 border-t border-gray-100",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Item Total"}),e.jsxs("p",{className:"text-lg font-bold text-blue-600",children:["₹",(i.singleUnitCost*i.quantity).toFixed(2)]})]})})]})]})},i._id||d))}):e.jsxs("div",{className:"py-23 text-center",children:[e.jsx("div",{className:"mx-auto w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-5",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-blue-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})})}),e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-2",children:"No Order History"}),e.jsx("p",{className:"text-gray-500 max-w-md mx-auto mb-6",children:"Your completed orders will appear here"})]})})]})]})]})};export{Y as default};
