import{D as pe,u as Fe,r as p,a6 as I,j as e,B as F,L as J,I as _,a1 as Xe,t as j,a as Ms,O as Ls}from"./index-BO7-A9Kz.js";import{c as Bs,d as $s,e as zs,f as Us,g as Js,h as Vs,i as Ks,j as Hs,k as qs,l as Ys,m as Xs,n as Gs,o as Qs,p as Zs,q as et}from"./workScheduleApi-CCOuSRiF.js";import{C as xe,b as fe,c as je,a as ve}from"./Card-f5wWE5lT.js";import{S as Ge,a as Qe,b as Ze,c as es,d as ke}from"./Select-DdgOLbVu.js";import{d as ss}from"./downloadFile-DVdO-NW3.js";import{I as De}from"./ImageGalleryMain-DPKejre0.js";import{b as st,c as tt}from"./workReportsApi-D3P4PLD7.js";import"./constants-C24MPKAV.js";import"./index-05XtR3do.js";const ts=()=>{var u;const y=pe(w=>w.authStore),z=pe(w=>w.userProfileStore),W=pe(w=>w.staffProfileStore),n=pe(w=>w.CTOProfileStore),$=pe(w=>w.workerProfileStore),C=pe(w=>w.clientProfileStore);if(!y.isauthenticated)return null;switch((u=y.role)==null?void 0:u.toLowerCase()){case"owner":return{id:(z==null?void 0:z.userId)||y._id,name:(z==null?void 0:z.userName)||""};case"staff":return{id:(W==null?void 0:W.staffId)||y._id,name:(W==null?void 0:W.staffName)||""};case"cto":return{id:(n==null?void 0:n.CTOId)||y._id,name:(n==null?void 0:n.CTOName)||""};case"worker":return{id:($==null?void 0:$.workerId)||y._id,name:($==null?void 0:$.workerName)||""};case"client":return{id:(C==null?void 0:C.clientId)||y._id,name:(C==null?void 0:C.clientName)||""};default:return null}},at=({projectId:y,isOpen:z,onClose:W,editData:n,onSave:$,onUpdate:C,scheduleId:u=null,refetch:w})=>{const{organizationId:ee}=Fe(),V=p.useRef(null),Q=p.useRef(null),d=ts(),{data:o}=Bs(y),{data:v,isLoading:q}=$s(ee),[R,E]=p.useState(!1),[N,le]=p.useState({name:"",url:""}),[se,ne]=p.useState({name:"",url:""}),[Y,be]=p.useState(null),[D,we]=p.useState(null),[ye,H]=p.useState(50),[Ce,re]=p.useState(!1),Se=s=>{s.scheduleId===u&&s.addedBy!==(d==null?void 0:d.id)&&(l(a=>[...a,s.selectImages]),j({title:"Comparison Added",description:`by ${s.addedByRole}`}))},ie=s=>{console.log("entierngint othe funtio"),s.scheduleId===u&&s.uploadedBy!==(d==null?void 0:d.id)&&(l(s.newSelectImages),j({title:"Select Images Added",description:`by ${s.uploadedByRole}`}))},oe=s=>{s.scheduleId===u&&s.createdBy!==(d==null?void 0:d.id)&&(l(a=>[...a,s.selectImages]),j({title:"New Comparison",description:`created by ${s.createdByRole}`}))},T=s=>{s.scheduleId===u&&s.uploadedBy!==(d==null?void 0:d.id)&&(l(s.newCorrectedImages),j({title:"Corrected Images Uploaded",description:`by ${s.uploadedByRole}`}))},Ie=s=>{if(s.scheduleId!==u||s.updatedBy===(d==null?void 0:d.id))return;const{comparisonId:a,selectedImageId:t,comment:r}=s;l(i=>i&&i.map(c=>c._id===a?{...c,selectImage:c.selectImage.map(A=>A._id===t?{...A,comment:r}:A)}:c)),j({title:"Comment Updated",description:`by ${s.updatedByRole}`})},Ne=s=>{s.scheduleId===u&&s.deletedBy!==(d==null?void 0:d.id)&&(l(s.images),j({title:"Select Image Deleted",description:`by ${s.deletedByRole}`}))},de=s=>{s.scheduleId===u&&s.deletedBy!==(d==null?void 0:d.id)&&(l(s.deletedImage),j({title:"Corrected Image Deleted",description:`by ${s.deletedByRole}`}))};p.useEffect(()=>{if(!(!I||!u||!y))return I.on("workSchedule:selectimage_added",Se),I.on("workSchedule:selectimage_added_manual",ie),I.on("workSchedule:comparison_created",oe),I.on("workSchedule:correctimage_upload",T),I.on("workSchedule:selectimage_comment",Ie),I.on("workSchedule:selectimage_delete",Ne),I.on("workSchedule:correctimage_delete",de),()=>{I.off("workSchedule:selectimage_added",Se),I.off("workSchedule:selectimage_added_manual",ie),I.off("workSchedule:comparison_created",oe),I.off("workSchedule:correctimage_upload",T),I.off("workSchedule:selectimage_comment",Ie),I.off("workSchedule:selectimage_delete",Ne),I.off("workSchedule:correctimage_delete",de)}},[I,u,d==null?void 0:d.id,R]);const ce=new Date().toISOString().split("T")[0],me=s=>{const a=ge=>String(ge).padStart(2,"0"),t=s.getFullYear(),r=a(s.getMonth()+1),i=a(s.getDate()),c=a(s.getHours()),A=a(s.getMinutes());return`${t}-${r}-${i}T${c}:${A}`},[x,M]=p.useState({projectAssignee:{projectName:"",siteAddress:"",designReferenceId:"",carpenterName:"",carpenterUIName:"",supervisorName:(d==null?void 0:d.name)||"",plannedStartDate:ce},dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:[],siteImages:[],supervisorCheck:{reviewerName:(d==null?void 0:d.name)||"",reviewerId:(d==null?void 0:d.id)||"",reviewDateTime:me(new Date),status:"pending",remarks:"",gatekeeping:"block"}}),[ue,Te]=p.useState(!1),[te,Ae]=p.useState([]),[X,l]=p.useState([]),[h,g]=p.useState(!1),f=(s,a)=>{s.preventDefault(),re(!1);const t=new DataTransfer;Array.from(s.dataTransfer.files).forEach(r=>t.items.add(r)),_e(t.files,a)};p.useEffect(()=>{var t,r,i,c,A,ge,Be,$e,ze,Ue,Je,Ve,Ke,He,qe,Ye;if(!o&&!n)return;let s;!o&&!n&&(s=v==null?void 0:v.find(K=>{var he;return(K==null?void 0:K._id)===((he=n.projectAssignee.carpenterName)==null?void 0:he._id)}));let a;if((t=n==null?void 0:n.supervisorCheck)!=null&&t.reviewDateTime)console.log("gettign into the place 1"),a=me(new Date((r=n==null?void 0:n.supervisorCheck)==null?void 0:r.reviewDateTime));else if((c=(i=n==null?void 0:n.dailyTasks)==null?void 0:i[0])!=null&&c.datePlanned){const K=new Date(n.dailyTasks[0].datePlanned);K.setHours(12,0,0),a=me(K)}else console.log("gettign into the place 333333"),a=me(new Date);if(M({projectAssignee:{projectName:((A=n==null?void 0:n.projectAssignee)==null?void 0:A.projectName)||(o==null?void 0:o.projectName)||"",siteAddress:((ge=n==null?void 0:n.projectAssignee)==null?void 0:ge.siteAddress)||(o==null?void 0:o.siteAddress)||"",designReferenceId:((Be=n==null?void 0:n.projectAssignee)==null?void 0:Be.designReferenceId)||(o==null?void 0:o.designReferenceId)||"",carpenterName:(($e=n==null?void 0:n.projectAssignee)==null?void 0:$e.carpenterName)||null,carpenterUIName:(s==null?void 0:s.workerName)||"",supervisorName:((ze=n==null?void 0:n.projectAssignee)==null?void 0:ze.supervisorName)||(d==null?void 0:d.name)||"",plannedStartDate:((Ue=n==null?void 0:n.projectAssignee)==null?void 0:Ue.plannedStartDate)||ce},dailyTasks:((Je=n==null?void 0:n.dailyTasks)==null?void 0:Je.map(K=>({...K,uploadedImages:K.uploadedImages||[]})))||[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:(n==null?void 0:n.designPlanImages)||[],siteImages:(n==null?void 0:n.siteImages)||[],supervisorCheck:{reviewerName:((Ve=n==null?void 0:n.supervisorCheck)==null?void 0:Ve.reviewerName)||(d==null?void 0:d.name)||"",reviewerId:((Ke=n==null?void 0:n.supervisorCheck)==null?void 0:Ke.reviewerId)||(d==null?void 0:d.id)||"",reviewDateTime:a,status:((He=n==null?void 0:n.supervisorCheck)==null?void 0:He.status)||"needs_changes",remarks:((qe=n==null?void 0:n.supervisorCheck)==null?void 0:qe.remarks)||"",gatekeeping:((Ye=n==null?void 0:n.supervisorCheck)==null?void 0:Ye.gatekeeping)||"block"}}),n!=null&&n.dailyTasks){const K={};n.dailyTasks.forEach((he,Ws)=>{he.materialsNeeded&&he.materialsNeeded.length>0&&(K[Ws]=he.materialsNeeded.join(", "))}),Ee(K)}n!=null&&n.workComparison?l(n.workComparison):l([])},[o,n]);const[b,m]=p.useState([]),[S,k]=p.useState([]),P=zs(),U=Us(),{mutateAsync:O,isPending:L}=Js(),B=(s,a)=>{M(t=>({...t,projectAssignee:{...t.projectAssignee,[s]:a}}))},G=s=>s?new Date(s).toISOString().split("T")[0]:"",Z=(s,a,t)=>{M(r=>{const i=r.dailyTasks.map((A,ge)=>ge===s?{...A,[a]:t}:A);let c=r.supervisorCheck;if(u===null&&s===0&&a==="datePlanned"){const A=`${t}T12:00`;c={...r.supervisorCheck,reviewDateTime:A}}return{...r,dailyTasks:i,supervisorCheck:c}})},[as,Ee]=p.useState({}),ls=(s,a)=>{Ee(t=>({...t,[s]:a})),M(t=>({...t,dailyTasks:t.dailyTasks.map((r,i)=>i===s?{...r,materialsNeeded:a.split(",").map(c=>c.trim()).filter(c=>c)}:r)}))},ns=()=>{M(s=>({...s,dailyTasks:[...s.dailyTasks,{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},rs=()=>{M(s=>({...s,dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},is=s=>{M(a=>({...a,dailyTasks:a.dailyTasks.filter((t,r)=>r!==s)}))},ae=(s,a)=>{M(t=>({...t,supervisorCheck:{...t.supervisorCheck,[s]:a}}))},os=async()=>{var s,a;try{if(n){const t=new FormData;t.append("projectAssignee",JSON.stringify(x.projectAssignee)),t.append("dailyTasks",JSON.stringify(x.dailyTasks)),t.append("supervisorCheck",JSON.stringify(x.supervisorCheck)),D&&t.append("actualImage",D),Y&&t.append("plannedImage",Y),b.forEach(r=>t.append("designPlanImages",r)),S.forEach(r=>t.append("siteImages",r)),await U.mutateAsync({projectId:y,scheduleId:n._id,formData:t}),C==null||C(x),j({title:"Success",description:"updated successfully"})}else{const t=new FormData;t.append("projectAssignee",JSON.stringify(x.projectAssignee)),t.append("dailyTasks",JSON.stringify(x.dailyTasks)),t.append("supervisorCheck",JSON.stringify(x.supervisorCheck)),D&&t.append("actualImage",D),Y&&t.append("plannedImage",Y),b.forEach(r=>t.append("designPlanImages",r)),S.forEach(r=>t.append("siteImages",r)),await P.mutateAsync({projectId:y,formData:t}),w(),$==null||$(x),j({title:"Success",description:"Created successfully"})}W()}catch(t){j({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"something went wrong",variant:"destructive"})}},ds=async()=>{var s,a;try{const t=new FormData;t.append("projectAssignee",JSON.stringify(x.projectAssignee)),t.append("dailyTasks",JSON.stringify(x.dailyTasks)),t.append("supervisorCheck",JSON.stringify(x.supervisorCheck)),D&&t.append("actualImage",D),Y&&t.append("plannedImage",Y),b.forEach(i=>t.append("designPlanImages",i)),S.forEach(i=>t.append("siteImages",i));let r;n?r=await O({projectId:y,scheduleId:u,formData:t}):r=await O({projectId:y,formData:t}),ss({src:r.downloadUrl,alt:r.fileName}),j({description:"Pdf Generated successfully",title:"Success"})}catch(t){j({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},_e=(s,a)=>{if(!s)return;const t=Array.from(s);if(a==="design"){const r=t.map(i=>({file:i,url:URL.createObjectURL(i)}));M(i=>({...i,designPlanImages:[...i.designPlanImages,...r]})),m(i=>[...i,...t])}else if(a==="site"){const r=t.map(i=>({file:i,url:URL.createObjectURL(i)}));M(i=>({...i,siteImages:[...i.siteImages,...r]})),k(i=>[...i,...t])}},Oe=(s,a)=>{a==="design"?(M(t=>({...t,designPlanImages:t.designPlanImages.filter((r,i)=>i!==s)})),m(t=>t.filter((r,i)=>i!==s))):a==="site"&&(M(t=>({...t,siteImages:t.siteImages.filter((r,i)=>i!==s)})),k(t=>t.filter((r,i)=>i!==s)))},cs=()=>{const s=JSON.stringify(x,null,2),a=new Blob([s],{type:"application/json"}),t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`work-schedule-${Date.now()}.json`,r.click(),URL.revokeObjectURL(t)},ms=s=>{var r;const a=(r=s.target.files)==null?void 0:r[0];if(!a)return;const t=new FileReader;t.onload=i=>{var c;try{const A=JSON.parse((c=i.target)==null?void 0:c.result);M(A)}catch{j({title:"Error",description:"Error importing JSON file",variant:"destructive"})}},t.readAsText(a)},[us,We]=p.useState(null),[gs,hs]=p.useState({}),{mutateAsync:ps,isPending:Me}=Vs(),{mutateAsync:xs,isPending:Re}=Ks(),{mutateAsync:fs}=Hs(),{mutateAsync:js}=qs(),{mutateAsync:vs,isPending:bs}=Ys(),{mutateAsync:ys}=Xs(),Ns=s=>{ue&&Ae(a=>a.includes(s)?a.filter(t=>t!==s):[...a,s])},ks=async()=>{var s,a;try{if(te.length===0)return;const t=te.map(i=>({...i})),r=await ps({projectId:y,scheduleId:u,formData:t});l(i=>[...i,r]),E(i=>!i),j({description:"Pdf Generated successfully",title:"Success"})}catch(t){j({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},ws=async(s,a)=>{var r,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("files",c)});try{const c=await vs({projectId:y,scheduleId:u,comparisonId:a,formData:t});l(c),E(A=>!A)}catch(c){j({title:"Error",description:((i=(r=c==null?void 0:c.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to upload corrected images",variant:"destructive"})}},Pe=async(s,a)=>{var r,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("correctfiles",c)});try{const c=await xs({projectId:y,scheduleId:u,comparisonId:a,formData:t});l(c),E(A=>!A),w()}catch(c){j({title:"Error",description:((i=(r=c==null?void 0:c.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to upload images",variant:"destructive"})}},Ss=async(s,a)=>{var t,r;try{const i=await ys({projectId:y,scheduleId:u,comparisonId:s,imageId:a});l(i),E(c=>!c),j({title:"Success",description:"Corrected image deleted successfully"})}catch(i){j({title:"Error",description:((r=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to delete corrected image",variant:"destructive"})}},Is=async(s,a)=>{var t,r;try{const i=await js({projectId:y,scheduleId:u,comparisonId:s,selectId:a});l(i),E(c=>!c),j({title:"Success",description:"image deleted successfully"})}catch(i){j({title:"Error",description:((r=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to delete corrected image",variant:"destructive"})}},Cs=async(s,a,t)=>{var r,i;try{const c=await fs({projectId:y,scheduleId:u,comparisonId:s,selectedImageId:a,data:{comment:t}});l(c),We(""),E(A=>!A),j({title:"Success",description:"Comment updated successfully"})}catch(c){j({title:"Error",description:((i=(r=c==null?void 0:c.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to update comment",variant:"destructive"})}},Ts=s=>{const a=s.target.files[0];a&&(le({name:a.name,url:URL.createObjectURL(a)}),be(a))},As=s=>{const a=s.target.files[0];a&&(ne({name:a.name,url:URL.createObjectURL(a)}),we(a))},_s=s=>{re(!0),s.preventDefault()},Rs=s=>{if(!Ce)return;const a=s.currentTarget.getBoundingClientRect(),t=s.clientX-a.left,r=Math.max(0,Math.min(100,t/a.width*100));H(r)},Le=()=>{re(!1)},Ps=()=>{H(50)},Ds=()=>{le({name:"",url:""}),be(null)},Fs=()=>{ne({name:"",url:""}),we(null)},Es=s=>{const a=x.dailyTasks.find((t,r)=>s===r);return(a==null?void 0:a.status)||"planned"},Os=()=>{const s=x.supervisorCheck.status;return s==="approved"?"Approved":s==="needs_changes"?"Changes Required":"Pending"};return z?e.jsx("div",{onClick:W,className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white rounded-lg max-w-[90%] max-h-[90vh] overflow-y-auto w-full mx-4",children:[e.jsx("div",{className:" bg-blue-600 text-white p-4 rounded-t-lg sticky top-0 z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Vertical Living — Carpenter Work Schedule & Visual Approval"}),e.jsx("p",{className:"text-sm opacity-90",children:"RAMS TECH CIRCLE OPC Pvt. Ltd. • No. 22, 13th Main Road, Anna Nagar West, Chennai - 600040 • WhatsApp: +91 93639 93814"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{isLoading:U.isPending||P.isPending,variant:"secondary",size:"sm",onClick:os,children:"Save"}),e.jsx(F,{variant:"secondary",size:"sm",onClick:cs,children:"Export JSON"}),e.jsx("input",{id:"json-import",type:"file",accept:".json",className:"hidden",onChange:ms}),e.jsx(F,{variant:"secondary",size:"sm",onClick:()=>{var s;return(s=document.getElementById("json-import"))==null?void 0:s.click()},children:"Import JSON"}),e.jsx(F,{variant:"secondary",isLoading:L,onClick:ds,size:"sm",children:"Print / PDF"}),e.jsx(F,{variant:"secondary",size:"sm",onClick:W,children:e.jsx("i",{className:"fas fa-times"})})]})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-file-text"}),"Project & Assignee",e.jsx(F,{variant:"link",size:"sm",className:"ml-auto text-blue-600",children:"Single sheet for multiple days"})]})}),e.jsx(ve,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(J,{htmlFor:"projectName",children:"Project Name"}),e.jsx(_,{id:"projectName",placeholder:"e.g., Shankar Residence — Wardrobe & TV Unit",value:x.projectAssignee.projectName,onChange:s=>B("projectName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"siteAddress",children:"Site Address"}),e.jsx(_,{id:"siteAddress",placeholder:"Full address",value:x.projectAssignee.siteAddress,onChange:s=>B("siteAddress",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"designReferenceId",children:"Design Reference ID"}),e.jsx(_,{id:"designReferenceId",placeholder:"e.g., VL-KTN-2025-001",value:x.projectAssignee.designReferenceId,onChange:s=>B("designReferenceId",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"carpenterName",children:"Carpenter Name"}),e.jsx("select",{className:"border-b px-2 py-1 text-sm w-[100%]",value:x.projectAssignee.carpenterUIName,onChange:s=>{const a=s.target.value,t=v==null?void 0:v.find(r=>r._id===a);B("carpenterName",s.target.value),B("carpenterUIName",t?t.workerName:"")},children:q?e.jsx("option",{disabled:!0,children:"Loading workers..."}):e.jsxs(e.Fragment,{children:[e.jsx("option",{disabled:!0,value:"",children:"Assign worker"}),Array.isArray(v)&&(v==null?void 0:v.length)>0?v==null?void 0:v.map(s=>e.jsxs("option",{value:s._id,children:[s.workerName," ",s.email&&`(${s.email})`]},s._id)):e.jsx("option",{disabled:!0,children:"No workers registered"})]})})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"supervisorName",children:"Supervisor Name"}),e.jsx(_,{id:"supervisorName",placeholder:"Site supervisor",value:x.projectAssignee.supervisorName,onChange:s=>B("supervisorName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"plannedStartDate",children:"Planned Start Date"}),e.jsx(_,{id:"plannedStartDate",type:"date",value:x.projectAssignee.plannedStartDate,onChange:s=>B("plannedStartDate",s.target.value)})]})]})})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-calendar-days"}),"Daily Work Schedule"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:ns,children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Task"]}),e.jsx(F,{variant:"outline",onClick:rs,size:"sm",children:"Clear"})]})]})}),e.jsx(ve,{children:e.jsx("div",{className:"h-fit border overflow-y-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2 text-center",children:"DATE"}),e.jsx("th",{className:"border p-2 text-center",children:"ROOM / UNIT"}),e.jsx("th",{className:"border p-2 text-center",children:"WORK DESCRIPTION"}),e.jsx("th",{className:"border p-2 text-center",children:"START"}),e.jsx("th",{className:"border p-2 text-center",children:"END"}),e.jsx("th",{className:"border p-2 text-center",children:"MATERIALS NEEDED"}),e.jsx("th",{className:"border p-2 text-center",children:"MANPOWER"}),e.jsx("th",{className:"border p-2 text-center",children:"STATUS"}),e.jsx("th",{className:"border p-2 text-center",children:"ACTIONS"})]})}),e.jsx("tbody",{className:"",children:x.dailyTasks.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:e.jsx(_,{type:"date",value:G(s.datePlanned),onChange:t=>Z(a,"datePlanned",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(_,{placeholder:"Kitchen",value:s.room,onChange:t=>Z(a,"room",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(Xe,{placeholder:"Base unit carcass fixing & levelling",value:s.workDescription,onChange:t=>Z(a,"workDescription",t.target.value),rows:2})}),e.jsx("td",{className:"border p-2",children:e.jsx(_,{type:"time",value:s.startTime,onChange:t=>Z(a,"startTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(_,{type:"time",value:s.endTime,onChange:t=>Z(a,"endTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(_,{placeholder:"Plywood, laminate, screws",value:as[a]??"",onChange:t=>ls(a,t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(_,{type:"number",placeholder:"No of workers",value:s.manpower,onChange:t=>Z(a,"manpower",Number.parseInt(t.target.value)||0)})}),e.jsx("td",{className:"border p-2",children:e.jsxs(Ge,{value:s.status,onValueChange:t=>Z(a,"status",t),children:[e.jsx(Qe,{children:e.jsx(Ze,{selectedValue:Es(a)})}),e.jsxs(es,{children:[e.jsx(ke,{value:"planned",children:"Planned"}),e.jsx(ke,{value:"in-progress",children:"In Progress"}),e.jsx(ke,{value:"completed",children:"Completed"})]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{className:"flex gap-1",children:e.jsx(F,{variant:"danger",size:"sm",onClick:()=>is(a),children:e.jsx("i",{className:"fas fa-trash"})})})})]},a))})]})})})]}),e.jsxs(xe,{className:"",children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Laminate/Design/Plan Images — for Explanation"}),e.jsx(F,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload reference plans, markups, sketches"})]})}),e.jsxs(ve,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${h?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=V.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),g(!0)},onDragLeave:()=>g(!1),onDrop:s=>f(s,"design"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop plan/reference images here or"}),e.jsx(F,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Accepted: JPG/PNG/WebP • Images auto-saved locally"})]})}),e.jsx("input",{ref:V,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>_e(s.target.files,"design")}),x.designPlanImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:x.designPlanImages.map((s,a)=>e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),!s._id&&e.jsx("button",{type:"button",onClick:()=>Oe(a,"design"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"×"})]},a))})})]})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Site / Actual Images — for Visual Confirmation"}),e.jsx(F,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload daily progress photos"})]})}),e.jsxs(ve,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${h?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=Q.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),g(!0)},onDragLeave:()=>g(!1),onDrop:s=>f(s,"site"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop site/progress images here or"}),e.jsx(F,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tip: Upload clear, well-lit photos with unit labels in frame"})]})}),e.jsx("input",{ref:Q,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>_e(s.target.files,"site")}),e.jsx("div",{children:n&&e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"checkbox",id:"correctionMode",checked:ue,onChange:s=>{Te(s.target.checked),s.target.checked||Ae([])}}),e.jsx("label",{htmlFor:"correctionMode",className:"text-sm font-medium",children:"Select images for correction"}),ue&&e.jsx(F,{size:"sm",className:"bg-green-600 text-white",disabled:te.length===0||Me,onClick:ks,children:Me?"Uploading...":"Upload Selected"})]})}),x.siteImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:x.siteImages.map((s,a)=>{const t=te.includes(s);return e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{onClick:()=>Ns(s),src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),t&&e.jsx("i",{className:"fa fa-check absolute top-1 right-1 text-green-600 bg-white rounded-full p-1 shadow-md"}),!ue&&e.jsx("button",{type:"button",onClick:()=>Oe(a,"site"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"×"})]},a)})})})]})]}),n&&e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsx(je,{className:"",children:"Correction Section"})}),e.jsx(ve,{children:X&&X.length>0?e.jsxs(e.Fragment,{children:[X.map((s,a)=>e.jsx(p.Fragment,{children:e.jsx("div",{className:" border-b pb-6 last:border-b-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsxs("div",{className:"md:w-1/2 w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>Pe(t.target.files,s._id)}),Re&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Selected Images for Correction"]}),s.selectImage&&s.selectImage.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(De,{imageFiles:s==null?void 0:s.selectImage.map(t=>{const{_id:r,...i}=t.plannedImage||{};return{_id:t._id,...i,comment:t.comment,createdBy:t.createdBy,createModel:t.createModel,createdAt:t.createdAt}}),handleDeleteFile:t=>{Is(s._id,t)},height:120,minWidth:120,maxWidth:140,isComments:!0,editingId:us,tempComment:gs,setEditingId:We,setTempComment:hs,onUpdateComment:(t,r)=>Cs(s._id,t,r)})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No selected images available for this comparison."})]}),e.jsx("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Refactored Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>ws(t.target.files,s._id)}),bs&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Refactored Outputs"]}),s.correctedImages&&s.correctedImages.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(De,{imageFiles:s==null?void 0:s.correctedImages,handleDeleteFile:t=>Ss(s._id,t),refetch:w,height:120,minWidth:120,maxWidth:140})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No refactored images uploaded yet."})]})]})})]})})},s._id||a)),e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",(X==null?void 0:X.length)+1||1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>Pe(s.target.files,null)}),Re&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage  ",X.length+1||1,": Select Outputs"]})})]})]}):e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-sm font-medium block mb-2",children:"Upload Select Images (Stage 1)"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>Pe(s.target.files,null)}),Re&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsx("h3",{className:"text-md font-semibold mb-2",children:"Stage 1: Select Outputs"})})]})})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Planned vs Actual — Slider Comparison"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("planned-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Planned"}),e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("actual-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Actual"}),e.jsx("button",{onClick:Ps,className:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600",children:"Reset"})]})]}),e.jsx("div",{className:"relative w-[100%] h-96 bg-gray-100 rounded-lg overflow-hidden border",children:N.url||se.url?e.jsxs("div",{className:"relative w-full h-full cursor-col-resize",onMouseMove:Rs,onMouseUp:Le,onMouseLeave:Le,children:[N.url&&e.jsxs("div",{className:"absolute top-0 left-0 h-full overflow-visible",style:{width:`${ye}%`},children:[e.jsx("img",{src:N.url,alt:"plannedimage",className:"absolute top-0 left-0 w-[100%] h-[100%] object-cover",style:{clipPath:"inset(0px 0% 0px 0px)"}}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Planned"}),e.jsx("button",{onClick:Ds,className:"absolute top-2 left-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),se.url&&e.jsxs("div",{className:"absolute top-0 right-0 h-full overflow-hidden",style:{width:`${100-ye}%`},children:[e.jsx("img",{src:se.url||"/placeholder.svg",alt:"Actual",className:"h-full object-cover",style:{width:"100%",maxWidth:"none"}}),e.jsx("div",{className:"absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Actual"}),e.jsx("button",{onClick:Fs,className:"absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("div",{className:"absolute top-0 h-full w-1 bg-white shadow-lg cursor-col-resize z-10",style:{left:`${ye}%`,transform:"translateX(-50%)"},children:e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg border-2 border-gray-300 cursor-col-resize flex items-center justify-center",onMouseDown:_s,children:e.jsx("i",{className:"fas fa-arrows-alt-h text-gray-600 text-xs"})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-images text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"Upload planned and actual images to compare"}),e.jsx("p",{className:"text-sm",children:"Use the buttons above to select images"})]})})}),e.jsx("p",{className:"text-sm text-gray-600 mt-2 text-center",children:"Drag the circle to reveal differences"}),e.jsx("input",{id:"planned-image",type:"file",accept:"image/*",onChange:Ts,className:"hidden"}),e.jsx("input",{id:"actual-image",type:"file",accept:"image/*",onChange:As,className:"hidden"})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Supervisor Visual Check & Approval"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("span",{className:"text-sm",children:Os()})]})]})}),e.jsxs(ve,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(J,{htmlFor:"reviewerName",children:"Reviewer Name"}),e.jsx(_,{id:"reviewerName",placeholder:"Staff doing the check",value:x.supervisorCheck.reviewerName,onChange:s=>ae("reviewerName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"reviewDateTime",children:"Review Date & Time"}),e.jsx(_,{id:"reviewDateTime",type:"datetime-local",value:x.supervisorCheck.reviewDateTime,onChange:s=>ae("reviewDateTime",s.target.value)})]})]}),e.jsx("div",{className:"flex gap-4 mb-4",children:e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"pending",name:"status",value:"pending",checked:x.supervisorCheck.status==="pending",onChange:s=>ae("status",s.target.value),className:"hidden peer"}),e.jsx(J,{htmlFor:"pending",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${x.supervisorCheck.status==="pending"?"border-gray-500 bg-gray-100 text-gray-900 font-semibold":"border-gray-300 text-gray-600 hover:border-gray-400 hover:bg-gray-50"}`,children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"approved",name:"status",value:"approved",checked:x.supervisorCheck.status==="approved",onChange:s=>ae("status",s.target.value),className:"hidden peer"}),e.jsx(J,{htmlFor:"approved",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${x.supervisorCheck.status==="approved"?"border-green-600 bg-green-100 text-green-800 font-semibold":"border-gray-300 text-green-700 hover:border-green-400 hover:bg-green-50"}`,children:"Approve"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"needs_changes",name:"status",value:"needs_changes",checked:x.supervisorCheck.status==="needs_changes",onChange:s=>ae("status",s.target.value),className:"hidden peer"}),e.jsx(J,{htmlFor:"needs_changes",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${x.supervisorCheck.status==="needs_changes"?"border-orange-600 bg-orange-100 text-orange-800 font-semibold":"border-gray-300 text-orange-700 hover:border-orange-400 hover:bg-orange-50"}`,children:"Changes Required"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(J,{htmlFor:"remarks",children:"Remarks / Observations"}),e.jsx(Xe,{id:"remarks",placeholder:"Note deviations, rework needed, or greenlight to proceed",value:x.supervisorCheck.remarks,onChange:s=>ae("remarks",s.target.value),rows:3})]}),e.jsxs("div",{children:[e.jsx(J,{htmlFor:"gatekeeping",children:"Gatekeeping (Workflow Interlock)"}),e.jsxs(Ge,{value:x.supervisorCheck.gatekeeping,onValueChange:s=>ae("gatekeeping",s),children:[e.jsx(Qe,{selectedValue:x.supervisorCheck.gatekeeping,children:e.jsx(Ze,{selectedValue:x.supervisorCheck.gatekeeping==="block"?"BLOCK work to start with Supervisor Watch":"ALLOW work to start with Supervisor Watch"})}),e.jsxs(es,{children:[e.jsx(ke,{value:"block",children:"BLOCK work to start with Supervisor Watch"}),e.jsx(ke,{value:"allow_with_watch",children:"ALLOW work to start with Supervisor Watch"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Matches CRM philosophy used in Material Arrival stage — prevent next step until approval."})]})]})]})]})]})]})}):null},lt=({dailyScheduleId:y,date:z,dailyTaskId:W})=>{const{projectId:n,organizationId:$}=Fe(),[C,u]=p.useState({workerName:"",date:new Date().toISOString().substring(0,10),placeOfWork:"",reportingTime:"",workStartTime:"",travelingTime:"",workDone:"",finishingTime:"",shiftDone:"",placeOfStay:""}),[w,ee]=p.useState([]),{data:V}=st(n,y,z,W),{mutateAsync:Q,isPending:d}=tt();console.log("fetchedimages",V),p.useEffect(()=>{V&&ee(V.map(R=>({...R,_id:void 0})))},[V]);const o=R=>{u({...C,[R.target.name]:R.target.value})},v=R=>{ee(E=>E.filter((N,le)=>le!==R))},q=async()=>{var R,E;try{const N=await Q({projectId:n,organizationId:$,payload:{...C,images:w}});ss({src:N==null?void 0:N.url,alt:N==null?void 0:N.fileName}),j({title:"Success",description:"Created report successfully"})}catch(N){j({title:"Error",description:((E=(R=N==null?void 0:N.response)==null?void 0:R.data)==null?void 0:E.message)||(N==null?void 0:N.message)||"Report not created"})}};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4 border rounded-md bg-white space-y-4",children:[e.jsx("h2",{className:"text-lg font-bold text-blue-700",children:"Create Work Report"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Worker Name"}),e.jsx(_,{name:"workerName",value:C.workerName,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date"}),e.jsx(_,{type:"date",name:"date",value:C.date,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Place of Work"}),e.jsx(_,{name:"placeOfWork",value:C.placeOfWork,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reporting Time"}),e.jsx(_,{type:"time",name:"reportingTime",value:C.reportingTime,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Work Start Time"}),e.jsx(_,{type:"time",name:"workStartTime",value:C.workStartTime,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Traveling Time"}),e.jsx(_,{type:"time",name:"travelingTime",value:C.travelingTime,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Finishing Time"}),e.jsx(_,{type:"time",name:"finishingTime",value:C.finishingTime,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Shift Done"}),e.jsx(_,{name:"shiftDone",value:C.shiftDone,onChange:o})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Place of Stay"}),e.jsx(_,{name:"placeOfStay",value:C.placeOfStay,onChange:o})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Work Done"}),e.jsx("textarea",{name:"workDone",className:"w-full border px-3 py-2 rounded-md",rows:3,value:C.workDone,onChange:o})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-700 mb-2",children:"Work Images"}),w.length===0?e.jsx("p",{className:"text-gray-500 text-sm",children:"No images found for this date."}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:w.map((R,E)=>e.jsxs("div",{className:"relative border p-1 rounded-md shadow-sm flex flex-col items-center justify-center",children:[e.jsx("img",{src:R==null?void 0:R.url,alt:(R==null?void 0:R.originalName)||"work image",className:"w-full h-[150px] object-cover rounded"}),e.jsxs(F,{onClick:()=>v(E),className:"text-xs text-white mt-1 bg-red-600",children:[e.jsx("i",{className:"fas fa-trash mr-1"}),"Remove"]})]},E))})]}),e.jsx(F,{onClick:q,isLoading:d,className:"mt-4",children:"Save Report"})]})})},ht=()=>{var X;const{projectId:y,organizationId:z}=Fe(),[W,n]=p.useState(!1),[$,C]=p.useState([]),[u,w]=p.useState(null),[ee,V]=p.useState(null),[Q,d]=p.useState(new Date),[o,v]=p.useState(null),[q,R]=p.useState([]),[E,N]=p.useState(!1),[le,se]=p.useState(!1),[ne,Y]=p.useState(null),be=Ms(),{data:D,isLoading:we,error:ye,refetch:H}=Gs(y),{mutateAsync:Ce}=Qs(),re=Zs(),Se=et();p.useEffect(()=>{(()=>{const h=Q.getFullYear(),g=Q.getMonth(),f=new Date(h,g,1),b=new Date(f);b.setDate(b.getDate()-f.getDay());const m=[],S=new Date(b);for(let k=0;k<42;k++)m.push({date:new Date(S),isCurrentMonth:S.getMonth()===g}),S.setDate(S.getDate()+1);C(m)})()},[Q]);const ie=p.useCallback(()=>{if(!u)return;const l=new Date(u);l.setDate(l.getDate()-1),de(l)},[u]),oe=p.useCallback(()=>{if(!u)return;const l=new Date(u);l.setDate(l.getDate()+1),de(l)},[u]);p.useEffect(()=>{const l=h=>{u&&(h.key==="Escape"?(w(null),v(null),N(!1)):h.key==="ArrowRight"?oe():h.key==="ArrowLeft"&&ie())};return document.addEventListener("keydown",l),()=>{document.removeEventListener("keydown",l)}},[oe,ie]);const T=ts();p.useEffect(()=>{if(!I||!z)return;const l=m=>{const{createdBy:S}=m;console.log("workinged created form teh socket 1294"),S!==(T==null?void 0:T.id)&&(H(),j({title:"New Task Created",description:`New work schedule created by ${m.createdByRole}`}))},h=m=>{const{updatedBy:S}=m;if(console.log("🔥 WebSocket Event Received:",m),console.log("👤 Current User ID:",T==null?void 0:T.id),S!==(T==null?void 0:T.id)&&(console.log("✅ Refetching data... in weebsocket useEffect"),H(),j({title:"Task Updated",description:`Work schedule updated by ${m.updatedByRole}`}),o&&o.scheduleId===m.taskId)){const k=D==null?void 0:D.find(P=>P._id===m.taskId);if(k){const P=k.dailyTasks.find(U=>U._id===o._id);P&&v({...P,scheduleId:m.taskId})}}},g=m=>{const{taskId:S,deletedBy:k}=m;k!==(T==null?void 0:T.id)&&(H(),j({title:"Task Deleted",description:`Task deleted by ${m.deletedByRole}`}),o&&o._id===S&&(v(null),w(null),N(!1)))},f=m=>{const{taskId:S,date:k,newImages:P,uploadedBy:U}=m;U!==(T==null?void 0:T.id)&&(o&&o._id===S&&v(O=>{if(!O)return O;const L=[...O.uploadedImages||[]],B=new Date(k),G=L.findIndex(Z=>new Date(Z.date).toDateString()===B.toDateString());return G!==-1?L[G]={...L[G],uploads:[...L[G].uploads,...P]}:L.push({date:B.toISOString(),uploads:P}),{...O,uploadedImages:L}}),j({title:"Images Uploaded",description:`New images uploaded by ${m.uploadedByRole}`}))},b=m=>{const{taskId:S,date:k,remainingImages:P,deletedBy:U}=m;U!==(T==null?void 0:T.id)&&(o&&o._id===S&&v(O=>{var B;if(!O)return O;const L=(B=O.uploadedImages)==null?void 0:B.map(G=>G.date.split("T")[0]===k?{...G,uploads:P}:G);return{...O,uploadedImages:L}}),j({title:"Image Deleted",description:`Image deleted by ${m.deletedByRole}`}))};return I.on("workSchedule:task_created",l),I.on("workSchedule:task_updated",h),I.on("workSchedule:task_deleted",g),I.on("workSchedule:image_uploaded",f),I.on("workSchedule:image_deleted",b),()=>{I.off("workSchedule:task_created",l),I.off("workSchedule:task_updated",h),I.off("workSchedule:task_deleted",g),I.off("workSchedule:image_uploaded",f),I.off("workSchedule:image_deleted",b)}},[z,T==null?void 0:T.id,o,D,E]);const Ie=l=>`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,Ne=l=>{const h=Ie(l);return D.flatMap(g=>(g.dailyTasks||[]).filter(b=>(typeof b.datePlanned=="string"?b.datePlanned.split("T")[0]:new Date(b.datePlanned).toISOString().split("T")[0])===h).map(b=>({...b,scheduleId:g._id})))},de=l=>{const h=Ne(l);w(l),R(h),h.length===1?(v(h[0]),N(!1)):h.length>1&&(N(!0),v(null))},ce=l=>{switch(l){case"completed":return"bg-green-200 text-green-800";case"in_progress":return"bg-yellow-200 text-yellow-800";case"planned":return"bg-blue-200 text-blue-800";default:return"bg-gray-200 text-gray-800"}},me=l=>{const h=D.find(g=>g._id===l);h&&(V(h),n(!0))},x=l=>{Y(l),se(!0)},M=async l=>{var h,g;try{await Ce({scheduleId:l.scheduleId,taskId:l._id,projectId:y}),w(null),v(null),H(),j({title:"Success",description:"deleted successfully"})}catch(f){j({title:"Error",description:((g=(h=f==null?void 0:f.response)==null?void 0:h.data)==null?void 0:g.message)||"failed to delete",variant:"destructive"})}},ue=async(l,h)=>{var g,f,b;if(u)try{const m=(g=D==null?void 0:D.find(S=>S.dailyTasks.some(k=>k._id===h._id)))==null?void 0:g._id;if(m){const S=await re.mutateAsync({scheduleId:m,taskId:h._id,date:u.toISOString().split("T")[0],projectId:y,files:l});H(),v(k=>{var U;if(!k)return k;const P=(U=k.uploadedImages)==null?void 0:U.find(O=>new Date(O.date).toDateString()===u.toDateString());return P?(P.uploads.push(...S.uploads),{...k,uploadedImages:[...k.uploadedImages]}):{...k,uploadedImages:[...k.uploadedImages||[],S]}}),j({title:"Success",description:"image uploaded successfully"})}}catch(m){j({title:"Error",description:((b=(f=m==null?void 0:m.response)==null?void 0:f.data)==null?void 0:b.message)||"failed to upload",variant:"destructive"})}},Te=async(l,h)=>{var g,f,b;try{const m=(g=D==null?void 0:D.find(S=>S.dailyTasks.some(k=>k._id===h._id)))==null?void 0:g._id;if(m){const S=await Se.mutateAsync({scheduleId:m,taskId:h._id,date:(u==null?void 0:u.toISOString().split("T")[0])||"",projectId:y,imageId:l});console.log("upladsImages",S),H();const k=(u==null?void 0:u.toISOString().split("T")[0])||"";v(P=>{var O;if(!P)return P;const U=(O=P.uploadedImages)==null?void 0:O.map(L=>L.date.split("T")[0]===k?{...L,uploads:L.uploads.filter(B=>B._id!==l)}:L);return{...P,uploadedImages:U}}),j({title:"Success",description:"deleted successfully"})}}catch(m){j({title:"Error",description:((b=(f=m==null?void 0:m.response)==null?void 0:f.data)==null?void 0:b.message)||"failed to delete",variant:"destructive"})}},te=l=>{d(h=>{const g=new Date(h);return g.setMonth(h.getMonth()+l),g})};return we?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading schedule..."})]})}):ye?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-exclamation-triangle text-4xl text-red-600 mb-4"}),e.jsx("p",{className:"text-red-600",children:"Error loading schedule data"})]})}):location.pathname.includes("workreport")?e.jsx(Ls,{}):e.jsx("div",{className:"max-h-full overflow-y-auto bg-gray-50",children:e.jsx("div",{className:" mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("button",{className:"bg-gray-100 rounded-lg px-2 py-1 cursor-pointer",onClick:()=>{be(-1)},children:[e.jsx("i",{className:"fas fa-arrow-left mr-1 "}),"back"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Work Schedule Calendar"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>n(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-plus"}),"Add Events"]}),e.jsxs("button",{className:"bg-gray-100 rounded-lg px-2 py-1 cursor-pointer",onClick:()=>{be("workreport")},children:[e.jsx("i",{className:"fas fas-file-lines mr-1 "}),"Work Report Lists"]})]})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("button",{onClick:()=>te(-1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsx("h2",{className:"text-xl font-semibold",children:Q.toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>te(1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-1 mb-4",children:[["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(l=>e.jsx("div",{className:"p-3 text-center font-semibold text-gray-600 bg-gray-100",children:l},l)),$.map((l,h)=>{const g=Ne(l.date);return e.jsxs("div",{className:`min-h-[120px] p-2 border border-gray-200 cursor-pointer hover:bg-gray-50 ${l.isCurrentMonth?"bg-white":"bg-gray-50"}`,onClick:()=>de(l.date),children:[e.jsx("div",{className:"font-medium text-sm mb-1",children:l.date.getDate()}),g.length===0?e.jsx("div",{className:"text-xs text-gray-400 italic",children:"No tasks assigned"}):e.jsxs("div",{className:"space-y-1",children:[g.slice(0,2).map((f,b)=>e.jsx("div",{className:`text-xs p-1 rounded truncate ${ce(f.status)}`,children:f.workDescription||f.room},b)),g.length>2&&e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["+",g.length-2," more"]})]})]},h)})]}),u&&e.jsxs("div",{onClick:()=>{V(null),w(null),v(null),N(!1)},className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-around z-50",children:[e.jsx("button",{onClick:l=>{l.stopPropagation(),ie()},className:"p-2 text-gray-600 bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsxs("div",{onClick:l=>l.stopPropagation(),className:"bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold",children:["Tasks for ",u.toLocaleDateString()]}),e.jsx("button",{onClick:()=>{V(null),w(null),v(null),N(!1)},className:"text-gray-500 hover:text-gray-700",children:e.jsx("i",{className:"fas fa-times text-xl"})})]}),q.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fas fa-calendar-times text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"No tasks assigned for this date"})]}):E&&q.length>1?e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Select a task to view details:"}),q.map((l,h)=>e.jsx("div",{className:"border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>{v(l),N(!1)},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-lg",children:l.workDescription}),e.jsxs("p",{className:"text-gray-600",children:["Room: ",l.room]}),e.jsxs("p",{className:"text-gray-600",children:["Time: ",l.startTime," - ",l.endTime]})]}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${ce(l.status)}`,children:l.status})]})},h))]}):o?e.jsxs("div",{className:"space-y-6",children:[q.length>1&&e.jsxs("button",{onClick:()=>{N(!0),v(null)},className:"text-blue-600 hover:text-blue-800 mb-4",children:[e.jsx("i",{className:"fas fa-arrow-left mr-2"}),"Back to task list"]}),e.jsxs("div",{className:"border rounded-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h4",{className:"text-xl font-bold",children:o.workDescription}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${ce(o.status)}`,children:o.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 text-gray-700 mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Room/Unit:"})," ",o.room]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Time:"})," ",o.startTime," - ",o.endTime]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Materials:"})," ",((X=o.materialsNeeded)==null?void 0:X.join(", "))||"None"]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Manpower:"})," ",o.manpower]})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"text-lg font-semibold",children:"Task Images"}),e.jsxs("label",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded cursor-pointer transition-colors",children:[re.isPending&&e.jsx("span",{className:"animate-spin fas fa-spinner mr-1"}),e.jsx("i",{className:"fas fa-upload mr-2"}),"Upload Images",e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:l=>{l.target.files&&ue(Array.from(l.target.files),o)}})]})]}),o!=null&&o.uploadedImages&&(o==null?void 0:o.uploadedImages.length)>0?e.jsx("div",{className:"",children:(()=>{const l=((o==null?void 0:o.uploadedImages)||[]).reduce((g,f)=>{if(!Array.isArray(f==null?void 0:f.uploads)||f.uploads.length===0)return g;let b="Unknown Date";if(f!=null&&f.date){const m=new Date(f.date);b=isNaN(m.getTime())?String(f.date):m.toISOString().split("T")[0]}return g[b]||(g[b]=[]),g[b].push(...f.uploads),g},{}),h=Object.keys(l);return h.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]}):h.map(g=>e.jsx("div",{className:"mb-4",children:e.jsx(De,{imageFiles:l[g],handleDeleteFile:f=>Te(f,o),refetch:H,height:120,minWidth:120,maxWidth:140})},g))})()}):e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]})]}),e.jsxs("div",{className:"mt-6 flex gap-3 pt-4 border-t",children:[e.jsxs("button",{onClick:()=>M(o),className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors",children:[e.jsx("i",{className:"fas fa-trash mr-2"}),"Delete Task"]}),e.jsx(F,{onClick:()=>me(o.scheduleId),children:"Edit Task"}),e.jsx(F,{onClick:()=>x(o.scheduleId),children:"Create Report"})]})]})]}):q.length===1?(v(q[0]),null):null]}),e.jsx("button",{onClick:l=>{l.stopPropagation(),oe()},className:"p-2 text-gray-600  bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),le&&ne&&e.jsxs("div",{className:"fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center",children:[e.jsx("div",{onClick:()=>{se(!1),Y(null)},className:"absolute inset-0"}),e.jsxs("div",{onClick:l=>l.stopPropagation(),className:"relative z-10 bg-white rounded-lg shadow-lg max-w-4xl w-full mx-auto max-h-[90vh] overflow-y-auto p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Create Work Report"}),e.jsx("button",{className:"text-gray-500 hover:text-red-600 text-xl",onClick:()=>{se(!1),Y(null)},children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx(lt,{dailyScheduleId:ne,date:o==null?void 0:o.datePlanned,dailyTaskId:o==null?void 0:o._id},ne)]})]}),W&&e.jsx(at,{projectId:y,isOpen:W,onClose:()=>{n(!1),V(null)},onSave:()=>{n(!1)},refetch:H,scheduleId:ee?o.scheduleId:null,editData:ee,onUpdate:()=>{w(null),v(null),N(!1)}})]})})})};export{ht as default};
