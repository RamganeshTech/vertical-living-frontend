import{j as e,L as A,u as _,r as u,s as p,q as D}from"./index-BzUhBKjh.js";import{u as M,a as R,b as $}from"./notificationApi-DByexR6f.js";import{B as E}from"./Button-G0_5Lr1e.js";import H from"./MaterialOverviewLoading-DH5TyW_t.js";import{u as L}from"./useCurrentSupervisor-QblP4OqE.js";import"./useQuery-DVRx6O1f.js";import"./useMutation-CBXZTi2Z.js";import"./useInfiniteQuery-CeMIkBnK.js";import"./roleCheck-Dfs5Z9Fe.js";import"./Skeleton-DrpFGjA3.js";const B=({deleteMutation:N,notification:s,onDelete:a,frontendUrl:x})=>{var g;const n=(r=>{switch(r){case"warning":return{icon:"fa-exclamation-triangle",bgColor:"bg-amber-50",borderColor:"border-l-amber-400",badgeBg:"bg-amber-100",badgeText:"text-amber-700"};case"assignment":return{icon:"fa-tasks",bgColor:"bg-blue-50",borderColor:"border-l-blue-400",badgeBg:"bg-blue-100",badgeText:"text-blue-700"};case"info":default:return{icon:"fa-info-circle",bgColor:"bg-slate-50",borderColor:"border-l-slate-400",badgeBg:"bg-slate-100",badgeText:"text-slate-700"}}})(s.type),y=r=>{const l=new Date(r),c=new Date,m=c.getTime()-l.getTime(),d=Math.floor(m/6e4),v=Math.floor(m/36e5),w=Math.floor(m/864e5);return d<1?"Just now":d<60?`${d}m ago`:v<24?`${v}h ago`:w<7?`${w}d ago`:l.toLocaleDateString("en-US",{month:"short",day:"numeric",year:l.getFullYear()!==c.getFullYear()?"numeric":void 0})},o=(()=>{var c;if(!((c=s==null?void 0:s.navigation)!=null&&c.url))return null;const r=x.endsWith("/")?x.slice(0,-1):x,l=s.navigation.url.startsWith("/")?s.navigation.url:`/${s.navigation.url}`;return`${r}${l}`})();return e.jsx(A,{to:o||"",onClick:()=>a(s._id),children:e.jsx("div",{className:`${n.bgColor} cursor-pointer border-l-4 ${n.borderColor} rounded-lg p-4 mb-3 transition-all duration-200 hover:shadow-md ${s.isRead?"":"ring-1 ring-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 pt-1",children:e.jsx("i",{className:`fas ${n.icon} text-lg ${n.badgeText}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 leading-relaxed",children:s.message}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:y(s.createdAt)})]})}),o&&e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsxs(A,{to:o,className:"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors",onClick:()=>a(s._id),children:[((g=s.navigation)==null?void 0:g.label)||"View Details",e.jsx("i",{className:"fas fa-arrow-right text-xs"})]})})]}),e.jsx("div",{className:"flex-shrink-0 flex gap-2",children:e.jsx(E,{variant:"danger",isLoading:N.isPending&&N.variables.notificationId===s._id,onClick:r=>{r.preventDefault(),r.stopPropagation(),a(s._id)},className:"!p-1 px-2  bg-red-600 !text-white hover:bg-red-600 transition-colors rounded",title:"Delete notification",size:"sm",children:e.jsx("i",{className:"fas fa-xmark text-sm"})})})]})})})},Q=()=>{var C,T;const N=_(),s=L(),{data:a,fetchNextPage:x,hasNextPage:j,isFetchingNextPage:n,isLoading:y,isError:k,error:o}=M(20),{mutateAsync:g}=R(),r=$(),l=u.useRef(null),c=u.useRef(null),m=u.useRef(0);u.useEffect(()=>{const t=s==null?void 0:s.id;if(!t)return;p.emit("join_notifications",{userId:t});const i=h=>{console.log("ðŸ”” New notification received:",h);const b=l.current;D.invalidateQueries({queryKey:["notifications","infinite"]}),setTimeout(()=>{b==null||b.scrollTo({top:0,behavior:"smooth"})},100)},f=()=>{D.invalidateQueries({queryKey:["notifications","unread-count"]})};return p.on("new_notification",i),p.on("unread_count_update",f),()=>{p.off("new_notification",i),p.off("unread_count_update",f)}},[s==null?void 0:s.id]);const d=((T=(C=a==null?void 0:a.pages)==null?void 0:C.flatMap(t=>t==null?void 0:t.notifications))==null?void 0:T.sort((t,i)=>{var f,h;return((f=new Date(i.createdAt))==null?void 0:f.getTime())-((h=new Date(t.createdAt))==null?void 0:h.getTime())}))??[];console.log("data.pages.",a==null?void 0:a.pages),u.useEffect(()=>{const t=l.current;if(!t)return;const i=()=>{t.scrollHeight-t.scrollTop-t.clientHeight<100&&j&&!n&&(console.log("ðŸ“œ Loading older notifications..."),m.current=t.scrollHeight,x().then(()=>{requestAnimationFrame(()=>{const b=t.scrollHeight-m.current;t.scrollTop=t.scrollTop+b})}))};return t.addEventListener("scroll",i),()=>t.removeEventListener("scroll",i)},[j,n,x]),u.useEffect(()=>{a&&(async()=>{await g()})()},[a,g]);const v="https://houseofram.in",w=async t=>{try{await r.mutateAsync({notificationId:t})}catch(i){console.error("Error deleting notification:",i)}};return y?e.jsx(H,{}):k?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-exclamation-circle"}),e.jsxs("span",{children:["Error loading notifications: ",(o==null?void 0:o.message)||"Unknown error"]})]})})}):e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col bg-white",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-slate-200 flex-shrink-0",children:e.jsx("div",{className:"px-4 md:px-6 py-2 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{onClick:()=>N(-1),className:"cursor-pointer w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-arrow-left text-blue-600 text-lg"})}),e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-bell text-blue-600 text-lg"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-slate-900",children:"Notifications"})})]})})}),e.jsx("div",{ref:l,className:"flex-1 overflow-y-auto p-4 md:p-6",style:{scrollBehavior:"auto"},children:d.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-8 text-center",children:[e.jsx("i",{className:"fas fa-bell text-4xl text-slate-300 mb-3 block"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No notifications yet"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"You're all caught up! Check back later for updates."})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:d.map(t=>e.jsx(B,{notification:t,onDelete:w,deleteMutation:r,frontendUrl:v},t._id))}),e.jsxs("div",{ref:c,className:"flex justify-center py-2",children:[n&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Loading earlier notifications..."})]}),!j&&d.length>0&&e.jsx("p",{className:"text-slate-400 text-xs font-medium",children:"Youâ€™ve reached the end"})]})]})})]})};export{Q as default};
