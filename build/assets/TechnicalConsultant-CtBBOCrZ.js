import{c as h,q as N,a as ie,f as le,u as re,r as g,j as e}from"./index-C0KkMjHg.js";import{I as E}from"./Input-e9nZV_sO.js";import{B as x}from"./Button-DIkkRbUr.js";import{L as W}from"./Label-0ovsOw6V.js";import{u as oe}from"./useQuery-Dp3DvoKb.js";import{u as v}from"./useMutation-CaYNPTtb.js";import{g as w}from"./roleCheck-DWgWWcQZ.js";import{t as p}from"./toast-BSC5QTk1.js";import{C as ce}from"./Card-CUvRTemJ.js";import{A as de,S as me}from"./AssignStaff-DVYIizg0.js";import{R as ue}from"./ResetStageButton-Bpb-Rgvi.js";import xe from"./MaterialOverviewLoading-DkgmTtHr.js";import{d as fe}from"./downloadFile-Bztbg4F7.js";import{B as ge}from"./Badge-EF8WaOnN.js";import{S as pe}from"./ShareDocumentWhatsapp-DU0nRP6m.js";import"./getAllUsersApi-BESJfawR.js";import"./Skeleton-BdeHOwUC.js";import"./documentationApi-Dc8cMkOF.js";import"./requirementFormApi-DJTMpzjT.js";const he=async({projectId:t,formData:n,api:a})=>{const{data:l}=await a.post(`/technicalconsultation/createmessage/${t}`,n);if(!l.ok)throw new Error(l.message);return l.data},we=async({projectId:t,api:n})=>{const{data:a}=await n.get(`/technicalconsultation/getmessages/${t}`);if(!a.ok)throw new Error(a.message);return a.data},ye=async({projectId:t,messageId:n,message:a,senderId:l,senderRole:r,api:m})=>{const{data:f}=await m.put(`/technicalconsultation/editmessage/${t}/${n}`,{message:a,senderId:l,senderRole:r});if(!f.ok)throw new Error(f.message);return f.data},je=async({formId:t,projectId:n,deadLine:a,api:l})=>{const{data:r}=await l.put(`/technicalconsultation/deadline/${n}/${t}`,{deadLine:a});if(!r.ok)throw new Error(r.message);return r.data},Ne=async({projectId:t,api:n})=>{const{data:a}=await n.put(`/technicalconsultation/completionstatus/${t}`);if(!a.ok)throw new Error(a.message);return a.data},ve=t=>{const n=["owner","staff","CTO","worker"],{role:a}=h(),l=w(a);return oe({queryKey:["consultationMessages",t],queryFn:async()=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!l)throw new Error("API not found");return await we({projectId:t,api:l})},enabled:!!t,retry:!1,refetchOnMount:!1,refetchOnWindowFocus:!1})},be=()=>{const t=["owner","staff","CTO","worker"],{role:n}=h(),a=w(n);return v({mutationFn:async({projectId:l,formData:r})=>{if(!n||!t.includes(n))throw new Error("Not allowed");if(!a)throw new Error("API not found");return await he({projectId:l,formData:r,api:a})},onSuccess:(l,{projectId:r})=>{N.invalidateQueries({queryKey:["consultationMessages",r]})}})},Ce=()=>{const t=["owner","staff","CTO","worker"],{role:n}=h(),a=w(n);return v({mutationFn:async({projectId:l,messageId:r,message:m,senderId:f})=>{if(!n||!t.includes(n))throw new Error("Not allowed");if(!a)throw new Error("API not found");return await ye({projectId:l,messageId:r,message:m,senderId:f,senderRole:n,api:a})},onSuccess:(l,{projectId:r})=>{N.invalidateQueries({queryKey:["consultationMessages",r]})}})},Se=()=>{const t=["owner","staff","CTO"],{role:n}=h(),a=w(n);return v({mutationFn:async({projectId:l})=>{if(!n||!t.includes(n))throw new Error("not allowed to make this api call");if(!a)throw new Error("API instance not found for role");return await Ne({projectId:l,api:a})},onSuccess:(l,{projectId:r})=>{N.invalidateQueries({queryKey:["consultationMessages",r]})}})},ke=()=>{const t=["owner","staff","CTO"],{role:n}=h(),a=w(n);return v({mutationFn:async({formId:l,projectId:r,deadLine:m})=>{if(!n)throw new Error("not authorized");if(!t.includes(n))throw new Error("you  dont have the access to make this api");if(!a)throw new Error("api is null");return await je({formId:l,projectId:r,deadLine:m,api:a})},onSuccess:(l,{projectId:r})=>{N.invalidateQueries({queryKey:["consultationMessages",r]})}})},Ue=()=>{var $,q,z,K,B,Q;const{projectId:t,organizationId:n}=ie(),{isMobile:a,openMobileSidebar:l}=le(),{role:r,_id:m}=h(),f=re(),[y,A]=g.useState(""),[M,T]=g.useState([]),[b,C]=g.useState(null),[S,j]=g.useState(""),[I,k]=g.useState(null),[L,P]=g.useState(!1);let{data:G,isLoading:R,error:u,isError:U,refetch:F}=ve(t);const o=G,{mutateAsync:Y,isPending:H}=be(),{mutateAsync:J,isPending:V}=Ce(),{mutateAsync:X,isPending:Z}=ke(),O=Se(),D=async()=>{var s,c;try{await O.mutateAsync({projectId:t}),p({description:"Completion status updated successfully",title:"Success"}),f("../paymentconfirmation")}catch(i){p({title:"Error",description:((c=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:c.message)||i.message||"Failed to update completion status",variant:"destructive"})}},_=async()=>{var s,c;try{if(!y&&M.length===0)throw new Error("please write anything");const i=new FormData;y&&i.append("message",y),r&&i.append("senderRole",r),i.append("sender",m),M.forEach(d=>i.append("attachments",d)),await Y({projectId:t,formData:i}),A(""),T([]),p({description:"message sent successfully",title:"Success"})}catch(i){p({title:"Error",description:((c=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:c.message)||(i==null?void 0:i.message)||"Failed to send the message",variant:"destructive"})}},ee=(s,c)=>{C(s),j(c)},se=()=>{C(null),j("")},ae=async()=>{var s,c;try{if(!b||!S)throw new Error("please write anything");await J({projectId:t,messageId:b,message:S,senderId:m}),C(null),j(""),p({description:"message edited successfully",title:"Success"})}catch(i){p({title:"Error",description:((c=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:c.message)||(i==null?void 0:i.message)||"Failed to edit the message",variant:"destructive"})}};if(R)return e.jsx(xe,{});const te=(s,c)=>{if(s==="owner")return c.username;if(s==="staff")return c.staffName;if(s==="worker")return c.workerName;if(s=="CTO")return c.CTOName};return e.jsxs("div",{className:"container mx-auto  max-w-full max-h-full",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-2",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[a&&e.jsx("button",{onClick:l,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-comments mr-2"})," Technical Consultation"]}),e.jsxs("div",{className:"w-full lg:w-[60%]  flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(x,{isLoading:O.isPending,onClick:D,className:"bg-green-600 hover:bg-green-700 text-white flex-1 sm:flex-initial min-w-max",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsxs("div",{className:"flex flex-wrap sm:flex-nowrap gap-2 justify-end",children:[e.jsx(ue,{projectId:t,stageNumber:4,stagePath:"technicalconsultation",className:"flex-1 sm:flex-initial min-w-max"}),!u&&e.jsx(pe,{projectId:t,stageNumber:"4",className:"w-full sm:w-fit",isStageCompleted:o==null?void 0:o.status}),e.jsx(de,{stageName:"TechnicalConsultationModel",projectId:t,organizationId:n,currentAssignedStaff:(o==null?void 0:o.assignedTo)||null,className:"flex-1 sm:flex-initial min-w-max"})]})]})]}),e.jsxs(ce,{className:"p-4 mb-3 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(me,{stageName:"technicalconsultation",completedAt:($=o==null?void 0:o.timer)==null?void 0:$.completedAt,projectId:t,formId:o==null?void 0:o._id,deadLine:(q=o==null?void 0:o.timer)==null?void 0:q.deadLine,startedAt:(z=o==null?void 0:o.timer)==null?void 0:z.startedAt,refetchStageMutate:F,deadLineMutate:X,isPending:Z})]}),e.jsx("div",{className:" flex flex-col bg-white rounded-xl p-2 shadow-md border custom-scrollbar min-h-[200px] sm:min-h-[170px] md:min-h-[190px] lg:min-h-[340px] border-gray-200 mb-2 flex-grow max-h-[70vh] sm:!max-h-[30vh] md:!max-h-[30vh] lg:!max-h-[42vh] xl:!max-h-[49vh] overflow-y-auto ",children:e.jsxs("div",{className:"flex flex-col-reverse overflow-y-auto custom-scrollbar  flex-grow p-2  md:!max-h-full space-y-reverse space-y-4",children:[(U||u)&&e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-ban text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:((B=(K=u==null?void 0:u.response)==null?void 0:K.data)==null?void 0:B.message)||(u==null?void 0:u.message)||"Failed to load messages, please try again"}),e.jsxs(x,{onClick:()=>F(),className:"mt-4 bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx("i",{className:"fas fa-redo mr-2"})," Retry"]})]})}),R?e.jsxs("div",{className:"flex h-full items-center justify-center py-10",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-blue-600 text-2xl"}),e.jsx("span",{className:"ml-3 text-blue-600 font-medium",children:"Loading messages..."})]}):(o==null?void 0:o.messages.length)===0?e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-envelope text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:"No messages have been posted yet."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation using the box below."})]})}):e.jsx("div",{className:"overflow-y-auto custom-scrollbar flex flex-col-reverse space-y-reverse space-y-4",children:(Q=o==null?void 0:o.messages)==null?void 0:Q.slice().sort((s,c)=>new Date(c.createdAt).getTime()-new Date(s.createdAt).getTime()).map(s=>{var c,i;return e.jsxs("div",{className:"bg-blue-50 w-full group px-4 py-[5px] rounded-lg shadow flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-xs sm:text-[10px] text-gray-600",children:[te(s.senderRole,s.sender)||((c=s==null?void 0:s.senderRole)==null?void 0:c.toUpperCase())||"User"," - ",new Date(s.createdAt).toLocaleString(),s.isEdited&&e.jsxs(ge,{className:"sm:ml-2 my-1 sm:my-0",children:[" ",e.jsxs("p",{className:"hidden sm:inline-block",children:["message is  "," "," "]})," Â  edited by ",s.senderRole]})]}),e.jsx("div",{className:"opacity-0 scale-95 group-hover:opacity-100 transition-all duration-300",children:(s.sender._id===m||r==="owner"||r==="CTO")&&e.jsx("div",{className:"flex gap-2",children:e.jsx(x,{variant:"secondary",onClick:()=>ee(s._id,s.message),className:"text-blue-600 text-sm",children:e.jsx("i",{className:"fas fa-edit"})})})})]}),b===s._id?e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-center mt-2",children:[e.jsx(E,{value:S,onChange:d=>j(d.target.value),className:"flex-grow"}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(x,{isLoading:V,onClick:ae,className:"w-full sm:w-auto",children:"Save"}),e.jsx(x,{variant:"danger",className:"w-full sm:w-auto border-red-200 hover:bg-red-700 bg-red-600 text-white",onClick:se,children:"Cancel"})]})]}):e.jsx("p",{className:"text-gray-900 text-sm",children:s.message}),e.jsx("div",{className:"flex flex-wrap gap-3 mt-3",children:(i=s.attachments)==null?void 0:i.map((d,ne)=>e.jsxs("div",{className:"flex items-center gap-2 bg-white border px-3 py-2 rounded shadow-sm w-full max-w-[280px]",children:[e.jsx("i",{className:`fas ${d.type==="pdf"?"fa-file-pdf text-red-500":"fa-image text-blue-500"}`}),e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 truncate flex-grow min-w-0",children:d.originalName}),d.type==="image"&&e.jsx(x,{size:"sm",variant:"primary",onClick:()=>{k(d.url),P(!0)},children:e.jsx("i",{className:"fas fa-eye"})}),e.jsx(x,{onClick:()=>fe({src:d==null?void 0:d.url,alt:(d==null?void 0:d.originalName)||"file.pdf"}),size:"sm",className:"text-sm",children:e.jsx("i",{className:"fa-solid fa-download"})})]},ne))})]},s._id)})})]})}),e.jsxs("div",{className:"bg-white px-4 py-2 rounded-xl shadow-md",children:[e.jsx(W,{htmlFor:"message",children:"Your Message"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mb-3",children:[e.jsx(E,{id:"message",placeholder:"Write something...",value:y,onChange:s=>A(s.target.value),onKeyDown:s=>{s.key==="Enter"&&_()},className:"flex-grow"}),e.jsxs(x,{isLoading:H,onClick:_,className:"w-full sm:w-auto",children:["Send ",e.jsx("i",{className:"ml-2 fa-solid fa-paper-plane"})]})]}),e.jsx(W,{children:"Attach Files (PDF or Image)"}),e.jsx(E,{type:"file",multiple:!0,accept:".pdf,image/*",onChange:s=>T(Array.from(s.target.files||[])),className:""})]}),I&&e.jsx("div",{onClick:()=>k(null),className:"fixed inset-0 z-50 bg-black/60 flex items-center justify-center",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white p-2 sm:p-4 rounded-lg shadow-lg max-w-[90%] max-h-[90%] overflow-auto relative",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{onClick:()=>k(null),className:"text-red-500 text-xl",children:e.jsx("i",{className:"fas fa-times"})})}),e.jsxs("div",{className:"relative min-w-80 ",children:[L&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm",children:e.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-gray-600"})}),e.jsx("img",{src:I,onLoad:()=>P(!1),loading:"lazy",alt:"Preview",className:`max-h-[80vh] rounded transition duration-500 ${L?"blur-sm scale-105":""}`})]})]})})]})};export{Ue as default};
