import{j as e,r as f,I as P,B as I,i as A,t as k,c as D,f as L}from"./index-C8ZngCsk.js";import{c as U,d as V,e as $,f as B}from"./costEstimationApi-BSrWXmLT.js";import{R as z}from"./RoomDetailLoading-BtJm8J6a.js";import{I as _}from"./ImageGalleryMain-CMJYgzS9.js";import"./constants-DELhKX7a.js";const M={primary:"text-blue-400",danger:"text-red-400",success:"text-green-400",warning:"text-yellow-400",gray:"text-gray-400"},q={envelope:"fas fa-envelope",box:"fas fa-box-open",message:"fas fa-comment-dots",chat:"fas fa-comments",warning:"fas fa-exclamation-triangle"},G=({message:c,icon:r="box",customIconClass:v,color:h="gray"})=>{const p=`${r==="custom"?v||"fas fa-question-circle":q[r]||q.box} text-7xl mb-4 ${M[h]||M.gray}`;return e.jsxs("div",{className:"w-full flex flex-col justify-center items-center py-12 px-4 text-center",children:[e.jsx("i",{className:p}),e.jsx("p",{className:"text-lg text-gray-600",children:c})]})},T=({projectId:c,roomId:r,initialFiles:v,refetch:h})=>{const[i,p]=f.useState([]),[R,b]=f.useState(v.filter(t=>t.type==="pdf")),[y,x]=f.useState(v.filter(t=>t.type==="image")),[l,m]=f.useState(null),{mutateAsync:N,isPending:j}=U(),{mutateAsync:C,isPending:w}=V(),s=t=>{t.target.files&&p(Array.from(t.target.files))},u=async()=>{var o,a;if(i.length===0)return;const t=new FormData;i.forEach(n=>t.append("files",n));try{const n=await N({projectId:c,roomId:r,formData:t}),d=n.filter(S=>S.type==="pdf"),F=n.filter(S=>S.type==="image");b(S=>[...S,...d]),x(S=>[...S,...F]),p([]),k({title:"Success",description:"file uploaded successfully"}),window.location.reload(),h()}catch(n){k({title:"error",description:((a=(o=n==null?void 0:n.response)==null?void 0:o.data)==null?void 0:a.message)||"failed to upload file",variant:"destructive"})}},g=async(t,o)=>{var a,n;try{await C({projectId:c,roomId:r,fileId:t}),o==="pdf"?b(d=>d.filter(F=>F._id!==t)):x(d=>d.filter(F=>F._id!==t)),k({title:"Success",description:"deleted successfully"}),h()}catch(d){k({title:"error",description:((n=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:n.message)||"failed to upload file",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-blue-700",children:"Uploads"}),e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsx(P,{type:"file",multiple:!0,onChange:s,accept:"image/*,application/pdf"}),e.jsx(I,{onClick:u,isLoading:j,className:"bg-blue-600 text-white",children:"Upload"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 pt-4",children:[e.jsxs("div",{className:"p-2",children:[e.jsx("h4",{className:"font-semibold text-red-700 mb-2",children:"📄 PDF Files"}),e.jsxs("ul",{className:"space-y-2 max-h-[280px] h-[280px] rounded-lg shadow-lg p-2 overflow-y-auto custom-scrollbar-none",children:[R.length===0&&e.jsx("div",{className:"min-h-[180px] rounded-lg  flex items-center justify-center",children:e.jsx("p",{className:"text-sm text-gray-500",children:"No PDFs uploaded."})}),R.map(t=>e.jsxs("li",{className:"flex justify-between items-center bg-red-50 p-2 rounded-xl",children:[e.jsx("span",{className:"text-sm",children:t.originalName}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{size:"sm",variant:"primary",onClick:()=>A({src:t==null?void 0:t.url,alt:(t==null?void 0:t.originalName)||"file.pdf"}),children:e.jsx("i",{className:"fa-solid fa-download"})}),e.jsx(I,{onClick:()=>g(t._id,"pdf"),disabled:w,variant:"primary",size:"sm",children:e.jsx("i",{className:"fa-solid fa-trash"})})]})]},t._id))]})]}),e.jsxs("div",{className:"p-2",children:[e.jsx("h4",{className:"font-semibold text-green-700 mb-2",children:"🖼️ Image Files"}),e.jsx("section",{className:"space-y-2 max-h-[280px] h-[280px] shadow-lg rounded-lg p-2 overflow-y-auto custom-scrollbar",children:e.jsx(_,{imageFiles:y,handleDeleteFile:g,height:80,minWidth:98,maxWidth:100})})]})]}),l&&e.jsx("div",{onClick:()=>m(null),className:"fixed inset-0 bg-black/70 z-50 p-8 bg-opacity-60 flex items-center justify-center",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),className:"relative bg-white rounded py-8 px-4 max-w-[90vw] max-h-[80vh] shadow-lg",children:[e.jsx("i",{className:"fas fa-times absolute top-2 right-3 text-xl text-gray-700 hover:text-red-500 cursor-pointer",onClick:()=>m(null)}),e.jsx("img",{src:l,alt:"Full View",className:"max-h-[70vh] w-auto object-contain rounded"})]})})]})},E=({materialKey:c,fieldKey:r,setEditingKey:v,setFormData:h,value:i,originalData:p,onSave:R,formatDisplay:b})=>{const[y,x]=f.useState(!1),[l,m]=f.useState(""),[N,j]=f.useState(!1),C=()=>{h(a=>({...a,areaSqFt:p.areaSqFt,predefinedRate:p.predefinedRate,overriddenRate:p.overriddenRate??null,profitMargin:p.profitMargin??0})),m((i==null?void 0:i.toString())||""),v(c),x(!0)},w=()=>{x(!1),m("")},s=async()=>{if(!y)return;let a=l;if(r==="areaSqFt"||r==="predefinedRate"||r==="profitMargin"?a=parseFloat(l)||0:r==="overriddenRate"&&(a=l===""?null:parseFloat(l)||0),a===i){w();return}try{j(!0);const n={...p,[r]:a};x(!1),await R(c,n)}catch(n){console.error("Failed to save:",n)}finally{j(!1)}},u=a=>{a.key==="Enter"?s():a.key==="Escape"&&w()},g=a=>{m(a.target.value);const n=parseFloat(a.target.value)||0;h(d=>({...d,[r]:n}))},t=b?b(i):i??"N/A",o=a=>{const n=["overriddenRate","predefinedRate"],d=["profitMargin"],F="areaSqFt";if(t==="N/A")return t;if(F===r)return a;if(n.includes(r))return"₹"+a;if(d.includes(r))return a+"%"};return e.jsx("div",{className:`group relative border-none !border-b-1 px-4 py-2  cursor-pointer transition-all duration-200
    ${y?"bg-white  border-gray-300":"hover:bg-gray-50 hover:border-gray-300"}
  `,onClick:y?void 0:C,children:y?e.jsx("input",{className:"w-full text-left outline-none  bg-transparent focus:ring-0 appearance-none",value:l,onChange:g,onBlur:s,onKeyDown:u,autoFocus:!0,type:"number",disabled:N,placeholder:"Type and hit Enter..."}):e.jsx("span",{className:"inline-block w-full text-sm text-gray-700 group-hover:text-gray-900 transition-colors duration-200",children:N?e.jsx("i",{className:"fa fa-spinner fa-spin text-gray-400"}):e.jsx("p",{className:"font-medium text-center",children:o(t)})})})};function Q(){var C,w;const{projectId:c,roomId:r,organizationId:v}=D(),h=L();if(!c||!r)return null;const{data:i,isLoading:p,refetch:R}=$(c,r),{mutateAsync:b}=B(),[y,x]=f.useState(null),[l,m]=f.useState({areaSqFt:0,predefinedRate:0,overriddenRate:null,profitMargin:0}),N=f.useCallback(s=>s==null?"N/A":s==null?void 0:s.toLocaleString("en-IN"),[]);if(p)return e.jsx(z,{});if(!i)return e.jsx(G,{message:"Room not found",color:"primary",customIconClass:"box",icon:"custom"});const j=async(s,u)=>{var g,t;try{await b({projectId:c,materialKey:s,updates:{areaSqFt:u.areaSqFt,predefinedRate:u.predefinedRate,overriddenRate:u.overriddenRate,profitMargin:u.profitMargin},roomId:r}),x(null),k({description:"Field updated successfully",title:"Success"})}catch(o){throw k({title:"Error",description:((t=(g=o==null?void 0:o.response)==null?void 0:g.data)==null?void 0:t.message)||o.message||"Failed to update field",variant:"destructive"}),o}};return e.jsxs("div",{className:"max-w-full h-full overflow-y-scroll custom-scrollbar mx-auto mt-0 bg-white  rounded py-2 px-0",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:i.name}),e.jsx("p",{className:"text-gray-500 mb-6",children:"Room Material Items"})]}),e.jsx(I,{variant:"primary",className:"h-10",onClick:()=>h(`/${v}/projectdetails/${c}/costestimation`),children:"Go Back"})]}),e.jsxs("section",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("section",{children:e.jsx("div",{className:"mb-4 p-2 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-blue-900",children:"Total Material Cost:"}),e.jsxs("span",{className:"text-lg font-bold  text-blue-900",children:["₹",((C=i==null?void 0:i.totalCost)==null?void 0:C.toLocaleString())||"0"]})]})})}),e.jsx("div",{className:"w-full overflow-x-auto h-[95%]  custom-scrollbar",children:e.jsxs("div",{className:"min-w-[1000px]",children:[e.jsxs("div",{className:"grid grid-cols-6 bg-blue-50 text-sm font-semibold text-gray-600 px-6 py-1 sm:py-3 ",children:[e.jsx("div",{className:"text-left px-3 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Item"}),e.jsx("div",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Area Sq.Ft"}),e.jsx("div",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Base Rate"}),e.jsx("div",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Added Rate"}),e.jsx("div",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Profit Margin (%)"}),e.jsx("div",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Cost"})]}),e.jsx("div",{className:"divide-y divide-gray-100 max-h-[70vh] overflow-y-auto custom-scrollbar bg-white",children:(w=i==null?void 0:i.materials)==null?void 0:w.map(s=>{var u;return e.jsxs("div",{className:`grid grid-cols-6 items-center px-6 py-4 text-sm ${y===s.key?"":"hover:bg-[#f7fbff]"}`,children:[e.jsx("div",{className:"font-medium text-gray-800",children:s.key}),e.jsxs(e.Fragment,{children:[e.jsx(E,{setFormData:m,setEditingKey:x,materialKey:s.key,fieldKey:"areaSqFt",value:s.areaSqFt,originalData:s,onSave:j}),e.jsx(E,{setFormData:m,setEditingKey:x,materialKey:s.key,fieldKey:"predefinedRate",value:s.predefinedRate,originalData:s,onSave:j,formatDisplay:N}),e.jsx(E,{setEditingKey:x,materialKey:s.key,setFormData:m,fieldKey:"overriddenRate",value:s.overriddenRate,originalData:s,onSave:j,formatDisplay:N}),e.jsx(E,{setEditingKey:x,materialKey:s.key,setFormData:m,fieldKey:"profitMargin",value:s.profitMargin,originalData:s,onSave:j,formatDisplay:N}),y===s.key?e.jsx(e.Fragment,{children:e.jsx("div",{className:"text-center text-gray-900 font-semibold",children:(()=>{const g=l.predefinedRate||0,t=(l==null?void 0:l.overriddenRate)||0,o=(l==null?void 0:l.profitMargin)||0,a=o>0?g*o/100:0,n=g+t+a;return l.areaSqFt>0?"₹"+(l.areaSqFt*n).toLocaleString("en-IN"):"N/A"})()})}):e.jsxs("div",{className:"text-center text-black font-semibold",children:["₹",((u=s==null?void 0:s.totalCost)==null?void 0:u.toLocaleString("en-IN"))??"N/A"]})]})]},s.key)})})]})})]}),e.jsx("section",{className:"mt-4",children:e.jsx(T,{projectId:c,roomId:r,initialFiles:i.uploads,refetch:R})})]})}export{Q as default};
