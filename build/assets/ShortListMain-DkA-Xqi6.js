import{j as e,r as y,q as z,E as Y,F as Q,G as V,H as T,M as O,C as se,a as ae,B as I,t as D,u as le,d as ne}from"./index-CKvTvGhg.js";import{N as U}from"./constants-CP15s2Qq.js";import{d as H}from"./downloadFile-DlgctQJj.js";import{r as re}from"./index-Dk9WZZUH.js";import{u as ie}from"./shortlistReferenceDesignApi-CCRlTgt9.js";function oe({images:s,onDelete:n,onDownload:a,isDeleting:r=!1,refetch:i,className:k="",minWidth:E=100,maxWidth:j=100,heightClass:R=0,showSelectButton:b,onToggleSelect:v,isSelected:o,onImageClick:d,portalId:w,controlledType:g,activePopupType:p,setActivePopupType:L,selectedSiteImage:u,showSiteSelectButton:S,onSiteImageConfirm:$,onPopupOpenChange:P}){const[f,C]=y.useState(null),[F,G]=y.useState(!1),[M,A]=y.useState({}),l=(t,N,W)=>{const q=W/N,ee=Math.max(150,Math.min(400,200*q));A(te=>({...te,[t]:ee}))},x=t=>{C(t),G(!0),P==null||P(!0)},c=()=>{G(!1),C(null),P==null||P(!1)},m=()=>{f!==null&&C((f-1+s.length)%s.length)},_=()=>{f!==null&&C((f+1)%s.length)};y.useEffect(()=>{if(!F||g!==p)return;const t=N=>{N.key==="Escape"?c():N.key==="ArrowRight"?_():N.key==="ArrowLeft"&&m()};return F&&(document.addEventListener("keydown",t),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",t),document.body.style.overflow="unset"}},[F,_,m,c]);const J=async t=>{if(n)try{await n(t),i&&await i(),s.length<=1?c():f!==null&&f>=s.length-1&&C(Math.max(0,s.length-2))}catch(N){console.error("Error deleting image:",N)}},X=t=>{a({src:t==null?void 0:t.url,alt:(t==null?void 0:t.originalName)||"image"})},Z=()=>{c()},h=f!==null&&f>=0&&f<s.length?s[f]:null;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`gap-1 flex flex-wrap ${k}`,children:s.map((t,N)=>{const W=M[t._id]||200;return e.jsx(e.Fragment,{children:e.jsx("div",{className:"relative cursor-pointer bg-gray-100  mb-1 break-inside-avoid ",style:{flex:`0 1 ${E}px`,minWidth:`${E}px`,maxWidth:`${j}px`,height:`${R||W}px`},onClick:()=>{x(N),d==null||d(t),L("reference")},children:e.jsx("img",{src:(t==null?void 0:t.url)||U,alt:(t==null?void 0:t.originalName)||`Image ${N+1}`,className:"w-full cursor-pointer h-full object-cover",loading:"lazy",onLoad:q=>{const B=q.target;l(t._id,B.naturalWidth,B.naturalHeight)}})},t._id)})})}),F&&h&&re.createPortal(e.jsxs("div",{className:"absolute inset-0 bg-black/90 text-white p-4 z-50 flex items-center justify-center",onClick:Z,style:{margin:0,padding:0,zIndex:1e3},children:[e.jsxs("div",{className:"absolute top-6 right-6 z-[10000] flex items-center gap-4",children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),X(h)},className:"bg-black/50 hover:bg-black/70 text-white rounded-full p-3 transition-all duration-200",title:"Download",children:e.jsx("i",{className:"fas fa-download text-lg"})}),n&&e.jsx("button",{onClick:t=>{t.stopPropagation(),J(h._id)},className:"bg-black/50 hover:bg-red-600/70 text-white rounded-full p-3 transition-all duration-200",title:"Delete",disabled:r,children:e.jsx("i",{className:`fas ${r?"fa-spinner fa-spin":"fa-trash-can"} text-lg`})}),b&&v&&h&&e.jsx("button",{onClick:t=>{t.stopPropagation();const N=(o==null?void 0:o(h))??!1;v(h,!N)},className:`bg-${o!=null&&o(h)?"red":"green"}-600 hover:bg-${o!=null&&o(h)?"red":"green"}-700 text-white rounded-full p-3 transition-all duration-200`,title:o!=null&&o(h)?"Unselect this image":"Select this image",children:e.jsx("i",{className:`fas ${o!=null&&o(h)?"fa-xmark":"fa-check"} text-lg`})}),S&&e.jsx("button",{onClick:t=>$==null?void 0:$(t,h),className:`${(u==null?void 0:u._id)===h._id?"bg-red-600 hover:bg-red-700":"bg-blue-600 hover:bg-blue-700"} text-white rounded-full p-3 transition-all duration-200`,title:(u==null?void 0:u._id)===h._id?"Unselect this site image":"Select this site image",children:e.jsx("i",{className:`fas ${(u==null?void 0:u._id)===h._id?"fa-xmark":"fa-check"} text-lg`})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),c()},className:"bg-black/50 hover:bg-black/70 text-white rounded-full p-3 transition-all duration-200",title:"Close",children:e.jsx("i",{className:"fas fa-times text-xl"})})]}),e.jsx("button",{onClick:t=>{t.stopPropagation(),m()},className:"absolute left-6 top-1/2 transform -translate-y-1/2 z-[10000] bg-black/50 hover:bg-black/70 text-white rounded-full p-3 transition-all duration-200",children:e.jsx("i",{className:"fas fa-chevron-left text-2xl"})}),e.jsx("button",{onClick:t=>{t.stopPropagation(),_()},className:"absolute right-6 top-1/2 transform -translate-y-1/2 z-[10000] bg-black/50 hover:bg-black/70 text-white rounded-full p-3 transition-all duration-200",children:e.jsx("i",{className:"fas fa-chevron-right text-2xl"})}),e.jsx("div",{className:"relative flex items-center justify-center",style:{width:"70vw",height:"70vh",maxWidth:"70vw",maxHeight:"70vh"},onClick:t=>{t.stopPropagation(),L(g)},children:e.jsx("img",{src:(h==null?void 0:h.url)||U,alt:h.originalName||`Image ${f!==null?f+1:1}`,className:"max-w-full max-h-full object-contain"})}),e.jsxs("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white text-sm bg-black/50 px-4 py-2 rounded-full",children:[f!==null?f+1:1," of ",s.length]})]}),document.getElementById(w))]})}function K({imageFiles:s=[],height:n,refetch:a,handleDeleteFile:r,className:i="",minWidth:k,maxWidth:E,isSelected:j,onToggleSelect:R,showSelectButton:b,onImageClick:v,portalId:o,setActivePopupType:d,activePopupType:w,controlledType:g,showSiteSelectButton:p,onSiteImageConfirm:L,selecteSiteImage:u,onPopupOpenChange:S}){return e.jsx(e.Fragment,{children:e.jsx(oe,{images:s,onDelete:r,onDownload:H,refetch:a,isDeleting:!1,className:i,heightClass:n,minWidth:k,maxWidth:E,showSelectButton:b,onToggleSelect:R,isSelected:j,onImageClick:v,portalId:o,setActivePopupType:d,activePopupType:w,controlledType:g,selectedSiteImage:u,showSiteSelectButton:p,onSiteImageConfirm:L,onPopupOpenChange:S})})}const ce=async({projectId:s,api:n})=>{const{data:a}=await n.get(`/shortlisteddesign/getshortlisteddesigns/${s}`);if(!a.ok)throw new Error(a.message);return a.data},de=async({projectId:s,selections:n,api:a})=>{const{data:r}=await a.post(`/shortlisteddesign/upload/${s}`,{selections:n});if(!r.ok)throw new Error(r.message);return r.data},xe=async({projectId:s,api:n})=>{const{data:a}=await n.get(`/shortlisteddesign/getsiteimages/${s}`);if(!a.ok)throw new Error(a.message);return a.data},me=async(s,n)=>{const{data:a}=await n.delete(`/shortlisteddesign/deletepdf/${s}`);if(!a.ok)throw new Error(a.message);return a.data},he=s=>{const n=["owner","staff","CTO"],{role:a}=z(),r=T(a);return Y({queryKey:["shortlistedDesigns",s],queryFn:async()=>{if(!a||!n.includes(a))throw new Error("Not authorized");if(!r)throw new Error("API instance missing");return await ce({projectId:s,api:r})},enabled:!!s&&!!a})},ue=()=>{const s=["owner","staff","CTO"],{role:n}=z(),a=T(n);return Q({mutationFn:async({projectId:r,selections:i})=>{if(!n||!s.includes(n))throw new Error("Not authorized");if(!a)throw new Error("API instance missing");return await de({projectId:r,selections:i,api:a})},onSuccess:(r,{projectId:i})=>{V.invalidateQueries({queryKey:["shortlistedDesigns",i]})}})},fe=()=>{const s=["owner","staff","CTO"],{role:n}=z(),a=T(n);return Q({mutationFn:async({id:r})=>{if(!n||!s.includes(n))throw new Error("Youre not allowed to delete pdf");if(!a)throw new Error("API instance not available");return await me(r,a)},onSuccess:(r,{projectId:i})=>{V.invalidateQueries({queryKey:["shortlistedDesigns",i]})}})},ge=s=>{const n=["owner","staff","CTO"],{role:a}=z(),r=T(a);return Y({queryKey:["siteImages",s],queryFn:async()=>{if(!a||!n.includes(a))throw new Error("Not authorized");if(!r)throw new Error("API instance missing");return await xe({projectId:s,api:r})},enabled:!!s&&!!a})},be=({projectId:s})=>{var R,b,v,o;const{data:n,isLoading:a,isError:r,error:i}=he(s),{mutateAsync:k,isPending:E}=fe(),j=async d=>{var w,g;try{await k({id:d,projectId:s}),D({title:"Success",description:"PDF deleted"})}catch(p){D({variant:"destructive",title:"Error",description:((g=(w=p==null?void 0:p.response)==null?void 0:w.data)==null?void 0:g.message)||(p==null?void 0:p.message)||"failed to delete"})}};return a?e.jsx("div",{className:"max-h-50 overflow-y-auto w-full",children:e.jsx(O,{})}):(r&&((b=(R=i==null?void 0:i.response)==null?void 0:R.data)!=null&&b.message||i!=null&&i.message&&((o=(v=i==null?void 0:i.response)==null?void 0:v.data)!=null&&o.message||i!=null&&i.message)),e.jsxs("div",{className:"max-w-full px-4 mx-auto py-2",children:[e.jsx("header",{className:"flex gap-2 items-center justify-between",children:e.jsx("div",{className:"flex gap-2",children:e.jsx("div",{children:e.jsx("h1",{className:"text-xl md:text-3xl font-bold text-gray-900 mb-1",children:"Shortlisted Pdf's"})})})}),e.jsx("section",{className:"gap-4 flex flex-col",children:(n==null?void 0:n.length)>0?n==null?void 0:n.map(d=>{var w;return e.jsx(se,{className:"border-green-200 bg-green-50",children:e.jsx(ae,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-check-circle text-green-600"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-green-900 mb-1",children:(w=d==null?void 0:d.pdfLink)==null?void 0:w.originalName}),e.jsx("p",{className:"text-sm text-green-700",children:"Your Design PDF is ready to view or download"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs(I,{variant:"outline",onClick:()=>{var g;return window.open((g=d==null?void 0:d.pdfLink)==null?void 0:g.url,"_blank")},className:"border-green-300 text-blue-700 hover:bg-blue-100 hover:border-blue-400",children:[e.jsx("i",{className:"fas mr-2 fa-external-link-alt"}),"View in New Tab"]}),e.jsx(I,{variant:"secondary",onClick:()=>{var g;return H({src:(g=d==null?void 0:d.pdfLink)==null?void 0:g.url,alt:"Shortlisted designs"})},className:"border-blue-300 text-blue-700 hover:bg-blue-100 hover:border-blue-400",children:"Download PDF"}),e.jsx(I,{variant:"danger",isLoading:E,onClick:()=>j(d._id),className:"border-red-300 bg-red-600 text-white hover:bg-red-600 hover:border-red-400",children:"Delete PDF"})]})]})})},d._id)}):e.jsxs("div",{className:"flex flex-col items-center  justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fa-solid fa-file-lines text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Pdf Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No PDF Generated"})]})})]}))};function ye(){var A;const{projectId:s,organizationId:n}=le(),[a,r]=y.useState(null),i=ne(),{data:k=[],isLoading:E}=ge(s),{data:j,isLoading:R}=ie({organizationId:n}),[b,v]=y.useState(null),[o,d]=y.useState([]),[w,g]=y.useState(!1),[p,L]=y.useState(!1),[u,S]=y.useState([]),{mutateAsync:$,isPending:P}=ue();y.useEffect(()=>{const l=w||p;return document.body.style.overflow=l?"hidden":"unset",()=>{document.body.style.overflow="unset"}},[w,p]);const f=(l,x)=>{l.stopPropagation(),v(c=>(c==null?void 0:c._id)===x._id?(D({title:"Success",description:"Unselected, You can now select another one."}),null):(D({title:"Success",description:"Site Image selected"}),x))},C=(l,x)=>{if(!b){D({title:"Error",description:"Please select a Site Image first",variant:"destructive"});return}d(c=>{const m=c.some(_=>_._id===l._id);return x&&!m?[...c,l]:x?c:c.filter(_=>_._id!==l._id)})},F=(l,x)=>{S(c=>c.map(m=>m.siteImage._id===l?{...m,referenceImages:m.referenceImages.filter(_=>_._id!==x)}:m).filter(m=>m.referenceImages.length>0))},G=l=>{S(x=>x.filter(c=>c.siteImage._id!==l))},M=async()=>{if(u.length===0){D({title:"Error",description:"No selections to generate",variant:"destructive"});return}try{const l=await $({projectId:s,selections:u});H({src:l.url,alt:l.fileName}),D({title:"Sucess",description:"Designs Generated Successfully!"})}catch(l){D({title:"Error",description:l==null?void 0:l.message,variant:"destructive"})}};return e.jsxs("div",{className:"max-w-full overflow-y-auto max-h-full px-4 mx-auto py-2",children:[e.jsxs("header",{className:"flex gap-2 items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{onClick:()=>i(-1),className:"flex bg-gray-200 h-fit rounded-full items-center gap-2 backdrop-blur-sm px-4 py-2 cursor-pointer",children:[e.jsx("i",{className:"fas fa-arrow-left text-sm"}),e.jsx("span",{className:"text-sm hidden sm:inline-block font-medium",children:"Back"})]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-3xl font-bold text-gray-900 mb-1",children:"Shortlisting Reference Designs"}),e.jsx("p",{className:"text-gray-600 hidden sm:inline-block text-sm md:text-md",children:"Select and organize your favorite design references for easy access"})]})]}),(b||o.length>0)&&e.jsx("button",{className:"mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg cursor-pointer",onClick:()=>{if(!b||o.length===0){D({title:"Error",description:"Select site image & at least 1 reference",variant:"destructive"});return}S(l=>[...l.filter(c=>c.siteImage._id!==b._id),{siteImage:b,referenceImages:o}]),v(null),d([])},children:"Confirm Selection"})]}),e.jsx("hr",{className:"my-3 bg-gray-500"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8 border-gray-300 border-2 rounded-2xl p-2",children:[e.jsxs("div",{className:"border-r-1 border-gray-300 pr-8",children:[e.jsx("h2",{className:"font-semibold text-lg mb-2",children:"Reference Designs"}),e.jsx("div",{className:"my-3 w-full h-[1px] bg-gray-200"}),R?e.jsx("div",{children:e.jsx(O,{})}):e.jsx("div",{className:"relative  h-[80vh]",id:"reference-popup-container",children:((A=j==null?void 0:j.referenceImages)==null?void 0:A.length)>0?e.jsx(K,{imageFiles:(j==null?void 0:j.referenceImages)||[],portalId:"reference-popup-container",height:190,refetch:()=>Promise.resolve(),minWidth:140,maxWidth:190,handleDeleteFile:void 0,showSelectButton:!0,setActivePopupType:r,activePopupType:a,controlledType:"reference",onToggleSelect:(l,x)=>C(l,x),isSelected:l=>o.some(x=>x._id===l._id),onPopupOpenChange:L,className:"overflow-y-auto max-h-[550px] "}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white   text-center p-6",children:[e.jsx("i",{className:"fas fa-box-open text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Reference Images Available"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Upload the Images in the ",e.jsx("span",{className:"cursor-pointer font-semibold text-blue-600",onClick:()=>i(`/organizations/${n}/projects/shortlistdesign`),children:"Reference Design"})," section",e.jsx("br",{}),"Select multiple Reference images",e.jsx("br",{}),"after selecting ",e.jsx("strong",{children:'"Confirm Selection"'})," to add images 🚀"]})]})})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-lg mb-2",children:"Site Images"}),e.jsx("div",{className:"my-3 w-full h-[1px] bg-gray-200"}),E?e.jsx("div",{children:e.jsx(O,{})}):e.jsx("div",{className:"relative  h-[80vh]",id:"site-popup-container",children:(k==null?void 0:k.length)>0?e.jsx(K,{portalId:"site-popup-container",imageFiles:k,height:190,refetch:()=>Promise.resolve(),minWidth:140,maxWidth:190,setActivePopupType:r,activePopupType:a,controlledType:"site",showSiteSelectButton:!0,onSiteImageConfirm:f,selecteSiteImage:b,onImageClick:l=>{v(l),r("site")},onPopupOpenChange:g,className:"overflow-y-auto max-h-[550px] "}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white   text-center p-6",children:[e.jsx("i",{className:"fas fa-box-open text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Site Images Available"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Upload the Images in the Site Measurement Stage",e.jsx("br",{}),"Select multiple Reference images for single Site Image ",e.jsx("br",{}),"after selection ",e.jsx("strong",{children:'"Confirm Selection"'})," to add images 🚀"]})]})})]})]}),u.length>0?e.jsxs("div",{className:"mt-10 space-y-8",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"font-bold text-xl mb-4",children:"Selected Designs"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{isLoading:P,onClick:M,className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow disabled:opacity-50",children:P?"Generating...":"Generate Pdf"}),e.jsx(I,{onClick:()=>{S([])},variant:"danger",className:"bg-red-600  text-white px-6 py-2 rounded shadow disabled:opacity-50",children:"Clear List"})]})]}),u.map(({siteImage:l,referenceImages:x},c)=>e.jsxs("div",{className:"p-4 py-6 border border-gray-300 rounded-lg bg-white shadow-md",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{className:"",children:[e.jsxs("h2",{className:"text-base font-semibold text-gray-700 min-w-[110px]",children:["Site Image ",c+1]}),e.jsx("br",{}),e.jsx("img",{src:l==null?void 0:l.url,alt:l.originalName||`Site ${c+1}`,className:"h-28 w-auto object-contain border rounded-md"})]}),e.jsxs(I,{variant:"danger",onClick:()=>G(l._id),className:"text-white bg-red-600 text-sm whitespace-nowrap",children:[e.jsx("i",{className:"fas fa-trash !mr-2 "}),"Remove Site + References"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 flex-col",children:[e.jsx("h2",{className:"text-base font-semibold text-gray-700 min-w-[110px]",children:"Referece Images"}),e.jsx("div",{className:"flex flex-wrap gap-4 ",children:x.map(m=>e.jsxs("div",{className:"relative  w-[120px] h-[120px] ",children:[e.jsx("img",{src:m.url,alt:m.originalName,className:"w-full h-full object-cover rounded  shadow-sm"}),e.jsx("button",{onClick:()=>F(l._id,m._id),className:"absolute top-1 right-1 bg-red-600 text-white p-1 px-2 text-xs rounded-full",children:"✕"}),e.jsx("p",{className:"text-xs mt-1 text-center max-w-[120px] truncate",children:m.originalName})]},m._id))})]})]},l._id))]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-xl font-semibold text-black-800 my-3",children:"Youre Selections will appear below"}),e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl shadow-xl border border-gray-100  text-center p-6",children:[e.jsx("i",{className:"fas fa-box-open text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Selections Created"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Your Selection will appear here.",e.jsx("br",{}),"Select multiple Reference images for single Site Image ",e.jsx("br",{}),"after selection ",e.jsx("strong",{children:'"Confirm Selection"'})," to add images 🚀"]})]})]}),e.jsx("section",{className:"mt-6",children:e.jsx(be,{projectId:s})})]})}export{ye as default};
