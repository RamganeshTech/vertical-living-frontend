var te=o=>{throw TypeError(o)};var V=(o,t,n)=>t.has(o)||te("Cannot "+n);var m=(o,t,n)=>(V(o,t,"read from private field"),n?n.call(o):t.get(o)),R=(o,t,n)=>t.has(o)?te("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(o):t.set(o,n),j=(o,t,n,r)=>(V(o,t,"write to private field"),r?r.call(o,n):t.set(o,n),n),T=(o,t,n)=>(V(o,t,"access private method"),n);import{S as ye,n as J,r as Ne,u as we,a as y,b as Se,j as e,c as Ce,d as Re,e as Te}from"./index-ftjmZ4WH.js";import{u as Oe,g as Ee,a as ke}from"./staffTaskApi-Bwrp31mW.js";import{u as Qe}from"./projectApi-DV972SNS.js";import{u as Ae}from"./getAllUsersApi-DNZ8rMMS.js";import{S as re}from"./SearchSelectNew-DpNEUat6.js";import{I as K}from"./Input-sieJTkC7.js";import{L as O}from"./Label-De7Bg4nO.js";import{B as _}from"./Button-BhpUbe89.js";import{T as De}from"./TextArea-CJKjua8R.js";import{t as ae}from"./toast-BSC5QTk1.js";import{Q as ue,u as Ie,a as Pe,e as Me,b as qe,c as Fe,s as ne,f as ie,w as _e,g as Le}from"./useQuery-DmDT-v30.js";import{g as Be}from"./roleCheck-BuedAs3v.js";import{d as $e,f as ze,a as le}from"./dateFormator-B0AlGPNQ.js";import"./useMutation-CSGCjuCw.js";function oe(o,t){const n=new Set(t);return o.filter(r=>!n.has(r))}function He(o,t,n){const r=o.slice(0);return r[t]=n,r}var P,w,M,q,S,Q,L,B,$,b,X,Y,Z,W,ee,ce,Ge=(ce=class extends ye{constructor(t,n,r){super();R(this,b);R(this,P);R(this,w);R(this,M);R(this,q);R(this,S);R(this,Q);R(this,L);R(this,B);R(this,$,[]);j(this,P,t),j(this,q,r),j(this,M,[]),j(this,S,[]),j(this,w,[]),this.setQueries(n)}onSubscribe(){this.listeners.size===1&&m(this,S).forEach(t=>{t.subscribe(n=>{T(this,b,W).call(this,t,n)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,m(this,S).forEach(t=>{t.destroy()})}setQueries(t,n){j(this,M,t),j(this,q,n),J.batch(()=>{const r=m(this,S),d=T(this,b,Z).call(this,m(this,M));j(this,$,d),d.forEach(c=>c.observer.setOptions(c.defaultedQueryOptions));const l=d.map(c=>c.observer),f=l.map(c=>c.getCurrentResult()),i=l.some((c,g)=>c!==r[g]);r.length===l.length&&!i||(j(this,S,l),j(this,w,f),this.hasListeners()&&(oe(r,l).forEach(c=>{c.destroy()}),oe(l,r).forEach(c=>{c.subscribe(g=>{T(this,b,W).call(this,c,g)})}),T(this,b,ee).call(this)))})}getCurrentResult(){return m(this,w)}getQueries(){return m(this,S).map(t=>t.getCurrentQuery())}getObservers(){return m(this,S)}getOptimisticResult(t,n){const r=T(this,b,Z).call(this,t),d=r.map(l=>l.observer.getOptimisticResult(l.defaultedQueryOptions));return[d,l=>T(this,b,Y).call(this,l??d,n),()=>T(this,b,X).call(this,d,r)]}},P=new WeakMap,w=new WeakMap,M=new WeakMap,q=new WeakMap,S=new WeakMap,Q=new WeakMap,L=new WeakMap,B=new WeakMap,$=new WeakMap,b=new WeakSet,X=function(t,n){return n.map((r,d)=>{const l=t[d];return r.defaultedQueryOptions.notifyOnChangeProps?l:r.observer.trackResult(l,f=>{n.forEach(i=>{i.observer.trackProp(f)})})})},Y=function(t,n){return n?((!m(this,Q)||m(this,w)!==m(this,B)||n!==m(this,L))&&(j(this,L,n),j(this,B,m(this,w)),j(this,Q,Ne(m(this,Q),n(t)))),m(this,Q)):t},Z=function(t){const n=new Map(m(this,S).map(d=>[d.options.queryHash,d])),r=[];return t.forEach(d=>{const l=m(this,P).defaultQueryOptions(d),f=n.get(l.queryHash);f?r.push({defaultedQueryOptions:l,observer:f}):r.push({defaultedQueryOptions:l,observer:new ue(m(this,P),l)})}),r},W=function(t,n){const r=m(this,S).indexOf(t);r!==-1&&(j(this,w,He(m(this,w),r,n)),T(this,b,ee).call(this))},ee=function(){var t;if(this.hasListeners()){const n=m(this,Q),r=T(this,b,X).call(this,m(this,w),m(this,$)),d=T(this,b,Y).call(this,r,(t=m(this,q))==null?void 0:t.combine);n!==d&&J.batch(()=>{this.listeners.forEach(l=>{l(m(this,w))})})}},ce);function Ue({queries:o,...t},n){const r=we(),d=Ie(),l=Pe(),f=y.useMemo(()=>o.map(x=>{const C=r.defaultQueryOptions(x);return C._optimisticResults=d?"isRestoring":"optimistic",C}),[o,r,d]);f.forEach(x=>{Me(x),qe(x,l)}),Fe(l);const[i]=y.useState(()=>new Ge(r,f,t)),[c,g,k]=i.getOptimisticResult(f,t.combine),z=!d&&t.subscribed!==!1;y.useSyncExternalStore(y.useCallback(x=>z?i.subscribe(J.batchCalls(x)):Se,[i,z]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),y.useEffect(()=>{i.setQueries(f,t)},[f,t,i]);const A=c.some((x,C)=>ne(f[C],x))?c.flatMap((x,C)=>{const N=f[C];if(N){const H=new ue(r,N);if(ne(N,x))return ie(N,H,l);_e(x,d)&&ie(N,H,l)}return[]}):[];if(A.length>0)throw Promise.all(A);const I=c.find((x,C)=>{const N=f[C];return N&&Le({result:x,errorResetBoundary:l,throwOnError:N.throwOnError,query:r.getQueryCache().get(N.queryHash),suspense:N.suspense})});if(I!=null&&I.error)throw I.error;return g(k())}const Ve=({allTasks:o,selected:t,onChange:n})=>{const[r,d]=y.useState(""),l=y.useMemo(()=>{const i=r.trim().toLowerCase();return o.filter(c=>(c==null?void 0:c.status)!=="done").filter(c=>{var g;return r?(g=c==null?void 0:c.title)==null?void 0:g.toLowerCase().includes(i):!0})},[o,r]),f=i=>{const g=t.includes(i)?t.filter(k=>k!==i):[...t,i];n(g)};return e.jsxs("div",{className:"col-span-full mt-4",children:[e.jsx(O,{htmlFor:"searchDependencies",children:"Search Tasks"}),e.jsx("input",{id:"searchDependencies",placeholder:"Search by title...",value:r,onChange:i=>d(i.target.value),className:"mt-2 mb-3 w-full border border-gray-300 px-3 py-2 rounded-md focus:ring focus:ring-blue-400 outline-none"}),(l==null?void 0:l.length)===0&&e.jsx("div",{className:"text-gray-500 mt-2",children:"No matching tasks found."}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mt-2",children:l.map(i=>{var g;const c=t.includes(i._id);return e.jsx("div",{className:`border rounded-lg p-3 cursor-pointer transition-all ${c?"bg-blue-100 border-blue-400":"bg-white hover:bg-gray-50"}`,onClick:()=>f(i._id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox text-blue-600",checked:c,onChange:()=>f(i._id),onClick:k=>k.stopPropagation()}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-blue-900",children:i.title||"N/A"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Assigned to: ",((g=i==null?void 0:i.assigneeId)==null?void 0:g.staffName)||"Unassigned"]}),(i==null?void 0:i.due)&&e.jsxs("p",{className:"text-sm text-blue-700",children:["Due: ",$e(i.due)," - ",ze(i.due)]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Status: ",(i==null?void 0:i.status)||"N/A"]})]})]})},i._id)})})]})},Ke=["owner","staff","CTO"];function ds(o,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>o(...r),t)}}const hs=()=>{const{organizationId:o}=Ce(),[t,n]=y.useState(!1),[r,d]=y.useState([{title:"",description:"",due:le(new Date),priority:"medium",department:"site",assigneeId:"",assigneeName:"",projectId:"",projectName:"",organizationId:o,status:"queued",tasks:[{taskName:""}]}]),{role:l}=Re(),f=Be(l),{data:i}=Oe(o),[c,g]=y.useState(()=>r.map(()=>"")),k=Ue({queries:(c??[]).map(s=>({queryKey:["suggested-subtasks",s],queryFn:async()=>{if(!s||s.length<=3)return[];if(!l||!Ke.includes(l))throw new Error("Not allowed");if(!f)throw new Error("Not Authenticated");return await Ee({title:s,api:f})},enabled:!!s&&s.length>3&&!!l}))});y.useEffect(()=>{(c==null?void 0:c.length)!==(r==null?void 0:r.length)&&g(r.map(s=>s.title||""))},[r.length]),y.useEffect(()=>{k.forEach((s,a)=>{var v,D,se;const{data:u,isSuccess:p}=s,h=r[a];if(p&&(u==null?void 0:u.length)>0&&((D=(v=h==null?void 0:h.title)==null?void 0:v.trim())==null?void 0:D.length)>3&&h.tasks.length===1&&((se=h.tasks[0])==null?void 0:se.taskName.trim())===""){const G=[...r];G[a].tasks.map(U=>U.taskName).join(",")===u.join(",")||(G[a].tasks=u.map(U=>({taskName:U})),d(G))}})},[k.map(s=>s.data).join("|")]);const z=Te(),{data:F}=Qe(o),{data:A}=Ae(o,"staff"),I=(A||[]).map(s=>({value:s._id,label:s.staffName,email:s.email})),x=(F||[]).map(s=>({value:s._id,label:s.projectName})),C=y.useRef([]),N=(s,a)=>{clearTimeout(C.current[s]),C.current[s]=setTimeout(()=>{g(u=>{const p=[...u];return p[s]=a,p})},800)},{mutateAsync:H,isPending:de}=ke(),he=()=>{d(s=>{const a=[...s,{title:"",description:"",due:le(new Date),priority:"medium",department:"site",assigneeId:"",assigneeName:"",projectId:"",projectName:"",organizationId:o,status:"queued",tasks:[{taskName:""}]}];return g(a.map(u=>u.title||"")),a})},me=s=>{d(a=>a.filter((u,p)=>p!==s))},E=(s,a)=>{const u=[...r];u[s]={...u[s],...a},d(u)},pe=(s,a)=>{const u=A==null?void 0:A.find(p=>p._id===a);E(s,{assigneeId:a||"",assigneeName:(u==null?void 0:u.staffName)||""})},fe=(s,a)=>{E(s,{dependentTaskId:a.length>0?a:void 0})},ge=(s,a)=>{const u=F==null?void 0:F.find(p=>p._id===a);E(s,{projectId:a||"",projectName:(u==null?void 0:u.projectName)||""})},be=(s,a,u)=>{const p=[...r];p[s].tasks[a].taskName=u,d(p)},xe=s=>{const a=[...r];a[s].tasks.push({taskName:""}),d(a)},je=(s,a)=>{const u=[...r];u[s].tasks.splice(a,1),d(u)},ve=async()=>{var a,u;const s=r.map(p=>{const h=p.tasks.filter(v=>{var D;return(D=v.taskName)==null?void 0:D.trim()}).map(v=>({taskName:v.taskName.trim()}));return{...p,tasks:h.length>0?h:[]}});try{await H({assigneRole:"staff",tasks:s}),ae({description:"Task Created Successfully",title:"Success"})}catch(p){ae({title:"Error",description:((u=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:u.message)||"Failed to update completion status",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6 text-blue-900 overflow-y-auto max-h-full",children:[e.jsxs("header",{className:"flex justify-between items-center w-full  sticky top-0 bg-white pb-5  border-b-1 border-gray-300 ",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{onClick:()=>z(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("h2",{className:"text-3xl font-bold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-dolly mr-3 text-blue-600"}),"Assign Staff Tasks"]})]}),e.jsxs("div",{className:"flex  gap-4",children:[e.jsxs(_,{type:"button",onClick:he,variant:"secondary",className:"",children:[e.jsx("i",{className:"fa fa-plus mr-1"})," Add More Task"]}),e.jsxs(_,{type:"button",onClick:ve,className:"bg-blue-600 text-white hover:bg-blue-700",disabled:de,children:[e.jsx("i",{className:"fa fa-paper-plane mr-1"})," Submit All Tasks"]})]})]}),r.map((s,a)=>{var u,p;return e.jsxs("div",{className:"bg-white border rounded-xl shadow-md p-6 space-y-4",children:[e.jsxs("section",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold text-blue-800",children:["Task #",a+1]}),e.jsxs(_,{onClick:()=>me(a),variant:"danger",className:"text-white bg-red-500 ",children:[e.jsx("i",{className:"fas fa-trash-alt mr-1"})," Remove Task"]})]}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(O,{htmlFor:`title-${a}`,children:"Task Title"}),e.jsx(K,{id:`title-${a}`,placeholder:"Enter task title",value:s.title,onChange:h=>{const v=h.target.value;E(a,{title:v}),N(a,v)}})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:`due-${a}`,children:"Due Date"}),e.jsx(K,{id:`due-${a}`,type:"datetime-local",value:s.due,onChange:h=>E(a,{due:h.target.value})})]}),e.jsxs("div",{children:[e.jsx(O,{children:"Select Assignee"}),e.jsx(re,{options:I,placeholder:"Select assignee",searchPlaceholder:"Search by name...",value:s.assigneeId||void 0,onValueChange:h=>pe(a,h),searchBy:"name",displayFormat:"detailed",className:"w-full"}),(s==null?void 0:s.assigneeName)&&e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Assignee: ",s==null?void 0:s.assigneeName]})]}),e.jsxs("div",{children:[e.jsx(O,{children:"Select Project"}),e.jsx(re,{options:x,placeholder:"Select project",searchPlaceholder:"Search projects...",value:s.projectId||void 0,onValueChange:h=>ge(a,h),searchBy:"name",displayFormat:"simple",className:"w-full"}),s.projectName&&e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Project: ",s.projectName]})]}),e.jsxs("div",{children:[e.jsx(O,{children:"Priority"}),e.jsxs("select",{value:s.priority,onChange:h=>E(a,{priority:h.target.value}),className:"w-full border border-blue-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"})]})]}),e.jsxs("div",{children:[e.jsx(O,{children:"Department"}),e.jsxs("select",{value:s.department,onChange:h=>E(a,{department:h.target.value}),className:"w-full border border-blue-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600",children:[e.jsx("option",{value:"site",children:"Site"}),e.jsx("option",{value:"procurement",children:"Procurement"}),e.jsx("option",{value:"design",children:"Design"}),e.jsx("option",{value:"accounts",children:"Accounts"})]})]}),e.jsxs("div",{children:[e.jsx(O,{children:"Status"}),e.jsxs("select",{value:s.status,onChange:h=>E(a,{status:h.target.value}),className:"w-full border border-blue-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600",children:[e.jsx("option",{value:"queued",children:"Queued"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"done",children:"Done"})]})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx(O,{children:"Description"}),e.jsx(De,{rows:3,placeholder:"Enter task description",value:s.description,onChange:h=>E(a,{description:h.target.value}),className:"resize-none w-full"})]}),e.jsx("div",{className:"col-span-full",children:e.jsxs("label",{className:"flex gap-2 items-center mt-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:t,onChange:()=>{n(h=>!h)}}),e.jsx("span",{children:"Enable Task Dependencies (Select required tasks to be completed first)"})]})}),t&&e.jsx(Ve,{allTasks:i,selected:s.dependentTaskId||[],onChange:h=>fe(a,h)})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx(O,{className:"text-[12px] text-gray-800",children:"Subtasks"}),e.jsx(O,{className:"text-[12px] text-gray-300",children:" (subtasks will be assinged automatically based on the task titles, if not assigned please enter the task manually, when you're assigning similar task, the sub tasks will be filled automatically )"}),((u=s==null?void 0:s.tasks)==null?void 0:u.length)===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl   text-center p-6",children:[e.jsx("i",{className:"fas fa-box-open text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Subtasks Found"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Looks like there are no tasks assigned yet ",e.jsx("br",{}),"Click on ",e.jsx("strong",{children:'"Add subtask"'})," to get started 🚀"]})]}),(p=s==null?void 0:s.tasks)==null?void 0:p.map((h,v)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{value:h.taskName,placeholder:`Subtask #${v+1}`,onChange:D=>be(a,v,D.target.value)},v),e.jsx(_,{onClick:()=>je(a,v),variant:"danger",className:"bg-red-600 text-white",size:"sm",children:e.jsx("i",{className:"fas fa-trash"})})]})),e.jsxs(_,{type:"button",onClick:()=>xe(a),className:"bg-blue-200 hover:bg-blue-300 text-blue-900 mt-2",children:[e.jsx("i",{className:"fa fa-plus mr-1"})," Add Subtask"]})]})]},a)})]})};export{hs as StaffAssignTaskMain,ds as debounce,hs as default};
