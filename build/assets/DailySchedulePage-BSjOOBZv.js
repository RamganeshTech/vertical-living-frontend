import{u as Be,r as h,d as ns,X as k,j as e,a as Ms,b as Ws,O as Ls}from"./index-BYTWf4fI.js";import{c as Bs,d as $s,e as zs,f as Us,g as Js,h as Vs,i as Ks,j as Hs,k as qs,l as Xs,m as Ys,n as Gs,o as Qs,p as Zs,q as et}from"./workScheduleApi-RXvB2vpH.js";import{B as F}from"./Button-aRmNljle.js";import{I as T}from"./Input-ChgExZu6.js";import{T as ss}from"./TextArea-EPgSj1kU.js";import{L as $}from"./Label-BupV_v2u.js";import{C as xe,b as fe,d as je,a as ve}from"./Card-ClDlfbss.js";import{S as ts,a as as,b as ls,c as rs,d as Ce}from"./Select-DzMj40ZL.js";import{t as f}from"./toast-BSC5QTk1.js";import{d as is}from"./downloadFile-DFN4JXcx.js";import{I as Le}from"./ImageGalleryMain-BTDqHC1K.js";import{N as st}from"./constants-4IFJeChr.js";import{b as tt,c as at}from"./workReportsApi-B2K6X2Y8.js";import lt from"./MaterialOverviewLoading-DkmRHaSw.js";import"./roleCheck-DhBlwT6t.js";import"./useQuery-DFVFWtWl.js";import"./useMutation-sTZCeqmg.js";import"./index-CofIYY6b.js";import"./Skeleton-Bc8D3KPj.js";const rt=({projectId:A,isOpen:le,onClose:q,editData:l,onSave:R,onUpdate:ee,scheduleId:g=null,refetch:L})=>{const{organizationId:X}=Be(),Y=h.useRef(null),G=h.useRef(null),d=ns(),{data:o}=Bs(A),{data:b,isLoading:S}=$s(X),[V,I]=h.useState(!1),[W,Te]=h.useState({name:"",url:""}),[se,re]=h.useState({name:"",url:""}),[H,be]=h.useState(null),[P,Ae]=h.useState(null),[ye,K]=h.useState(50),[Fe,ne]=h.useState(!1),Pe=s=>{s.scheduleId===g&&s.addedBy!==(d==null?void 0:d.id)&&(D(a=>[...a,s.selectImages]),f({title:"Comparison Added",description:`by ${s.addedByRole}`}))},ie=s=>{console.log("entierngint othe funtio"),s.scheduleId===g&&s.uploadedBy!==(d==null?void 0:d.id)&&(D(s.newSelectImages),f({title:"Select Images Added",description:`by ${s.uploadedByRole}`}))},z=s=>{s.scheduleId===g&&s.createdBy!==(d==null?void 0:d.id)&&(D(a=>[...a,s.selectImages]),f({title:"New Comparison",description:`created by ${s.createdByRole}`}))},Ne=s=>{s.scheduleId===g&&s.uploadedBy!==(d==null?void 0:d.id)&&(D(s.newCorrectedImages),f({title:"Corrected Images Uploaded",description:`by ${s.uploadedByRole}`}))},oe=s=>{if(s.scheduleId!==g||s.updatedBy===(d==null?void 0:d.id))return;const{comparisonId:a,selectedImageId:t,comment:n}=s;D(i=>i&&i.map(c=>c._id===a?{...c,selectImage:c.selectImage.map(C=>C._id===t?{...C,comment:n}:C)}:c)),f({title:"Comment Updated",description:`by ${s.updatedByRole}`})},ke=s=>{s.scheduleId===g&&s.deletedBy!==(d==null?void 0:d.id)&&(D(s.images),f({title:"Select Image Deleted",description:`by ${s.deletedByRole}`}))},de=s=>{s.scheduleId===g&&s.deletedBy!==(d==null?void 0:d.id)&&(D(s.deletedImage),f({title:"Corrected Image Deleted",description:`by ${s.deletedByRole}`}))};h.useEffect(()=>{if(!(!k||!g||!A))return k.on("workSchedule:selectimage_added",Pe),k.on("workSchedule:selectimage_added_manual",ie),k.on("workSchedule:comparison_created",z),k.on("workSchedule:correctimage_upload",Ne),k.on("workSchedule:selectimage_comment",oe),k.on("workSchedule:selectimage_delete",ke),k.on("workSchedule:correctimage_delete",de),()=>{k.off("workSchedule:selectimage_added",Pe),k.off("workSchedule:selectimage_added_manual",ie),k.off("workSchedule:comparison_created",z),k.off("workSchedule:correctimage_upload",Ne),k.off("workSchedule:selectimage_comment",oe),k.off("workSchedule:selectimage_delete",ke),k.off("workSchedule:correctimage_delete",de)}},[k,g,d==null?void 0:d.id,V]);const ce=new Date().toISOString().split("T")[0],w=s=>{const a=he=>String(he).padStart(2,"0"),t=s.getFullYear(),n=a(s.getMonth()+1),i=a(s.getDate()),c=a(s.getHours()),C=a(s.getMinutes());return`${t}-${n}-${i}T${c}:${C}`},[p,O]=h.useState({projectAssignee:{projectName:"",siteAddress:"",designReferenceId:"",carpenterName:"",carpenterUIName:"",supervisorName:(d==null?void 0:d.name)||"",plannedStartDate:ce},dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:[],siteImages:[],supervisorCheck:{reviewerName:(d==null?void 0:d.name)||"",reviewerId:(d==null?void 0:d.id)||"",reviewDateTime:w(new Date),status:"pending",remarks:"",gatekeeping:"block"}}),[Z,we]=h.useState(!1),[me,Re]=h.useState([]),[Q,D]=h.useState([]),[_e,te]=h.useState(!1),De=(s,a)=>{s.preventDefault(),ne(!1);const t=new DataTransfer;Array.from(s.dataTransfer.files).forEach(n=>t.items.add(n)),Oe(t.files,a)};h.useEffect(()=>{var t,n,i,c,C,he,Ve,Ke,He,qe,Xe,Ye,Ge,Qe,Ze,es;if(!o&&!l)return;let s;!o&&!l&&(s=b==null?void 0:b.find(J=>{var pe;return(J==null?void 0:J._id)===((pe=l.projectAssignee.carpenterName)==null?void 0:pe._id)}));let a;if((t=l==null?void 0:l.supervisorCheck)!=null&&t.reviewDateTime)console.log("gettign into the place 1"),a=w(new Date((n=l==null?void 0:l.supervisorCheck)==null?void 0:n.reviewDateTime));else if((c=(i=l==null?void 0:l.dailyTasks)==null?void 0:i[0])!=null&&c.datePlanned){const J=new Date(l.dailyTasks[0].datePlanned);J.setHours(12,0,0),a=w(J)}else console.log("gettign into the place 333333"),a=w(new Date);if(O({projectAssignee:{projectName:((C=l==null?void 0:l.projectAssignee)==null?void 0:C.projectName)||(o==null?void 0:o.projectName)||"",siteAddress:((he=l==null?void 0:l.projectAssignee)==null?void 0:he.siteAddress)||(o==null?void 0:o.siteAddress)||"",designReferenceId:((Ve=l==null?void 0:l.projectAssignee)==null?void 0:Ve.designReferenceId)||(o==null?void 0:o.designReferenceId)||"",carpenterName:((Ke=l==null?void 0:l.projectAssignee)==null?void 0:Ke.carpenterName)||null,carpenterUIName:(s==null?void 0:s.workerName)||"",supervisorName:((He=l==null?void 0:l.projectAssignee)==null?void 0:He.supervisorName)||(d==null?void 0:d.name)||"",plannedStartDate:((qe=l==null?void 0:l.projectAssignee)==null?void 0:qe.plannedStartDate)||ce},dailyTasks:((Xe=l==null?void 0:l.dailyTasks)==null?void 0:Xe.map(J=>({...J,uploadedImages:J.uploadedImages||[]})))||[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:(l==null?void 0:l.designPlanImages)||[],siteImages:(l==null?void 0:l.siteImages)||[],supervisorCheck:{reviewerName:((Ye=l==null?void 0:l.supervisorCheck)==null?void 0:Ye.reviewerName)||(d==null?void 0:d.name)||"",reviewerId:((Ge=l==null?void 0:l.supervisorCheck)==null?void 0:Ge.reviewerId)||(d==null?void 0:d.id)||"",reviewDateTime:a,status:((Qe=l==null?void 0:l.supervisorCheck)==null?void 0:Qe.status)||"needs_changes",remarks:((Ze=l==null?void 0:l.supervisorCheck)==null?void 0:Ze.remarks)||"",gatekeeping:((es=l==null?void 0:l.supervisorCheck)==null?void 0:es.gatekeeping)||"block"}}),l!=null&&l.dailyTasks){const J={};l.dailyTasks.forEach((pe,Os)=>{pe.materialsNeeded&&pe.materialsNeeded.length>0&&(J[Os]=pe.materialsNeeded.join(", "))}),E(J)}l!=null&&l.workComparison?D(l.workComparison):D([])},[o,l]);const[ge,Se]=h.useState([]),[ue,Ie]=h.useState([]),r=zs(),u=Us(),{mutateAsync:x,isPending:j}=Js(),v=(s,a)=>{O(t=>({...t,projectAssignee:{...t.projectAssignee,[s]:a}}))},m=s=>s?new Date(s).toISOString().split("T")[0]:"",y=(s,a,t)=>{O(n=>{const i=n.dailyTasks.map((C,he)=>he===s?{...C,[a]:t}:C);let c=n.supervisorCheck;if(g===null&&s===0&&a==="datePlanned"){const C=`${t}T12:00`;c={...n.supervisorCheck,reviewDateTime:C}}return{...n,dailyTasks:i,supervisorCheck:c}})},[N,E]=h.useState({}),B=(s,a)=>{E(t=>({...t,[s]:a})),O(t=>({...t,dailyTasks:t.dailyTasks.map((n,i)=>i===s?{...n,materialsNeeded:a.split(",").map(c=>c.trim()).filter(c=>c)}:n)}))},_=()=>{O(s=>({...s,dailyTasks:[...s.dailyTasks,{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},U=()=>{O(s=>({...s,dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},ae=s=>{O(a=>({...a,dailyTasks:a.dailyTasks.filter((t,n)=>n!==s)}))},M=(s,a)=>{O(t=>({...t,supervisorCheck:{...t.supervisorCheck,[s]:a}}))},Ee=async()=>{var s,a;try{if(l){const t=new FormData;t.append("projectAssignee",JSON.stringify(p.projectAssignee)),t.append("dailyTasks",JSON.stringify(p.dailyTasks)),t.append("supervisorCheck",JSON.stringify(p.supervisorCheck)),P&&t.append("actualImage",P),H&&t.append("plannedImage",H),ge.forEach(n=>t.append("designPlanImages",n)),ue.forEach(n=>t.append("siteImages",n)),await u.mutateAsync({projectId:A,scheduleId:l._id,formData:t}),ee==null||ee(p),f({title:"Success",description:"updated successfully"})}else{const t=new FormData;t.append("projectAssignee",JSON.stringify(p.projectAssignee)),t.append("dailyTasks",JSON.stringify(p.dailyTasks)),t.append("supervisorCheck",JSON.stringify(p.supervisorCheck)),P&&t.append("actualImage",P),H&&t.append("plannedImage",H),ge.forEach(n=>t.append("designPlanImages",n)),ue.forEach(n=>t.append("siteImages",n)),await r.mutateAsync({projectId:A,formData:t}),L(),R==null||R(p),f({title:"Success",description:"Created successfully"})}q()}catch(t){f({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"something went wrong",variant:"destructive"})}},os=async()=>{var s,a;try{const t=new FormData;t.append("projectAssignee",JSON.stringify(p.projectAssignee)),t.append("dailyTasks",JSON.stringify(p.dailyTasks)),t.append("supervisorCheck",JSON.stringify(p.supervisorCheck)),P&&t.append("actualImage",P),H&&t.append("plannedImage",H),ge.forEach(i=>t.append("designPlanImages",i)),ue.forEach(i=>t.append("siteImages",i));let n;l?n=await x({projectId:A,scheduleId:g,formData:t}):n=await x({projectId:A,formData:t}),is({src:n.downloadUrl,alt:n.fileName}),f({description:"Pdf Generated successfully",title:"Success"})}catch(t){f({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},Oe=(s,a)=>{if(!s)return;const t=Array.from(s);if(a==="design"){const n=t.map(i=>({file:i,url:URL.createObjectURL(i)}));O(i=>({...i,designPlanImages:[...i.designPlanImages,...n]})),Se(i=>[...i,...t])}else if(a==="site"){const n=t.map(i=>({file:i,url:URL.createObjectURL(i)}));O(i=>({...i,siteImages:[...i.siteImages,...n]})),Ie(i=>[...i,...t])}},$e=(s,a)=>{a==="design"?(O(t=>({...t,designPlanImages:t.designPlanImages.filter((n,i)=>i!==s)})),Se(t=>t.filter((n,i)=>i!==s))):a==="site"&&(O(t=>({...t,siteImages:t.siteImages.filter((n,i)=>i!==s)})),Ie(t=>t.filter((n,i)=>i!==s)))},ds=()=>{const s=JSON.stringify(p,null,2),a=new Blob([s],{type:"application/json"}),t=URL.createObjectURL(a),n=document.createElement("a");n.href=t,n.download=`work-schedule-${Date.now()}.json`,n.click(),URL.revokeObjectURL(t)},cs=s=>{var n;const a=(n=s.target.files)==null?void 0:n[0];if(!a)return;const t=new FileReader;t.onload=i=>{var c;try{const C=JSON.parse((c=i.target)==null?void 0:c.result);O(C)}catch{f({title:"Error",description:"Error importing JSON file",variant:"destructive"})}},t.readAsText(a)},[ms,ze]=h.useState(null),[gs,us]=h.useState({}),{mutateAsync:hs,isPending:Ue}=Vs(),{mutateAsync:ps,isPending:Me}=Ks(),{mutateAsync:xs}=Hs(),{mutateAsync:fs}=qs(),{mutateAsync:js,isPending:vs}=Xs(),{mutateAsync:bs}=Ys(),ys=s=>{Z&&Re(a=>a.includes(s)?a.filter(t=>t!==s):[...a,s])},Ns=async()=>{var s,a;try{if(me.length===0)return;const t=me.map(i=>({...i})),n=await hs({projectId:A,scheduleId:g,formData:t});D(i=>[...i,n]),I(i=>!i),f({description:"Pdf Generated successfully",title:"Success"})}catch(t){f({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},ks=async(s,a)=>{var n,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("files",c)});try{const c=await js({projectId:A,scheduleId:g,comparisonId:a,formData:t});D(c),I(C=>!C)}catch(c){f({title:"Error",description:((i=(n=c==null?void 0:c.response)==null?void 0:n.data)==null?void 0:i.message)||"Failed to upload corrected images",variant:"destructive"})}},We=async(s,a)=>{var n,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("correctfiles",c)});try{const c=await ps({projectId:A,scheduleId:g,comparisonId:a,formData:t});D(c),I(C=>!C),L()}catch(c){f({title:"Error",description:((i=(n=c==null?void 0:c.response)==null?void 0:n.data)==null?void 0:i.message)||"Failed to upload images",variant:"destructive"})}},ws=async(s,a)=>{var t,n;try{const i=await bs({projectId:A,scheduleId:g,comparisonId:s,imageId:a});D(i),I(c=>!c),f({title:"Success",description:"Corrected image deleted successfully"})}catch(i){f({title:"Error",description:((n=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to delete corrected image",variant:"destructive"})}},Ss=async(s,a)=>{var t,n;try{const i=await fs({projectId:A,scheduleId:g,comparisonId:s,selectId:a});D(i),I(c=>!c),f({title:"Success",description:"image deleted successfully"})}catch(i){f({title:"Error",description:((n=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to delete corrected image",variant:"destructive"})}},Is=async(s,a,t)=>{var n,i;try{const c=await xs({projectId:A,scheduleId:g,comparisonId:s,selectedImageId:a,data:{comment:t}});D(c),ze(""),I(C=>!C),f({title:"Success",description:"Comment updated successfully"})}catch(c){f({title:"Error",description:((i=(n=c==null?void 0:c.response)==null?void 0:n.data)==null?void 0:i.message)||"Failed to update comment",variant:"destructive"})}},Cs=s=>{const a=s.target.files[0];a&&(Te({name:a.name,url:URL.createObjectURL(a)}),be(a))},Ts=s=>{const a=s.target.files[0];a&&(re({name:a.name,url:URL.createObjectURL(a)}),Ae(a))},As=s=>{ne(!0),s.preventDefault()},Ps=s=>{if(!Fe)return;const a=s.currentTarget.getBoundingClientRect(),t=s.clientX-a.left,n=Math.max(0,Math.min(100,t/a.width*100));K(n)},Je=()=>{ne(!1)},Rs=()=>{K(50)},_s=()=>{Te({name:"",url:""}),be(null)},Fs=()=>{re({name:"",url:""}),Ae(null)},Ds=s=>{const a=p.dailyTasks.find((t,n)=>s===n);return(a==null?void 0:a.status)||"planned"},Es=()=>{const s=p.supervisorCheck.status;return s==="approved"?"Approved":s==="needs_changes"?"Changes Required":"Pending"};return le?e.jsx("div",{onClick:q,className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white rounded-lg max-w-[90%] max-h-[90vh] overflow-y-auto w-full mx-4",children:[e.jsx("div",{className:" bg-blue-600 text-white p-4 rounded-t-lg sticky top-0 z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Vertical Living â€” Carpenter Work Schedule & Visual Approval"}),e.jsx("p",{className:"text-sm opacity-90",children:"RAMS TECH CIRCLE OPC Pvt. Ltd. â€¢ No. 22, 13th Main Road, Anna Nagar West, Chennai - 600040 â€¢ WhatsApp: +91 93639 93814"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{isLoading:u.isPending||r.isPending,variant:"secondary",size:"sm",onClick:Ee,children:"Save"}),e.jsx(F,{variant:"secondary",size:"sm",onClick:ds,children:"Export JSON"}),e.jsx("input",{id:"json-import",type:"file",accept:".json",className:"hidden",onChange:cs}),e.jsx(F,{variant:"secondary",size:"sm",onClick:()=>{var s;return(s=document.getElementById("json-import"))==null?void 0:s.click()},children:"Import JSON"}),e.jsx(F,{variant:"secondary",isLoading:j,onClick:os,size:"sm",children:"Print / PDF"}),e.jsx(F,{variant:"secondary",size:"sm",onClick:q,children:e.jsx("i",{className:"fas fa-times"})})]})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-file-text"}),"Project & Assignee",e.jsx(F,{variant:"link",size:"sm",className:"ml-auto text-blue-600",children:"Single sheet for multiple days"})]})}),e.jsx(ve,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx($,{htmlFor:"projectName",children:"Project Name"}),e.jsx(T,{id:"projectName",placeholder:"e.g., Shankar Residence â€” Wardrobe & TV Unit",value:p.projectAssignee.projectName,onChange:s=>v("projectName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"siteAddress",children:"Site Address"}),e.jsx(T,{id:"siteAddress",placeholder:"Full address",value:p.projectAssignee.siteAddress,onChange:s=>v("siteAddress",s.target.value)})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"designReferenceId",children:"Design Reference ID"}),e.jsx(T,{id:"designReferenceId",placeholder:"e.g., VL-KTN-2025-001",value:p.projectAssignee.designReferenceId,onChange:s=>v("designReferenceId",s.target.value)})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"carpenterName",children:"Carpenter Name"}),e.jsx("select",{className:"border-b px-2 py-1 text-sm w-[100%]",value:p.projectAssignee.carpenterUIName,onChange:s=>{const a=s.target.value,t=b==null?void 0:b.find(n=>n._id===a);v("carpenterName",s.target.value),v("carpenterUIName",t?t.workerName:"")},children:S?e.jsx("option",{disabled:!0,children:"Loading workers..."}):e.jsxs(e.Fragment,{children:[e.jsx("option",{disabled:!0,value:"",children:"Assign worker"}),Array.isArray(b)&&(b==null?void 0:b.length)>0?b==null?void 0:b.map(s=>e.jsxs("option",{value:s._id,children:[s.workerName," ",s.email&&`(${s.email})`]},s._id)):e.jsx("option",{disabled:!0,children:"No workers registered"})]})})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"supervisorName",children:"Supervisor Name"}),e.jsx(T,{id:"supervisorName",placeholder:"Site supervisor",value:p.projectAssignee.supervisorName,onChange:s=>v("supervisorName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"plannedStartDate",children:"Planned Start Date"}),e.jsx(T,{id:"plannedStartDate",type:"date",value:p.projectAssignee.plannedStartDate,onChange:s=>v("plannedStartDate",s.target.value)})]})]})})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-calendar-days"}),"Daily Work Schedule"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:_,children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Task"]}),e.jsx(F,{variant:"outline",onClick:U,size:"sm",children:"Clear"})]})]})}),e.jsx(ve,{children:e.jsx("div",{className:"h-fit border overflow-y-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2 text-center",children:"DATE"}),e.jsx("th",{className:"border p-2 text-center",children:"ROOM / UNIT"}),e.jsx("th",{className:"border p-2 text-center",children:"WORK DESCRIPTION"}),e.jsx("th",{className:"border p-2 text-center",children:"START"}),e.jsx("th",{className:"border p-2 text-center",children:"END"}),e.jsx("th",{className:"border p-2 text-center",children:"MATERIALS NEEDED"}),e.jsx("th",{className:"border p-2 text-center",children:"MANPOWER"}),e.jsx("th",{className:"border p-2 text-center",children:"STATUS"}),e.jsx("th",{className:"border p-2 text-center",children:"ACTIONS"})]})}),e.jsx("tbody",{className:"",children:p.dailyTasks.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:e.jsx(T,{type:"date",value:m(s.datePlanned),onChange:t=>y(a,"datePlanned",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(T,{placeholder:"Kitchen",value:s.room,onChange:t=>y(a,"room",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(ss,{placeholder:"Base unit carcass fixing & levelling",value:s.workDescription,onChange:t=>y(a,"workDescription",t.target.value),rows:2})}),e.jsx("td",{className:"border p-2",children:e.jsx(T,{type:"time",value:s.startTime,onChange:t=>y(a,"startTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(T,{type:"time",value:s.endTime,onChange:t=>y(a,"endTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(T,{placeholder:"Plywood, laminate, screws",value:N[a]??"",onChange:t=>B(a,t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(T,{type:"number",placeholder:"No of workers",value:s.manpower,onChange:t=>y(a,"manpower",Number.parseInt(t.target.value)||0)})}),e.jsx("td",{className:"border p-2",children:e.jsxs(ts,{value:s.status,onValueChange:t=>y(a,"status",t),children:[e.jsx(as,{children:e.jsx(ls,{selectedValue:Ds(a)})}),e.jsxs(rs,{children:[e.jsx(Ce,{value:"planned",children:"Planned"}),e.jsx(Ce,{value:"in-progress",children:"In Progress"}),e.jsx(Ce,{value:"completed",children:"Completed"})]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{className:"flex gap-1",children:e.jsx(F,{variant:"danger",size:"sm",onClick:()=>ae(a),children:e.jsx("i",{className:"fas fa-trash"})})})})]},a))})]})})})]}),e.jsxs(xe,{className:"",children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Laminate/Design/Plan Images â€” for Explanation"}),e.jsx(F,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload reference plans, markups, sketches"})]})}),e.jsxs(ve,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${_e?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=Y.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),te(!0)},onDragLeave:()=>te(!1),onDrop:s=>De(s,"design"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop plan/reference images here or"}),e.jsx(F,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Accepted: JPG/PNG/WebP â€¢ Images auto-saved locally"})]})}),e.jsx("input",{ref:Y,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>Oe(s.target.files,"design")}),p.designPlanImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:p.designPlanImages.map((s,a)=>e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),!s._id&&e.jsx("button",{type:"button",onClick:()=>$e(a,"design"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"Ã—"})]},a))})})]})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Site / Actual Images â€” for Visual Confirmation"}),e.jsx(F,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload daily progress photos"})]})}),e.jsxs(ve,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${_e?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=G.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),te(!0)},onDragLeave:()=>te(!1),onDrop:s=>De(s,"site"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop site/progress images here or"}),e.jsx(F,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tip: Upload clear, well-lit photos with unit labels in frame"})]})}),e.jsx("input",{ref:G,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>Oe(s.target.files,"site")}),e.jsx("div",{children:l&&e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"checkbox",id:"correctionMode",checked:Z,onChange:s=>{we(s.target.checked),s.target.checked||Re([])}}),e.jsx("label",{htmlFor:"correctionMode",className:"text-sm font-medium",children:"Select images for correction"}),Z&&e.jsx(F,{size:"sm",className:"bg-green-600 text-white",disabled:me.length===0||Ue,onClick:Ns,children:Ue?"Uploading...":"Upload Selected"})]})}),p.siteImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:p.siteImages.map((s,a)=>{const t=me.includes(s);return e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{onClick:()=>ys(s),src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),t&&e.jsx("i",{className:"fa fa-check absolute top-1 right-1 text-green-600 bg-white rounded-full p-1 shadow-md"}),!Z&&e.jsx("button",{type:"button",onClick:()=>$e(a,"site"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"Ã—"})]},a)})})})]})]}),l&&e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsx(je,{className:"",children:"Correction Section"})}),e.jsx(ve,{children:Q&&Q.length>0?e.jsxs(e.Fragment,{children:[Q.map((s,a)=>e.jsx(h.Fragment,{children:e.jsx("div",{className:" border-b pb-6 last:border-b-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsxs("div",{className:"md:w-1/2 w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>We(t.target.files,s._id)}),Me&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Selected Images for Correction"]}),s.selectImage&&s.selectImage.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(Le,{imageFiles:s==null?void 0:s.selectImage.map(t=>{const{_id:n,...i}=t.plannedImage||{};return{_id:t._id,...i,comment:t.comment,createdBy:t.createdBy,createModel:t.createModel,createdAt:t.createdAt}}),handleDeleteFile:t=>{Ss(s._id,t)},height:120,minWidth:120,maxWidth:140,isComments:!0,editingId:ms,tempComment:gs,setEditingId:ze,setTempComment:us,onUpdateComment:(t,n)=>Is(s._id,t,n)})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No selected images available for this comparison."})]}),e.jsx("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Refactored Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>ks(t.target.files,s._id)}),vs&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Refactored Outputs"]}),s.correctedImages&&s.correctedImages.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(Le,{imageFiles:s==null?void 0:s.correctedImages,handleDeleteFile:t=>ws(s._id,t),refetch:L,height:120,minWidth:120,maxWidth:140})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No refactored images uploaded yet."})]})]})})]})})},s._id||a)),e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",(Q==null?void 0:Q.length)+1||1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>We(s.target.files,null)}),Me&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage  ",Q.length+1||1,": Select Outputs"]})})]})]}):e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-sm font-medium block mb-2",children:"Upload Select Images (Stage 1)"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>We(s.target.files,null)}),Me&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsx("h3",{className:"text-md font-semibold mb-2",children:"Stage 1: Select Outputs"})})]})})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Planned vs Actual â€” Slider Comparison"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("planned-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Planned"}),e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("actual-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Actual"}),e.jsx("button",{onClick:Rs,className:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600",children:"Reset"})]})]}),e.jsx("div",{className:"relative w-[100%] h-96 bg-gray-100 rounded-lg overflow-hidden border",children:W.url||se.url?e.jsxs("div",{className:"relative w-full h-full cursor-col-resize",onMouseMove:Ps,onMouseUp:Je,onMouseLeave:Je,children:[W.url&&e.jsxs("div",{className:"absolute top-0 left-0 h-full overflow-visible",style:{width:`${ye}%`},children:[e.jsx("img",{src:W.url,alt:"plannedimage",className:"absolute top-0 left-0 w-[100%] h-[100%] object-cover",style:{clipPath:"inset(0px 0% 0px 0px)"}}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Planned"}),e.jsx("button",{onClick:_s,className:"absolute top-2 left-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),se.url&&e.jsxs("div",{className:"absolute top-0 right-0 h-full overflow-hidden",style:{width:`${100-ye}%`},children:[e.jsx("img",{src:se.url||st,alt:"Actual",className:"h-full object-cover",style:{width:"100%",maxWidth:"none"}}),e.jsx("div",{className:"absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Actual"}),e.jsx("button",{onClick:Fs,className:"absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("div",{className:"absolute top-0 h-full w-1 bg-white shadow-lg cursor-col-resize z-10",style:{left:`${ye}%`,transform:"translateX(-50%)"},children:e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg border-2 border-gray-300 cursor-col-resize flex items-center justify-center",onMouseDown:As,children:e.jsx("i",{className:"fas fa-arrows-alt-h text-gray-600 text-xs"})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-images text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"Upload planned and actual images to compare"}),e.jsx("p",{className:"text-sm",children:"Use the buttons above to select images"})]})})}),e.jsx("p",{className:"text-sm text-gray-600 mt-2 text-center",children:"Drag the circle to reveal differences"}),e.jsx("input",{id:"planned-image",type:"file",accept:"image/*",onChange:Cs,className:"hidden"}),e.jsx("input",{id:"actual-image",type:"file",accept:"image/*",onChange:Ts,className:"hidden"})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:e.jsxs(je,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Supervisor Visual Check & Approval"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("span",{className:"text-sm",children:Es()})]})]})}),e.jsxs(ve,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx($,{htmlFor:"reviewerName",children:"Reviewer Name"}),e.jsx(T,{id:"reviewerName",placeholder:"Staff doing the check",value:p.supervisorCheck.reviewerName,onChange:s=>M("reviewerName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"reviewDateTime",children:"Review Date & Time"}),e.jsx(T,{id:"reviewDateTime",type:"datetime-local",value:p.supervisorCheck.reviewDateTime,onChange:s=>M("reviewDateTime",s.target.value)})]})]}),e.jsx("div",{className:"flex gap-4 mb-4",children:e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"pending",name:"status",value:"pending",checked:p.supervisorCheck.status==="pending",onChange:s=>M("status",s.target.value),className:"hidden peer"}),e.jsx($,{htmlFor:"pending",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${p.supervisorCheck.status==="pending"?"border-gray-500 bg-gray-100 text-gray-900 font-semibold":"border-gray-300 text-gray-600 hover:border-gray-400 hover:bg-gray-50"}`,children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"approved",name:"status",value:"approved",checked:p.supervisorCheck.status==="approved",onChange:s=>M("status",s.target.value),className:"hidden peer"}),e.jsx($,{htmlFor:"approved",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${p.supervisorCheck.status==="approved"?"border-green-600 bg-green-100 text-green-800 font-semibold":"border-gray-300 text-green-700 hover:border-green-400 hover:bg-green-50"}`,children:"Approve"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"needs_changes",name:"status",value:"needs_changes",checked:p.supervisorCheck.status==="needs_changes",onChange:s=>M("status",s.target.value),className:"hidden peer"}),e.jsx($,{htmlFor:"needs_changes",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${p.supervisorCheck.status==="needs_changes"?"border-orange-600 bg-orange-100 text-orange-800 font-semibold":"border-gray-300 text-orange-700 hover:border-orange-400 hover:bg-orange-50"}`,children:"Changes Required"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx($,{htmlFor:"remarks",children:"Remarks / Observations"}),e.jsx(ss,{id:"remarks",placeholder:"Note deviations, rework needed, or greenlight to proceed",value:p.supervisorCheck.remarks,onChange:s=>M("remarks",s.target.value),rows:3})]}),e.jsxs("div",{children:[e.jsx($,{htmlFor:"gatekeeping",children:"Gatekeeping (Workflow Interlock)"}),e.jsxs(ts,{value:p.supervisorCheck.gatekeeping,onValueChange:s=>M("gatekeeping",s),children:[e.jsx(as,{selectedValue:p.supervisorCheck.gatekeeping,children:e.jsx(ls,{selectedValue:p.supervisorCheck.gatekeeping==="block"?"BLOCK work to start with Supervisor Watch":"ALLOW work to start with Supervisor Watch"})}),e.jsxs(rs,{children:[e.jsx(Ce,{value:"block",children:"BLOCK work to start with Supervisor Watch"}),e.jsx(Ce,{value:"allow_with_watch",children:"ALLOW work to start with Supervisor Watch"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Matches CRM philosophy used in Material Arrival stage â€” prevent next step until approval."})]})]})]})]})]})]})}):null},nt=({dailyScheduleId:A,dailyTaskId:le})=>{const{projectId:q,organizationId:l}=Be(),[R,ee]=h.useState({workerName:"",date:new Date().toISOString().substring(0,10),placeOfWork:"",reportingTime:"",workStartTime:"",travelingTime:"",workDone:"",finishingTime:"",shiftDone:"",placeOfStay:""}),[g,L]=h.useState([]),{data:X}=tt(q,A,le),{mutateAsync:Y,isPending:G}=at();console.log("fetchedimages",X),h.useEffect(()=>{X&&L(X.map(S=>({...S,_id:void 0})))},[X]);const d=S=>{ee({...R,[S.target.name]:S.target.value})},o=S=>{L(V=>V.filter((I,W)=>W!==S))},b=async()=>{var S,V;try{const I=await Y({projectId:q,organizationId:l,payload:{...R,images:g}});is({src:I==null?void 0:I.url,alt:I==null?void 0:I.fileName}),f({title:"Success",description:"Created report successfully"})}catch(I){f({title:"Error",description:((V=(S=I==null?void 0:I.response)==null?void 0:S.data)==null?void 0:V.message)||(I==null?void 0:I.message)||"Report not created"})}};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-4 border rounded-md bg-white space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Worker Name"}),e.jsx(T,{name:"workerName",value:R.workerName,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date"}),e.jsx(T,{type:"date",name:"date",value:R.date,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Place of Work"}),e.jsx(T,{name:"placeOfWork",value:R.placeOfWork,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reporting Time"}),e.jsx(T,{type:"time",name:"reportingTime",value:R.reportingTime,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Work Start Time"}),e.jsx(T,{type:"time",name:"workStartTime",value:R.workStartTime,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Traveling Time"}),e.jsx(T,{type:"time",name:"travelingTime",value:R.travelingTime,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Finishing Time"}),e.jsx(T,{type:"time",name:"finishingTime",value:R.finishingTime,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Shift Done"}),e.jsx(T,{name:"shiftDone",value:R.shiftDone,onChange:d})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Place of Stay"}),e.jsx(T,{name:"placeOfStay",value:R.placeOfStay,onChange:d})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Work Done"}),e.jsx("textarea",{name:"workDone",className:"w-full border px-3 py-2 rounded-md",rows:3,value:R.workDone,onChange:d})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-sm font-bold text-gray-700 mb-2",children:"Work Images"}),g.length===0?e.jsx("p",{className:"text-gray-500 text-sm",children:"No images found for this date."}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:g.map((S,V)=>e.jsxs("div",{className:"relative border p-1 rounded-md shadow-sm flex flex-col items-center justify-center",children:[e.jsx("img",{src:S==null?void 0:S.url,alt:(S==null?void 0:S.originalName)||"work image",className:"w-full h-[150px] object-cover rounded"}),e.jsxs(F,{onClick:()=>o(V),className:"text-xs text-white mt-1 bg-red-600",children:[e.jsx("i",{className:"fas fa-trash mr-1"}),"Remove"]})]},V))})]}),e.jsx(F,{onClick:b,isLoading:G,className:"mt-4",children:"Save Report"})]})})},It=()=>{var ge,Se,ue,Ie;const{projectId:A,organizationId:le}=Be(),[q,l]=h.useState(!1),[R,ee]=h.useState([]),[g,L]=h.useState(null),[X,Y]=h.useState(null),[G,d]=h.useState(new Date),[o,b]=h.useState(null),[S,V]=h.useState([]),[I,W]=h.useState(!1),[Te,se]=h.useState(!1),[re,H]=h.useState(null),be=Ms(),{data:P,isLoading:Ae,error:ye,refetch:K}=Gs(A),{mutateAsync:Fe}=Qs(),ne=Zs(),Pe=et(),{role:ie,permission:z}=Ws(),Ne=ie==="owner"||((ge=z==null?void 0:z.workschedule)==null?void 0:ge.delete),oe=ie==="owner"||((Se=z==null?void 0:z.workschedule)==null?void 0:Se.create),ke=ie==="owner"||((ue=z==null?void 0:z.workschedule)==null?void 0:ue.create);h.useEffect(()=>{(()=>{const u=G.getFullYear(),x=G.getMonth(),j=new Date(u,x,1),v=new Date(j);v.setDate(v.getDate()-j.getDay());const m=[],y=new Date(v);for(let N=0;N<42;N++)m.push({date:new Date(y),isCurrentMonth:y.getMonth()===x}),y.setDate(y.getDate()+1);ee(m)})()},[G]);const de=h.useCallback(()=>{if(!g)return;const r=new Date(g);r.setDate(r.getDate()-1),Z(r)},[g]),ce=h.useCallback(()=>{if(!g)return;const r=new Date(g);r.setDate(r.getDate()+1),Z(r)},[g]);h.useEffect(()=>{const r=u=>{g&&(u.key==="Escape"?(L(null),b(null),W(!1)):u.key==="ArrowRight"?ce():u.key==="ArrowLeft"&&de())};return document.addEventListener("keydown",r),()=>{document.removeEventListener("keydown",r)}},[ce,de]);const w=ns();h.useEffect(()=>{if(!k||!le)return;const r=m=>{const{createdBy:y}=m;console.log("workinged created form teh socket 1294"),y!==(w==null?void 0:w.id)&&(K(),f({title:"New Task Created",description:`New work schedule created by ${m.createdByRole}`}))},u=m=>{const{updatedBy:y}=m;if(console.log("ðŸ”¥ WebSocket Event Received:",m),console.log("ðŸ‘¤ Current User ID:",w==null?void 0:w.id),y!==(w==null?void 0:w.id)&&(console.log("âœ… Refetching data... in weebsocket useEffect"),K(),f({title:"Task Updated",description:`Work schedule updated by ${m.updatedByRole}`}),o&&o.scheduleId===m.taskId)){const N=P==null?void 0:P.find(E=>E._id===m.taskId);if(N){const E=N.dailyTasks.find(B=>B._id===o._id);E&&b({...E,scheduleId:m.taskId})}}},x=m=>{const{taskId:y,deletedBy:N}=m;N!==(w==null?void 0:w.id)&&(K(),f({title:"Task Deleted",description:`Task deleted by ${m.deletedByRole}`}),o&&o._id===y&&(b(null),L(null),W(!1)))},j=m=>{const{taskId:y,date:N,newImages:E,uploadedBy:B}=m;B!==(w==null?void 0:w.id)&&(o&&o._id===y&&b(_=>{if(!_)return _;const U=[..._.uploadedImages||[]],ae=new Date(N),M=U.findIndex(Ee=>new Date(Ee.date).toDateString()===ae.toDateString());return M!==-1?U[M]={...U[M],uploads:[...U[M].uploads,...E]}:U.push({date:ae.toISOString(),uploads:E}),{..._,uploadedImages:U}}),f({title:"Images Uploaded",description:`New images uploaded by ${m.uploadedByRole}`}))},v=m=>{const{taskId:y,date:N,remainingImages:E,deletedBy:B}=m;B!==(w==null?void 0:w.id)&&(o&&o._id===y&&b(_=>{var ae;if(!_)return _;const U=(ae=_.uploadedImages)==null?void 0:ae.map(M=>M.date.split("T")[0]===N?{...M,uploads:E}:M);return{..._,uploadedImages:U}}),f({title:"Image Deleted",description:`Image deleted by ${m.deletedByRole}`}))};return k.on("workSchedule:task_created",r),k.on("workSchedule:task_updated",u),k.on("workSchedule:task_deleted",x),k.on("workSchedule:image_uploaded",j),k.on("workSchedule:image_deleted",v),()=>{k.off("workSchedule:task_created",r),k.off("workSchedule:task_updated",u),k.off("workSchedule:task_deleted",x),k.off("workSchedule:image_uploaded",j),k.off("workSchedule:image_deleted",v)}},[le,w==null?void 0:w.id,o,P,I]);const p=r=>`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}`,O=r=>{const u=p(r);return P.flatMap(x=>(x.dailyTasks||[]).filter(v=>(typeof v.datePlanned=="string"?v.datePlanned.split("T")[0]:new Date(v.datePlanned).toISOString().split("T")[0])===u).map(v=>({...v,scheduleId:x._id})))},Z=r=>{const u=O(r);L(r),V(u),u.length===1?(b(u[0]),W(!1)):u.length>1&&(W(!0),b(null))},we=r=>{switch(r){case"completed":return"bg-green-200 text-green-800";case"in_progress":return"bg-yellow-200 text-yellow-800";case"planned":return"bg-blue-200 text-blue-800";default:return"bg-gray-200 text-gray-800"}},me=r=>{const u=P.find(x=>x._id===r);u&&(Y(u),l(!0))},Re=r=>{H(r),se(!0)},Q=async r=>{var u,x;try{await Fe({scheduleId:r.scheduleId,taskId:r._id,projectId:A}),L(null),b(null),K(),f({title:"Success",description:"deleted successfully"})}catch(j){f({title:"Error",description:((x=(u=j==null?void 0:j.response)==null?void 0:u.data)==null?void 0:x.message)||"failed to delete",variant:"destructive"})}},D=async(r,u)=>{var x,j,v;if(g)try{const m=(x=P==null?void 0:P.find(y=>y.dailyTasks.some(N=>N._id===u._id)))==null?void 0:x._id;if(m){const y=await ne.mutateAsync({scheduleId:m,taskId:u._id,date:g.toISOString().split("T")[0],projectId:A,files:r});K(),b(N=>{var B;if(!N)return N;const E=(B=N.uploadedImages)==null?void 0:B.find(_=>new Date(_.date).toDateString()===g.toDateString());return E?(E.uploads.push(...y.uploads),{...N,uploadedImages:[...N.uploadedImages]}):{...N,uploadedImages:[...N.uploadedImages||[],y]}}),f({title:"Success",description:"image uploaded successfully"})}}catch(m){f({title:"Error",description:((v=(j=m==null?void 0:m.response)==null?void 0:j.data)==null?void 0:v.message)||"failed to upload",variant:"destructive"})}},_e=async(r,u)=>{var x,j,v;try{const m=(x=P==null?void 0:P.find(y=>y.dailyTasks.some(N=>N._id===u._id)))==null?void 0:x._id;if(m){await Pe.mutateAsync({scheduleId:m,taskId:u._id,date:(g==null?void 0:g.toISOString().split("T")[0])||"",projectId:A,imageId:r}),K();const y=(g==null?void 0:g.toISOString().split("T")[0])||"";b(N=>{var B;if(!N)return N;const E=(B=N.uploadedImages)==null?void 0:B.map(_=>_.date.split("T")[0]===y?{..._,uploads:_.uploads.filter(U=>U._id!==r)}:_);return{...N,uploadedImages:E}}),f({title:"Success",description:"deleted successfully"})}}catch(m){f({title:"Error",description:((v=(j=m==null?void 0:m.response)==null?void 0:j.data)==null?void 0:v.message)||"failed to delete",variant:"destructive"})}},te=r=>{d(u=>{const x=new Date(u);return x.setMonth(u.getMonth()+r),x})};return Ae?e.jsx(lt,{}):ye?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-exclamation-triangle text-4xl text-red-600 mb-4"}),e.jsx("p",{className:"text-red-600",children:"Error loading schedule data"})]})}):location.pathname.includes("workreport")?e.jsx(Ls,{}):e.jsx("div",{className:"max-h-full overflow-y-auto bg-gray-50",children:e.jsx("div",{className:" mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("header",{className:"flex justify-between items-center mb-6",children:[e.jsxs("button",{className:"bg-gray-100 rounded-lg px-2 py-1 cursor-pointer",onClick:()=>{be(-1)},children:[e.jsx("i",{className:"fas fa-arrow-left mr-1 "}),"back"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Work Schedule Calendar"}),e.jsxs("div",{className:"flex gap-2",children:[oe&&e.jsxs("button",{onClick:()=>l(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-plus"}),"Add Events"]}),e.jsxs("button",{className:"bg-gray-100 rounded-lg px-2 py-1 cursor-pointer",onClick:()=>{be("workreport")},children:[e.jsx("i",{className:"fas fas-file-lines mr-1 "}),"Work Report Lists"]})]})]}),e.jsxs("section",{className:"flex justify-between items-center mb-4",children:[e.jsx("button",{onClick:()=>te(-1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsx("h2",{className:"text-xl font-semibold",children:G.toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>te(1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),e.jsxs("section",{className:"grid grid-cols-7 gap-1 mb-4",children:[["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(r=>e.jsx("div",{className:"p-3 text-center font-semibold text-gray-600 bg-gray-100",children:r},r)),R.map((r,u)=>{const x=O(r.date);return e.jsxs("div",{className:`min-h-[120px] p-2 border border-gray-200 cursor-pointer hover:bg-gray-50 ${r.isCurrentMonth?"bg-white":"bg-gray-50"}`,onClick:()=>Z(r.date),children:[e.jsx("div",{className:"font-medium text-sm mb-1",children:r.date.getDate()}),x.length===0?e.jsx("div",{className:"text-xs text-gray-400 italic",children:"No tasks assigned"}):e.jsxs("div",{className:"space-y-1",children:[x.slice(0,2).map((j,v)=>e.jsx("div",{className:`text-xs p-1 rounded truncate ${we(j.status)}`,children:j.workDescription||j.room},v)),x.length>2&&e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["+",x.length-2," more"]})]})]},u)})]}),g&&e.jsxs("div",{onClick:()=>{Y(null),L(null),b(null),W(!1)},className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-around z-50",children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),de()},className:"p-2 text-gray-600 bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsxs("div",{onClick:r=>r.stopPropagation(),className:"bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold",children:["Tasks for ",g.toLocaleDateString()]}),e.jsx("button",{onClick:()=>{Y(null),L(null),b(null),W(!1)},className:"text-gray-500 hover:text-gray-700",children:e.jsx("i",{className:"fas fa-times text-xl"})})]}),S.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fas fa-calendar-times text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"No tasks assigned for this date"})]}):I&&S.length>1?e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Select a task to view details:"}),S.map((r,u)=>e.jsx("div",{className:"border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>{b(r),W(!1)},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-lg",children:r.workDescription}),e.jsxs("p",{className:"text-gray-600",children:["Room: ",r.room]}),e.jsxs("p",{className:"text-gray-600",children:["Time: ",r.startTime," - ",r.endTime]})]}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${we(r.status)}`,children:r.status})]})},u))]}):o?e.jsxs("div",{className:"space-y-6",children:[S.length>1&&e.jsxs("button",{onClick:()=>{W(!0),b(null)},className:"text-blue-600 hover:text-blue-800 mb-4",children:[e.jsx("i",{className:"fas fa-arrow-left mr-2"}),"Back to task list"]}),e.jsxs("div",{className:"border rounded-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h4",{className:"text-xl font-bold",children:o.workDescription}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${we(o.status)}`,children:o.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 text-gray-700 mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Room/Unit:"})," ",o.room]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Time:"})," ",o.startTime," - ",o.endTime]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Materials:"})," ",((Ie=o.materialsNeeded)==null?void 0:Ie.join(", "))||"None"]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Manpower:"})," ",o.manpower]})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"text-lg font-semibold",children:"Task Images"}),(oe||ke)&&e.jsxs("label",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded cursor-pointer transition-colors",children:[ne.isPending&&e.jsx("span",{className:"animate-spin fas fa-spinner mr-1"}),e.jsx("i",{className:"fas fa-upload mr-2"}),"Upload Images",e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:r=>{r.target.files&&D(Array.from(r.target.files),o)}})]})]}),o!=null&&o.uploadedImages&&(o==null?void 0:o.uploadedImages.length)>0?e.jsx("div",{className:"",children:(()=>{const r=((o==null?void 0:o.uploadedImages)||[]).reduce((x,j)=>{if(!Array.isArray(j==null?void 0:j.uploads)||j.uploads.length===0)return x;let v="Unknown Date";if(j!=null&&j.date){const m=new Date(j.date);v=isNaN(m.getTime())?String(j.date):m.toISOString().split("T")[0]}return x[v]||(x[v]=[]),x[v].push(...j.uploads),x},{}),u=Object.keys(r);return u.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]}):u.map(x=>e.jsx("div",{className:"mb-4",children:e.jsx(Le,{imageFiles:r[x],...Ne?{handleDeleteFile:j=>_e(j,o)}:{},refetch:K,height:120,minWidth:120,maxWidth:140})},x))})()}):e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]})]}),e.jsxs("div",{className:"mt-6 flex gap-3 pt-4 border-t",children:[Ne&&e.jsxs("button",{onClick:()=>Q(o),className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors",children:[e.jsx("i",{className:"fas fa-trash mr-2"}),"Delete Task"]}),(ke||oe)&&e.jsxs(e.Fragment,{children:[" ",e.jsx(F,{onClick:()=>me(o.scheduleId),children:"Edit Task"}),e.jsx(F,{onClick:()=>Re(o.scheduleId),children:"Create Report"})]})]})]})]}):S.length===1?(b(S[0]),null):null]}),e.jsx("button",{onClick:r=>{r.stopPropagation(),ce()},className:"p-2 text-gray-600  bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),Te&&re&&e.jsxs("div",{className:"fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm flex items-center justify-center",children:[e.jsx("div",{onClick:()=>{se(!1),H(null)},className:"absolute inset-0"}),e.jsxs("div",{onClick:r=>r.stopPropagation(),className:"relative z-10 bg-white rounded-lg shadow-lg max-w-4xl w-full mx-auto max-h-[90vh] overflow-y-auto p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Create Work Report"}),e.jsx("button",{className:"text-gray-500 hover:text-red-600 text-xl",onClick:()=>{se(!1),H(null)},children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx(nt,{dailyScheduleId:re,date:o==null?void 0:o.datePlanned,dailyTaskId:o==null?void 0:o._id},re)]})]}),q&&e.jsx(rt,{projectId:A,isOpen:q,onClose:()=>{l(!1),Y(null)},onSave:()=>{l(!1)},refetch:K,scheduleId:X?o==null?void 0:o.scheduleId:null,editData:X,onUpdate:()=>{L(null),b(null),W(!1)}})]})})})};export{It as default};
