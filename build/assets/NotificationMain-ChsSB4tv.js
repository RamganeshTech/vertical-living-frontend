import{j as e,Z as M,B as _,a as $,o as R,a1 as E,r as f,a0 as j,M as H,q as A}from"./index-MXS_gbde.js";import{u as L,a as S,b as B}from"./notificationApi-DBnhtTab.js";const F=({deleteMutation:v,notification:s,onDelete:l,frontendUrl:a})=>{var d;const i=(r=>{switch(r){case"warning":return{icon:"fa-exclamation-triangle",bgColor:"bg-amber-50",borderColor:"border-l-amber-400",badgeBg:"bg-amber-100",badgeText:"text-amber-700"};case"assignment":return{icon:"fa-tasks",bgColor:"bg-blue-50",borderColor:"border-l-blue-400",badgeBg:"bg-blue-100",badgeText:"text-blue-700"};case"info":default:return{icon:"fa-info-circle",bgColor:"bg-slate-50",borderColor:"border-l-slate-400",badgeBg:"bg-slate-100",badgeText:"text-slate-700"}}})(s.type),g=r=>{const c=new Date(r),n=new Date,b=n.getTime()-c.getTime(),x=Math.floor(b/6e4),u=Math.floor(b/36e5),w=Math.floor(b/864e5);return x<1?"Just now":x<60?`${x}m ago`:u<24?`${u}h ago`:w<7?`${w}d ago`:c.toLocaleDateString("en-US",{month:"short",day:"numeric",year:c.getFullYear()!==n.getFullYear()?"numeric":void 0})},h=(()=>{var n;if(!((n=s==null?void 0:s.navigation)!=null&&n.url))return null;const r=a.endsWith("/")?a.slice(0,-1):a,c=s.navigation.url.startsWith("/")?s.navigation.url:`/${s.navigation.url}`;return`${r}${c}`})();return e.jsx(M,{to:h||"",onClick:()=>{(s==null?void 0:s.fromModule)!=="tool"&&l(s._id)},children:e.jsx("div",{className:`${i.bgColor} cursor-pointer border-l-4 ${i.borderColor} rounded-lg p-4 mb-3 transition-all duration-200 hover:shadow-md ${s.isRead?"":"ring-1 ring-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 pt-1",children:e.jsx("i",{className:`fas ${i.icon} text-lg ${i.badgeText}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 leading-relaxed",children:s.message}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:g(s.createdAt)})]})}),h&&e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsxs(M,{to:h,className:"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors",onClick:()=>{(s==null?void 0:s.fromModule)!=="tool"&&l(s._id)},children:[((d=s.navigation)==null?void 0:d.label)||"View Details",e.jsx("i",{className:"fas fa-arrow-right text-xs"})]})})]}),e.jsx("div",{className:"flex-shrink-0 flex gap-2",children:e.jsx(_,{variant:"danger",isLoading:v.isPending&&v.variables.notificationId===s._id,onClick:r=>{r.preventDefault(),r.stopPropagation(),l(s._id)},className:"!p-1 px-2  bg-red-600 !text-white hover:bg-red-600 transition-colors rounded",title:"Delete notification",size:"sm",children:e.jsx("i",{className:"fas fa-xmark text-sm"})})})]})})})},U=()=>{var C,T;const v=$(),s=R(),l=E(t=>t.authStore),{data:a,fetchNextPage:y,hasNextPage:i,isFetchingNextPage:g,isLoading:k,isError:h,error:d}=L(20),{mutateAsync:r}=S(),c=B(),n=f.useRef(null),b=f.useRef(null),x=f.useRef(0);f.useEffect(()=>{const t=s==null?void 0:s.id;if(!t)return;j.emit("join_notifications",{userId:t});const o=p=>{console.log("ðŸ”” New notification received:",p);const N=n.current;A.invalidateQueries({queryKey:["notifications","infinite"]}),setTimeout(()=>{N==null||N.scrollTo({top:0,behavior:"smooth"})},100)},m=()=>{A.invalidateQueries({queryKey:["notifications","unread-count"]})};return j.on("new_notification",o),j.on("unread_count_update",m),()=>{j.off("new_notification",o),j.off("unread_count_update",m)}},[s==null?void 0:s.id]);const u=((T=(C=a==null?void 0:a.pages)==null?void 0:C.flatMap(t=>t==null?void 0:t.notifications))==null?void 0:T.sort((t,o)=>{var m,p;return((m=new Date(o.createdAt))==null?void 0:m.getTime())-((p=new Date(t.createdAt))==null?void 0:p.getTime())}))??[];console.log("data.pages.",a==null?void 0:a.pages),f.useEffect(()=>{const t=n.current;if(!t)return;const o=()=>{t.scrollHeight-t.scrollTop-t.clientHeight<100&&i&&!g&&(console.log("ðŸ“œ Loading older notifications..."),x.current=t.scrollHeight,y().then(()=>{requestAnimationFrame(()=>{const N=t.scrollHeight-x.current;t.scrollTop=t.scrollTop+N})}))};return t.addEventListener("scroll",o),()=>t.removeEventListener("scroll",o)},[i,g,y]),f.useEffect(()=>{a&&(async()=>{await r()})()},[a,r]);const w="https://houseofram.in",D=async t=>{try{await c.mutateAsync({notificationId:t})}catch(o){console.error("Error deleting notification:",o)}};return k?e.jsx(H,{}):h?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-exclamation-circle"}),e.jsxs("span",{children:["Error loading notifications: ",(d==null?void 0:d.message)||"Unknown error"]})]})})}):e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col bg-white",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-slate-200 flex-shrink-0",children:e.jsx("div",{className:"px-4 md:px-6 py-2 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{onClick:()=>v(-1),className:"cursor-pointer w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-arrow-left text-blue-600 text-lg"})}),e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-bell text-blue-600 text-lg"})}),e.jsx("div",{children:e.jsxs("h1",{className:"text-xl md:text-2xl font-bold text-slate-900",children:["Notifications ",l!=null&&l.userName?`for (${l==null?void 0:l.userName})`:""]})})]})})}),e.jsx("div",{ref:n,className:"flex-1 overflow-y-auto p-4 md:p-6",style:{scrollBehavior:"auto"},children:u.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-8 text-center",children:[e.jsx("i",{className:"fas fa-bell text-4xl text-slate-300 mb-3 block"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No notifications yet"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"You're all caught up! Check back later for updates."})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:u.map(t=>e.jsx(F,{notification:t,onDelete:D,deleteMutation:c,frontendUrl:w},t._id))}),e.jsxs("div",{ref:b,className:"flex justify-center py-2",children:[g&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Loading earlier notifications..."})]}),!i&&u.length>0&&e.jsx("p",{className:"text-slate-400 text-xs font-medium",children:"Youâ€™ve reached the end"})]})]})})]})};export{U as default};
