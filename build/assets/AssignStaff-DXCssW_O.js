import{z as _,r as x,j as e}from"./index-DkfQDeIt.js";import{B as g}from"./Button-C-chqFKc.js";import{I as $}from"./Input-lr8I7tVA.js";import{t as d}from"./toast-BSC5QTk1.js";import{u as k}from"./useMutation-BWlLDX_I.js";import{u as M,g as O}from"./roleCheck-DNL7PxQZ.js";import{u as q}from"./getAllUsersApi-CuWWGdu9.js";const B=async({stageName:n,projectId:s,api:o,startedAt:c})=>{const r=c?{startedAt:c}:{},{data:a}=await o.post(`/starttimer/start/${n}/${s}`,r);if(!a.ok)throw new Error(a.message);return a.data},G=()=>{const n=["owner","staff","CTO"],{role:s}=M(),o=O(s),c=_();return k({mutationFn:async({stageName:r,projectId:a,startedAt:h})=>{if(!s||!n.includes(s))throw new Error("Not allowed to start timer.");if(!o)throw new Error("API instance missing.");return await B({stageName:r,projectId:a,api:o,startedAt:h})},onSuccess:(r,a)=>{c.invalidateQueries({queryKey:["stage",a.stageName,a.projectId]})}})},I=n=>{const s=Math.floor(n/1e3),o=Math.floor(s/(3600*24)),c=Math.floor(s%(3600*24)/3600),r=Math.floor(s%3600/60),a=s%60;return`${o}d ${c}h ${r}m ${a}s`},te=({startedAt:n,stageName:s,projectId:o,completedAt:c,deadLine:r,formId:a,deadLineMutate:h,isPending:f,refetchStageMutate:j})=>{const[y,b]=x.useState(new Date),[p,w]=x.useState(r?new Date(r).toISOString().split("T")[0]:""),[D,t]=x.useState(!1),[N,v]=x.useState(!1),[m,R]=x.useState(""),{mutateAsync:z,isPending:F}=G();x.useEffect(()=>{const l=setInterval(()=>{b(new Date)},1e3);return()=>clearInterval(l)},[]);const S=n?new Date(n):null,T=c?new Date(c):null,E=r?new Date(r):null,P=()=>{if(!S)return"Not started yet";if(S&&T){const u=T.getTime()-S.getTime();return`âœ… Completed in: ${I(u)}`}if(E){const u=E.getTime()-y.getTime();return u<=0?e.jsx("span",{className:"text-red-600 font-semibold",children:"âš ï¸ Deadline has reached"}):`â³ Remaining: ${I(u)}`}const l=y.getTime()-S.getTime();return`ðŸ•’ Running: ${I(l)}`},C=l=>l?l.toLocaleString("en-IN",{timeZone:"Asia/Kolkata",dateStyle:"medium",timeStyle:"short"}):"Not Available",L=async()=>{var l,u;try{if(!a||!p)return;const i=p.length===10?`${p}T00:00:00`:p,A=new Date(i);if(isNaN(A.getTime()))return d({title:"Invalid Date",description:"Please pick a valid date & time",variant:"destructive"});if(A<new Date)return d({title:"Invalid Date",description:"Deadline cannot be in the past",variant:"destructive"});await h({formId:a,projectId:o,deadLine:i}),j(),t(!1),d({title:"Success",description:"Deadline updated successfully"})}catch(i){d({title:"Error",description:((u=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:u.message)||"Failed to update deadline",variant:"destructive"})}},U=async()=>{var l,u;try{if(!m)return d({title:"Error",description:"Please pick a date"});const i=new Date(m);if(isNaN(i.getTime()))return d({title:"Invalid Date",description:"Please provide a valid date & time.",variant:"destructive"});if(i<new Date)return d({title:"Invalid Date",description:"The started time cannot be in the past.",variant:"destructive"});await z({projectId:o,stageName:s,startedAt:i.toISOString()}),await j(),d({title:"Success",description:"Started time updated"}),v(!1)}catch(i){d({title:"Error",description:((u=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:u.message)||(i==null?void 0:i.message)||"Failed to update started time",variant:"destructive"})}};return e.jsxs("div",{className:"text-sm w-full text-blue-900 space-y-3",children:[e.jsxs("div",{className:"flex w-full justify-between flex-wrap gap-x-6 gap-y-2 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-play text-blue-500"}),e.jsx("strong",{children:"Started On:"})," ",C(S),!N&&e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>v(!0),children:[e.jsx("i",{className:"fa-solid fa-pen mr-1"})," Edit"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-flag-checkered text-green-500"}),e.jsx("strong",{children:"Completed On:"})," ",C(T)]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-calendar text-purple-600"}),e.jsx("strong",{children:"Deadline:"})," ",C(E),!D&&e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>t(!0),children:[e.jsx("i",{className:"fa-solid fa-pen mr-1"})," Edit"]})]})]}),e.jsx("div",{className:"font-semibold text-blue-700",children:P()}),N&&e.jsxs("div",{className:"flex w-full flex-wrap gap-3 pt-2 items-center",children:[e.jsx($,{type:"datetime-local",value:m,min:new Date().toISOString().slice(0,16),onChange:l=>R(l.target.value),className:"max-w-xs"}),e.jsx(g,{onClick:U,isLoading:F,variant:"primary",children:"Update StartedAt"}),e.jsx(g,{onClick:()=>v(!1),variant:"ghost",children:"Cancel"})]}),D&&e.jsxs("div",{className:"flex w-full flex-wrap gap-3 pt-2 items-center",children:[e.jsx($,{type:"datetime-local",value:p,min:new Date().toISOString().slice(0,16),onChange:l=>w(l.target.value),className:"max-w-xs"}),e.jsx(g,{onClick:L,isLoading:f,className:"bg-blue-600 text-white",children:"Update Deadline"}),e.jsx(g,{onClick:()=>t(!1),variant:"ghost",children:"Cancel"})]})]})},K=async(n,s,o,c)=>(await c.put(`/assignstafftostage/${n}/${s}/${o}`)).data,Q=()=>{const{role:n}=M(),s=O(n),o=["owner","CTO","staff"];return k({mutationFn:async({projectId:c,staffId:r,stageName:a})=>{if(!n)throw new Error("Not Authorized");if(!n||!o.includes(n))throw new Error("Not allowed to Access this api");if(!s)throw new Error("API not found");return K(c,r,a,s)}})};function se({stageName:n,projectId:s,organizationId:o,currentAssignedStaff:c,className:r=""}){const[a,h]=x.useState(!1),[f,j]=x.useState(c),{data:y,isLoading:b}=q(o,"staff"),{mutateAsync:p}=Q(),w=y,D=async t=>{var N,v;try{await p({projectId:s,staffId:t._id,stageName:n}),j(t),d({title:"Success",description:`${t.staffName} assigned to ${n}`}),h(!1)}catch(m){d({title:"Error",description:((v=(N=m==null?void 0:m.response)==null?void 0:N.data)==null?void 0:v.message)||(m==null?void 0:m.message)||"Failed to assign staff",variant:"destructive"})}};return e.jsxs("div",{className:`relative inline-flex items-center px-2 py-2 sm:py-1 rounded-lg text-sm shadow-sm border-[#92abc4] sm:border-none ${r} `,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-gray-700 whitespace-nowrap",children:[e.jsx("span",{className:"font-medium hidden sm:inline text-blue-800",children:"Staff:"})," ",e.jsx("span",{className:"font-medium inline sm:hidden text-blue-800",children:"Staff Member:"})," ",f?e.jsx("span",{className:"text-gray-800 font-semibold",children:f==null?void 0:f.staffName}):e.jsx("span",{className:"text-gray-400 text-[12px]  italic",children:"Not Assigned"})]}),e.jsx(g,{size:"sm",variant:"ghost",className:"text-blue-600 hover:bg-blue-50 px-2 py-1 text-xs",onClick:()=>h(!a),children:a?e.jsx("i",{className:"fas fa-xmark text-red-600"}):e.jsx("i",{className:"fas fa-pencil text-blue-600"})})]}),a&&e.jsx("div",{className:"absolute z-10 top-full left-[0%] sm:left-[-20%] mt-2 w-[200px] bg-white border border-blue-200 rounded-md shadow-lg max-h-48 overflow-auto text-sm",children:b?e.jsx("div",{className:"p-3 text-gray-500 text-center",children:"Loading..."}):w.length===0?e.jsx("div",{className:"p-3 text-gray-400 text-center",children:"No staff available"}):e.jsx("ul",{className:"divide-y divide-blue-100 max-h-40 overflow-y-auto custom-scrollbar",children:w==null?void 0:w.map(t=>e.jsxs("li",{onClick:()=>D(t),className:"px-3 py-2 hover:bg-blue-50 cursor-pointer",children:[e.jsx("span",{className:"font-medium text-blue-700 block truncate",children:(t==null?void 0:t.staffName)||(t==null?void 0:t.name)}),e.jsx("span",{className:"text-xs text-gray-500 truncate",children:t==null?void 0:t.email})]},t==null?void 0:t._id))})})]})}export{se as A,te as S};
