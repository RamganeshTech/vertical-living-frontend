import{u as Z,r as h,j as e}from"./index-C2KHEypQ.js";import{B as u}from"./Button-Cz-akwNZ.js";import{u as ee}from"./customerAccountApi-igjK-uv2.js";import{S as se}from"./SearchSelectNew-DXgMXAyq.js";import{L as D}from"./Label-DwpAHG3d.js";import{d as te,f}from"./formatCurrency-Cj-u22jQ.js";import{C as ae,a as re}from"./Card-C6pBT2vm.js";import{ORDERMATERIAL_UNIT_OPTIONS as ne}from"./OrderMaterialOverview-B6TD8e7F.js";import{d as le}from"./downloadFile--yCVHHwF.js";import{u as oe}from"./projectApi-BtQy_PTR.js";import{t as R}from"./toast-BSC5QTk1.js";import{I as ce}from"./InfoToolTip-BYTiJ2_K.js";const ye=({mode:w,initialData:o,onSubmit:q,isSubmitting:C,organizationId:S})=>{var _;const T=Z(),[x,j]=h.useState(w),{data:N}=ee(S),k={customerId:"",customerName:"",projectId:null,projectName:null,orderNumber:"",accountsReceivable:"",salesPerson:"",subject:"",invoiceDate:new Date().toISOString().split("T")[0],terms:"",dueDate:new Date(Date.now()+10*24*60*60*1e3).toISOString().split("T")[0],items:[{itemName:"",rate:0,unit:"nos",quantity:1,totalCost:0}],discountPercentage:0,taxPercentage:0,customerNotes:"",termsAndConditions:""},[I,O]=h.useState(!1),[r,i]=h.useState(k),[m,V]=h.useState({totalAmount:0,discountAmount:0,taxAmount:0,grandTotal:0}),{mutateAsync:L,isPending:U}=te(),G=async()=>{var s,a;try{await L({id:o._id}),R({title:"Success",description:"Invoice sent to Accounts Department"})}catch(t){R({variant:"destructive",title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||(t==null?void 0:t.message)||"operation failed"})}},F=s=>{var a;return{customerId:((a=s.customerId)==null?void 0:a._id)||(s==null?void 0:s.customerId)||null,customerName:s.customerName||"",orderNumber:s.orderNumber||"",projectId:s.projectId||null,projectName:s.projectName||null,accountsReceivable:s.accountsReceivable||"",salesPerson:s.salesPerson||"",subject:s.subject||"",invoiceDate:s.invoiceDate?new Date(s.invoiceDate).toISOString().split("T")[0]:"",terms:s.terms||"",dueDate:s.dueDate?new Date(s.dueDate).toISOString().split("T")[0]:"",items:s.items&&s.items.length>0?s.items:[{itemName:"",quantity:1,unit:"nos",rate:0,totalCost:0}],discountPercentage:s.discountPercentage||0,taxPercentage:s.taxPercentage||0,customerNotes:s.customerNotes||"",termsAndConditions:s.termsAndConditions||"",pdfData:s.pdfData}};h.useEffect(()=>{o&&(i(F(o)),w==="view"&&j("view"))},[o,w]),h.useEffect(()=>{const s=r.items.reduce((c,p)=>c+(p.totalCost||0),0),a=s*r.discountPercentage/100,t=s-a,n=t*r.taxPercentage/100,d=t+n;V({totalAmount:s,discountAmount:a,taxAmount:n,grandTotal:d})},[r.items,r.discountPercentage,r.taxPercentage]);const M=(_=N||[])==null?void 0:_.map(s=>({value:s._id,label:s.customerName,email:s.email})),{data:P}=oe(S),b=P==null?void 0:P.map(s=>({_id:s._id,projectName:s.projectName})),B=()=>{j("edit")},$=()=>{j("view"),o&&i(F(o))},g=s=>{const{name:a,value:t}=s.target;i(n=>({...n,[a]:t}))},E=s=>{const{name:a,value:t}=s.target,n=parseFloat(t)||0;i(d=>({...d,[a]:n<0?0:n}))},Q=()=>{i(s=>({...s,items:[...s.items,{itemName:"",quantity:1,unit:"nos",rate:0,totalCost:0}]}))},z=s=>{i(a=>({...a,items:a.items.filter((t,n)=>n!==s)}))},y=(s,a,t)=>{i(n=>{const d=[...n.items],c={...d[s]};if(a==="itemName"){const p=c.itemName;c.itemName=t;const W=s===n.items.length-1,X=p.trim()==="",Y=t.trim()!=="";W&&X&&Y&&d.push({itemName:"",quantity:1,rate:0,unit:"nos",totalCost:0})}else if(a==="quantity"||a==="rate"){const p=typeof t=="string"?parseFloat(t)||0:t;c[a]=p<0?0:p,c.totalCost=c.quantity*c.rate}else a==="unit"&&(c.unit=t);return d[s]=c,{...n,items:d}})},H=s=>{const a=[];return s.customerName.trim()||a.push("Customer name is required"),s.items.forEach((t,n)=>{t.itemName.trim()&&t.rate<=0&&a.push(`Item ${n+1}: Rate must be greater than 0`)}),a},J=s=>{const a=N==null?void 0:N.find(t=>t._id===s);i(t=>({...t,customerId:s||"",customerName:(a==null?void 0:a.customerName)||""}))},K=async s=>{s.preventDefault();const a=r.items.filter(c=>c.itemName.trim()!=="");if(a.length===0){alert("Please add at least one item");return}const t={...r,items:a},n=H(t);if(n.length>0){alert(n.join(`
`));return}const d={...t,organizationId:"",totalAmount:m.totalAmount,discountAmount:m.discountAmount,taxAmount:m.taxAmount,grandTotal:m.grandTotal};try{await q(d),x==="edit"&&j("view"),x==="create"&&i(k)}catch{console.error("Form submission failed")}},l=x==="view",v=x==="create",A=x==="edit";return e.jsxs("div",{className:"max-w-full mx-auto space-y-2",children:[e.jsxs("header",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex justify-between items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>T(-1),className:"bg-blue-100 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-file-invoice mr-3 text-blue-600"}),v?"Create Invoice":A?"Update Invoice":"View Invoice"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:v?"Fill in the details to create a new invoice":A?"Update the invoice details":"Invoice details"})]})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"flex items-center space-y-1",children:[e.jsx(u,{variant:"primary",isLoading:U,onClick:G,children:"Send To Accounts Dept"}),e.jsx(ce,{content:"Click the button to send the payment to accounts department",type:"info",position:"bottom"})]}),x==="view"&&e.jsxs(u,{type:"button",onClick:B,className:"bg-blue-600 text-white",children:[e.jsx("i",{className:"fas fa-edit mr-2"}),"Edit"]})]})]}),e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx("i",{className:"fas fa-file-alt mr-2 text-blue-600"}),"Invoice Details"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx(D,{children:"Customer"}),e.jsx(se,{options:M,placeholder:"Select Customer",searchPlaceholder:"Search Customer...",value:(r==null?void 0:r.customerId)||void 0,onValueChange:s=>J(s),searchBy:"name",displayFormat:"simple",className:"w-full"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"checkbox",className:"cursor-pointer",checked:I,id:"enableName",onChange:()=>O(s=>!s)}),e.jsx(D,{htmlFor:"enableName",className:"cursor-pointer",children:"Click to enter name manually"})]}),e.jsx("input",{type:"text",name:"customerName",value:r.customerName,onChange:s=>{I&&g(s)},disabled:l||!I,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sales Person"}),e.jsx("input",{type:"text",name:"salesPerson",value:r.salesPerson,onChange:g,disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Remarks"}),e.jsx("input",{type:"text",name:"subject",value:r.subject,onChange:g,disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Invoice Date"}),e.jsx("input",{type:"date",name:"invoiceDate",value:r.invoiceDate,onChange:g,disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Due Date"}),e.jsx("input",{type:"date",name:"dueDate",value:r.dueDate,onChange:g,disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Project"}),e.jsxs("select",{value:(r==null?void 0:r.projectId)||"",disabled:l,onChange:s=>{const a=b==null?void 0:b.find(t=>t._id===s.target.value);i(a?t=>({...t,projectId:a._id,projectName:a.projectName}):t=>({...t,projectId:null,projectName:null}))},className:" disabled:bg-gray-100 disabled:cursor-not-allowed w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Projects"}),b==null?void 0:b.map(s=>e.jsx("option",{value:s._id,children:s.projectName},s._id))]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-list mr-2 text-blue-600"}),"Invoice Items ",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),!l&&e.jsxs(u,{type:"button",onClick:Q,variant:"primary",children:[e.jsx("i",{className:"fas fa-plus mr-2"}),"Add Item"]})]}),r.items.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fas fa-inbox text-4xl mb-2"}),e.jsx("p",{children:"No items added yet."})]}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("div",{className:"grid grid-cols-14 gap-3 mb-2 px-4 py-3 bg-gray-100 rounded-lg font-semibold text-gray-700 text-sm",children:[e.jsx("div",{className:"col-span-1 text-center",children:"#"}),e.jsxs("div",{className:"col-span-4 text-center",children:["Item Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"col-span-2 text-center",children:"Unit"}),e.jsx("div",{className:"col-span-2 text-center",children:"Quantity"}),e.jsxs("div",{className:"col-span-2 text-center",children:["Rate ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"col-span-2 text-center",children:"Total"}),!l&&e.jsx("div",{className:"col-span-1 text-center",children:"Action"})]}),e.jsx("div",{className:"space-y-2",children:r.items.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-14 gap-3 px-4 py-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300 transition-colors items-center",children:[e.jsx("div",{className:"col-span-1 text-center text-gray-600 font-medium",children:a+1}),e.jsx("div",{className:"col-span-4",children:e.jsx("input",{type:"text",value:s.itemName,onChange:t=>y(a,"itemName",t.target.value),disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm disabled:bg-gray-100",placeholder:"Enter item name"})}),e.jsx("div",{className:"col-span-2",children:e.jsx("select",{value:s.unit,onChange:t=>y(a,"unit",t.target.value),disabled:l,className:"w-full px-3 py-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 bg-white text-sm disabled:bg-gray-100",children:ne.map(t=>e.jsx("option",{value:t,children:t},t))})}),e.jsx("div",{className:"col-span-2",children:e.jsx("input",{type:"number",value:s.quantity,onChange:t=>y(a,"quantity",t.target.value),disabled:l,min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm disabled:bg-gray-100"})}),e.jsx("div",{className:"col-span-2",children:e.jsx("input",{type:"number",value:s.rate,onChange:t=>y(a,"rate",t.target.value),disabled:l,min:"0",step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm disabled:bg-gray-100"})}),e.jsx("div",{className:"col-span-2 text-center font-semibold text-gray-900",children:f(s.totalCost)}),e.jsx("div",{className:"col-span-1 text-center",children:!l&&e.jsx("button",{type:"button",onClick:()=>z(a),disabled:r.items.length===1,className:"text-red-600 cursor-pointer hover:text-red-800 disabled:text-gray-400 p-2",children:e.jsx("i",{className:"fas fa-trash"})})})]},a))})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 mb-4 flex items-center",children:[e.jsx("i",{className:"fas fa-calculator mr-2 text-blue-600"}),"Discount & Tax"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Discount Percentage (%)"}),e.jsx("input",{type:"number",name:"discountPercentage",value:r.discountPercentage,onChange:E,disabled:l,min:"0",max:"100",step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-lg disabled:bg-gray-100"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tax Percentage (%)"}),e.jsx("input",{type:"number",name:"taxPercentage",value:r.taxPercentage,onChange:E,disabled:l,min:"0",max:"100",step:"0.01",className:"w-full px-3 py-2 border border-gray-300 rounded-lg disabled:bg-gray-100"})]})]})]}),e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm p-6 border border-blue-100",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-blue-200",children:[e.jsx("span",{className:"text-gray-700 font-medium",children:"Subtotal:"}),e.jsx("span",{className:"text-xl font-semibold text-gray-900",children:f(m.totalAmount)})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-blue-200",children:[e.jsx("span",{className:"text-gray-700 font-medium",children:"Discount:"}),e.jsxs("span",{className:"text-xl font-semibold text-green-600",children:["-",f(m.discountAmount)]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-blue-200",children:[e.jsx("span",{className:"text-gray-700 font-medium",children:"Tax:"}),e.jsx("span",{className:"text-xl font-semibold text-gray-900",children:f(m.taxAmount)})]}),e.jsxs("div",{className:"flex justify-between items-center py-3 bg-blue-100 px-4 rounded-lg",children:[e.jsx("span",{className:"text-lg font-bold text-gray-900",children:"Grand Total:"}),e.jsx("span",{className:"text-2xl font-bold text-blue-600",children:f(m.grandTotal)})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer Notes"}),e.jsx("textarea",{name:"customerNotes",value:r.customerNotes,onChange:g,disabled:l,rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg disabled:bg-gray-100"})]}),(o==null?void 0:o.pdfData)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:"Invoice Pdf"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Generate a PDF document for the invoice"})]})}),e.jsx(ae,{className:"border-green-200 bg-green-50",children:e.jsx(re,{className:"p-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("i",{className:"fas fa-check-circle text-green-600 text-2xl"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-green-900",children:o.pdfData.originalName}),e.jsx("p",{className:"text-sm text-green-700",children:"Invoice PDF is ready"})]})]}),e.jsxs("div",{className:"gap-2 flex items-center",children:[e.jsx(u,{type:"button",variant:"outline",onClick:()=>window.open(o.pdfData.url,"_blank"),className:"",children:"View PDF"}),e.jsx(u,{type:"button",variant:"primary",onClick:()=>le({src:o.pdfData.url,alt:o.pdfData.originalName}),className:"",children:"download PDF"})]})]})})})]}),!l&&e.jsxs("div",{className:"flex justify-end gap-4 pt-6",children:[e.jsxs(u,{type:"button",onClick:A?$:()=>T(-1),className:"bg-gray-500 text-white px-6 py-2",disabled:C,children:[e.jsx("i",{className:"fas fa-times mr-2"}),"Cancel"]}),e.jsx(u,{type:"submit",className:"bg-blue-600 text-white px-6 py-2",disabled:C,children:C?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-2"})," Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:`fas ${v?"fa-plus":"fa-save"} mr-2`})," ",v?"Create Invoice":"Update Invoice"]})})]})]})]})};export{ye as I};
