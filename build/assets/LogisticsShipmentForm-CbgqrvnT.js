import{b as N,q as I,r as C,j as e}from"./index-e25x2Bps.js";import{B as S}from"./Button-KF95J_5e.js";import{L as y}from"./Label-DWVJTy_f.js";import{I as p}from"./Input-Rsb-PiAm.js";import{u as R}from"./projectApi-BbvOkph3.js";import{u as K}from"./useQuery-CvvWn2i9.js";import{u as E}from"./useMutation-D72r7dXD.js";import{g as b}from"./roleCheck-Do9EccPs.js";import{t as k}from"./toast-BSC5QTk1.js";const V=async({projectId:s,organizationId:n,payload:a,projectName:r,api:h})=>{const{data:c}=await h.post(`/department/logistics/shipment/create/${s}/${n}/${r}`,a);if(!c.ok)throw new Error(c.message);return c.data},W=async({projectId:s,organizationId:n,shipmentId:a,payload:r,api:h})=>{const{data:c}=await h.put(`/department/logistics/shipment/update/${s}/${n}/${a}`,r);if(!c.ok)throw new Error(c.message);return c.data},G=async({shipmentId:s,organizationId:n,api:a})=>{const{data:r}=await a.delete(`/department/logistics/shipment/delete/${n}/${s}`);if(!r.ok)throw new Error(r.message);return r.message},O=async({api:s,organizationId:n,status:a,projectId:r,scheduledDate:h})=>{const c=new URLSearchParams({organizationId:n});a&&c.append("status",a),r&&c.append("projectId",r),h&&c.append("scheduledDate",h);const{data:v}=await s.get(`/department/logistics/shipment/getshipment?${c.toString()}`);if(!v.ok)throw new Error(v.message);return v==null?void 0:v.data},M=async({api:s,shipmentId:n})=>{const{data:a}=await s.get(`/department/logistics/shipment/getsingle/${n}`);if(!a.ok)throw new Error(a.message);return a==null?void 0:a.data},P=["owner","CTO","staff"],H=()=>{const{role:s}=N(),n=b(s);return E({mutationFn:async({projectId:a,organizationId:r,payload:h,projectName:c})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await V({projectId:a,organizationId:r,payload:h,projectName:c,api:n})},onSuccess:()=>{I.invalidateQueries({queryKey:["logistics","shipments"]})}})},Y=()=>{const{role:s}=N(),n=b(s);return E({mutationFn:async({projectId:a,organizationId:r,shipmentId:h,payload:c})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await W({projectId:a,organizationId:r,shipmentId:h,payload:c,api:n})},onSuccess:()=>{I.invalidateQueries({queryKey:["logistics","shipments"]})}})},le=()=>{const{role:s}=N(),n=b(s);return E({mutationFn:async({organizationId:a,shipmentId:r})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await G({shipmentId:r,organizationId:a,api:n})},onSuccess:()=>{I.invalidateQueries({queryKey:["logistics","shipments"]})}})},ce=(s,n)=>{const{role:a}=N(),r=b(a);return K({queryKey:["logistics","shipments",n],queryFn:async()=>{if(!a||!P.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance not found for role");return await O({api:r,organizationId:s,status:n==null?void 0:n.status,projectId:n==null?void 0:n.projectId,scheduledDate:n==null?void 0:n.scheduledDate})},retry:!1,enabled:!!s})},oe=s=>{const{role:n}=N(),a=b(n);return K({queryKey:["logistics","single"],queryFn:async()=>{if(!n||!P.includes(n))throw new Error("Not allowed");if(!a)throw new Error("API instance not found for role");return await M({api:a,shipmentId:s})},retry:!1,enabled:!!s})},de=()=>{const{role:s}=N(),n=b(s);return E({mutationFn:async({organizationId:a,projectId:r,fromDept:h,totalCost:c,upiId:v})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await z({organizationId:a,projectId:r,fromDept:h,totalCost:c,api:n,upiId:v})},onSuccess:()=>{I.invalidateQueries({queryKey:["logistics","shipments"]})}})},z=async({api:s,organizationId:n,projectId:a,fromDept:r,totalCost:h,upiId:c})=>{const{data:v}=await s.post(`/department/logistics/syncaccounting/${n}/${a}`,{totalCost:h,fromDept:r,upiId:c});return v},T=s=>{if(!s)return"";const n=new Date(s),a=g=>String(g).padStart(2,"0"),r=n.getFullYear(),h=a(n.getMonth()+1),c=a(n.getDate()),v=a(n.getHours()),w=a(n.getMinutes());return`${r}-${h}-${c}T${v}:${w}`},ue=({shipment:s,onClose:n,organizationId:a})=>{var q;const{mutateAsync:r,isPending:h}=H(),{mutateAsync:c,isPending:v}=Y(),{data:w}=R(a),g=w==null?void 0:w.map(t=>({_id:t._id,projectName:t.projectName})),[f,$]=C.useState({_id:"",projectName:""}),[l,j]=C.useState({status:"pending",vehicleDetails:{vehicleNumber:"",vehicleType:"truck",driverCharge:0,driver:{name:"",phone:"",licenseNumber:""},driverUpiId:""},origin:{address:"",contactPerson:"",contactPhone:""},destination:{address:"",contactPerson:"",contactPhone:""},items:[{name:"",quantity:0}],scheduledDate:"",actualPickupTime:"",actualDeliveryTime:"",notes:""});C.useEffect(()=>{s&&(j({...l,...s,scheduledDate:s.scheduledDate?T(s.scheduledDate):"",actualPickupTime:s.actualPickupTime?T(s.actualPickupTime):"",actualDeliveryTime:s.actualDeliveryTime?T(s.actualDeliveryTime):""}),$(()=>{const t=g==null?void 0:g.find(i=>i._id===(s==null?void 0:s.projectId));return{_id:s.projectId,projectName:t==null?void 0:t.projectName}}))},[s]),C.useEffect(()=>{s||g&&g.length>0&&(console.log("projects",g),$(()=>{var t,i;return{_id:(t=g[0])==null?void 0:t._id,projectName:(i=g[0])==null?void 0:i.projectName}}))},[w]);const m=t=>{const{name:i,value:o}=t.target;if(i.startsWith("origin.")){const u=i.split(".")[1];j(d=>({...d,origin:{...d.origin,[u]:o}}))}else if(i.startsWith("destination.")){const u=i.split(".")[1];j(d=>({...d,destination:{...d.destination,[u]:o}}))}else if(i.startsWith("vehicleDetails.driver.")){const u=i.split(".")[2];j(d=>({...d,vehicleDetails:{...d.vehicleDetails,driver:{...d.vehicleDetails.driver,[u]:o}}}))}else if(i.startsWith("vehicleDetails.")){const u=i.split(".")[1];j(d=>({...d,vehicleDetails:{...d.vehicleDetails,[u]:o}}))}else j(u=>({...u,[i]:o}))},Q=t=>{var o,u,d,x,_,A,D,L;const i=[];return(o=t==null?void 0:t.origin)!=null&&o.contactPhone&&!/^\d{10}$/.test((u=t==null?void 0:t.origin)==null?void 0:u.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(d=t==null?void 0:t.destination)!=null&&d.contactPhone&&!/^\d{10}$/.test((x=t==null?void 0:t.destination)==null?void 0:x.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(A=(_=t==null?void 0:t.vehicleDetails)==null?void 0:_.vehicleNumber)!=null&&A.trim()||i.push("vehicle number is required."),((D=t==null?void 0:t.items)==null?void 0:D.length)>0&&((L=t==null?void 0:t.items)==null||L.forEach((F,U)=>{F.name||i.push(`Item ${U+1} is missing a name.`),F.quantity<0&&i.push(`Item ${U+1} has invalid quantity.`)})),i},B=async()=>{var t,i;try{const o=Q(l);if(o.length>0){o.forEach(u=>{k({title:"Validation Error",description:u,variant:"destructive"})});return}s?await c({shipmentId:s._id,organizationId:a,projectId:f==null?void 0:f._id,payload:l}):await r({organizationId:a,projectId:f._id,payload:l,projectName:f.projectName}),k({title:"success",description:"shipment has generated"}),n()}catch(o){k({title:"Error",description:((i=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:i.message)||"Operation Failed",variant:"destructive"})}};return e.jsx("div",{onClick:n,className:"fixed inset-0 bg-black/60 flex justify-center items-center z-50",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),className:"bg-white rounded-xl p-6 shadow-lg w-[90vw] max-w-[1300px] h-[90vh] flex flex-col",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:s?"Edit Shipment":"Create Shipment"}),e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto p-2 sm:p-4 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-blue-700",children:"Shipment Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Select Project"}),e.jsx("select",{className:"w-full px-3 py-2 border rounded-xl",name:"projectID",value:f._id,onChange:t=>{const i=g==null?void 0:g.find(o=>o._id===t.target.value);i&&$({_id:i._id,projectName:i.projectName})},children:g==null?void 0:g.map(t=>e.jsx("option",{value:t._id,children:t.projectName},t._id))})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Status"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded-xl",name:"status",value:l.status,onChange:m,children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"assigned",children:"Assigned"}),e.jsx("option",{value:"in_transit",children:"In Transit"}),e.jsx("option",{value:"delivered",children:"Delivered"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Scheduled Date"}),e.jsx(p,{type:"datetime-local",name:"scheduledDate",value:l.scheduledDate,onChange:m})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-green-700",children:"Vehicle Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(p,{name:"vehicleDetails.vehicleNumber",placeholder:"Vehicle Number",required:!0,value:l.vehicleDetails.vehicleNumber,onChange:m}),e.jsxs("select",{name:"vehicleDetails.vehicleType",value:l.vehicleDetails.vehicleType,onChange:m,className:"w-full px-3 py-2 border rounded-xl",children:[e.jsx("option",{value:"truck",children:"Truck"}),e.jsx("option",{value:"van",children:"Van"}),e.jsx("option",{value:"car",children:"Car"}),e.jsx("option",{value:"bike",children:"Bike"}),e.jsx("option",{value:"tempo",children:"Tempo"}),e.jsx("option",{value:"container",children:"Container"})]}),e.jsx(p,{name:"vehicleDetails.driver.name",placeholder:"Driver Name",value:l.vehicleDetails.driver.name,onChange:m}),e.jsx(p,{name:"vehicleDetails.driver.phone",type:"tel",maxLength:10,placeholder:"Driver Phone",value:l.vehicleDetails.driver.phone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}}),e.jsx(p,{name:"vehicleDetails.driver.licenseNumber",placeholder:"License Number",value:l.vehicleDetails.driver.licenseNumber,onChange:m}),e.jsx(p,{name:"vehicleDetails.driverCharge",type:"number",placeholder:"Driver Charge",value:(q=l==null?void 0:l.vehicleDetails)==null?void 0:q.driverCharge,onChange:t=>{const i=t.target.value;(i===""||Number(i)>=0)&&m(t)}}),e.jsx(p,{name:"vehicleDetails.driverUpiId",type:"text",placeholder:"Driver Upi",value:l.vehicleDetails.driverUpiId||"",onChange:t=>{m(t)}})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-yellow-700 mb-2",children:"Origin & Destination"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Origin"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"origin.address",placeholder:"Address",value:l.origin.address,onChange:m}),e.jsx(p,{name:"origin.contactPerson",placeholder:"Contact Person",value:l.origin.contactPerson,onChange:m}),e.jsx(p,{name:"origin.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:l.origin.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Destination"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"destination.address",placeholder:"Address",value:l.destination.address,onChange:m}),e.jsx(p,{name:"destination.contactPerson",placeholder:"Contact Person",value:l.destination.contactPerson,onChange:m}),e.jsx(p,{name:"destination.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:l.destination.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-700 mb-2",children:"Timing Schedule"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Actual Pickup Time"}),e.jsx(p,{type:"datetime-local",name:"actualPickupTime",value:l.actualPickupTime,onChange:m})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Actual Delivery Time"}),e.jsx(p,{type:"datetime-local",name:"actualDeliveryTime",value:l.actualDeliveryTime,onChange:m})]})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Notes"}),e.jsx("textarea",{name:"notes",className:"w-full px-3 py-2 border rounded-xl",rows:3,value:l.notes,onChange:m})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-pink-700 mb-2",children:"Shipment Items"}),e.jsxs("div",{className:"space-y-4",children:[l.items.map((t,i)=>e.jsxs("div",{className:"grid grid-cols-12  items-center gap-2 sm:gap-4",children:[e.jsxs("div",{className:"col-span-6 sm:col-span-5",children:[e.jsx(y,{children:"Item Name"}),e.jsx(p,{name:`item-name-${i}`,value:t.name,placeholder:"e.g. Wooden Pallets",onChange:o=>{const u=o.target.value;j(d=>{const x=[...d.items];return x[i].name=u,i===x.length-1&&u.trim()!==""&&x.push({name:"",quantity:0}),u.trim()===""&&i<x.length-1&&x.splice(i,1),{...d,items:x}})}})]}),e.jsxs("div",{className:"col-span-4 sm:col-span-3",children:[e.jsx(y,{children:"Quantity"}),e.jsx(p,{type:"number",name:`item-qty-${i}`,value:t.quantity,placeholder:"e.g. 10",onChange:o=>{const u=parseInt(o.target.value)||0;Number(u)>=0&&j(d=>{const x=[...d.items];return x[i].quantity=u,{...d,items:x}})}})]}),e.jsx("div",{className:"col-span-2 sm:col-span-2 flex mt-5 place-items-center h-full",children:e.jsx(S,{variant:"danger",size:"md",type:"button",className:"text-white bg-red-600",onClick:()=>{j(o=>({...o,items:o.items.filter((u,d)=>d!==i)}))},children:e.jsx("i",{className:"fas fa-trash"})})})]},i)),e.jsx("div",{children:e.jsxs(S,{variant:"outline",size:"sm",type:"button",onClick:()=>j(t=>({...t,items:[...t.items,{name:"",quantity:0}]})),children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Item"]})})]})]})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-3 border-t mt-5",children:[e.jsx(S,{variant:"outline",onClick:n,children:"Cancel"}),e.jsx(S,{isLoading:v||h,onClick:()=>B(),children:s?"Update":"Create"})]})]})})};export{ue as L,ce as a,oe as b,de as c,T as f,le as u};
