import{c as I,x as _,d as M,g as O,r as x,j as e,B as g,I as A,t as d}from"./index-CUvv9ev0.js";import{u as q}from"./getAllUsersApi-0yi3cLLK.js";const B=async({stageName:a,projectId:s,api:o,startedAt:c})=>{const i=c?{startedAt:c}:{},{data:n}=await o.post(`/starttimer/start/${a}/${s}`,i);if(!n.ok)throw new Error(n.message);return n.data},G=()=>{const a=["owner","staff","CTO"],{role:s}=I(),o=O(s),c=_();return M({mutationFn:async({stageName:i,projectId:n,startedAt:h})=>{if(!s||!a.includes(s))throw new Error("Not allowed to start timer.");if(!o)throw new Error("API instance missing.");return await B({stageName:i,projectId:n,api:o,startedAt:h})},onSuccess:(i,n)=>{c.invalidateQueries({queryKey:["stage",n.stageName,n.projectId]})}})},k=a=>{const s=Math.floor(a/1e3),o=Math.floor(s/(3600*24)),c=Math.floor(s%(3600*24)/3600),i=Math.floor(s%3600/60),n=s%60;return`${o}d ${c}h ${i}m ${n}s`},V=({startedAt:a,stageName:s,projectId:o,completedAt:c,deadLine:i,formId:n,deadLineMutate:h,isPending:w,refetchStageMutate:y})=>{const[b,D]=x.useState(new Date),[p,f]=x.useState(i?new Date(i).toISOString().split("T")[0]:""),[v,t]=x.useState(!1),[S,N]=x.useState(!1),[m,P]=x.useState(""),{mutateAsync:R,isPending:F}=G();x.useEffect(()=>{const l=setInterval(()=>{D(new Date)},1e3);return()=>clearInterval(l)},[]);const j=a?new Date(a):null,T=c?new Date(c):null,C=i?new Date(i):null,z=()=>{if(!j)return"Not started yet";if(j&&T){const u=T.getTime()-j.getTime();return`âœ… Completed in: ${k(u)}`}if(C){const u=C.getTime()-b.getTime();return u<=0?e.jsx("span",{className:"text-red-600 font-semibold",children:"âš ï¸ Deadline has reached"}):`â³ Remaining: ${k(u)}`}const l=b.getTime()-j.getTime();return`ðŸ•’ Running: ${k(l)}`},E=l=>l?l.toLocaleString("en-IN",{timeZone:"Asia/Kolkata",dateStyle:"medium",timeStyle:"short"}):"In Progress",L=async()=>{var l,u;try{if(!n||!p)return;const r=p.length===10?`${p}T00:00:00`:p,$=new Date(r);if(isNaN($.getTime()))return d({title:"Invalid Date",description:"Please pick a valid date & time",variant:"destructive"});if($<new Date)return d({title:"Invalid Date",description:"Deadline cannot be in the past",variant:"destructive"});await h({formId:n,projectId:o,deadLine:r}),y(),t(!1),d({title:"Success",description:"Deadline updated successfully"})}catch(r){d({title:"Error",description:((u=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:u.message)||"Failed to update deadline",variant:"destructive"})}},U=async()=>{var l,u;try{if(!m)return d({title:"Error",description:"Please pick a date"});const r=new Date(m);if(isNaN(r.getTime()))return d({title:"Invalid Date",description:"Please provide a valid date & time.",variant:"destructive"});await R({projectId:o,stageName:s,startedAt:r.toISOString()}),await y(),d({title:"Success",description:"Started time updated"}),N(!1)}catch(r){d({title:"Error",description:((u=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:u.message)||(r==null?void 0:r.message)||"Failed to update started time",variant:"destructive"})}};return e.jsxs("div",{className:"text-sm w-full text-blue-900 space-y-3",children:[e.jsxs("div",{className:"flex w-full justify-between flex-wrap gap-x-6 gap-y-2 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-play text-blue-500"}),e.jsx("strong",{children:"Started On:"})," ",E(j),!S&&e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[e.jsx("i",{className:"fa-solid fa-pen mr-1"})," Edit"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-flag-checkered text-green-500"}),e.jsx("strong",{children:"Completed On:"})," ",E(T)]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-calendar text-purple-600"}),e.jsx("strong",{children:"Deadline:"})," ",E(C),!v&&e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>t(!0),children:[e.jsx("i",{className:"fa-solid fa-pen mr-1"})," Edit"]})]})]}),e.jsx("div",{className:"font-semibold text-blue-700",children:z()}),S&&e.jsxs("div",{className:"flex w-full flex-wrap gap-3 pt-2 items-center",children:[e.jsx(A,{type:"datetime-local",value:m,onChange:l=>P(l.target.value),className:"max-w-xs"}),e.jsx(g,{onClick:U,isLoading:F,variant:"primary",children:"Update StartedAt"}),e.jsx(g,{onClick:()=>N(!1),variant:"ghost",children:"Cancel"})]}),v&&e.jsxs("div",{className:"flex w-full flex-wrap gap-3 pt-2 items-center",children:[e.jsx(A,{type:"datetime-local",value:p,min:new Date().toISOString().slice(0,16),onChange:l=>f(l.target.value),className:"max-w-xs"}),e.jsx(g,{onClick:L,isLoading:w,className:"bg-blue-600 text-white",children:"Update Deadline"}),e.jsx(g,{onClick:()=>t(!1),variant:"ghost",children:"Cancel"})]})]})},K=async(a,s,o,c)=>(console.log("staffid",s),(await c.put(`/assignstafftostage/${a}/${s}/${o}`)).data),Q=()=>{const{role:a}=I(),s=O(a),o=["owner","CTO","staff"];return M({mutationFn:async({projectId:c,staffId:i,stageName:n})=>{if(!a)throw new Error("Not Authorized");if(!a||!o.includes(a))throw new Error("Not allowed to Access this api");if(!s)throw new Error("API not found");return K(c,i,n,s)}})};function W({stageName:a,projectId:s,organizationId:o,currentAssignedStaff:c,className:i=""}){const[n,h]=x.useState(!1),[w,y]=x.useState(c),{data:b,isLoading:D}=q(o,"staff"),{mutateAsync:p}=Q(),f=b,v=async t=>{var S,N;try{await p({projectId:s,staffId:(t==null?void 0:t._id)||null,stageName:a}),y(t),t!=null&&t.staffName?d({title:"Success",description:`${t.staffName} assigned to ${a}`}):d({title:"Success",description:`No staff assigned to ${a}`}),h(!1)}catch(m){d({title:"Error",description:((N=(S=m==null?void 0:m.response)==null?void 0:S.data)==null?void 0:N.message)||(m==null?void 0:m.message)||"Failed to assign staff",variant:"destructive"})}};return e.jsxs("div",{className:`relative inline-flex items-center px-2 py-2 sm:py-1 rounded-lg text-sm shadow-sm border-[#92abc4] sm:border-none ${i} `,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-gray-700 whitespace-nowrap",children:[e.jsx("span",{className:"font-medium hidden sm:inline text-blue-800",children:"Staff:"})," ",e.jsx("span",{className:"font-medium inline sm:hidden text-blue-800",children:"Staff Member:"})," ",w?e.jsx("span",{className:"text-gray-800 font-semibold",children:w==null?void 0:w.staffName}):e.jsx("span",{className:"text-gray-400 text-[12px]  italic",children:"Not Assigned"})]}),e.jsx(g,{size:"sm",variant:"ghost",className:"text-blue-600 hover:bg-blue-50 px-2 py-1 text-xs",onClick:()=>h(!n),children:n?e.jsx("i",{className:"fas fa-xmark text-red-600"}):e.jsx("i",{className:"fas fa-pencil text-blue-600"})})]}),n&&e.jsx("div",{className:"absolute z-10 top-full left-[0%] sm:left-[-20%] mt-2 w-[200px] bg-white border border-blue-200 rounded-md shadow-lg max-h-48 overflow-auto text-sm",children:D?e.jsx("div",{className:"p-3 text-gray-500 text-center",children:"Loading..."}):f.length===0?e.jsx("div",{className:"p-3 text-gray-400 text-center",children:"No staff available"}):e.jsxs("ul",{className:"divide-y divide-blue-100 max-h-40 overflow-y-auto custom-scrollbar",children:[e.jsx("li",{onClick:()=>v(null),className:"px-3 py-2 hover:bg-blue-50 cursor-pointer",children:e.jsx("span",{className:"font-medium text-blue-700 block truncate text-center py-1",children:"Select Staff"})}),f==null?void 0:f.map(t=>e.jsxs("li",{onClick:()=>v(t),className:"px-3 py-2 hover:bg-blue-50 cursor-pointer",children:[e.jsx("span",{className:"font-medium text-blue-700 block truncate",children:(t==null?void 0:t.staffName)||(t==null?void 0:t.name)}),e.jsx("span",{className:"text-xs text-gray-500 truncate",children:t==null?void 0:t.email})]},t==null?void 0:t._id))]})})]})}export{W as A,V as S};
