import{d as M,c as O,r as b,e as T,z,j as e,B as j,L as l,A as c,t as p}from"./index-CBsAK0nv.js";import{u as F,a as G}from"./procurementApi-Dw1XYOpM.js";import{ORDERMATERIAL_UNIT_OPTIONS as Q}from"./OrderMaterialOverview-DPfqeiU4.js";import"./AssignStaff-sIZdITJf.js";import"./ResetStageButton-B7sMo0Hh.js";import"./ShareDocumentWhatsapp-B5KdABdk.js";import"./documentationApi-D-dHEfnd.js";import"./requirementFormApi-Kwdfn7sN.js";import"./orderMaterialHistoryApi-Tv_wZzhK.js";import"./shopLibDetailApi-7Q-KTTTk.js";import"./StageGuide-DK1G5Ici.js";const te=()=>{var I;const f=M(),{organizationId:v}=O(),[a,d]=b.useState({projectId:"",projectName:"",fromDeptNumber:"",fromDeptRefId:null,shopDetails:{shopName:"",contactPerson:"",phoneNumber:"",address:"",upiId:""},deliveryLocationDetails:{siteName:"",siteSupervisor:"",phoneNumber:"",address:""},items:[{subItemName:"",quantity:"",unit:""}]}),N=b.useRef([]),{role:D,permission:x}=T(),w=D==="owner"||((I=x==null?void 0:x.procurement)==null?void 0:I.create),{data:u}=z(v),m=u!=null&&u.data?u.data:Array.isArray(u)?u.map(t=>({_id:t._id,projectName:t.projectName})):[],{data:C,isLoading:P}=F(a.projectId),y=C||[];b.useEffect(()=>{if(m&&m.length>0&&!a.projectId){const t=m[0];d(s=>({...s,projectId:t._id,projectName:t.projectName}))}},[m]);const{mutateAsync:L,isPending:S}=G(),R=t=>{const s=t.target.value,r=m==null?void 0:m.find(i=>i._id===s);d(r?i=>({...i,projectId:r._id,projectName:r.projectName,fromDeptNumber:"",fromDeptRefId:null}):i=>({...i,projectId:"",projectName:"",fromDeptNumber:"",fromDeptRefId:null}))},o=(t,s,r)=>{d(i=>({...i,[t]:{...i[t],[s]:r}}))},g=(t,s,r)=>{const i=[...a.items];i[t]={...i[t],[s]:r};const E=t===i.length-1;if(s==="subItemName"&&t===i.length-1&&r.trim()!==""&&i.push({subItemName:"",quantity:"",unit:""}),!E){const n=i[t],h=!n.subItemName||n.subItemName.toString().trim()==="",U=!n.quantity||n.quantity===0,_=!n.unit||n.unit==="";h&&U&&_&&i.splice(t,1)}d(n=>({...n,items:i})),s==="unit"&&setTimeout(()=>{const n=t+1,h=N.current[n];h==null||h.focus()},50)},q=()=>{d(t=>({...t,items:[...t.items,{subItemName:"",quantity:"",unit:""}]}))},A=t=>{a.items.length<=1||d(s=>({...s,items:s.items.filter((r,i)=>i!==t)}))},k=async()=>{try{if(!a.projectId){p({variant:"destructive",title:"Missing Field",description:"Please select a Project."});return}if(!a.fromDeptNumber){p({variant:"destructive",title:"Missing Field",description:"Please select an Order Material Reference."});return}const t=a.items.filter(i=>i.subItemName.trim()!=="");if(t.length===0){p({variant:"destructive",title:"No Items",description:"Please add at least one valid item."});return}if(t.some(i=>!i.quantity||!i.unit)){p({variant:"destructive",title:"Incomplete Details",description:"All items must have a Quantity and Unit selected."});return}const r={organizationId:v,projectId:a.projectId,fromDeptNumber:a.fromDeptNumber,fromDeptRefId:a.fromDeptRefId,fromDeptName:"Order Material",shopDetails:a.shopDetails,deliveryLocationDetails:a.deliveryLocationDetails,selectedUnits:t.map(i=>({subItemName:i.subItemName,quantity:Number(i.quantity),unit:i.unit,rate:0,totalCost:0}))};await L({payload:r}),p({title:"Success",description:"Procurement Order Created Successfully!"})}catch(t){console.error(t),p({variant:"destructive",title:"Error",description:t.message||"Failed to create procurement."})}};if(w)return e.jsxs("div",{className:"max-w-full mx-auto space-y-6 max-h-full overflow-y-auto",children:[e.jsxs("header",{className:"sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200 pb-4 pt-2 mb-3 flex justify-between items-center px-4",children:[e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>f(-1),className:"bg-blue-50 hover:bg-blue-100 flex items-center justify-center w-8 h-8 border border-blue-200 text-blue-600 text-sm cursor-pointer rounded-md transition-colors",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-receipt mr-3 text-blue-600"}),"Create Procurement"]}),e.jsx("p",{className:"text-gray-500 text-xs sm:text-sm mt-0.5",children:"Generate a new link for vendor pricing"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{variant:"outline",type:"button",onClick:()=>f(-1),className:"hidden sm:flex border-gray-300 text-gray-700",children:"Cancel"}),e.jsx(j,{type:"button",onClick:k,isLoading:S,className:"bg-blue-600 text-white px-6 shadow-md hover:bg-blue-700",children:"Create Order"})]})]}),e.jsxs("form",{className:"space-y-2 max-w-full mx-auto",children:[e.jsx("div",{className:"bg-white rounded-xl p-3",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 divide-y lg:divide-y-0 lg:divide-x divide-gray-100",children:[e.jsxs("div",{className:"lg:pr-6 pb-6 lg:pb-0",children:[e.jsxs("h2",{className:"text-md font-bold text-gray-900 mb-2 flex items-center",children:[e.jsx("i",{className:"fas fa-store mr-2 text-purple-600"})," Shop Details"]}),e.jsxs("div",{className:"",children:[e.jsxs("div",{children:[e.jsx(l,{children:"Shop Name"}),e.jsx(c,{placeholder:"Enter Shop Name",value:a.shopDetails.shopName,onChange:t=>o("shopDetails","shopName",t.target.value),className:"border-gray-300"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(l,{children:"Contact Person"}),e.jsx(c,{placeholder:"Name",value:a.shopDetails.contactPerson,onChange:t=>o("shopDetails","contactPerson",t.target.value),className:"border-gray-300"})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Phone"}),e.jsx(c,{placeholder:"10 Digits",maxLength:10,value:a.shopDetails.phoneNumber,onChange:t=>{/^\d*$/.test(t.target.value)&&o("shopDetails","phoneNumber",t.target.value)},className:"border-gray-300"})]})]}),e.jsxs("div",{children:[e.jsx(l,{children:"UPI ID (Optional)"}),e.jsx(c,{placeholder:"e.g. user@okaxis",value:a.shopDetails.upiId,onChange:t=>o("shopDetails","upiId",t.target.value),className:"border-gray-300"})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Address"}),e.jsx(c,{placeholder:"Shop Location",value:a.shopDetails.address,onChange:t=>o("shopDetails","address",t.target.value),className:"border-gray-300"})]})]})]}),e.jsxs("div",{className:"lg:pl-6 pt-6 lg:pt-0",children:[e.jsxs("h2",{className:"text-md font-bold text-gray-900 mb-2 flex items-center",children:[e.jsx("i",{className:"fas fa-truck mr-2 text-orange-600"})," Delivery Location"]}),e.jsxs("div",{className:"",children:[e.jsxs("div",{children:[e.jsx(l,{children:"Site Name"}),e.jsx(c,{placeholder:"Enter Site Name",value:a.deliveryLocationDetails.siteName,onChange:t=>o("deliveryLocationDetails","siteName",t.target.value),className:"border-gray-300"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(l,{children:"Supervisor"}),e.jsx(c,{placeholder:"Name",value:a.deliveryLocationDetails.siteSupervisor,onChange:t=>o("deliveryLocationDetails","siteSupervisor",t.target.value),className:"border-gray-300"})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Phone"}),e.jsx(c,{placeholder:"10 Digits",maxLength:10,value:a.deliveryLocationDetails.phoneNumber,onChange:t=>{/^\d*$/.test(t.target.value)&&o("deliveryLocationDetails","phoneNumber",t.target.value)},className:"border-gray-300"})]})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Site Address"}),e.jsx(c,{placeholder:"Delivery Location",value:a.deliveryLocationDetails.address,onChange:t=>o("deliveryLocationDetails","address",t.target.value),className:"border-gray-300"})]})]})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl p-3",children:[e.jsxs("h2",{className:"text-md font-bold text-gray-900 mb-4 flex items-center border-b border-gray-200 pb-2",children:[e.jsx("i",{className:"fas fa-file-contract mr-2 text-blue-600"})," Project Details"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs(l,{children:["Project ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:a.projectId,onChange:R,className:"w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Project"}),m.map(t=>e.jsx("option",{value:t._id,children:t.projectName},t._id))]})]}),e.jsxs("div",{children:[e.jsxs(l,{children:["Reference ID ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:a.fromDeptNumber,onChange:t=>{const s=y.find(r=>(r==null?void 0:r.refUniquePdf)===t.target.value);d(r=>({...r,fromDeptNumber:t.target.value,fromDeptRefId:(s==null?void 0:s.fromDeptRefId)||null}))},disabled:!a.projectId,className:"w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white disabled:bg-gray-100 disabled:cursor-not-allowed",children:[e.jsx("option",{value:"",children:P?"Loading...":a.projectId?"Select Order Material Ref":"Select Project First"}),y.map((t,s)=>e.jsx("option",{value:t.refUniquePdf,children:t.refUniquePdf},s))]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-list mr-2 text-blue-600"})," Selected Units",e.jsx("span",{className:"text-red-500 ml-1",children:"*"}),e.jsx("span",{className:"text-xs font-normal text-gray-400 ml-2 hidden sm:inline",children:"(Auto-adds new rows)"})]}),e.jsxs(j,{type:"button",onClick:q,variant:"outline",size:"sm",className:"border-blue-200 text-blue-700 hover:bg-blue-50",children:[e.jsx("i",{className:"fas fa-plus mr-2"})," Add Row"]})]}),e.jsxs("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 px-4 py-3 bg-gray-50 font-semibold text-sm text-gray-700 min-w-[700px]",children:[e.jsx("div",{className:"col-span-1 text-center",children:"#"}),e.jsx("div",{className:"col-span-6",children:"Item Name"}),e.jsx("div",{className:"col-span-2",children:"Quantity"}),e.jsx("div",{className:"col-span-2",children:"Unit"}),e.jsx("div",{className:"col-span-1 text-center",children:"Action"})]}),e.jsx("div",{className:"divide-y divide-gray-100 min-w-[700px]",children:a.items.map((t,s)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 px-4 py-2 bg-white items-center hover:bg-gray-50 transition-colors",children:[e.jsx("div",{className:"col-span-1 text-center text-gray-400 text-sm font-mono",children:s+1}),e.jsx("div",{className:"col-span-6",children:e.jsx("input",{ref:r=>{N.current[s]=r},value:t.subItemName,onChange:r=>g(s,"subItemName",r.target.value),placeholder:s===a.items.length-1?"+ Type to add new item...":"Item Description",className:`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm outline-none transition-all ${s===a.items.length-1?"bg-blue-50/30 border-blue-200 placeholder-blue-400":"border-gray-300"}`})}),e.jsx("div",{className:"col-span-2",children:e.jsx("input",{type:"number",value:t.quantity,onChange:r=>g(s,"quantity",r.target.value),placeholder:"0",min:"0",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm outline-none"})}),e.jsx("div",{className:"col-span-2",children:e.jsxs("select",{value:t.unit,onChange:r=>g(s,"unit",r.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-sm outline-none cursor-pointer",children:[e.jsx("option",{value:"",disabled:!0,children:"Unit"}),Q.map(r=>e.jsx("option",{value:r,children:r},r))]})}),e.jsx("div",{className:"col-span-1 text-center",children:s!==a.items.length-1&&e.jsx("button",{type:"button",onClick:()=>A(s),className:"text-gray-300 hover:text-red-500 p-2 transition-colors",children:e.jsx("i",{className:"fas fa-trash-alt"})})})]},s))})]})]})]})]})};export{te as default};
