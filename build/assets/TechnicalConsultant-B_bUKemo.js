import{c as w,q as v,a as re,d as oe,u as ce,r as h,j as e}from"./index-PP9bwaFb.js";import{I as M}from"./Input-_X1NL7t9.js";import{B as f}from"./Button-De5O-mHo.js";import{L as U}from"./Label-CiUFagGb.js";import{u as de}from"./useQuery-Crlnn1zB.js";import{u as b}from"./useMutation-CnbKwdgs.js";import{g as y}from"./roleCheck-BSRkLz35.js";import{t as p}from"./toast-BSC5QTk1.js";import{C as me}from"./Card-gvD20p1g.js";import{A as ue,S as xe}from"./AssignStaff-CmYESkpA.js";import{R as fe}from"./ResetStageButton-CM5VSQE2.js";import ge from"./MaterialOverviewLoading-DX9W2li4.js";import{d as he}from"./downloadFile-CTU6Oetr.js";import{B as pe}from"./Badge-D3sVig5a.js";import{S as we}from"./ShareDocumentWhatsapp-CB8_nB23.js";import{u as ye}from"./stageSelectionApi-BZ-PDDjU.js";import"./useBaseQuery--We87FtY.js";import"./getAllUsersApi-I1nnZEum.js";import"./Skeleton-Yn6Ls0QM.js";import"./documentationApi-D9Ke8zDL.js";import"./requirementFormApi-D8xGCl0z.js";const je=async({projectId:a,formData:n,api:t})=>{const{data:r}=await t.post(`/technicalconsultation/createmessage/${a}`,n);if(!r.ok)throw new Error(r.message);return r.data},Ne=async({projectId:a,api:n})=>{const{data:t}=await n.get(`/technicalconsultation/getmessages/${a}`);if(!t.ok)throw new Error(t.message);return t.data},ve=async({projectId:a,messageId:n,message:t,senderId:r,senderRole:o,api:m})=>{const{data:u}=await m.put(`/technicalconsultation/editmessage/${a}/${n}`,{message:t,senderId:r,senderRole:o});if(!u.ok)throw new Error(u.message);return u.data},be=async({formId:a,projectId:n,deadLine:t,api:r})=>{const{data:o}=await r.put(`/technicalconsultation/deadline/${n}/${a}`,{deadLine:t});if(!o.ok)throw new Error(o.message);return o.data},Ce=async({projectId:a,api:n})=>{const{data:t}=await n.put(`/technicalconsultation/completionstatus/${a}`);if(!t.ok)throw new Error(t.message);return t.data},Se=a=>{const n=["owner","staff","CTO","worker"],{role:t}=w(),r=y(t);return de({queryKey:["consultationMessages",a],queryFn:async()=>{if(!t||!n.includes(t))throw new Error("Not allowed");if(!r)throw new Error("API not found");return await Ne({projectId:a,api:r})},enabled:!!a,retry:!1,refetchOnMount:!1,refetchOnWindowFocus:!1})},ke=()=>{const a=["owner","staff","CTO","worker"],{role:n}=w(),t=y(n);return b({mutationFn:async({projectId:r,formData:o})=>{if(!n||!a.includes(n))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await je({projectId:r,formData:o,api:t})},onSuccess:(r,{projectId:o})=>{v.invalidateQueries({queryKey:["consultationMessages",o]})}})},Ee=()=>{const a=["owner","staff","CTO","worker"],{role:n}=w(),t=y(n);return b({mutationFn:async({projectId:r,messageId:o,message:m,senderId:u})=>{if(!n||!a.includes(n))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await ve({projectId:r,messageId:o,message:m,senderId:u,senderRole:n,api:t})},onSuccess:(r,{projectId:o})=>{v.invalidateQueries({queryKey:["consultationMessages",o]})}})},Me=()=>{const a=["owner","staff","CTO"],{role:n}=w(),t=y(n);return b({mutationFn:async({projectId:r})=>{if(!n||!a.includes(n))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await Ce({projectId:r,api:t})},onSuccess:(r,{projectId:o})=>{v.invalidateQueries({queryKey:["consultationMessages",o]})}})},Ae=()=>{const a=["owner","staff","CTO"],{role:n}=w(),t=y(n);return b({mutationFn:async({formId:r,projectId:o,deadLine:m})=>{if(!n)throw new Error("not authorized");if(!a.includes(n))throw new Error("you  dont have the access to make this api");if(!t)throw new Error("api is null");return await be({formId:r,projectId:o,deadLine:m,api:t})},onSuccess:(r,{projectId:o})=>{v.invalidateQueries({queryKey:["consultationMessages",o]})}})},Xe=()=>{var q,z,K,B,Q,G;const{projectId:a,organizationId:n}=re(),{isMobile:t,openMobileSidebar:r}=oe(),{role:o,_id:m}=w(),u=ce(),{data:g,isLoading:W}=ye(a),[j,A]=h.useState(""),[T,L]=h.useState([]),[C,S]=h.useState(null),[k,N]=h.useState(""),[P,E]=h.useState(null),[I,F]=h.useState(!1);let{data:Y,isLoading:R,error:x,isError:H,refetch:O}=Se(a);const i=Y,{mutateAsync:J,isPending:V}=ke(),{mutateAsync:X,isPending:Z}=Ee(),{mutateAsync:D,isPending:ee}=Ae(),_=Me(),se=async()=>{var s,c;try{await _.mutateAsync({projectId:a}),p({description:"Completion status updated successfully",title:"Success"}),W?alert("Please navigate to next stage manually , you havet selected the stage yet"):g.mode?g&&g.mode==="Manual Flow"?u("../materialselection"):g&&(g==null?void 0:g.mode)==="Modular Units"&&u("../modularunits"):u("../selectstage")}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||l.message||"Failed to update completion status",variant:"destructive"})}},$=async()=>{var s,c;try{if(!j&&T.length===0)throw new Error("please write anything");const l=new FormData;j&&l.append("message",j),o&&l.append("senderRole",o),l.append("sender",m),T.forEach(d=>l.append("attachments",d)),await J({projectId:a,formData:l}),A(""),L([]),p({description:"message sent successfully",title:"Success"})}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||(l==null?void 0:l.message)||"Failed to send the message",variant:"destructive"})}},ae=(s,c)=>{S(s),N(c)},te=()=>{S(null),N("")},ne=async()=>{var s,c;try{if(!C||!k)throw new Error("please write anything");await X({projectId:a,messageId:C,message:k,senderId:m}),S(null),N(""),p({description:"message edited successfully",title:"Success"})}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||(l==null?void 0:l.message)||"Failed to edit the message",variant:"destructive"})}};if(R)return e.jsx(ge,{});console.log("techDoc",i);const le=(s,c)=>{if(s==="owner")return c.username;if(s==="staff")return c.staffName;if(s==="worker")return c.workerName;if(s=="CTO")return c.CTOName};return e.jsxs("div",{className:"container mx-auto  max-w-full max-h-full",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-2",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[t&&e.jsx("button",{onClick:r,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-comments mr-2"})," Technical Consultation"]}),e.jsxs("div",{className:"w-full lg:w-[60%]  flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(f,{isLoading:_.isPending,onClick:se,className:"bg-green-600 hover:bg-green-700 text-white flex-1 sm:flex-initial min-w-max",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsxs("div",{className:"flex flex-wrap sm:flex-nowrap gap-2 justify-end",children:[e.jsx(fe,{projectId:a,stageNumber:4,stagePath:"technicalconsultation",className:"flex-1 sm:flex-initial min-w-max"}),!x&&e.jsx(we,{projectId:a,stageNumber:"4",className:"w-full sm:w-fit",isStageCompleted:i==null?void 0:i.status}),e.jsx(ue,{stageName:"TechnicalConsultationModel",projectId:a,organizationId:n,currentAssignedStaff:(i==null?void 0:i.assignedTo)||null,className:"flex-1 sm:flex-initial min-w-max"})]})]})]}),e.jsxs(me,{className:"p-4 mb-3 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(xe,{stageName:"technicalconsultation",completedAt:(q=i==null?void 0:i.timer)==null?void 0:q.completedAt,projectId:a,formId:i==null?void 0:i._id,deadLine:(z=i==null?void 0:i.timer)==null?void 0:z.deadLine,startedAt:(K=i==null?void 0:i.timer)==null?void 0:K.startedAt,refetchStageMutate:O,deadLineMutate:D,isPending:ee})]}),e.jsx("div",{className:" flex flex-col bg-white rounded-xl p-2 shadow-md border custom-scrollbar min-h-[200px] sm:min-h-[170px] md:min-h-[190px] lg:min-h-[340px] border-gray-200 mb-2 flex-grow max-h-[70vh] sm:!max-h-[30vh] md:!max-h-[30vh] lg:!max-h-[42vh] xl:!max-h-[49vh] overflow-y-auto ",children:e.jsxs("div",{className:"flex flex-col-reverse overflow-y-auto custom-scrollbar  flex-grow p-2  md:!max-h-full space-y-reverse space-y-4",children:[(H||x)&&e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-ban text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:((Q=(B=x==null?void 0:x.response)==null?void 0:B.data)==null?void 0:Q.message)||(x==null?void 0:x.message)||"Failed to load messages, please try again"}),e.jsxs(f,{onClick:()=>O(),className:"mt-4 bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx("i",{className:"fas fa-redo mr-2"})," Retry"]})]})}),R?e.jsxs("div",{className:"flex h-full items-center justify-center py-10",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-blue-600 text-2xl"}),e.jsx("span",{className:"ml-3 text-blue-600 font-medium",children:"Loading messages..."})]}):(i==null?void 0:i.messages.length)===0?e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-envelope text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:"No messages have been posted yet."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation using the box below."})]})}):e.jsx("div",{className:"overflow-y-auto custom-scrollbar flex flex-col-reverse space-y-reverse space-y-4",children:(G=i==null?void 0:i.messages)==null?void 0:G.slice().sort((s,c)=>new Date(c.createdAt).getTime()-new Date(s.createdAt).getTime()).map(s=>{var c,l;return console.log("messge",s),e.jsxs("div",{className:"bg-blue-50 w-full group px-4 py-[5px] rounded-lg shadow flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-xs sm:text-[10px] text-gray-600",children:[le(s.senderRole,s.sender)||((c=s==null?void 0:s.senderRole)==null?void 0:c.toUpperCase())||"User"," - ",new Date(s.createdAt).toLocaleString(),s.isEdited&&e.jsxs(pe,{className:"sm:ml-2 my-1 sm:my-0",children:[" ",e.jsxs("p",{className:"hidden sm:inline-block",children:["message is  "," "," "]}),"   edited by ",s.senderRole]})]}),e.jsx("div",{className:"opacity-0 scale-95 group-hover:opacity-100 transition-all duration-300",children:(s.sender._id===m||o==="owner"||o==="CTO")&&e.jsx("div",{className:"flex gap-2",children:e.jsx(f,{variant:"secondary",onClick:()=>ae(s._id,s.message),className:"text-blue-600 text-sm",children:e.jsx("i",{className:"fas fa-edit"})})})})]}),C===s._id?e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-center mt-2",children:[e.jsx(M,{value:k,onChange:d=>N(d.target.value),className:"flex-grow"}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(f,{isLoading:Z,onClick:ne,className:"w-full sm:w-auto",children:"Save"}),e.jsx(f,{variant:"danger",className:"w-full sm:w-auto border-red-200 hover:bg-red-700 bg-red-600 text-white",onClick:te,children:"Cancel"})]})]}):e.jsx("p",{className:"text-gray-900 text-sm",children:s.message}),e.jsx("div",{className:"flex flex-wrap gap-3 mt-3",children:(l=s.attachments)==null?void 0:l.map((d,ie)=>e.jsxs("div",{className:"flex items-center gap-2 bg-white border px-3 py-2 rounded shadow-sm w-full max-w-[280px]",children:[e.jsx("i",{className:`fas ${d.type==="pdf"?"fa-file-pdf text-red-500":"fa-image text-blue-500"}`}),e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 truncate flex-grow min-w-0",children:d.originalName}),d.type==="image"&&e.jsx(f,{size:"sm",variant:"primary",onClick:()=>{E(d.url),F(!0)},children:e.jsx("i",{className:"fas fa-eye"})}),e.jsx(f,{onClick:()=>he({src:d==null?void 0:d.url,alt:(d==null?void 0:d.originalName)||"file.pdf"}),size:"sm",className:"text-sm",children:e.jsx("i",{className:"fa-solid fa-download"})})]},ie))})]},s._id)})})]})}),e.jsxs("div",{className:"bg-white px-4 py-2 rounded-xl shadow-md",children:[e.jsx(U,{htmlFor:"message",children:"Your Message"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mb-3",children:[e.jsx(M,{id:"message",placeholder:"Write something...",value:j,onChange:s=>A(s.target.value),onKeyDown:s=>{s.key==="Enter"&&$()},className:"flex-grow"}),e.jsxs(f,{isLoading:V,onClick:$,className:"w-full sm:w-auto",children:["Send ",e.jsx("i",{className:"ml-2 fa-solid fa-paper-plane"})]})]}),e.jsx(U,{children:"Attach Files (PDF or Image)"}),e.jsx(M,{type:"file",multiple:!0,accept:".pdf,image/*",onChange:s=>L(Array.from(s.target.files||[])),className:""})]}),P&&e.jsx("div",{onClick:()=>E(null),className:"fixed inset-0 z-50 bg-black/60 flex items-center justify-center",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white p-2 sm:p-4 rounded-lg shadow-lg max-w-[90%] max-h-[90%] overflow-auto relative",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{onClick:()=>E(null),className:"text-red-500 text-xl",children:e.jsx("i",{className:"fas fa-times"})})}),e.jsxs("div",{className:"relative min-w-80 ",children:[I&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm",children:e.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-gray-600"})}),e.jsx("img",{src:P,onLoad:()=>F(!1),loading:"lazy",alt:"Preview",className:`max-h-[80vh] rounded transition duration-500 ${I?"blur-sm scale-105":""}`})]})]})})]})};export{Xe as default};
