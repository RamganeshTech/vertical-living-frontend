import{u as w,q as E,a as $,b as P,r as v,j as e}from"./index-Di9fivK2.js";import{u as B}from"./useQuery-D3U2IXUF.js";import{u as k}from"./useMutation-Br_DKCOJ.js";import{g as N}from"./roleCheck-CZ0YkMwP.js";import{t as p}from"./toast-BSC5QTk1.js";import{B as T}from"./Button-CVj9LlQY.js";import D from"./MaterialOverviewLoading-Coogz3JI.js";import"./useBaseQuery-DArxBqcU.js";import"./Skeleton-o7WjJukS.js";const L=async({projectId:o,payload:a,api:n})=>{console.log("paylod from creating",a);const{data:s}=await n.post(`/inventory/create/${o}`,a);if(!s.ok)throw new Error(s.message);return s.data},O=async({projectId:o,subItemId:a,payload:n,api:s})=>{console.log("paylod from updating",n);const{data:c}=await s.put(`/inventory/update/${o}/${a}`,n);if(!c.ok)throw new Error(c.message);return c.data},U=async({projectId:o,subItemId:a,api:n})=>{const{data:s}=await n.delete(`/inventory/delete/${o}/${a}`);if(!s.ok)throw new Error(s.message);return s.data},V=async({projectId:o,api:a})=>{const{data:n}=await a.get(`/inventory/get/${o}`);if(!n.ok)throw new Error(n.message);return n.data},G=()=>{const o=["owner","staff","CTO"],{role:a}=w(),n=N(a);return k({mutationFn:async({projectId:s,payload:c})=>{if(!a||!o.includes(a))throw new Error("not allowed to make this api call");if(!n)throw new Error("API instance not found for role");return await L({projectId:s,payload:c,api:n})},onSuccess:(s,{projectId:c})=>{E.invalidateQueries({queryKey:["inventory",c]})}})},z=()=>{const o=["owner","staff","CTO"],{role:a}=w(),n=N(a);return k({mutationFn:async({projectId:s,subItemId:c,payload:j})=>{if(!a||!o.includes(a))throw new Error("not allowed to make this api call");if(!n)throw new Error("API instance not found for role");return await O({projectId:s,subItemId:c,payload:j,api:n})},onSuccess:(s,{projectId:c})=>{E.invalidateQueries({queryKey:["inventory",c]})}})},H=()=>{const o=["owner","staff","CTO"],{role:a}=w(),n=N(a);return k({mutationFn:async({projectId:s,subItemId:c})=>{if(!a||!o.includes(a))throw new Error("not allowed to make this api call");if(!n)throw new Error("API instance not found for role");return await U({projectId:s,subItemId:c,api:n})},onSuccess:(s,{projectId:c})=>{E.invalidateQueries({queryKey:["inventory",c]})}})},J=o=>{const a=["owner","staff","CTO","worker"],{role:n}=w(),s=N(n);return B({queryKey:["inventory",o],queryFn:async()=>{if(!n||!a.includes(n))throw new Error("not allowed to make this api call");if(!s)throw new Error("API instance not found for role");return await V({projectId:o,api:s})},enabled:!!o&&!!n,retry:!1})},M=["nos","pieces","litre","kg","mm","cm","meter","feet","inch","sqft","sqmm","packet","roll","sheet"],se=()=>{const{projectId:o}=$(),{data:a,isLoading:n,isError:s,error:c}=J(o),j=G(),q=z(),Q=H(),{isMobile:C,openMobileSidebar:F,projectName:S}=P(),[i,m]=v.useState(null),[l,g]=v.useState({name:"",totalQuantity:1,unit:""}),b=v.useRef(null),f=(a==null?void 0:a.subItems)||[];v.useEffect(()=>{i&&b.current&&(b.current.focus(),b.current.select())},[i]);const x=async(t,r,d)=>{var u,h,_,A,R;try{await q.mutateAsync({projectId:o,subItemId:t,payload:{itemName:r==="name"?d:(u=f.find(y=>y._id===t))==null?void 0:u.itemName,totalQuantity:r==="totalQuantity"?Number(d)?Number(d):1:(h=f.find(y=>y._id===t))==null?void 0:h.totalQuantity,unit:r==="unit"?d:(_=f.find(y=>y._id===t))==null?void 0:_.unit,note:""}}),p({title:"Success",description:"Item updated successfully"})}catch(y){p({title:"Error",description:((R=(A=y==null?void 0:y.response)==null?void 0:A.data)==null?void 0:R.message)||"Failed to update item",variant:"destructive"})}},I=async t=>{var r,d;if(!t.name.trim()||!t.unit)return p({title:"Error",description:"Material Name and Unit are mandatory",variant:"destructive"});try{const{name:u,...h}=t;await j.mutateAsync({projectId:o,payload:{...h,itemName:u,note:""}}),g({name:"",totalQuantity:1,unit:""}),p({title:"Success",description:"Item created successfully"})}catch(u){p({title:"Error",description:((d=(r=u==null?void 0:u.response)==null?void 0:r.data)==null?void 0:d.message)||"Failed to create item",variant:"destructive"})}},K=async t=>{var r,d;try{await Q.mutateAsync({projectId:o,subItemId:t}),p({title:"Success",description:"Item deleted successfully"})}catch(u){p({title:"Error",description:((d=(r=u==null?void 0:u.response)==null?void 0:r.data)==null?void 0:d.message)||"Failed to delete item",variant:"destructive"})}};return n?e.jsx("div",{children:e.jsx(D,{})}):s?e.jsxs("div",{children:["Error: ",c.message]}):e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col p-2 min-h-full",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-semibold mb-1 text-blue-600 flex items-center",children:[C&&e.jsx("button",{onClick:F,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fa-solid fa-boxes-stacked mr-2"}),"Inventory Items ",S?`for ${S}`:""]}),e.jsx("p",{className:"text-gray-400",children:"Manage and track project materials in one place"})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 bg-gray-50 h-[95vh] rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("i",{className:"fa-solid fa-list text-blue-600"}),e.jsx("h4",{className:"font-semibold text-gray-800",children:"Material Items"}),e.jsx("span",{className:"text-sm text-gray-500",children:"(Click to edit, changes save by clicking Enter)"})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-gray-100 border-b border-gray-200",children:[e.jsx("div",{className:"col-span-8 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Material Name"}),e.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Total Quantity"}),e.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Remaining Quantity"}),e.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Unit"}),e.jsx("div",{className:"col-span-1 px-4 py-3 text-sm font-medium text-gray-700",children:"Action"})]}),f.map(t=>e.jsxs("div",{className:"grid grid-cols-17 gap-0 border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("div",{className:"col-span-8 border-r border-gray-200",children:(i==null?void 0:i.subItemId)===t._id&&(i==null?void 0:i.field)==="name"?e.jsx("input",{ref:b,type:"text",defaultValue:t.itemName,className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:r=>{var d;(d=l==null?void 0:l.name)!=null&&d.trim()&&(l!=null&&l.unit)&&x(t._id,"name",r.target.value),m(null)},onKeyDown:r=>{r.key==="Enter"&&(x(t._id,"name",r.target.value),m(null)),r.key==="Escape"&&m(null)}}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>m({subItemId:t._id,field:"name"}),children:t.itemName})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:(i==null?void 0:i.subItemId)===t._id&&(i==null?void 0:i.field)==="totalQuantity"?e.jsx("input",{ref:b,type:"number",defaultValue:t.totalQuantity,min:"0",className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:r=>{x(t._id,"totalQuantity",r.target.value),m(null)},onKeyDown:r=>{r.key==="Enter"&&(x(t._id,"totalQuantity",r.target.value),m(null)),r.key==="Escape"&&m(null)}}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>m({subItemId:t._id,field:"totalQuantity"}),children:t.totalQuantity})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>m({subItemId:t._id,field:"totalQuantity"}),children:t.remainingQuantity})}),e.jsx("div",{className:"col-span-3 border-r border-gray-200",children:(i==null?void 0:i.subItemId)===t._id&&(i==null?void 0:i.field)==="unit"?e.jsxs("select",{defaultValue:t.unit,onChange:r=>{x(t._id,"unit",r.target.value),m(null)},className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",children:[e.jsx("option",{value:"",disabled:!0,children:"Selected unit"}),M.map(r=>e.jsx("option",{value:r,children:r},r))]}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>m({subItemId:t._id,field:"unit"}),children:t.unit})}),e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx(T,{variant:"danger",isLoading:Q.isPending,onClick:()=>K(t._id),className:"p-2 bg-red-600 text-white hover:bg-red-50 rounded transition-colors",title:"Delete item",children:e.jsx("i",{className:"fa fa-trash text-sm"})})})]},t._id)),e.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-green-50 border-b border-gray-100",children:[e.jsx("div",{className:"col-span-8 border-r border-gray-200",children:e.jsx("input",{type:"text",placeholder:"Enter material name...",value:l.name,onChange:t=>g({...l,name:t.target.value}),onBlur:()=>{l.name.trim()&&l.unit&&I(l)},onKeyDown:t=>{t.key==="Enter"&&I(l)},className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("input",{type:"number",placeholder:"Qty",min:"0",value:l.totalQuantity,onChange:t=>g({...l,totalQuantity:Number(t.target.value)||0}),className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("input",{type:"number",placeholder:"Remaining Quanitity",disabled:!0,min:"0",value:l.totalQuantity,className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-3 border-r border-gray-200",children:e.jsxs("select",{value:l.unit,onChange:async t=>{g({...l,unit:t.target.value});const r={...l,unit:t.target.value};await I(r)},className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",children:[e.jsx("option",{value:"",disabled:!0,children:"Selected unit"}),M.map(t=>e.jsx("option",{value:t,children:t},t))]})})]}),f.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-inbox text-2xl mb-2"}),e.jsx("p",{className:"text-sm",children:"No sub-items yet. Start typing in the row above to add items."})]})]})]})]})};export{se as default};
