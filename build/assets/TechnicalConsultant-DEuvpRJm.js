import{f as y,b as de,h as C,s as S,i as N,u as me,af as ue,a as xe,k as fe,r as w,j as e,M as he,B as u,t as p}from"./index-BAM0eJUz.js";import{I as T}from"./Input-1UBXZqEj.js";import{L as J}from"./Label-C8i6KaZe.js";import{C as ge}from"./Card-CdxfjEr-.js";import{A as we,S as pe}from"./AssignStaff-Bt6qrEbL.js";import{R as ye}from"./ResetStageButton-DaUxSSZv.js";import{d as je}from"./downloadFile-BbGV_BaX.js";import{B as Ne}from"./Badge-DlwVZlzE.js";import{S as ve}from"./StageGuide-e28gQ0h1.js";import"./getAllUsersApi-O0JEgRtZ.js";const be=async({projectId:n,formData:a,api:t})=>{const{data:i}=await t.post(`/technicalconsultation/createmessage/${n}`,a);if(!i.ok)throw new Error(i.message);return i.data},Ce=async({projectId:n,api:a})=>{const{data:t}=await a.get(`/technicalconsultation/getmessages/${n}`);if(!t.ok)throw new Error(t.message);return t.data},Se=async({projectId:n,messageId:a,message:t,senderId:i,senderRole:r,api:x})=>{const{data:m}=await x.put(`/technicalconsultation/editmessage/${n}/${a}`,{message:t,senderId:i,senderRole:r});if(!m.ok)throw new Error(m.message);return m.data},ke=async({formId:n,projectId:a,deadLine:t,api:i})=>{const{data:r}=await i.put(`/technicalconsultation/deadline/${a}/${n}`,{deadLine:t});if(!r.ok)throw new Error(r.message);return r.data},Ee=async({projectId:n,api:a})=>{const{data:t}=await a.put(`/technicalconsultation/completionstatus/${n}`);if(!t.ok)throw new Error(t.message);return t.data},Ae=n=>{const a=["owner","staff","CTO","worker"],{role:t}=y(),i=N(t);return de({queryKey:["consultationMessages",n],queryFn:async()=>{if(!t||!a.includes(t))throw new Error("Not allowed");if(!i)throw new Error("API not found");return await Ce({projectId:n,api:i})},enabled:!!n,retry:!1,refetchOnMount:!1,refetchOnWindowFocus:!1})},Me=()=>{const n=["owner","staff","CTO","worker"],{role:a}=y(),t=N(a);return C({mutationFn:async({projectId:i,formData:r})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await be({projectId:i,formData:r,api:t})},onSuccess:(i,{projectId:r})=>{S.invalidateQueries({queryKey:["consultationMessages",r]})}})},Te=()=>{const n=["owner","staff","CTO","worker"],{role:a}=y(),t=N(a);return C({mutationFn:async({projectId:i,messageId:r,message:x,senderId:m})=>{if(!a||!n.includes(a))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await Se({projectId:i,messageId:r,message:x,senderId:m,senderRole:a,api:t})},onSuccess:(i,{projectId:r})=>{S.invalidateQueries({queryKey:["consultationMessages",r]})}})},Ie=()=>{const n=["owner","staff","CTO"],{role:a}=y(),t=N(a);return C({mutationFn:async({projectId:i})=>{if(!a||!n.includes(a))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await Ee({projectId:i,api:t})},onSuccess:(i,{projectId:r})=>{S.invalidateQueries({queryKey:["consultationMessages",r]})}})},Le=()=>{const n=["owner","staff","CTO"],{role:a}=y(),t=N(a);return C({mutationFn:async({formId:i,projectId:r,deadLine:x})=>{if(!a)throw new Error("not authorized");if(!n.includes(a))throw new Error("you  dont have the access to make this api");if(!t)throw new Error("api is null");return await ke({formId:i,projectId:r,deadLine:x,api:t})},onSuccess:(i,{projectId:r})=>{S.invalidateQueries({queryKey:["consultationMessages",r]})}})},Qe=()=>{var K,B,Q,G,U,W,Y,H;const{projectId:n,organizationId:a}=me(),{isMobile:t,openMobileSidebar:i}=ue(),{_id:r}=y(),x=xe(),{role:m,permission:h}=fe(),j=m==="owner"||((K=h==null?void 0:h.technicalconsultant)==null?void 0:K.create),g=m==="owner"||((B=h==null?void 0:h.technicalconsultant)==null?void 0:B.edit),[v,I]=w.useState(""),[L,P]=w.useState([]),[k,E]=w.useState(null),[A,b]=w.useState(""),[F,M]=w.useState(null),[R,O]=w.useState(!1);let{data:V,isLoading:_,error:f,isError:X,refetch:$}=Ae(n);const o=V,{mutateAsync:Z,isPending:D}=Me(),{mutateAsync:ee,isPending:se}=Te(),{mutateAsync:ae,isPending:te}=Le(),q=Ie(),ne=async()=>{var s,c;try{await q.mutateAsync({projectId:n}),p({description:"Completion status updated successfully",title:"Success"}),x("../paymentconfirmation")}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||l.message||"Failed to update completion status",variant:"destructive"})}},z=async()=>{var s,c;try{if(!v&&L.length===0)throw new Error("please write anything");const l=new FormData;v&&l.append("message",v),m&&l.append("senderRole",m),l.append("sender",r),L.forEach(d=>l.append("attachments",d)),await Z({projectId:n,formData:l}),I(""),P([]),p({description:"message sent successfully",title:"Success"})}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||(l==null?void 0:l.message)||"Failed to send the message",variant:"destructive"})}},le=(s,c)=>{E(s),b(c)},ie=()=>{E(null),b("")},re=async()=>{var s,c;try{if(!k||!A)throw new Error("please write anything");await ee({projectId:n,messageId:k,message:A,senderId:r}),E(null),b(""),p({description:"message edited successfully",title:"Success"})}catch(l){p({title:"Error",description:((c=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:c.message)||(l==null?void 0:l.message)||"Failed to edit the message",variant:"destructive"})}};if(_)return e.jsx(he,{});const oe=(s,c)=>{if(s==="owner")return c.username;if(s==="staff")return c.staffName;if(s==="worker")return c.workerName;if(s=="CTO")return c.CTOName};return e.jsxs("div",{className:"container mx-auto  max-w-full max-h-full",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-2",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[t&&e.jsx("button",{onClick:i,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-comments mr-2"})," Technical Consultation"]}),e.jsxs("div",{className:"w-full lg:w-[60%]  flex flex-col sm:flex-row gap-3 justify-end",children:[(j||g)&&e.jsxs(u,{isLoading:q.isPending,onClick:ne,className:"bg-green-600 hover:bg-green-700 text-white flex-1 sm:flex-initial min-w-max",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsxs("div",{className:"flex flex-wrap sm:flex-nowrap gap-2 justify-end",children:[(j||g)&&e.jsx(ye,{projectId:n,stageNumber:4,stagePath:"technicalconsultation",className:"flex-1 sm:flex-initial min-w-max"}),(j||g)&&e.jsx(we,{stageName:"TechnicalConsultationModel",projectId:n,organizationId:a,currentAssignedStaff:(o==null?void 0:o.assignedTo)||null,className:"flex-1 sm:flex-initial min-w-max"}),e.jsx("div",{className:"w-full sm:w-auto flex justify-end sm:block",children:e.jsx(ve,{organizationId:a,stageName:"technicalconsultant"})})]})]})]}),e.jsxs(ge,{className:"p-4 mb-3 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(pe,{stageName:"technicalconsultation",completedAt:(Q=o==null?void 0:o.timer)==null?void 0:Q.completedAt,projectId:n,formId:o==null?void 0:o._id,deadLine:(G=o==null?void 0:o.timer)==null?void 0:G.deadLine,startedAt:(U=o==null?void 0:o.timer)==null?void 0:U.startedAt,refetchStageMutate:$,deadLineMutate:ae,isPending:te})]}),e.jsx("div",{className:" flex flex-col bg-white rounded-xl p-2 shadow-md border custom-scrollbar min-h-[200px] sm:min-h-[170px] md:min-h-[190px] lg:min-h-[340px] border-gray-200 mb-2 flex-grow max-h-[70vh] sm:!max-h-[30vh] md:!max-h-[30vh] lg:!max-h-[42vh] xl:!max-h-[49vh] overflow-y-auto ",children:e.jsxs("div",{className:"flex flex-col-reverse overflow-y-auto custom-scrollbar  flex-grow p-2  md:!max-h-full space-y-reverse space-y-4",children:[(X||f)&&e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-ban text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:((Y=(W=f==null?void 0:f.response)==null?void 0:W.data)==null?void 0:Y.message)||(f==null?void 0:f.message)||"Failed to load messages, please try again"}),e.jsxs(u,{onClick:()=>$(),className:"mt-4 bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx("i",{className:"fas fa-redo mr-2"})," Retry"]})]})}),_?e.jsxs("div",{className:"flex h-full items-center justify-center py-10",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-blue-600 text-2xl"}),e.jsx("span",{className:"ml-3 text-blue-600 font-medium",children:"Loading messages..."})]}):(o==null?void 0:o.messages.length)===0?e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-envelope text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:"No messages have been posted yet."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation using the box below."})]})}):e.jsx("div",{className:"overflow-y-auto custom-scrollbar flex flex-col-reverse space-y-reverse space-y-4",children:(H=o==null?void 0:o.messages)==null?void 0:H.slice().sort((s,c)=>new Date(c.createdAt).getTime()-new Date(s.createdAt).getTime()).map(s=>{var c,l;return e.jsxs("div",{className:"bg-blue-50 w-full group px-4 py-[5px] rounded-lg shadow flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-xs sm:text-[10px] text-gray-600",children:[oe(s.senderRole,s.sender)||((c=s==null?void 0:s.senderRole)==null?void 0:c.toUpperCase())||"User"," - ",new Date(s.createdAt).toLocaleString(),s.isEdited&&e.jsxs(Ne,{className:"sm:ml-2 my-1 sm:my-0",children:[" ",e.jsxs("p",{className:"hidden sm:inline-block",children:["message is  "," "," "]})," Â  edited by ",s.senderRole]})]}),e.jsx("div",{className:"opacity-0 scale-95 group-hover:opacity-100 transition-all duration-300",children:(s.sender._id===r||m==="owner"||m==="CTO")&&e.jsx("div",{className:"flex gap-2",children:g&&e.jsx(u,{variant:"secondary",onClick:()=>le(s._id,s.message),className:"text-blue-600 text-sm",children:e.jsx("i",{className:"fas fa-edit"})})})})]}),k===s._id?e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-center mt-2",children:[e.jsx(T,{value:A,onChange:d=>b(d.target.value),className:"flex-grow"}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(u,{isLoading:se,onClick:re,className:"w-full sm:w-auto",children:"Save"}),e.jsx(u,{variant:"danger",className:"w-full sm:w-auto border-red-200 hover:bg-red-700 bg-red-600 text-white",onClick:ie,children:"Cancel"})]})]}):e.jsx("p",{className:"text-gray-900 text-sm",children:s.message}),e.jsx("div",{className:"flex flex-wrap gap-3 mt-3",children:(l=s.attachments)==null?void 0:l.map((d,ce)=>e.jsxs("div",{className:"flex items-center gap-2 bg-white border px-3 py-2 rounded shadow-sm w-full max-w-[280px]",children:[e.jsx("i",{className:`fas ${d.type==="pdf"?"fa-file-pdf text-red-500":"fa-image text-blue-500"}`}),e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 truncate flex-grow min-w-0",children:d.originalName}),d.type==="image"&&e.jsx(u,{size:"sm",variant:"primary",onClick:()=>{M(d.url),O(!0)},children:e.jsx("i",{className:"fas fa-eye"})}),e.jsx(u,{onClick:()=>je({src:d==null?void 0:d.url,alt:(d==null?void 0:d.originalName)||"file.pdf"}),size:"sm",className:"text-sm",children:e.jsx("i",{className:"fa-solid fa-download"})})]},ce))})]},s._id)})})]})}),(j||g)&&e.jsxs("div",{className:"bg-white px-4 py-2 rounded-xl shadow-md",children:[e.jsx(J,{htmlFor:"message",children:"Your Message"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mb-3",children:[e.jsx(T,{id:"message",placeholder:"Write something...",value:v,onChange:s=>I(s.target.value),onKeyDown:s=>{s.key==="Enter"&&z()},className:"flex-grow"}),e.jsxs(u,{isLoading:D,onClick:z,className:"w-full sm:w-auto",children:["Send ",e.jsx("i",{className:"ml-2 fa-solid fa-paper-plane"})]})]}),(j||g)&&e.jsxs(e.Fragment,{children:["  ",e.jsx(J,{children:"Attach Files (PDF or Image)"}),e.jsx(T,{type:"file",multiple:!0,accept:".pdf,image/*",onChange:s=>P(Array.from(s.target.files||[])),className:""})]})]}),F&&e.jsx("div",{onClick:()=>M(null),className:"fixed inset-0 z-50 bg-black/60 flex items-center justify-center",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white p-2 sm:p-4 rounded-lg shadow-lg max-w-[90%] max-h-[90%] overflow-auto relative",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{onClick:()=>M(null),className:"text-red-500 text-xl",children:e.jsx("i",{className:"fas fa-times"})})}),e.jsxs("div",{className:"relative min-w-80 ",children:[R&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm",children:e.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-gray-600"})}),e.jsx("img",{src:F,onLoad:()=>O(!1),loading:"lazy",alt:"Preview",className:`max-h-[80vh] rounded transition duration-500 ${R?"blur-sm scale-105":""}`})]})]})})]})};export{Qe as default};
