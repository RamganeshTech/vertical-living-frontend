import{u as N,q as S,r as C,j as e}from"./index-By5P0A7l.js";import{B as k}from"./Button-DLUK8O0t.js";import{L as j}from"./Label-TAdUzpu-.js";import{I as p}from"./Input-DKpmFZl7.js";import{u as R}from"./projectApi-_duyp5-I.js";import{u as K}from"./useQuery-Cc7pLKfK.js";import{u as E}from"./useMutation-7YLqc7VE.js";import{g as P}from"./roleCheck-YGaMnK_P.js";import{t as T}from"./toast-BSC5QTk1.js";const V=async({projectId:n,organizationId:s,payload:a,projectName:r,api:m})=>{const{data:c}=await m.post(`/department/logistics/shipment/create/${n}/${s}/${r}`,a);if(!c.ok)throw new Error(c.message);return c.data},W=async({projectId:n,organizationId:s,shipmentId:a,payload:r,api:m})=>{const{data:c}=await m.put(`/department/logistics/shipment/update/${n}/${s}/${a}`,r);if(!c.ok)throw new Error(c.message);return c.data},G=async({shipmentId:n,organizationId:s,api:a})=>{const{data:r}=await a.delete(`/department/logistics/shipment/delete/${s}/${n}`);if(!r.ok)throw new Error(r.message);return r.message},O=async({api:n,organizationId:s,status:a,projectId:r,scheduledDate:m})=>{const c=new URLSearchParams({organizationId:s});a&&c.append("status",a),r&&c.append("projectId",r),m&&c.append("scheduledDate",m);const{data:v}=await n.get(`/department/logistics/shipment/getshipment?${c.toString()}`);if(!v.ok)throw new Error(v.message);return v==null?void 0:v.data},M=async({api:n,shipmentId:s})=>{const{data:a}=await n.get(`/department/logistics/shipment/getsingle/${s}`);if(!a.ok)throw new Error(a.message);return a==null?void 0:a.data},b=["owner","CTO","staff"],H=()=>{const{role:n}=N(),s=P(n);return E({mutationFn:async({projectId:a,organizationId:r,payload:m,projectName:c})=>{if(!n||!b.includes(n))throw new Error("Not allowed");if(!s)throw new Error("API instance not found for role");return await V({projectId:a,organizationId:r,payload:m,projectName:c,api:s})},onSuccess:()=>{S.invalidateQueries({queryKey:["logistics","shipments"]})}})},Y=()=>{const{role:n}=N(),s=P(n);return E({mutationFn:async({projectId:a,organizationId:r,shipmentId:m,payload:c})=>{if(!n||!b.includes(n))throw new Error("Not allowed");if(!s)throw new Error("API instance not found for role");return await W({projectId:a,organizationId:r,shipmentId:m,payload:c,api:s})},onSuccess:()=>{S.invalidateQueries({queryKey:["logistics","shipments"]})}})},le=()=>{const{role:n}=N(),s=P(n);return E({mutationFn:async({organizationId:a,shipmentId:r})=>{if(!n||!b.includes(n))throw new Error("Not allowed");if(!s)throw new Error("API instance not found for role");return await G({shipmentId:r,organizationId:a,api:s})},onSuccess:()=>{S.invalidateQueries({queryKey:["logistics","shipments"]})}})},ce=(n,s)=>{const{role:a}=N(),r=P(a);return K({queryKey:["logistics","shipments",s],queryFn:async()=>{if(!a||!b.includes(a))throw new Error("Not allowed");if(!r)throw new Error("API instance not found for role");return await O({api:r,organizationId:n,status:s==null?void 0:s.status,projectId:s==null?void 0:s.projectId,scheduledDate:s==null?void 0:s.scheduledDate})},retry:!1,enabled:!!n})},oe=n=>{const{role:s}=N(),a=P(s);return K({queryKey:["logistics","single"],queryFn:async()=>{if(!s||!b.includes(s))throw new Error("Not allowed");if(!a)throw new Error("API instance not found for role");return await M({api:a,shipmentId:n})},retry:!1,enabled:!!n})},de=()=>{const{role:n}=N(),s=P(n);return E({mutationFn:async({organizationId:a,projectId:r,fromDept:m,totalCost:c,upiId:v})=>{if(!n||!b.includes(n))throw new Error("Not allowed");if(!s)throw new Error("API instance not found for role");return await z({organizationId:a,projectId:r,fromDept:m,totalCost:c,api:s,upiId:v})},onSuccess:()=>{S.invalidateQueries({queryKey:["logistics","shipments"]})}})},z=async({api:n,organizationId:s,projectId:a,fromDept:r,totalCost:m,upiId:c})=>{const{data:v}=await n.post(`/department/logistics/syncaccounting/${s}/${a}`,{totalCost:m,fromDept:r,upiId:c});return v},$=n=>{if(!n)return"";const s=new Date(n),a=g=>String(g).padStart(2,"0"),r=s.getFullYear(),m=a(s.getMonth()+1),c=a(s.getDate()),v=a(s.getHours()),w=a(s.getMinutes());return`${r}-${m}-${c}T${v}:${w}`},he=({shipment:n,onClose:s,organizationId:a})=>{var q;const{mutateAsync:r,isPending:m}=H(),{mutateAsync:c,isPending:v}=Y(),{data:w}=R(a),g=w==null?void 0:w.map(t=>({_id:t._id,projectName:t.projectName})),[f,I]=C.useState({_id:"",projectName:""}),[l,y]=C.useState({shipmentStatus:"pending",vehicleDetails:{vehicleNumber:"",vehicleType:"truck",driverCharge:0,driver:{name:"",phone:"",licenseNumber:""},driverUpiId:""},origin:{address:"",contactPerson:"",contactPhone:""},destination:{address:"",contactPerson:"",contactPhone:""},items:[{name:"",quantity:0}],scheduledDate:"",actualPickupTime:"",actualDeliveryTime:"",notes:"",trackingLink:null});C.useEffect(()=>{n&&(y({...l,...n,scheduledDate:n.scheduledDate?$(n.scheduledDate):"",actualPickupTime:n.actualPickupTime?$(n.actualPickupTime):"",actualDeliveryTime:n.actualDeliveryTime?$(n.actualDeliveryTime):""}),I(()=>{const t=g==null?void 0:g.find(i=>i._id===(n==null?void 0:n.projectId));return{_id:n.projectId,projectName:t==null?void 0:t.projectName}}))},[n]),C.useEffect(()=>{n||g&&g.length>0&&(console.log("projects",g),I(()=>{var t,i;return{_id:(t=g[0])==null?void 0:t._id,projectName:(i=g[0])==null?void 0:i.projectName}}))},[w]),C.useEffect(()=>{const t=i=>{i.key==="Escape"&&s()};return window.addEventListener("keydown",t),()=>{window.removeEventListener("keydown",t)}},[s]);const u=t=>{const{name:i,value:o}=t.target;if(i.startsWith("origin.")){const h=i.split(".")[1];y(d=>({...d,origin:{...d.origin,[h]:o}}))}else if(i.startsWith("destination.")){const h=i.split(".")[1];y(d=>({...d,destination:{...d.destination,[h]:o}}))}else if(i.startsWith("vehicleDetails.driver.")){const h=i.split(".")[2];y(d=>({...d,vehicleDetails:{...d.vehicleDetails,driver:{...d.vehicleDetails.driver,[h]:o}}}))}else if(i.startsWith("vehicleDetails.")){const h=i.split(".")[1];y(d=>({...d,vehicleDetails:{...d.vehicleDetails,[h]:o}}))}else y(h=>({...h,[i]:o}))},Q=t=>{var o,h,d,x,L,_,A,D;const i=[];return(o=t==null?void 0:t.origin)!=null&&o.contactPhone&&!/^\d{10}$/.test((h=t==null?void 0:t.origin)==null?void 0:h.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(d=t==null?void 0:t.destination)!=null&&d.contactPhone&&!/^\d{10}$/.test((x=t==null?void 0:t.destination)==null?void 0:x.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(_=(L=t==null?void 0:t.vehicleDetails)==null?void 0:L.vehicleNumber)!=null&&_.trim()||i.push("vehicle number is required."),((A=t==null?void 0:t.items)==null?void 0:A.length)>0&&((D=t==null?void 0:t.items)==null||D.forEach((F,U)=>{F.name||i.push(`Item ${U+1} is missing a name.`),F.quantity<0&&i.push(`Item ${U+1} has invalid quantity.`)})),i},B=async()=>{var t,i;try{const o=Q(l);if(o.length>0){o.forEach(h=>{T({title:"Validation Error",description:h,variant:"destructive"})});return}n?await c({shipmentId:n._id,organizationId:a,projectId:f==null?void 0:f._id,payload:l}):await r({organizationId:a,projectId:f._id,payload:l,projectName:f.projectName}),T({title:"success",description:"shipment has generated"}),s()}catch(o){T({title:"Error",description:((i=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:i.message)||"Operation Failed",variant:"destructive"})}};return e.jsx("div",{onClick:s,className:"fixed inset-0 bg-black/60 flex justify-center items-center z-50",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),className:"bg-white rounded-xl p-6 shadow-lg w-[90vw] max-w-[1300px] h-[90vh] flex flex-col",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:n?"Edit Shipment":"Create Shipment"}),e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto p-2 sm:p-4 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-blue-700",children:"Shipment Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{children:"Select Project"}),e.jsx("select",{className:"w-full px-3 py-2 border rounded-xl",name:"projectID",value:f._id,onChange:t=>{const i=g==null?void 0:g.find(o=>o._id===t.target.value);i&&I({_id:i._id,projectName:i.projectName})},children:g==null?void 0:g.map(t=>e.jsx("option",{value:t._id,children:t.projectName},t._id))})]}),e.jsxs("div",{children:[e.jsx(j,{children:"shipmentStatus"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded-xl",name:"shipmentStatus",value:l.shipmentStatus,onChange:u,children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"assigned",children:"Assigned"}),e.jsx("option",{value:"pickedup",children:"Picked Up"}),e.jsx("option",{value:"in_transit",children:"In Transit"}),e.jsx("option",{value:"delivered",children:"Delivered"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Scheduled Date"}),e.jsx(p,{type:"datetime-local",name:"scheduledDate",value:l.scheduledDate,onChange:u})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-green-700",children:"Vehicle Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(p,{name:"vehicleDetails.vehicleNumber",placeholder:"Vehicle Number",required:!0,value:l.vehicleDetails.vehicleNumber,onChange:u}),e.jsxs("select",{name:"vehicleDetails.vehicleType",value:l.vehicleDetails.vehicleType,onChange:u,className:"w-full px-3 py-2 border rounded-xl",children:[e.jsx("option",{value:"truck",children:"Truck"}),e.jsx("option",{value:"van",children:"Van"}),e.jsx("option",{value:"car",children:"Car"}),e.jsx("option",{value:"bike",children:"Bike"}),e.jsx("option",{value:"tempo",children:"Tempo"}),e.jsx("option",{value:"container",children:"Container"})]}),e.jsx(p,{name:"vehicleDetails.driver.name",placeholder:"Driver Name",value:l.vehicleDetails.driver.name,onChange:u}),e.jsx(p,{name:"vehicleDetails.driver.phone",type:"tel",maxLength:10,placeholder:"Driver Phone",value:l.vehicleDetails.driver.phone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&u(t)}}),e.jsx(p,{name:"vehicleDetails.driver.licenseNumber",placeholder:"License Number",value:l.vehicleDetails.driver.licenseNumber,onChange:u}),e.jsx(p,{name:"vehicleDetails.driverCharge",type:"number",placeholder:"Driver Charge",value:(q=l==null?void 0:l.vehicleDetails)==null?void 0:q.driverCharge,onChange:t=>{const i=t.target.value;(i===""||Number(i)>=0)&&u(t)}}),e.jsx(p,{name:"vehicleDetails.driverUpiId",type:"text",placeholder:"Driver Upi",value:l.vehicleDetails.driverUpiId||"",onChange:t=>{u(t)}})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-yellow-700 mb-2",children:"Origin & Destination"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{children:"Origin"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"origin.address",placeholder:"Address",value:l.origin.address,onChange:u}),e.jsx(p,{name:"origin.contactPerson",placeholder:"Contact Person",value:l.origin.contactPerson,onChange:u}),e.jsx(p,{name:"origin.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:l.origin.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&u(t)}})]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Destination"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"destination.address",placeholder:"Address",value:l.destination.address,onChange:u}),e.jsx(p,{name:"destination.contactPerson",placeholder:"Contact Person",value:l.destination.contactPerson,onChange:u}),e.jsx(p,{name:"destination.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:l.destination.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&u(t)}})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-700 mb-2",children:"Timing Schedule"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{children:"Actual Pickup Time"}),e.jsx(p,{type:"datetime-local",name:"actualPickupTime",value:l.actualPickupTime,onChange:u})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Actual Delivery Time"}),e.jsx(p,{type:"datetime-local",name:"actualDeliveryTime",value:l.actualDeliveryTime,onChange:u})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Notes"}),e.jsx("textarea",{name:"notes",className:"w-full px-3 py-2 border rounded-xl",rows:3,value:l.notes,onChange:u})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-pink-700 mb-2",children:"Shipment Items"}),e.jsxs("div",{className:"space-y-4",children:[l.items.map((t,i)=>e.jsxs("div",{className:"grid grid-cols-12  items-center gap-2 sm:gap-4",children:[e.jsxs("div",{className:"col-span-6 sm:col-span-5",children:[e.jsx(j,{children:"Item Name"}),e.jsx(p,{name:`item-name-${i}`,value:t.name,placeholder:"e.g. Wooden Pallets",onChange:o=>{const h=o.target.value;y(d=>{const x=[...d.items];return x[i].name=h,i===x.length-1&&h.trim()!==""&&x.push({name:"",quantity:0}),h.trim()===""&&i<x.length-1&&x.splice(i,1),{...d,items:x}})}})]}),e.jsxs("div",{className:"col-span-4 sm:col-span-3",children:[e.jsx(j,{children:"Quantity"}),e.jsx(p,{type:"number",name:`item-qty-${i}`,value:t.quantity,placeholder:"e.g. 10",onChange:o=>{const h=parseInt(o.target.value)||0;Number(h)>=0&&y(d=>{const x=[...d.items];return x[i].quantity=h,{...d,items:x}})}})]}),e.jsx("div",{className:"col-span-2 sm:col-span-2 flex mt-5 place-items-center h-full",children:e.jsx(k,{variant:"danger",size:"md",type:"button",className:"text-white bg-red-600",onClick:()=>{y(o=>({...o,items:o.items.filter((h,d)=>d!==i)}))},children:e.jsx("i",{className:"fas fa-trash"})})})]},i)),e.jsx("div",{children:e.jsxs(k,{variant:"outline",size:"sm",type:"button",onClick:()=>y(t=>({...t,items:[...t.items,{name:"",quantity:0}]})),children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Item"]})})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Tracking Link"}),e.jsx(p,{name:"trackingLink",placeholder:"Paste the Tracking Link here",value:l.trackingLink||"",onChange:u})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-3 border-t mt-5",children:[e.jsx(k,{variant:"outline",onClick:s,children:"Cancel"}),e.jsx(k,{isLoading:v||m,onClick:()=>B(),children:n?"Update":"Create"})]})]})})};export{he as L,ce as a,oe as b,de as c,$ as f,le as u};
