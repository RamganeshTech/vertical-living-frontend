import{j as e,L as M,b as A,f as D,$ as R,r as f,_ as j,q as _}from"./index-By5P0A7l.js";import{u as E,a as H,b as L}from"./notificationApi-BZWUzyjQ.js";import{B as S}from"./Button-DLUK8O0t.js";import B from"./MaterialOverviewLoading-9Ck4pGPe.js";import"./useQuery-Cc7pLKfK.js";import"./useMutation-7YLqc7VE.js";import"./useInfiniteQuery-DQF0m-E9.js";import"./roleCheck-YGaMnK_P.js";import"./Skeleton-FCBR4RgB.js";const F=({deleteMutation:v,notification:t,onDelete:l,frontendUrl:r})=>{var d;const i=(a=>{switch(a){case"warning":return{icon:"fa-exclamation-triangle",bgColor:"bg-amber-50",borderColor:"border-l-amber-400",badgeBg:"bg-amber-100",badgeText:"text-amber-700"};case"assignment":return{icon:"fa-tasks",bgColor:"bg-blue-50",borderColor:"border-l-blue-400",badgeBg:"bg-blue-100",badgeText:"text-blue-700"};case"info":default:return{icon:"fa-info-circle",bgColor:"bg-slate-50",borderColor:"border-l-slate-400",badgeBg:"bg-slate-100",badgeText:"text-slate-700"}}})(t.type),g=a=>{const c=new Date(a),o=new Date,b=o.getTime()-c.getTime(),m=Math.floor(b/6e4),x=Math.floor(b/36e5),w=Math.floor(b/864e5);return m<1?"Just now":m<60?`${m}m ago`:x<24?`${x}h ago`:w<7?`${w}d ago`:c.toLocaleDateString("en-US",{month:"short",day:"numeric",year:c.getFullYear()!==o.getFullYear()?"numeric":void 0})},h=(()=>{var o;if(!((o=t==null?void 0:t.navigation)!=null&&o.url))return null;const a=r.endsWith("/")?r.slice(0,-1):r,c=t.navigation.url.startsWith("/")?t.navigation.url:`/${t.navigation.url}`;return`${a}${c}`})();return e.jsx(M,{to:h||"",onClick:()=>{(t==null?void 0:t.fromModule)!=="tool"&&l(t._id)},children:e.jsx("div",{className:`${i.bgColor} cursor-pointer border-l-4 ${i.borderColor} rounded-lg p-4 mb-3 transition-all duration-200 hover:shadow-md ${t.isRead?"":"ring-1 ring-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 pt-1",children:e.jsx("i",{className:`fas ${i.icon} text-lg ${i.badgeText}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 leading-relaxed",children:t.message}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:g(t.createdAt)})]})}),h&&e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsxs(M,{to:h,className:"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors",onClick:()=>{(t==null?void 0:t.fromModule)!=="tool"&&l(t._id)},children:[((d=t.navigation)==null?void 0:d.label)||"View Details",e.jsx("i",{className:"fas fa-arrow-right text-xs"})]})})]}),e.jsx("div",{className:"flex-shrink-0 flex gap-2",children:e.jsx(S,{variant:"danger",isLoading:v.isPending&&v.variables.notificationId===t._id,onClick:a=>{a.preventDefault(),a.stopPropagation(),l(t._id)},className:"!p-1 px-2  bg-red-600 !text-white hover:bg-red-600 transition-colors rounded",title:"Delete notification",size:"sm",children:e.jsx("i",{className:"fas fa-xmark text-sm"})})})]})})})},W=()=>{var C,T;const v=A(),t=D(),l=R(s=>s.authStore),{data:r,fetchNextPage:y,hasNextPage:i,isFetchingNextPage:g,isLoading:k,isError:h,error:d}=E(20),{mutateAsync:a}=H(),c=L(),o=f.useRef(null),b=f.useRef(null),m=f.useRef(0);f.useEffect(()=>{const s=t==null?void 0:t.id;if(!s)return;j.emit("join_notifications",{userId:s});const n=p=>{console.log("ðŸ”” New notification received:",p);const N=o.current;_.invalidateQueries({queryKey:["notifications","infinite"]}),setTimeout(()=>{N==null||N.scrollTo({top:0,behavior:"smooth"})},100)},u=()=>{_.invalidateQueries({queryKey:["notifications","unread-count"]})};return j.on("new_notification",n),j.on("unread_count_update",u),()=>{j.off("new_notification",n),j.off("unread_count_update",u)}},[t==null?void 0:t.id]);const x=((T=(C=r==null?void 0:r.pages)==null?void 0:C.flatMap(s=>s==null?void 0:s.notifications))==null?void 0:T.sort((s,n)=>{var u,p;return((u=new Date(n.createdAt))==null?void 0:u.getTime())-((p=new Date(s.createdAt))==null?void 0:p.getTime())}))??[];console.log("data.pages.",r==null?void 0:r.pages),f.useEffect(()=>{const s=o.current;if(!s)return;const n=()=>{s.scrollHeight-s.scrollTop-s.clientHeight<100&&i&&!g&&(console.log("ðŸ“œ Loading older notifications..."),m.current=s.scrollHeight,y().then(()=>{requestAnimationFrame(()=>{const N=s.scrollHeight-m.current;s.scrollTop=s.scrollTop+N})}))};return s.addEventListener("scroll",n),()=>s.removeEventListener("scroll",n)},[i,g,y]),f.useEffect(()=>{r&&(async()=>{await a()})()},[r,a]);const w="https://houseofram.in",$=async s=>{try{await c.mutateAsync({notificationId:s})}catch(n){console.error("Error deleting notification:",n)}};return k?e.jsx(B,{}):h?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-exclamation-circle"}),e.jsxs("span",{children:["Error loading notifications: ",(d==null?void 0:d.message)||"Unknown error"]})]})})}):e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col bg-white",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-slate-200 flex-shrink-0",children:e.jsx("div",{className:"px-4 md:px-6 py-2 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{onClick:()=>v(-1),className:"cursor-pointer w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-arrow-left text-blue-600 text-lg"})}),e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-bell text-blue-600 text-lg"})}),e.jsx("div",{children:e.jsxs("h1",{className:"text-xl md:text-2xl font-bold text-slate-900",children:["Notifications ",l!=null&&l.userName?`for (${l==null?void 0:l.userName})`:""]})})]})})}),e.jsx("div",{ref:o,className:"flex-1 overflow-y-auto p-4 md:p-6",style:{scrollBehavior:"auto"},children:x.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-8 text-center",children:[e.jsx("i",{className:"fas fa-bell text-4xl text-slate-300 mb-3 block"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No notifications yet"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"You're all caught up! Check back later for updates."})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-3",children:x.map(s=>e.jsx(F,{notification:s,onDelete:$,deleteMutation:c,frontendUrl:w},s._id))}),e.jsxs("div",{ref:b,className:"flex justify-center py-2",children:[g&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Loading earlier notifications..."})]}),!i&&x.length>0&&e.jsx("p",{className:"text-slate-400 text-xs font-medium",children:"Youâ€™ve reached the end"})]})]})})]})};export{W as default};
