var le=c=>{throw TypeError(c)};var K=(c,r,a)=>r.has(c)||le("Cannot "+a);var p=(c,r,a)=>(K(c,r,"read from private field"),a?a.call(c):r.get(c)),R=(c,r,a)=>r.has(c)?le("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(c):r.set(c,a),v=(c,r,a,n)=>(K(c,r,"write to private field"),n?n.call(c,a):r.set(c,a),a),O=(c,r,a)=>(K(c,r,"access private method"),a);import{S as Ae,y as Y,M as Qe,e as De,r as y,n as Me,j as e,b as Pe,c as Fe,u as Le}from"./index-C2yypHlC.js";import{u as qe,g as Ie,a as Ue,b as _e}from"./staffTaskApi-CAQdXzRW.js";import{u as Be}from"./projectApi-DN2My7SU.js";import{u as $e}from"./getAllUsersApi-D88-t5m-.js";import{S as J}from"./SearchSelectNew-pNmNyd8z.js";import{I as H}from"./Input-2iiBXUfz.js";import{L as k}from"./Label-Cu1McGld.js";import{B}from"./Button-tnhURsi3.js";import{T as ze}from"./TextArea-cIwjS3k2.js";import{t as X}from"./toast-BSC5QTk1.js";import{Q as he,b as We,c as Ge,e as He,d as Ve,f as Ke,s as oe,g as ce,w as Je,h as Xe}from"./useQuery-CXWUgeEV.js";import{g as Ye}from"./roleCheck-ZvNAcsbM.js";import{d as Ze,f as es,a as ss}from"./dateFormator-BGKi5rfZ.js";import{a as ts}from"./workLibraryApi-B149sN2t.js";import"./useMutation-5BwurMj6.js";function ue(c,r){const a=new Set(r);return c.filter(n=>!a.has(n))}function rs(c,r,a){const n=c.slice(0);return n[r]=a,n}var q,S,I,U,C,P,$,z,W,x,Z,ee,se,te,re,de,as=(de=class extends Ae{constructor(r,a,n){super();R(this,x);R(this,q);R(this,S);R(this,I);R(this,U);R(this,C);R(this,P);R(this,$);R(this,z);R(this,W,[]);v(this,q,r),v(this,U,n),v(this,I,[]),v(this,C,[]),v(this,S,[]),this.setQueries(a)}onSubscribe(){this.listeners.size===1&&p(this,C).forEach(r=>{r.subscribe(a=>{O(this,x,te).call(this,r,a)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,p(this,C).forEach(r=>{r.destroy()})}setQueries(r,a){v(this,I,r),v(this,U,a),Y.batch(()=>{const n=p(this,C),l=O(this,x,se).call(this,p(this,I));v(this,W,l),l.forEach(m=>m.observer.setOptions(m.defaultedQueryOptions));const i=l.map(m=>m.observer),f=i.map(m=>m.getCurrentResult()),o=i.some((m,j)=>m!==n[j]);n.length===i.length&&!o||(v(this,C,i),v(this,S,f),this.hasListeners()&&(ue(n,i).forEach(m=>{m.destroy()}),ue(i,n).forEach(m=>{m.subscribe(j=>{O(this,x,te).call(this,m,j)})}),O(this,x,re).call(this)))})}getCurrentResult(){return p(this,S)}getQueries(){return p(this,C).map(r=>r.getCurrentQuery())}getObservers(){return p(this,C)}getOptimisticResult(r,a){const n=O(this,x,se).call(this,r),l=n.map(i=>i.observer.getOptimisticResult(i.defaultedQueryOptions));return[l,i=>O(this,x,ee).call(this,i??l,a),()=>O(this,x,Z).call(this,l,n)]}},q=new WeakMap,S=new WeakMap,I=new WeakMap,U=new WeakMap,C=new WeakMap,P=new WeakMap,$=new WeakMap,z=new WeakMap,W=new WeakMap,x=new WeakSet,Z=function(r,a){return a.map((n,l)=>{const i=r[l];return n.defaultedQueryOptions.notifyOnChangeProps?i:n.observer.trackResult(i,f=>{a.forEach(o=>{o.observer.trackProp(f)})})})},ee=function(r,a){return a?((!p(this,P)||p(this,S)!==p(this,z)||a!==p(this,$))&&(v(this,$,a),v(this,z,p(this,S)),v(this,P,Qe(p(this,P),a(r)))),p(this,P)):r},se=function(r){const a=new Map(p(this,C).map(l=>[l.options.queryHash,l])),n=[];return r.forEach(l=>{const i=p(this,q).defaultQueryOptions(l),f=a.get(i.queryHash);f?n.push({defaultedQueryOptions:i,observer:f}):n.push({defaultedQueryOptions:i,observer:new he(p(this,q),i)})}),n},te=function(r,a){const n=p(this,C).indexOf(r);n!==-1&&(v(this,S,rs(p(this,S),n,a)),O(this,x,re).call(this))},re=function(){var r;if(this.hasListeners()){const a=p(this,P),n=O(this,x,Z).call(this,p(this,S),p(this,W)),l=O(this,x,ee).call(this,n,(r=p(this,U))==null?void 0:r.combine);a!==l&&Y.batch(()=>{this.listeners.forEach(i=>{i(p(this,S))})})}},de);function ns({queries:c,...r},a){const n=De(),l=We(),i=Ge(),f=y.useMemo(()=>c.map(b=>{const T=n.defaultQueryOptions(b);return T._optimisticResults=l?"isRestoring":"optimistic",T}),[c,n,l]);f.forEach(b=>{He(b),Ve(b,i)}),Ke(i);const[o]=y.useState(()=>new as(n,f,r)),[m,j,D]=o.getOptimisticResult(f,r.combine),L=!l&&r.subscribed!==!1;y.useSyncExternalStore(y.useCallback(b=>L?o.subscribe(Y.batchCalls(b)):Me,[o,L]),()=>o.getCurrentResult(),()=>o.getCurrentResult()),y.useEffect(()=>{o.setQueries(f,r)},[f,r,o]);const _=m.some((b,T)=>oe(f[T],b))?m.flatMap((b,T)=>{const w=f[T];if(w){const F=new he(n,w);if(oe(w,b))return ce(w,F,i);Je(b,l)&&ce(w,F,i)}return[]}):[];if(_.length>0)throw Promise.all(_);const A=m.find((b,T)=>{const w=f[T];return w&&Xe({result:b,errorResetBoundary:i,throwOnError:w.throwOnError,query:n.getQueryCache().get(w.queryHash),suspense:w.suspense})});if(A!=null&&A.error)throw A.error;return j(D())}const is=({allTasks:c,selected:r,onChange:a})=>{const[n,l]=y.useState(""),i=y.useMemo(()=>{const o=n.trim().toLowerCase();return c.filter(m=>(m==null?void 0:m.status)!=="done").filter(m=>{var j;return n?(j=m==null?void 0:m.title)==null?void 0:j.toLowerCase().includes(o):!0})},[c,n]),f=o=>{const j=r.includes(o)?r.filter(D=>D!==o):[...r,o];a(j)};return e.jsxs("div",{className:"col-span-full mt-4",children:[e.jsx(k,{htmlFor:"searchDependencies",children:"Search Tasks"}),e.jsx("input",{id:"searchDependencies",placeholder:"Search by title...",value:n,onChange:o=>l(o.target.value),className:"mt-2 mb-3 w-full border border-gray-300 px-3 py-2 rounded-md focus:ring focus:ring-blue-400 outline-none"}),(i==null?void 0:i.length)===0&&e.jsx("div",{className:"text-gray-500 mt-2",children:"No matching tasks found."}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mt-2",children:i.map(o=>{var j;const m=r.includes(o._id);return e.jsx("div",{className:`border rounded-lg p-3 cursor-pointer transition-all ${m?"bg-blue-100 border-blue-400":"bg-white hover:bg-gray-50"}`,onClick:()=>f(o._id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox text-blue-600",checked:m,onChange:()=>f(o._id),onClick:D=>D.stopPropagation()}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-blue-900",children:o.title||"N/A"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Assigned to: ",((j=o==null?void 0:o.assigneeId)==null?void 0:j.staffName)||"Unassigned"]}),(o==null?void 0:o.due)&&e.jsxs("p",{className:"text-sm text-blue-700",children:["Due: ",Ze(o.due)," - ",es(o.due)]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Status: ",(o==null?void 0:o.status)||"N/A"]})]})]})},o._id)})})]})},ls=["owner","staff","CTO"];function Cs(c,r){let a;return function(...n){clearTimeout(a),a=setTimeout(()=>c(...n),r)}}const Ts=()=>{var ie;const{organizationId:c}=Pe(),[r,a]=y.useState(!1),n={images:[],previewUrls:[],title:"",description:"",due:ss(new Date),priority:"high",department:"site",assigneeId:"",assigneeName:"",projectId:"",projectName:"",organizationId:c,status:"queued",tasks:[{taskName:""}]},[l,i]=y.useState([n]),{role:f}=Fe(),o=Ye(f),[m,j]=y.useState(null),[D,L]=y.useState(!1),{data:ae}=qe(c),{data:_=[]}=ts(c),[A,b]=y.useState(()=>l.map(()=>"")),T=ns({queries:(A??[]).map(s=>({queryKey:["suggested-subtasks",s],queryFn:async()=>{if(!s||s.length<=3)return[];if(!f||!ls.includes(f))throw new Error("Not allowed");if(!o)throw new Error("Not Authenticated");return await Ie({title:s,api:o})},enabled:!!s&&s.length>3&&!!f}))});y.useEffect(()=>{(A==null?void 0:A.length)!==(l==null?void 0:l.length)&&b(l.map(s=>s.title||""))},[l.length]),y.useEffect(()=>{T.forEach((s,t)=>{var h,g,Q;const{data:u,isSuccess:d}=s,N=l[t];if(d&&(u==null?void 0:u.length)>0&&((g=(h=N==null?void 0:N.title)==null?void 0:h.trim())==null?void 0:g.length)>3&&N.tasks.length===1&&((Q=N.tasks[0])==null?void 0:Q.taskName.trim())===""){const M=[...l];M[t].tasks.map(V=>V.taskName).join(",")===u.join(",")||(M[t].tasks=u.map(V=>({taskName:V})),i(M))}})},[T.map(s=>s.data).join("|")]);const w=Le(),{data:F}=Be(c),{data:G}=$e(c,"staff"),me=(G||[]).map(s=>({value:s._id,label:s.staffName,email:s.email})),pe=(F||[]).map(s=>({value:s._id,label:s.projectName})),fe=(ie=_||[])==null?void 0:ie.map(s=>({label:s.workName,value:s._id})),ne=y.useRef([]),ge=(s,t)=>{clearTimeout(ne.current[s]),ne.current[s]=setTimeout(()=>{b(u=>{const d=[...u];return d[s]=t,d})},800)},{mutateAsync:be,isPending:xe}=Ue(),{mutateAsync:je,isPending:ve}=_e(),ye=()=>{i(s=>{const t=[...s,n];return b(t.map(u=>u.title||"")),t}),L(!1)},Ne=s=>{i(t=>t.filter((u,d)=>d!==s))},E=(s,t)=>{i(u=>{const d=[...u];return d[s]={...d[s],...t},d})},we=(s,t)=>{const u=G==null?void 0:G.find(d=>d._id===t);E(s,{assigneeId:t||"",assigneeName:(u==null?void 0:u.staffName)||""})},Se=(s,t)=>{E(s,{dependentTaskId:t.length>0?t:void 0})},Ce=(s,t)=>{const u=F==null?void 0:F.find(d=>d._id===t);E(s,{projectId:t||"",projectName:(u==null?void 0:u.projectName)||""})},Te=s=>{if(!s)return;const t=_.find(d=>d._id===s);if(!t)return X({title:"Error",description:"No work Available",variant:"destructive"});const u=t==null?void 0:t.tasks.map(d=>{const N=d.estimatedTimeInMinutes||0;return{title:d.title,due:N,description:"",tasks:(d.subtasks||[]).map(h=>({taskName:h.title})),images:[],previewUrls:[],priority:"high",department:"site",assigneeId:"",assigneeName:"",projectId:"",projectName:"",organizationId:c,status:"queued"}});j((t==null?void 0:t.workName)||null),i(u),L(!0)},Re=(s,t,u)=>{const d=[...l];d[s].tasks[t].taskName=u,i(d)},Oe=s=>{const t=[...l];t[s].tasks.push({taskName:""}),i(t)},ke=(s,t)=>{const u=[...l];u[s].tasks.splice(t,1),i(u)},Ee=async()=>{var t,u;const s=l.map(d=>{const N=d.tasks.filter(h=>{var g;return(g=h.taskName)==null?void 0:g.trim()}).map(h=>({taskName:h.taskName.trim()}));return{...d,tasks:N.length>0?N:[]}});try{D?await je({assigneRole:"staff",tasks:s}):await be({assigneRole:"staff",tasks:s}),L(!1),i([n]),X({description:"Task Created Successfully",title:"Success"})}catch(d){X({title:"Error",description:((u=(t=d==null?void 0:d.response)==null?void 0:t.data)==null?void 0:u.message)||"Failed to update completion status",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6 text-blue-900 overflow-y-auto max-h-full",children:[e.jsxs("header",{className:"flex justify-between items-center w-full  sticky z-[999] top-0 bg-white pb-5  border-b-1 border-gray-300 ",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{onClick:()=>w(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("h2",{className:"text-3xl font-bold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-dolly mr-3 text-blue-600"}),"Assign Staff Tasks"]})]}),e.jsxs("div",{className:"flex justify-end md:w-[90%]  items-center gap-4",children:[e.jsxs(B,{type:"button",onClick:ye,variant:"secondary",className:"",children:[e.jsx("i",{className:"fa fa-plus mr-1"})," Add More Task"]}),e.jsxs(B,{type:"button",onClick:Ee,className:"bg-blue-600 text-white hover:bg-blue-700",isLoading:ve||xe,disabled:l.length===0,children:[e.jsx("i",{className:"fa fa-paper-plane mr-1"})," Submit All Tasks"]}),e.jsxs("div",{children:[e.jsx(k,{children:"Select Work from work library"}),e.jsx(J,{options:fe,placeholder:"Select Work",searchPlaceholder:"Search Works...",value:m||void 0,onValueChange:s=>Te(s),searchBy:"name",displayFormat:"simple",className:"w-full"})]})]})]}),l.map((s,t)=>{var u,d,N;return e.jsxs("div",{className:"bg-white border rounded-xl shadow-md p-6 space-y-4",children:[e.jsxs("section",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold text-blue-800",children:["Task #",t+1]}),e.jsxs(B,{onClick:()=>Ne(t),variant:"danger",className:`text-white bg-red-500 ${l.length===1?"!cursor-not-allowed":"cursor-pointer"}`,disabled:l.length===1,children:[e.jsx("i",{className:"fas fa-trash-alt mr-1"})," Remove Task"]})]}),e.jsx(H,{type:"file",multiple:!0,accept:"image/*",onChange:h=>{const g=Array.from(h.target.files||[]),Q=g.map(M=>URL.createObjectURL(M));E(t,{images:g,previewUrls:Q})}}),(s==null?void 0:s.previewUrls)&&e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mt-3",children:((u=s==null?void 0:s.previewUrls)==null?void 0:u.length)>0&&s.previewUrls.map((h,g)=>e.jsxs("div",{className:"w-50 h-50 relative group aspect-square rounded-lg overflow-hidden border border-gray-200 shadow-sm",children:[e.jsx("img",{src:h,className:"w-full h-full object-cover group-hover:opacity-80 transition"}),e.jsx("button",{type:"button",onClick:()=>{const Q=[...s.images],M=[...s.previewUrls];Q.splice(g,1),M.splice(g,1),E(t,{images:Q,previewUrls:M})},className:"absolute top-1 right-1 bg-black/70 text-white w-6 h-6 rounded-full flex items-center justify-center hover:bg-red-600 transition",children:"âœ•"})]},g))}),e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(k,{htmlFor:`title-${t}`,children:"Task Title"}),e.jsx(H,{id:`title-${t}`,placeholder:"Enter task title",value:s.title,onChange:h=>{const g=h.target.value;E(t,{title:g}),ge(t,g)}})]}),!D&&e.jsxs("div",{children:[e.jsx(k,{htmlFor:`due-${t}`,children:"Due Date"}),e.jsx(H,{id:`due-${t}`,type:"datetime-local",value:s.due,onChange:h=>E(t,{due:h.target.value})})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Select Assignee"}),e.jsx(J,{options:me,placeholder:"Select assignee",searchPlaceholder:"Search by name...",value:s.assigneeId||void 0,onValueChange:h=>we(t,h),searchBy:"name",displayFormat:"detailed",className:"w-full"}),(s==null?void 0:s.assigneeName)&&e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Assignee: ",s==null?void 0:s.assigneeName]})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Select Project"}),e.jsx(J,{options:pe,placeholder:"Select project",searchPlaceholder:"Search projects...",value:s.projectId||void 0,onValueChange:h=>Ce(t,h),searchBy:"name",displayFormat:"simple",className:"w-full"}),s.projectName&&e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Project: ",s.projectName]})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Priority"}),e.jsxs("select",{value:s.priority,onChange:h=>E(t,{priority:h.target.value}),className:"w-full border border-blue-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"})]})]}),e.jsxs("div",{children:[e.jsx(k,{children:"Department"}),e.jsxs("select",{value:s.department,onChange:h=>E(t,{department:h.target.value}),className:"w-full border border-blue-200 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600",children:[e.jsx("option",{value:"site",children:"Site"}),e.jsx("option",{value:"procurement",children:"Procurement"}),e.jsx("option",{value:"design",children:"Design"}),e.jsx("option",{value:"accounts",children:"Accounts"})]})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx(k,{children:"Description"}),e.jsx(ze,{rows:3,placeholder:"Enter task description",value:s.description,onChange:h=>E(t,{description:h.target.value}),className:"resize-none w-full"})]}),e.jsx("div",{className:"col-span-full",children:e.jsxs("label",{className:"flex gap-2 items-center mt-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:r,onChange:()=>{a(h=>!h)}}),e.jsx("span",{children:"Enable Task Dependencies (Select required tasks to be completed first)"})]})}),r&&e.jsx(is,{allTasks:ae,selected:s.dependentTaskId||[],onChange:h=>Se(t,h)})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx(k,{className:"text-[12px] text-gray-800",children:"Subtasks"}),e.jsx(k,{className:"text-[12px] text-gray-300",children:" (subtasks will be assinged automatically based on the task titles, if not assigned please enter the task manually, when you're assigning similar task, the sub tasks will be filled automatically )"}),((d=s==null?void 0:s.tasks)==null?void 0:d.length)===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl   text-center p-6",children:[e.jsx("i",{className:"fas fa-box-open text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Subtasks Found"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Looks like there are no tasks assigned yet ",e.jsx("br",{}),"Click on ",e.jsx("strong",{children:'"Add subtask"'})," to get started ðŸš€"]})]}),(N=s==null?void 0:s.tasks)==null?void 0:N.map((h,g)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:h.taskName,placeholder:`Subtask #${g+1}`,onChange:Q=>Re(t,g,Q.target.value)},g),e.jsx(B,{onClick:()=>ke(t,g),variant:"danger",className:"bg-red-600 text-white",size:"sm",children:e.jsx("i",{className:"fas fa-trash"})})]})),e.jsxs(B,{type:"button",onClick:()=>Oe(t),className:"bg-blue-200 hover:bg-blue-300 text-blue-900 mt-2",children:[e.jsx("i",{className:"fa fa-plus mr-1"})," Add Subtask"]})]})]},t)})]})};export{Ts as StaffAssignTaskMain,Cs as debounce,Ts as default};
