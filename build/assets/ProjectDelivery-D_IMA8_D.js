import{c as w,k as oe,x as N,d as y,q as B,g,u as le,w as ce,r as k,a as de,j as e,M as me,B as x,e as ue,t as p}from"./index-CUvv9ev0.js";import{C as W}from"./Card-CHHq377-.js";import{A as pe,S as fe}from"./AssignStaff-OukO8SLI.js";import{S as xe}from"./ShareDocumentWhatsapp-BuVztAX3.js";import{I as we}from"./ImageGalleryMain-CpyKJ1TW.js";import{S as ge}from"./StageGuide-n_FMHWm4.js";import"./getAllUsersApi-0yi3cLLK.js";import"./documentationApi-ZYgPAMqy.js";import"./requirementFormApi-Cjm4ZgKK.js";import"./index-BKXLMMDl.js";const he=async(s,r,n)=>{const{data:a}=await n.post(`/projectdelivery/${s}/upload`,r);if(!a.ok)throw new Error(a.message);return a.data},ye=()=>{const{role:s}=w(),r=g(s),n=["owner","CTO","staff"],a=N();return y({mutationFn:async({projectId:o,formData:l})=>{if(!s||!n.includes(s))throw new Error("Not allowed.");if(!r)throw new Error("API instance missing");return await he(o,l,r)},onSuccess:(o,{projectId:l})=>{a.invalidateQueries({queryKey:["project-delivery",l]})}})},je=async(s,r,n)=>{const{data:a}=await n.delete(`/projectdelivery/${s}/upload/${r}`);if(!a.ok)throw new Error(a.message);return a.data},be=()=>{const{role:s}=w(),r=g(s),n=["owner","CTO","staff"],a=N();return y({mutationFn:async({projectId:o,fileId:l})=>{if(!s||!n.includes(s))throw new Error("Not allowed.");if(!r)throw new Error("API instance missing");return await je(o,l,r)},onSuccess:(o,{projectId:l})=>{a.invalidateQueries({queryKey:["project-delivery",l]})}})},ve=async(s,r,n)=>{const{data:a}=await n.put(`/projectdelivery/${s}/client-confirmation`,{confirmed:r});if(!a.ok)throw new Error(a.message);return a.data},Ne=()=>{const{role:s}=w(),r=g(s),n=["client"],a=N();return y({mutationFn:async({projectId:o,confirm:l})=>{if(!s||!n.includes(s))throw new Error("Not allowed.");if(!r)throw new Error("API instance missing");return await ve(o,l,r)},onSuccess:(o,{projectId:l})=>{a.invalidateQueries({queryKey:["project-delivery",l]})}})},Ce=async(s,r,n)=>{const{data:a}=await n.put(`/projectdelivery/${s}/owner-confirmation`,{confirmed:r});if(!a.ok)throw new Error(a.message);return a.data},Ae=()=>{const{role:s}=w(),r=g(s),n=["owner"],a=N();return y({mutationFn:async({projectId:o,confirm:l})=>{if(!s||!n.includes(s))throw new Error("Not allowed.");if(!r)throw new Error("API instance missing");return await Ce(o,l,r)},onSuccess:(o,{projectId:l})=>{a.invalidateQueries({queryKey:["project-delivery",l]})}})},Fe=async(s,r)=>{const{data:n}=await r.get(`/projectdelivery/${s}`);if(!n.ok)throw new Error(n.message);return n.data},ke=s=>{const{role:r}=w(),n=g(r),a=["owner","CTO","client","staff"];return oe({queryKey:["project-delivery",s],queryFn:async()=>{if(!r||!a.includes(r))throw new Error("Not allowed.");if(!n)throw new Error("API instance missing");return await Fe(s,n)},enabled:!!s&&!!r,retry:!1,refetchOnMount:!1})},Pe=async({formId:s,deadLine:r,projectId:n,api:a})=>{const{data:o}=await a.put(`/projectdelivery/deadline/${n}/${s}`,{deadLine:r});if(!o.ok)throw new Error(o.message);return o.data},Se=async({projectId:s,organizationId:r,api:n})=>{const{data:a}=await n.put(`/projectdelivery/completionstatus/${r}/${s}`);if(!a.ok)throw new Error(a.message);return a.data},De=()=>{const s=["owner","staff","CTO"],{role:r}=w(),n=g(r);return y({mutationFn:async({formId:a,deadLine:o,projectId:l})=>{if(!r||!s.includes(r))throw new Error("not allowed to make this api call");if(!n)throw new Error("API instance missing");return await Pe({formId:a,projectId:l,deadLine:o,api:n})},onSuccess:()=>{B.invalidateQueries({queryKey:["project-delivery"]})}})},Ee=()=>{const s=["owner","staff","CTO"],{role:r}=w(),n=g(r);return y({mutationFn:async({projectId:a,organizationId:o})=>{if(!r||!s.includes(r))throw new Error("not allowed to make this api call");if(!n)throw new Error("API instance missing");return await Se({projectId:a,organizationId:o,api:n})},onSuccess:(a,{projectId:o})=>{B.invalidateQueries({queryKey:["project-delivery",o]})}})};function Ke(){var R,L,M,_,Q,T,K,U,z,G;const{projectId:s,organizationId:r}=le(),{isMobile:n,openMobileSidebar:a}=ce(),[o,l]=k.useState(null),{data:t,isLoading:P,error:f,refetch:h}=ke(s),{mutateAsync:V,isPending:Y}=ye(),{mutateAsync:H,isPending:J,variables:C}=be(),{mutateAsync:X}=Ne(),{mutateAsync:Z}=Ae(),{mutateAsync:ee,isPending:te}=De(),{mutateAsync:se,isPending:re}=Ee(),{role:A,permission:u}=de(),S=A==="owner"||((R=u==null?void 0:u.projectdelivery)==null?void 0:R.delete),j=A==="owner"||((L=u==null?void 0:u.projectdelivery)==null?void 0:L.create),b=A==="owner"||((M=u==null?void 0:u.projectdelivery)==null?void 0:M.edit),[D,E]=k.useState([]),F=k.useRef(null),ae=async()=>{var i,m;try{await se({projectId:s,organizationId:r}),p({description:"Project Delivery marked as complete.",title:"Success"}),h()}catch(d){p({title:"Error",description:((m=(i=d==null?void 0:d.response)==null?void 0:i.data)==null?void 0:m.message)||d.message||"Failed to update status",variant:"destructive"})}},ne=i=>{i.target.files&&E(Array.from(i.target.files))},ie=async()=>{var m,d;if(!D.length){p({title:"Error",description:"Please select at least one file.",variant:"destructive"});return}const i=new FormData;D.forEach(c=>{i.append("files",c)});try{await V({projectId:s,formData:i}),p({title:"Success",description:"Files uploaded successfully."}),h(),E([]),F.current&&(F.current.value="")}catch(c){p({title:"Error",description:((d=(m=c==null?void 0:c.response)==null?void 0:m.data)==null?void 0:d.message)||c.message||"Upload failed",variant:"destructive"})}},I=async i=>{var m,d;try{await H({projectId:s,fileId:i}),p({title:"Success",description:"File deleted."}),h()}catch(c){p({title:"Error",description:((d=(m=c==null?void 0:c.response)==null?void 0:m.data)==null?void 0:d.message)||c.message||"Deletion failed",variant:"destructive"})}},$=async i=>{var d,c;const m=i==="client"?X:Z;try{await m({projectId:s,confirm:!(t!=null&&t[`${i}Confirmation`])}),p({title:"Success",description:`${i==="client"?"Client":"Owner"} confirmation updated.`}),h()}catch(v){p({title:"Error",description:((c=(d=v==null?void 0:v.response)==null?void 0:d.data)==null?void 0:c.message)||v.message||"Failed to update confirmation",variant:"destructive"})}};let q=(_=(t==null?void 0:t.uploads)||[])==null?void 0:_.filter(i=>i.type==="pdf"),O=(Q=(t==null?void 0:t.uploads)||[])==null?void 0:Q.filter(i=>i.type==="image");return P?e.jsx(me,{}):e.jsxs("div",{className:"w-full sm:min-h-full sm:overflow-y-auto space-y-6 py-1 sm:py-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start lg:items-center gap-4pb-4",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-semibold text-blue-600 flex items-center",children:[n&&e.jsx("button",{onClick:a,className:"mr-3 p-2 rounded-md border border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-handshake mr-2"}),"Project Delivery"]}),e.jsxs(e.Fragment,{children:[" ",(j||b)&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs(x,{isLoading:re,onClick:ae,className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark as Complete"]}),!f&&e.jsx(xe,{projectId:s,stageNumber:"14",className:"w-full sm:w-fit",isStageCompleted:t==null?void 0:t.status}),e.jsx(pe,{projectId:s,organizationId:r,stageName:"ProjectDeliveryModel",currentAssignedStaff:(t==null?void 0:t.assignedTo)||null,className:"w-full sm:w-auto"})]}),e.jsx("div",{className:"w-full sm:w-auto flex justify-end sm:block",children:e.jsx(ge,{organizationId:r,stageName:"projectdelivery"})})]})]}),f?e.jsxs("div",{className:"max-w-xl mx-auto bg-red-50 border border-red-200 rounded-lg shadow p-6 text-center",children:[e.jsx("div",{className:"text-red-600 text-xl font-bold mb-2",children:"⚠️ Error Loading Data"}),e.jsx("p",{className:"text-sm text-red-500 mb-4",children:((K=(T=f==null?void 0:f.response)==null?void 0:T.data)==null?void 0:K.message)||(f==null?void 0:f.message)||"Something went wrong while fetching project delivery details."}),e.jsx(x,{onClick:()=>h(),isLoading:P,className:"bg-red-600 hover:bg-red-700 text-white",children:"Retry"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(W,{className:"p-4 border-l-[4px] border-blue-600 shadow w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(fe,{completedAt:(U=t==null?void 0:t.timer)==null?void 0:U.completedAt,stageName:"projectdelivery",projectId:s,formId:t==null?void 0:t._id,deadLine:(z=t==null?void 0:t.timer)==null?void 0:z.deadLine,startedAt:(G=t==null?void 0:t.timer)==null?void 0:G.startedAt,refetchStageMutate:h,deadLineMutate:ee,isPending:te})]}),e.jsxs(W,{className:"p-6 border-2 border-blue-200 shadow w-full flex flex-col gap-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-bold text-blue-800 mb-3",children:[e.jsx("i",{className:"fas fa-paperclip mr-2 text-blue-600"}),"Upload Files"]}),(j||b)&&e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-end",children:[e.jsx("input",{multiple:!0,ref:F,type:"file",onChange:ne,accept:".pdf,image/*",className:"w-full sm:w-[300px] border border-blue-300 px-3 py-2 rounded text-sm"}),e.jsx(x,{onClick:ie,isLoading:Y,className:"bg-blue-600 text-white hover:bg-blue-700",children:"Upload Files"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"min-h-[220px] sm:max-h-[150px] sm:min-h-[150px] border-2 border-[#0a0a0a18] px-2 rounded-xl lg:min-h-[280px]  overflow-y-auto custom-scrollbar",children:[e.jsxs("h3",{className:"font-semibold text-blue-700 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-file-pdf"}),"PDF Files"]}),q.length===0?e.jsx("div",{className:"h-[85%] shadow rounded bg-blue-50 flex items-center justify-center",children:e.jsx("p",{className:"text-sm font-medium text-gray-500 px-4 text-center",children:"No PDF files uploaded."})}):e.jsx("ul",{className:"space-y-2",children:q.map(i=>e.jsxs("li",{className:"flex justify-between items-center bg-blue-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"truncate text-sm",children:i.originalName}),e.jsxs("div",{className:"flex gap-3 items-center text-blue-600",children:[e.jsx(x,{size:"sm",variant:"primary",onClick:()=>ue({src:i==null?void 0:i.url,alt:(i==null?void 0:i.originalName)||"file.pdf"}),children:e.jsx("i",{className:"fa-solid fa-download"})}),S&&e.jsx(x,{size:"sm",isLoading:(C==null?void 0:C.fileId)===i._id&&J,onClick:()=>I(i._id),className:"text-red-600",children:e.jsx("i",{className:"fas fa-trash"})})]})]},i._id))})]}),e.jsxs("div",{className:" min-h-[220px] sm:max-h-[150px]  sm:min-h-[150px]  border-2 border-[#0a0a0a18] px-2 rounded-xl lg:min-h-[280px] overflow-y-auto custom-scrollbar",children:[e.jsxs("h3",{className:"font-semibold text-blue-700 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-image"}),"Image Files"]}),O.length===0?e.jsx("div",{className:"h-[85%] shadow rounded bg-blue-50 flex items-center justify-center",children:e.jsx("p",{className:"text-sm font-medium text-gray-500 px-4 text-center",children:"No images uploaded."})}):e.jsx(we,{imageFiles:O,...S?{handleDeleteFile:I}:{},height:80,minWidth:98,maxWidth:100})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-3 gap-4",children:[(j||b)&&e.jsxs(x,{onClick:()=>$("client"),className:`w-full ${t!=null&&t.clientConfirmation?"bg-blue-600":"bg-red-600"} text-white`,children:[e.jsx("i",{className:`fas ${t!=null&&t.clientConfirmation?"fa-check":"fa-xmark"} mr-2`})," ",t!=null&&t.clientConfirmation?"Client Confirmed":"Client not confirmed"]}),(j||b)&&e.jsxs(x,{onClick:()=>$("owner"),className:`w-full ${t!=null&&t.ownerConfirmation?"bg-blue-600":"bg-red-600"} text-white`,children:[e.jsx("i",{className:`fas ${t!=null&&t.ownerConfirmation?"fa-check":"fa-xmark"} mr-2`})," ",t!=null&&t.ownerConfirmation?"Owner Confirmed":"Owner not confirmed"]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded px-4 py-3 flex items-center gap-3 text-sm text-blue-800",children:[e.jsx("i",{className:"fas fa-user-check text-blue-600 text-base"}),e.jsxs("p",{className:"font-medium",children:["Client Confirmed At:"," ",e.jsx("span",{className:"font-semibold text-blue-900",children:t!=null&&t.clientAcceptedAt?new Date(t.clientAcceptedAt).toLocaleDateString():"Not Confirmed Yet"})]})]})]}),o&&e.jsx("div",{onClick:()=>l(null),className:"fixed inset-0 z-50 bg-black/70 bg-opacity-60 flex items-center justify-center",children:e.jsxs("div",{onClick:i=>i.stopPropagation(),className:"relative bg-white rounded py-8 px-4 max-w-[90vw] max-h-[80vh] shadow-lg",children:[e.jsx("i",{className:"fas fa-times absolute top-2 right-3 text-xl text-gray-700 hover:text-red-500 cursor-pointer",onClick:()=>l(null)}),e.jsx("img",{src:o,alt:"Full View",className:"max-h-[70vh] w-auto object-contain rounded"})]})})]})]})}export{Ke as default};
