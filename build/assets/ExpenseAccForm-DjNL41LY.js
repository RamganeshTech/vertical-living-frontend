import{r as f,b as Q,j as e}from"./index-BZjlY-2Z.js";import{b as X,c as Y,d as Z,e as ee}from"./expenseApi-B_9sK2uy.js";import{t as m}from"./toast-BSC5QTk1.js";import{u as te}from"./vendorAccApi-Dr83gsac.js";import{L as E}from"./Label-D3bfhfMc.js";import{S as ae}from"./SearchSelectNew-CsBcN9wE.js";import se from"./MaterialOverviewLoading-C38kMtqM.js";import{B as re}from"./Button-BGBzZFjk.js";import{I as ne}from"./InfoToolTip-0lhuhhlF.js";import{u as le}from"./projectApi-BpJewSwc.js";const ye=({mode:n,organizationId:j,expenseId:b,onSuccess:p,onCancel:y,onEdit:d,isEditing:O})=>{var A,B,F,$;const D=X(),S=Y(),[N,W]=f.useState(!1),{mutateAsync:M,isPending:U}=Z(),{data:t,isLoading:G,refetch:w}=ee(b||"",n!=="create"&&!!b),{data:g}=te(j),H=(A=g||[])==null?void 0:A.map(a=>({value:a._id,label:a.vendorName,email:a.email})),{role:P,permission:h}=Q(),q=P==="owner"||((B=h==null?void 0:h.expense)==null?void 0:B.create),I=P==="owner"||((F=h==null?void 0:h.expense)==null?void 0:F.edit),T=new Date,C=new Date(T);C.setDate(T.getDate()+10);const[r,c]=f.useState({vendorId:"",vendorName:"",amount:0,dueDate:C,projectId:null,projectName:null,expenseDate:new Date,payThrough:"",notes:""}),{data:k}=le(j),x=k==null?void 0:k.map(a=>({_id:a._id,projectName:a.projectName})),[u,L]=f.useState({});f.useEffect(()=>{t&&(n==="edit"||n==="view")&&c({vendorId:t.vendorId,vendorName:t.vendorName,amount:t.amount,expenseDate:new Date(t.expenseDate),payThrough:t.payThrough,notes:t.notes||"",projectId:(t==null?void 0:t.projectId)||null,projectName:(t==null?void 0:t.projectName)||null,dueDate:new Date(t==null?void 0:t.dueDate)})},[t,n]);const z=async()=>{var a,l;try{if(t!=null&&t.isSyncWithPaymentsSection)return m({variant:"destructive",title:"Error",description:"already sent to payments section"});await M({expenseId:t==null?void 0:t._id}),w==null||w(),m({title:"Success",description:"Expense sent to Payments Section"})}catch(s){m({variant:"destructive",title:"Error",description:((l=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:l.message)||(s==null?void 0:s.message)||"operation failed"})}},R=()=>{const a={};return r.vendorName.trim()||(a.vendorName="Vendor name is required"),r.amount<=0&&(a.amount="Amount must be greater than 0"),L(a),Object.keys(a).length===0},v=a=>{const{name:l,value:s}=a.target;c(i=>({...i,[l]:l==="amount"?parseFloat(s)||0:s})),u[l]&&L(i=>({...i,[l]:void 0}))},V=a=>{const{name:l,value:s}=a.target;c(i=>({...i,[l]:new Date(s)}))},J=a=>{const l=g==null?void 0:g.find(s=>s._id===a);c(s=>({...s,vendorId:a||"",vendorName:(l==null?void 0:l.vendorName)||""}))},K=async a=>{var l,s;if(a.preventDefault(),n!=="view"){if(!R()){m({title:"Error",description:"Please fix the errors in the form",variant:"destructive"});return}try{n==="create"?(await D.mutateAsync({organizationId:j,...r}),m({title:"Success",description:"Expense created successfully!"}),p==null||p(),c({vendorId:"",vendorName:"",amount:0,dueDate:C,projectId:null,projectName:null,expenseDate:new Date,payThrough:"",notes:""})):n==="edit"&&b&&(await S.mutateAsync({id:b,...r,vendorId:r.vendorId._id}),m({title:"Success",description:"Expense updated successfully!"}),p==null||p(),d==null||d())}catch(i){m({title:"Error",description:((s=(l=i==null?void 0:i.response)==null?void 0:l.data)==null?void 0:s.message)||(i==null?void 0:i.message)||"Failed to submit expense",variant:"destructive"})}}};if(n!=="create"&&G)return e.jsx(se,{});const o=n==="view",_=D.isPending||S.isPending;return e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[e.jsxs("header",{className:"border-b pb-4 flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 flex gap-2",children:[e.jsx("div",{onClick:y,className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),n==="create"&&"Create New Expense",n==="edit"&&"Edit Expense",n==="view"&&"Expense Details"]}),n==="view"&&t&&e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Expense: ",t==null?void 0:t.expenseNumber]})]}),e.jsxs("div",{className:"gap-2 flex items-center",children:[n==="view"&&(q||I)&&e.jsxs("div",{className:"flex items-center space-y-1",children:[e.jsx(re,{variant:"primary",className:`${t!=null&&t.isSyncWithPaymentsSection?"!cursor-not-allowed":""}`,title:t!=null&&t.isSyncWithPaymentsSection?"already sent to payment":"",isLoading:U,disabled:t==null?void 0:t.isSyncWithPaymentsSection,onClick:z,children:"Send To Payments Section"}),e.jsx(ne,{content:"Click the button to send the bill to Payments section",type:"info",position:"bottom"})]}),(n==="edit"||n==="view")&&I&&e.jsxs("button",{type:"button",onClick:d,className:`bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 \r
                                            transition-colors flex items-center gap-2`,children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),O?"Cancel":"Edit"," Expense"]})]})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Vendor"}),e.jsx(ae,{options:H,placeholder:"Select Vendor",searchPlaceholder:"Search Vendor...",value:(r==null?void 0:r.vendorId)||void 0,onValueChange:a=>J(a),searchBy:"name",displayFormat:"simple",className:"w-full"})]}),e.jsxs("div",{className:"",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"checkbox",className:"cursor-pointer",checked:N,id:"enableName",onChange:()=>W(a=>!a)}),e.jsx(E,{htmlFor:"enableName",className:"cursor-pointer",children:"Click the check box to enter the name manually, if not available from the drop down"})]}),e.jsx("input",{type:"text",name:"vendorName",value:r.vendorName,onChange:a=>{N&&v(a)},disabled:!N,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"Enter customer name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Project"}),e.jsxs("select",{value:(r==null?void 0:r.projectId)||"",onChange:a=>{const l=x==null?void 0:x.find(s=>s._id===a.target.value);c(l?s=>({...s,projectId:l._id,projectName:l.projectName}):s=>({...s,projectId:null,projectName:null}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Projects"}),x==null?void 0:x.map(a=>e.jsx("option",{value:a._id,children:a.projectName},a._id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Amount ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-2.5 text-gray-500",children:"â‚¹"}),e.jsx("input",{type:"number",name:"amount",value:r.amount,onChange:v,disabled:o,step:"1",min:"0",className:`w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 
                            ${u.amount?"border-red-500":"border-gray-300"}
                            ${o?"bg-gray-100 cursor-not-allowed":""}`,placeholder:"0.00"})]}),u.amount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:u.amount})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Expense Date"}),e.jsx("input",{type:"date",name:"expenseDate",value:($=r==null?void 0:r.expenseDate)==null?void 0:$.toISOString().split("T")[0],onChange:V,disabled:o,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 
                        ${o?"bg-gray-100 cursor-not-allowed":"border-gray-300"}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Due Date"}),e.jsx("input",{type:"date",name:"dueDate",value:r!=null&&r.dueDate&&!isNaN(new Date(r.dueDate).getTime())?new Date(r.dueDate).toISOString().split("T")[0]:"",onChange:V,disabled:o,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 
                        ${o?"bg-gray-100 cursor-not-allowed":"border-gray-300"}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Paid Through"}),e.jsxs("select",{name:"payThrough",value:r.payThrough,onChange:v,disabled:o,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 
                        ${u.payThrough?"border-red-500":"border-gray-300"}
                        ${o?"bg-gray-100 cursor-not-allowed":""}`,children:[e.jsx("option",{value:"",children:"Select payment method"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit Card",children:"Credit Card"}),e.jsx("option",{value:"Debit Card",children:"Debit Card"}),e.jsx("option",{value:"Check",children:"Check"}),e.jsx("option",{value:"UPI",children:"UPI"}),e.jsx("option",{value:"Other",children:"Other"})]}),u.payThrough&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:u.payThrough})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes"}),e.jsx("textarea",{name:"notes",value:r.notes,onChange:v,disabled:o,rows:4,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 
                        ${o?"bg-gray-100 cursor-not-allowed":"border-gray-300"}`,placeholder:"Add any additional notes..."})]}),e.jsx("div",{className:"flex gap-4 pt-4 border-t",children:!o&&e.jsxs("div",{className:"w-full flex justify-between space-x-3 ",children:[e.jsx("button",{type:"submit",disabled:_,className:`flex-1  bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 \r
                            disabled:opacity-50 disabled:cursor-not-allowed transition-colors`,children:_?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsxs("svg",{className:"animate-spin h-5 w-5",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),n==="create"?"Creating...":"Updating..."]}):n==="create"?"Create Expense":"Update Expense"}),e.jsx("button",{type:"button",onClick:()=>{n==="create"?y==null||y():n==="edit"&&(d==null||d())},className:`flex-1  bg-gray-200 text-gray-700 py-2 px-4 rounded-lg \r
                        hover:bg-gray-300 transition-colors`,children:o?"Close":"Cancel"})]})})]})};export{ye as E};
