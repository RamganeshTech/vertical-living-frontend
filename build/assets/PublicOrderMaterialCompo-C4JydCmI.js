import{b as C,h as Q,s as w,c as A,g as G,r as p,j as r,B as J,t as q}from"./index-BAM0eJUz.js";import{O as Z}from"./OrderMaterialOverview-6X9CUgR9.js";import{I as V}from"./Input-1UBXZqEj.js";import{S as ee}from"./SearchSelectNew-IGAHiELy.js";import{u as re}from"./vendorAccApi-m3R96_-K.js";const T="https://houseofram.in/api",se=async({projectId:s})=>{const{data:c}=await A.get(`${T}/publicordermaterial/${s}/getpublicsubitems`);if(!c.ok)throw new Error(c.message);return c.data},te=s=>C({queryKey:["public-ordering-material",s],queryFn:async()=>await se({projectId:s}),enabled:!!s,retry:!1,refetchOnMount:!1}),ae=async({projectId:s,subItemName:c,quantity:e,unit:i})=>{const{data:u}=await A.post(`${T}/publicordermaterial/${s}/addsubitem`,{subItemName:c,quantity:e,unit:i});if(!u.ok)throw new Error(u.message);return u.data},ce=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemName:e,quantity:i,unit:u})=>await ae({projectId:c,subItemName:e,quantity:i,unit:u}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},ne=async({projectId:s,subItemId:c})=>{const{data:e}=await A.delete(`${T}/publicordermaterial/${s}/deletesubitem/${c}`);if(!e.ok)throw new Error(e.message);return e.data},ue=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemId:e})=>await ne({projectId:c,subItemId:e}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},ie=async({projectId:s,subItemId:c,subItemName:e,quantity:i,unit:u})=>{const{data:t}=await A.put(`${T}/publicordermaterial/${s}/updatesubitem/${c}`,{subItemName:e,quantity:i,unit:u});if(!t.ok)throw new Error(t.message);return t.data},de=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemId:e,subItemName:i,quantity:u,unit:t})=>await ie({projectId:c,subItemId:e,subItemName:i,quantity:u,unit:t}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},oe=async({projectId:s})=>{const{data:c}=await A.put(`${T}/publicordermaterial/${s}/submitpublicorder`);if(!c.ok)throw new Error(c.message);return c.data},ge=()=>Q({mutationFn:async({projectId:s})=>await oe({projectId:s}),onSuccess:(s,{projectId:c})=>{w.invalidateQueries({queryKey:["public-ordering-material",c]})}}),le=async({orgsId:s})=>{try{let{data:c}=await A.get(`https://houseofram.in/api/publicordermaterial/getprojects/${s}`);return c.ok?c.data:[]}catch(c){throw c}},Ne=s=>C({queryKey:["publicproject"],queryFn:async()=>await le({orgsId:s}),refetchOnWindowFocus:!1,retry:!1}),me=async(s,c)=>{const{data:e}=await A.put(`https://houseofram.in/api/publicordermaterial/${s}/shop`,c);if(!e.ok)throw new Error(e.message);return e.data},pe=()=>{const s=G();return Q({mutationFn:async({projectId:c,updates:e})=>await me(c,e),onSuccess:(c,{projectId:e})=>{s.invalidateQueries({queryKey:["public-ordering-material",e]})}})},he=({label:s="",options:c,value:e,onChange:i,onSelectOption:u,placeholder:t="Type or select...",name:d,mode:m="simple",onKeyDown:j,onBlur:N,autoFocus:b=!1})=>{var $;const[I,x]=p.useState(!1),[h,a]=p.useState(""),[v,k]=p.useState(c),O=p.useRef(null),g=p.useRef(null);p.useEffect(()=>{b&&g.current&&g.current.focus()},[b]),p.useEffect(()=>{m==="object"&&e&&typeof e=="object"?a(e.value):m==="simple"&&typeof e=="string"?a(e):e||a("")},[e,m]),p.useEffect(()=>{if(h){const o=c.filter(y=>(typeof y=="string"?y:y.value).toLowerCase().includes(h.toLowerCase()));k(o)}else k(c)},[h,c]),p.useEffect(()=>{const o=y=>{O.current&&!O.current.contains(y.target)&&x(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const W=o=>{const y=o.target.value;a(y),x(!0),i(m==="simple"?y:{_id:"",value:y})},z=o=>{const y=typeof o=="string"?o:o.value;a(y),x(!1),typeof o=="string"?(i(o),u==null||u(o)):(i(o),u==null||u(o.value))},H=()=>{x(!0)},X=()=>{setTimeout(()=>{N==null||N()},200)},Y=o=>{o.key==="Escape"&&x(!1),j==null||j(o)},K=o=>typeof o=="string"?o:o.value;return r.jsxs("div",{className:"relative w-full",ref:O,children:[s&&r.jsx("label",{htmlFor:d,className:"block text-sm font-medium text-gray-700 mb-2",children:s}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{ref:g,id:d,type:"text",value:h,onChange:W,onFocus:H,onBlur:X,onKeyDown:Y,placeholder:t,className:"w-full px-4 py-2.5 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all",autoComplete:"off"}),r.jsx("button",{type:"button",onClick:()=>x(!I),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",tabIndex:-1,children:r.jsx("i",{className:`fas fa-chevron-down transition-transform duration-200 ${I?"rotate-180":""}`})})]}),I&&r.jsx("div",{className:"fixed z-[9999] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",style:{width:(($=g.current)==null?void 0:$.offsetWidth)||"auto",top:g.current?g.current.getBoundingClientRect().bottom+window.scrollY:0,left:g.current?g.current.getBoundingClientRect().left+window.scrollX:0},children:v.length>0?r.jsx("ul",{className:"py-1",children:v.map((o,y)=>{const F=K(o),S=typeof o=="object"?o._id:y;return r.jsx("li",{onMouseDown:()=>z(o),className:"px-4 py-2.5 hover:bg-blue-50 cursor-pointer transition-colors text-gray-700 hover:text-blue-600",children:F},S)})}):r.jsx("div",{className:"px-4 py-3 text-sm text-gray-500",children:r.jsxs("p",{className:"flex items-center gap-2",children:[r.jsx("i",{className:"fas fa-info-circle"}),'No matches found. Current value: "',h,'"']})})})]})},U=["Cement","Steel Rods","Bricks","Sand","Gravel","Concrete Mix","Paint","Wood Planks","Tiles","Glass","Nails","Screws"],E=({item:s,isNewRow:c=!1,newRowData:e,setNewRowData:i,editingCell:u,setEditingCell:t,onSave:d,onNewRowSave:m,onDelete:j,isDeleting:N,isAdding:b})=>{const I=p.useRef(null),[x,h]=p.useState("");return p.useEffect(()=>{u&&I.current&&I.current.focus()},[u]),c?r.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-green-50 border-b border-gray-100",children:[r.jsx("div",{className:"col-span-3 border-r border-gray-200 px-4 py-3 text-gray-400 text-sm",children:"Auto"}),r.jsx("div",{className:"col-span-8 border-r border-gray-200",children:r.jsx(B,{value:(e==null?void 0:e.name)||"",options:U,placeholder:"Enter material name...",onChange:a=>{i==null||i({...e,name:a})},onSelectOption:a=>{i==null||i({...e,name:a}),e!=null&&e.unit&&(m==null||m({...e,name:a}))},onEnter:()=>{var a;(a=e==null?void 0:e.name)!=null&&a.trim()&&(e!=null&&e.unit)&&(m==null||m(e))}})}),r.jsx("div",{className:"col-span-2 border-r border-gray-200",children:r.jsx("input",{type:"number",placeholder:"Qty",min:"0",value:(e==null?void 0:e.quantity)||1,onChange:a=>{i==null||i({...e,quantity:Number(a.target.value)||1})},className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),r.jsx("div",{className:"col-span-3 border-r border-gray-200",children:r.jsx(B,{value:(e==null?void 0:e.unit)||"",options:Z,placeholder:"Select unit...",onChange:a=>{i==null||i({...e,unit:a})},onSelectOption:async a=>{var k;const v={...e,unit:a};i==null||i(v),(k=v.name)!=null&&k.trim()&&await(m==null?void 0:m(v))},onEnter:async()=>{var a;(a=e==null?void 0:e.name)!=null&&a.trim()&&(e!=null&&e.unit)&&await(m==null?void 0:m(e))}})}),r.jsx("div",{className:"col-span-1 flex items-center justify-center",children:b&&r.jsx("i",{className:"fas fa-spinner fa-spin text-green-600"})})]}):r.jsxs("div",{className:"grid grid-cols-17 gap-0 border-b border-gray-100 hover:bg-gray-50",children:[r.jsx("div",{className:"col-span-3 border-r border-blue-200 px-4 py-3 text-sm text-gray-600",children:(s==null?void 0:s.refId)||"N/A"}),r.jsx("div",{className:"col-span-8 border-r border-blue-200",children:(u==null?void 0:u.subItemId)===s._id&&(u==null?void 0:u.field)==="name"?r.jsx(B,{value:x||s.subItemName,options:U,onChange:a=>{h(a)},onSelectOption:a=>{d==null||d(s._id,"name",a),t==null||t(null),h("")},onEnter:()=>{d==null||d(s._id,"name",x||s.subItemName),t==null||t(null),h("")},onBlur:()=>{t==null||t(null),h("")},autoFocus:!0}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{t==null||t({subItemId:s._id,field:"name"}),h(s.subItemName)},children:s.subItemName})}),r.jsx("div",{className:"col-span-2 border-r border-blue-200",children:(u==null?void 0:u.subItemId)===s._id&&(u==null?void 0:u.field)==="quantity"?r.jsx("input",{ref:I,type:"number",defaultValue:s.quantity,min:"0",className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:a=>{d==null||d(s._id,"quantity",a.target.value),t==null||t(null)},onKeyDown:a=>{a.key==="Enter"&&(d==null||d(s._id,"quantity",a.currentTarget.value),t==null||t(null)),a.key==="Escape"&&(t==null||t(null))}}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>t==null?void 0:t({subItemId:s._id,field:"quantity"}),children:s.quantity})}),r.jsx("div",{className:"col-span-3 border-r border-blue-200",children:(u==null?void 0:u.subItemId)===s._id&&(u==null?void 0:u.field)==="unit"?r.jsx(B,{value:x||s.unit,options:Z,onChange:a=>{h(a)},onSelectOption:a=>{d==null||d(s._id,"unit",a),t==null||t(null),h("")},onEnter:()=>{d==null||d(s._id,"unit",x||s.unit),t==null||t(null),h("")},onBlur:()=>{t==null||t(null),h("")},autoFocus:!0}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{t==null||t({subItemId:s._id,field:"unit"}),h(s.unit)},children:s.unit})}),r.jsx("div",{className:"col-span-1 flex items-center justify-center",children:r.jsx(J,{variant:"danger",onClick:()=>j==null?void 0:j(s._id),disabled:N,className:"p-2 bg-red-600 text-white hover:bg-red-700 rounded transition-colors disabled:opacity-50",title:"Delete item",children:N?r.jsx("i",{className:"fas fa-spinner fa-spin text-sm"}):r.jsx("i",{className:"fa fa-trash text-sm"})})})]})},B=({value:s,options:c,placeholder:e,onChange:i,onSelectOption:u,onBlur:t,onEnter:d,autoFocus:m})=>{const j=b=>{typeof b=="string"?i(b):b&&typeof b=="object"?i(b.value):b===null&&i("")},N=b=>{b.key==="Enter"&&(d==null||d())};return r.jsx("div",{className:"w-full",children:r.jsx(he,{label:"",name:"field",value:s,onChange:j,onSelectOption:u,options:c,mode:"simple",placeholder:e,onKeyDown:N,onBlur:t,autoFocus:m})})},Ie=({selectedProjectId:s,organizationId:c})=>{var K,$,o,y,F,S;const{data:e}=re(c),[i,u]=p.useState(!1),[t,d]=p.useState({}),[m,j]=p.useState({selectedId:null,shopName:null});p.useEffect(()=>{if(m.selectedId&&e.length>0){const n=e.find(l=>l._id===m.selectedId);n&&d({shopName:n==null?void 0:n.shopName,address:n==null?void 0:n.address,contactPerson:n==null?void 0:n.vendorName,phoneNumber:n==null?void 0:n.phoneNo,priority:(n==null?void 0:n.priority)||[]})}},[m.selectedId,e]);const N=p.useMemo(()=>e==null?void 0:e.map(n=>({value:n._id,label:n.shopName||n.vendorName,subLabel:n.contactPerson})),[e]),[b,I]=p.useState({name:"",quantity:1,unit:""}),[x,h]=p.useState(null),{data:a,isLoading:v}=te(s),k=ce(),O=de(),g=ue(),W=async(n,l,f)=>{var _,L,M;try{const P=(_=a==null?void 0:a.subItems)==null?void 0:_.find(R=>R._id===n);if(!P)return;const D={projectId:s,subItemId:n,subItemName:l==="name"?f:P.subItemName,quantity:l==="quantity"?Number(f)||1:P.quantity,unit:l==="unit"?f:P.unit};await O.mutateAsync(D),q({title:"Success",description:"Item updated successfully"})}catch(P){q({title:"Error",description:((M=(L=P==null?void 0:P.response)==null?void 0:L.data)==null?void 0:M.message)||"Failed to update item",variant:"destructive"})}},z=async n=>{var f,_,L;const l=n;if(!((f=l==null?void 0:l.name)!=null&&f.trim()))return q({title:"Error",description:"Material Name is mandatory",variant:"destructive"});if(!(l!=null&&l.unit))return q({title:"Error",description:"Unit is mandatory",variant:"destructive"});try{await k.mutateAsync({projectId:s,unitId:"",subItemName:l.name,quantity:l.quantity||1,unit:l.unit}),I({name:"",quantity:1,unit:""}),q({title:"Success",description:"Item created successfully"})}catch(M){q({title:"Error",description:((L=(_=M==null?void 0:M.response)==null?void 0:_.data)==null?void 0:L.message)||"Failed to create item",variant:"destructive"})}},H=async n=>{var l,f;try{await g.mutateAsync({projectId:s,subItemId:n}),q({title:"Success",description:"Item deleted successfully"})}catch(_){q({title:"Error",description:((f=(l=_==null?void 0:_.response)==null?void 0:l.data)==null?void 0:f.message)||"Failed to delete item",variant:"destructive"})}},{mutateAsync:X}=pe(),Y=async()=>{var n,l;try{if(t.phoneNumber&&!/^\d{10}$/.test(t.phoneNumber.trim()))throw new Error("Phone number should contain exactly 10 digit numbers");await X({projectId:s,updates:t}),q({title:"Success",description:"Shop Details Updated"}),u(!1)}catch(f){q({variant:"destructive",title:"Error",description:((l=(n=f==null?void 0:f.response)==null?void 0:n.data)==null?void 0:l.message)||(f==null?void 0:f.message)||"Update failed"})}};return r.jsxs("div",{className:"bg-white rounded-lg border-2 border-gray-200 overflow-hidden shadow-lg",children:[r.jsxs("div",{className:"border rounded-lg p-4 mb-6 bg-white  shadow-sm",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsxs("h2",{className:"text-lg font-semibold text-blue-700 flex items-center gap-2",children:[r.jsx("i",{className:"fa-solid fa-store text-blue-600"}),"Shop Details"]}),i?r.jsxs("div",{className:"w-[25%] animate-in fade-in duration-300 mb-2",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Shop Selection"}),r.jsx(ee,{options:N,placeholder:"Select Shop",searchPlaceholder:"Search by shop name...",value:m.selectedId||"",onValueChange:n=>{const l=e.find(f=>f._id===n);l&&j({selectedId:l._id,shopName:l.shopName})},searchBy:"name",displayFormat:"detailed",className:"w-full"})]}):r.jsxs("button",{onClick:()=>{d(a==null?void 0:a.shopDetails),u(!0)},className:"text-blue-600 text-sm font-medium flex items-center gap-1 hover:underline",children:[r.jsx("i",{className:"fa-solid fa-pen-to-square"}),"Edit"]})]}),i?r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r.jsx(V,{placeholder:"Shop Name",value:(t==null?void 0:t.shopName)||"",onChange:n=>d({...t,shopName:n.target.value})}),r.jsx(V,{placeholder:"Contact Person",value:(t==null?void 0:t.contactPerson)||"",onChange:n=>d({...t,contactPerson:n.target.value})}),r.jsx(V,{placeholder:"Phone Number",value:(t==null?void 0:t.phoneNumber)||"",type:"tel",maxLength:10,onChange:n=>d({...t,phoneNumber:n.target.value})}),r.jsx(V,{placeholder:"Address",value:(t==null?void 0:t.address)||"",onChange:n=>d({...t,address:n.target.value})}),r.jsxs("div",{className:"flex gap-3 justify-end sm:col-span-2 mt-4",children:[r.jsxs(J,{onClick:Y,className:"bg-blue-600 hover:bg-blue-700 text-white",children:[r.jsx("i",{className:"fa-solid fa-save mr-2"}),"Save"]}),r.jsxs(J,{variant:"outline",onClick:()=>u(!1),children:[r.jsx("i",{className:"fa-solid fa-times mr-2"}),"Cancel"]})]})]}):r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-y-2 text-gray-700 text-sm sm:text-base",children:[r.jsxs("p",{children:[r.jsx("strong",{children:"Shop Name:"})," ",((K=a==null?void 0:a.shopDetails)==null?void 0:K.shopName)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Contact Person:"})," ",(($=a==null?void 0:a.shopDetails)==null?void 0:$.contactPerson)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Phone Number:"})," ",((o=a==null?void 0:a.shopDetails)==null?void 0:o.phoneNumber)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Address:"})," ",((y=a==null?void 0:a.shopDetails)==null?void 0:y.address)||"-"]})]})]}),r.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-gradient-to-r from-blue-100 to-blue-100 border-b-2 border-blue-200",children:[r.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Ref ID"}),r.jsx("div",{className:"col-span-8 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Material Name"}),r.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Quantity"}),r.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Unit"}),r.jsx("div",{className:"col-span-1 px-4 py-3 text-sm font-medium text-gray-700",children:"Action"})]}),v&&r.jsxs("div",{className:"p-8 text-center",children:[r.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-blue-600 mb-3"}),r.jsx("p",{className:"text-gray-600",children:"Loading materials..."})]}),!v&&((F=a==null?void 0:a.subItems)==null?void 0:F.map(n=>r.jsx(E,{item:n,editingCell:x,setEditingCell:h,onSave:W,onDelete:H,isDeleting:g.isPending},n._id))),r.jsx(E,{isNewRow:!0,newRowData:b,setNewRowData:I,onNewRowSave:z,isAdding:k.isPending}),!v&&((S=a==null?void 0:a.subItems)==null?void 0:S.length)===0&&r.jsxs("div",{className:"text-center py-12 text-gray-500",children:[r.jsx("i",{className:"fa-solid fa-inbox text-4xl mb-3 text-gray-300"}),r.jsx("p",{className:"text-sm",children:"No materials yet. Start typing in the row above to add items."})]})]})};export{Ie as P,ge as a,Ne as u};
