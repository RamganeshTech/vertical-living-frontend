import{e as h,g as K,f as j,q as M,n as z,h as f,u as B,A as V,o as U,r as P,j as e,O as Y,B as E,S as W,i as H,k as J,l as X,m as b,N as O,t as g}from"./index-JlGfSpRF.js";import{R as Z}from"./ResetStageButton-CZOWPV6u.js";import{C as T}from"./Card-CY56x9cu.js";import{A as ee,S as se}from"./AssignStaff-Cn-f0R-m.js";import te from"./MaterialOverviewLoading-TeAbRek7.js";import{S as ae}from"./ShareDocumentWhatsapp-BmUiDCJr.js";import"./getAllUsersApi-BWabMZQn.js";import"./Skeleton-w_PAHx2U.js";import"./documentationApi-BUkgjPDK.js";const le=async(a,l,s,r)=>{const{data:n}=await r.put(`/installation/${a}/${l}/status`,{status:s});if(!n.ok)throw new Error(n.message);return n.data},ie=async(a,l)=>{const{data:s}=await l.get(`/installation/${a}/getalldetail`);if(!s.ok)throw new Error(s.message);return s.data},ne=a=>{const l=["CTO","owner","staff","worker","client"],{role:s}=h(),r=f(s);return K({queryKey:["installation-details",a],queryFn:async()=>{if(!s||!l.includes(s))throw new Error("Not allowed to make this API call.");if(!r)throw new Error("API instance not found.");return await ie(a,r)},enabled:!!s&&!!a&&!!r,retry:!1,refetchOnMount:!1})},re=()=>{const a=["CTO","owner","staff","worker"],{role:l}=h(),s=f(l),r=z();return j({mutationFn:async({projectId:n,taskId:c,status:x})=>{if(!l||!a.includes(l))throw new Error("Not allowed to make this API call.");if(!s)throw new Error("API instance not found.");return await le(n,c,x,s)},onSuccess:(n,{projectId:c})=>{r.invalidateQueries({queryKey:["installation-details",c]})}})},oe=async({formId:a,projectId:l,deadLine:s,api:r})=>{const{data:n}=await r.put(`/installation/deadline/${l}/${a}`,{deadLine:s});if(!n.ok)throw new Error(n.message);return n.data},ce=async({projectId:a,api:l})=>{const{data:s}=await l.put(`/installation/completionstatus/${a}`);if(!s.ok)throw new Error(s.message);return s.data},de=()=>{const a=["owner","staff","CTO"],{role:l}=h(),s=f(l);return j({mutationFn:async({formId:r,projectId:n,deadLine:c})=>{if(!l||!a.includes(l))throw new Error("not allowed to make this api call");if(!s)throw new Error("API instance missing");return await oe({formId:r,projectId:n,deadLine:c,api:s})},onSuccess:(r,{projectId:n})=>{M.invalidateQueries({queryKey:["installation-details",n]})}})},me=()=>{const a=["owner","staff","CTO"],{role:l}=h(),s=f(l);return j({mutationFn:async({projectId:r})=>{if(!l||!a.includes(l))throw new Error("not allowed to make this api call");if(!s)throw new Error("API instance missing");return await ce({projectId:r,api:s})},onSuccess:(r,{projectId:n})=>{M.invalidateQueries({queryKey:["installation-details",n]})}})};function Ne(){var S,I,C,k,A;const{projectId:a,organizationId:l}=B(),s=V(),{isMobile:r,openMobileSidebar:n}=U(),[c,x]=P.useState(!1),[N,R]=P.useState(""),$=s.pathname.includes("/installationroom"),{data:t,isLoading:y,isError:q,refetch:p,error:d}=ne(a),{mutateAsync:F,isPending:L}=me(),{mutateAsync:_,isPending:D}=de(),Q=async()=>{var i,m;try{await F({projectId:a}),g({title:"Success",description:"Completion status updated successfully"})}catch(o){g({title:"Error",description:((m=(i=o==null?void 0:o.response)==null?void 0:i.data)==null?void 0:m.message)||o.message||"Failed to update status",variant:"destructive"})}},v=re(),G=async(i,m)=>{var o,u;try{await v.mutateAsync({projectId:a,taskId:i,status:m}),g({title:"Success",description:"Task status updated successfully"}),p()}catch(w){g({title:"Error",description:((u=(o=w==null?void 0:w.response)==null?void 0:o.data)==null?void 0:u.message)||"Failed to update task status",variant:"destructive"})}};return y?e.jsx(te,{}):e.jsx("main",{className:"w-full overflow-y-auto h-full",children:$?e.jsx(Y,{}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-semibold text-blue-600 flex items-center",children:[r&&e.jsx("button",{onClick:n,className:"mr-3 p-2 rounded-md border border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-tools mr-2"})," Installation Overview"]}),e.jsxs("div",{className:"w-full sm:w-auto flex flex-col sm:flex-row gap-2",children:[e.jsxs(E,{isLoading:L,onClick:Q,className:"bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsx(Z,{projectId:a,stageNumber:11,stagePath:"installation",className:"w-full sm:w-auto"}),!d&&e.jsx(ae,{projectId:a,stageNumber:"11",className:"w-full sm:w-fit",isStageCompleted:t==null?void 0:t.status}),e.jsx(ee,{stageName:"InstallationModel",projectId:a,organizationId:l,currentAssignedStaff:(t==null?void 0:t.assignedTo)||null,className:"w-full sm:w-auto"})]})]}),q?e.jsxs("div",{className:"max-w-xl mx-auto p-6 bg-red-50 border border-red-200 rounded-lg shadow text-center",children:[e.jsx("div",{className:"text-red-600 text-xl font-semibold mb-2",children:"⚠️ Oops! An Error Occurred"}),e.jsx("p",{className:"text-red-500 text-sm mb-4",children:((I=(S=d==null?void 0:d.response)==null?void 0:S.data)==null?void 0:I.message)||(d==null?void 0:d.message)||"Something went wrong"}),e.jsx(E,{isLoading:y,onClick:()=>p(),className:"bg-red-600 text-white hover:bg-red-700",children:"Retry"})]}):t&&e.jsxs(e.Fragment,{children:[e.jsxs(T,{className:"p-4 mb-6 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(se,{completedAt:(C=t==null?void 0:t.timer)==null?void 0:C.completedAt,stageName:"installation",projectId:a,formId:t==null?void 0:t._id,deadLine:(k=t==null?void 0:t.timer)==null?void 0:k.deadLine,startedAt:(A=t==null?void 0:t.timer)==null?void 0:A.startedAt,refetchStageMutate:p,deadLineMutate:_,isPending:D})]}),t!=null&&t.tasks&&(t==null?void 0:t.tasks.length)>0?e.jsxs(T,{className:"p-6 mb-6 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-lg font-semibold mb-6",children:[e.jsx("i",{className:"fa-solid fa-images text-blue-500 text-xl"}),e.jsx("span",{children:"Installation Progress Gallery"})]}),e.jsx("div",{className:"space-y-8",children:t.tasks.map((i,m)=>e.jsxs("div",{className:"border-b border-gray-200 pb-6 last:border-b-0 last:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("i",{className:"fa-solid fa-hammer text-blue-600 text-sm"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:i.workName||`Installation Task ${m+1}`}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${i.status==="completed"?"bg-green-100 text-green-800":i.status==="pending"?"bg-yellow-100 text-yellow-800":i.status==="inprogress"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:i.status}),e.jsxs("span",{className:"text-sm text-gray-500",children:[i.images.length," image",i.images.length!==1?"s":""]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Update Status"}),e.jsxs(W,{onValueChange:o=>G(i._id,o),value:i.status||"",children:[e.jsx(H,{className:"w-40 rounded-xl border-gray-200 focus:ring-2 focus:ring-blue-500 bg-white",children:e.jsx(J,{placeholder:"Select status",selectedValue:i.status||""})}),e.jsxs(X,{children:[e.jsx(b,{value:"pending",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-yellow-500 rounded-full"}),"Pending"]})}),e.jsx(b,{value:"inprogress",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),"In Progress"]})}),e.jsx(b,{value:"submitted",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full"}),"Submitted"]})})]})]})]}),v.isPending&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"})})]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:i.images.map((o,u)=>e.jsxs("div",{className:"group relative aspect-square bg-gray-100 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer",onClick:()=>{R(o==null?void 0:o.url),x(!0)},children:[e.jsx("img",{src:o.url||O,alt:`${i.workName} - Image ${u+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-200",loading:"lazy"}),e.jsx("div",{className:"absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded-full",children:u+1})]},o._id||u))}),i.images.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-image text-3xl mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No images uploaded for this task yet"})]})]},m))}),t.tasks.every(i=>!i.images||i.images.length===0)&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-images text-4xl mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Installation Images Yet"}),e.jsx("p",{className:"text-sm",children:"Images will appear here once they are uploaded to installation tasks"})]})]}):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-images text-4xl mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Installation Images Yet"}),e.jsx("p",{className:"text-sm",children:"Images will appear here once they are uploaded to installation tasks"})]}),c&&N&&e.jsx("div",{onClick:()=>x(!1),className:"fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[60]",children:e.jsxs("div",{className:"relative max-w-4xl max-h-[80%]",children:[e.jsx("button",{onClick:()=>x(!1),className:"absolute -top-12 right-0 text-white hover:text-gray-300 text-xl",children:e.jsx("i",{className:"fas fa-times"})}),e.jsx("img",{src:N||O,alt:"preveiw image",className:"max-w-full max-h-[80vh] object-contain rounded-lg",onClick:i=>i.stopPropagation()})]})})]})]})})}export{Ne as default};
