import{E as le,u as Ze,r as j,a3 as k,j as e,B as R,C as ie,o as de,p as oe,g as ce,t as v,e as Ms,a as Ls}from"./index-sOEqqOOm.js";import{c as Bs,d as $s,e as Ws,f as zs,g as Us,h as Js,i as Vs,j as Ks,k as Hs,l as qs,m as Ys,n as Xs,o as Qs,p as Zs,q as Gs}from"./workScheduleApi-Dy2gAPuk.js";import{I as O}from"./Input-BLVPl92q.js";import{T as He}from"./TextArea-Dt8I-SBm.js";import{L as M}from"./Label-BG8NiAko.js";import{S as qe,a as Ye,b as Xe,c as Qe,d as pe}from"./Select-BbVXcQk6.js";import{I as Ae}from"./ImageGalleryMain-XaQX1eKx.js";import"./constants-BoN4q75_.js";const Ge=()=>{var h;const w=le(I=>I.authStore),W=le(I=>I.userProfileStore),E=le(I=>I.staffProfileStore),n=le(I=>I.CTOProfileStore),L=le(I=>I.workerProfileStore),B=le(I=>I.clientProfileStore);if(!w.isauthenticated)return null;switch((h=w.role)==null?void 0:h.toLowerCase()){case"owner":return{id:(W==null?void 0:W.userId)||w._id,name:(W==null?void 0:W.userName)||""};case"staff":return{id:(E==null?void 0:E.staffId)||w._id,name:(E==null?void 0:E.staffName)||""};case"cto":return{id:(n==null?void 0:n.CTOId)||w._id,name:(n==null?void 0:n.CTOName)||""};case"worker":return{id:(L==null?void 0:L.workerId)||w._id,name:(L==null?void 0:L.workerName)||""};case"client":return{id:(B==null?void 0:B.clientId)||w._id,name:(B==null?void 0:B.clientName)||""};default:return null}},et=({projectId:w,isOpen:W,onClose:E,editData:n,onSave:L,onUpdate:B,scheduleId:h=null,refetch:I})=>{const{organizationId:xe}=Ze(),Y=j.useRef(null),X=j.useRef(null),m=Ge(),{data:o}=Bs(w),{data:y,isLoading:K}=$s(xe),[Se,V]=j.useState(!1),[F,fe]=j.useState({name:"",url:""}),[_,je]=j.useState({name:"",url:""}),[H,z]=j.useState(null),[q,me]=j.useState(null),[ue,se]=j.useState(50),[ge,S]=j.useState(!1),ve=s=>{s.scheduleId===h&&s.addedBy!==(m==null?void 0:m.id)&&(p(a=>[...a,s.selectImages]),v({title:"Comparison Added",description:`by ${s.addedByRole}`}))},he=s=>{console.log("entierngint othe funtio"),s.scheduleId===h&&s.uploadedBy!==(m==null?void 0:m.id)&&(p(s.newSelectImages),v({title:"Select Images Added",description:`by ${s.uploadedByRole}`}))},te=s=>{s.scheduleId===h&&s.createdBy!==(m==null?void 0:m.id)&&(p(a=>[...a,s.selectImages]),v({title:"New Comparison",description:`created by ${s.createdByRole}`}))},ae=s=>{s.scheduleId===h&&s.uploadedBy!==(m==null?void 0:m.id)&&(p(s.newCorrectedImages),v({title:"Corrected Images Uploaded",description:`by ${s.uploadedByRole}`}))},ye=s=>{if(s.scheduleId!==h||s.updatedBy===(m==null?void 0:m.id))return;const{comparisonId:a,selectedImageId:t,comment:l}=s;p(i=>i&&i.map(c=>c._id===a?{...c,selectImage:c.selectImage.map(T=>T._id===t?{...T,comment:l}:T)}:c)),v({title:"Comment Updated",description:`by ${s.updatedByRole}`})},Ne=s=>{s.scheduleId===h&&s.deletedBy!==(m==null?void 0:m.id)&&(p(s.images),v({title:"Select Image Deleted",description:`by ${s.deletedByRole}`}))},be=s=>{s.scheduleId===h&&s.deletedBy!==(m==null?void 0:m.id)&&(p(s.deletedImage),v({title:"Corrected Image Deleted",description:`by ${s.deletedByRole}`}))};j.useEffect(()=>{if(!(!k||!h||!w))return k.on("workSchedule:selectimage_added",ve),k.on("workSchedule:selectimage_added_manual",he),k.on("workSchedule:comparison_created",te),k.on("workSchedule:correctimage_upload",ae),k.on("workSchedule:selectimage_comment",ye),k.on("workSchedule:selectimage_delete",Ne),k.on("workSchedule:correctimage_delete",be),()=>{k.off("workSchedule:selectimage_added",ve),k.off("workSchedule:selectimage_added_manual",he),k.off("workSchedule:comparison_created",te),k.off("workSchedule:correctimage_upload",ae),k.off("workSchedule:selectimage_comment",ye),k.off("workSchedule:selectimage_delete",Ne),k.off("workSchedule:correctimage_delete",be)}},[k,h,m==null?void 0:m.id,Se]);const ke=new Date().toISOString().split("T")[0],Q=s=>{const a=ne=>String(ne).padStart(2,"0"),t=s.getFullYear(),l=a(s.getMonth()+1),i=a(s.getDate()),c=a(s.getHours()),T=a(s.getMinutes());return`${t}-${l}-${i}T${c}:${T}`},[g,r]=j.useState({projectAssignee:{projectName:"",siteAddress:"",designReferenceId:"",carpenterName:"",carpenterUIName:"",supervisorName:(m==null?void 0:m.name)||"",plannedStartDate:ke},dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:[],siteImages:[],supervisorCheck:{reviewerName:(m==null?void 0:m.name)||"",reviewerId:(m==null?void 0:m.id)||"",reviewDateTime:Q(new Date),status:"pending",remarks:"",gatekeeping:"block"}}),[u,x]=j.useState(!1),[f,N]=j.useState([]),[d,p]=j.useState([]),[b,C]=j.useState(!1),D=(s,a)=>{s.preventDefault(),S(!1);const t=new DataTransfer;Array.from(s.dataTransfer.files).forEach(l=>t.items.add(l)),Ie(t.files,a)};j.useEffect(()=>{var t,l,i,c,T,ne,Me,Le,Be,$e,We,ze,Ue,Je,Ve,Ke;if(!o&&!n)return;let s;!o&&!n&&(s=y==null?void 0:y.find($=>{var re;return($==null?void 0:$._id)===((re=n.projectAssignee.carpenterName)==null?void 0:re._id)}));let a;if((t=n==null?void 0:n.supervisorCheck)!=null&&t.reviewDateTime)console.log("gettign into the place 1"),a=Q(new Date((l=n==null?void 0:n.supervisorCheck)==null?void 0:l.reviewDateTime));else if((c=(i=n==null?void 0:n.dailyTasks)==null?void 0:i[0])!=null&&c.datePlanned){const $=new Date(n.dailyTasks[0].datePlanned);$.setHours(12,0,0),a=Q($)}else console.log("gettign into the place 333333"),a=Q(new Date);if(r({projectAssignee:{projectName:((T=n==null?void 0:n.projectAssignee)==null?void 0:T.projectName)||(o==null?void 0:o.projectName)||"",siteAddress:((ne=n==null?void 0:n.projectAssignee)==null?void 0:ne.siteAddress)||(o==null?void 0:o.siteAddress)||"",designReferenceId:((Me=n==null?void 0:n.projectAssignee)==null?void 0:Me.designReferenceId)||(o==null?void 0:o.designReferenceId)||"",carpenterName:((Le=n==null?void 0:n.projectAssignee)==null?void 0:Le.carpenterName)||null,carpenterUIName:(s==null?void 0:s.workerName)||"",supervisorName:((Be=n==null?void 0:n.projectAssignee)==null?void 0:Be.supervisorName)||(m==null?void 0:m.name)||"",plannedStartDate:(($e=n==null?void 0:n.projectAssignee)==null?void 0:$e.plannedStartDate)||ke},dailyTasks:((We=n==null?void 0:n.dailyTasks)==null?void 0:We.map($=>({...$,uploadedImages:$.uploadedImages||[]})))||[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}],designPlanImages:(n==null?void 0:n.designPlanImages)||[],siteImages:(n==null?void 0:n.siteImages)||[],supervisorCheck:{reviewerName:((ze=n==null?void 0:n.supervisorCheck)==null?void 0:ze.reviewerName)||(m==null?void 0:m.name)||"",reviewerId:((Ue=n==null?void 0:n.supervisorCheck)==null?void 0:Ue.reviewerId)||(m==null?void 0:m.id)||"",reviewDateTime:a,status:((Je=n==null?void 0:n.supervisorCheck)==null?void 0:Je.status)||"needs_changes",remarks:((Ve=n==null?void 0:n.supervisorCheck)==null?void 0:Ve.remarks)||"",gatekeeping:((Ke=n==null?void 0:n.supervisorCheck)==null?void 0:Ke.gatekeeping)||"block"}}),n!=null&&n.dailyTasks){const $={};n.dailyTasks.forEach((re,Os)=>{re.materialsNeeded&&re.materialsNeeded.length>0&&($[Os]=re.materialsNeeded.join(", "))}),Re($)}n!=null&&n.workComparison?p(n.workComparison):p([])},[o,n]);const[A,P]=j.useState([]),[U,J]=j.useState([]),we=Ws(),_e=zs(),{mutateAsync:Pe,isPending:es}=Us(),Z=(s,a)=>{r(t=>({...t,projectAssignee:{...t.projectAssignee,[s]:a}}))},ss=s=>s?new Date(s).toISOString().split("T")[0]:"",G=(s,a,t)=>{r(l=>{const i=l.dailyTasks.map((T,ne)=>ne===s?{...T,[a]:t}:T);let c=l.supervisorCheck;if(h===null&&s===0&&a==="datePlanned"){const T=`${t}T12:00`;c={...l.supervisorCheck,reviewDateTime:T}}return{...l,dailyTasks:i,supervisorCheck:c}})},[ts,Re]=j.useState({}),as=(s,a)=>{Re(t=>({...t,[s]:a})),r(t=>({...t,dailyTasks:t.dailyTasks.map((l,i)=>i===s?{...l,materialsNeeded:a.split(",").map(c=>c.trim()).filter(c=>c)}:l)}))},ns=()=>{r(s=>({...s,dailyTasks:[...s.dailyTasks,{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},rs=()=>{r(s=>({...s,dailyTasks:[{datePlanned:"",room:"",workDescription:"",startTime:"",endTime:"",materialsNeeded:[],manpower:0,status:"planned",uploadedImages:[]}]}))},ls=s=>{r(a=>({...a,dailyTasks:a.dailyTasks.filter((t,l)=>l!==s)}))},ee=(s,a)=>{r(t=>({...t,supervisorCheck:{...t.supervisorCheck,[s]:a}}))},is=async()=>{var s,a;try{if(n){const t=new FormData;t.append("projectAssignee",JSON.stringify(g.projectAssignee)),t.append("dailyTasks",JSON.stringify(g.dailyTasks)),t.append("supervisorCheck",JSON.stringify(g.supervisorCheck)),q&&t.append("actualImage",q),H&&t.append("plannedImage",H),A.forEach(l=>t.append("designPlanImages",l)),U.forEach(l=>t.append("siteImages",l)),await _e.mutateAsync({projectId:w,scheduleId:n._id,formData:t}),B==null||B(g),v({title:"Success",description:"updated successfully"})}else{const t=new FormData;t.append("projectAssignee",JSON.stringify(g.projectAssignee)),t.append("dailyTasks",JSON.stringify(g.dailyTasks)),t.append("supervisorCheck",JSON.stringify(g.supervisorCheck)),q&&t.append("actualImage",q),H&&t.append("plannedImage",H),A.forEach(l=>t.append("designPlanImages",l)),U.forEach(l=>t.append("siteImages",l)),await we.mutateAsync({projectId:w,formData:t}),I(),L==null||L(g),v({title:"Success",description:"Created successfully"})}E()}catch(t){v({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"something went wrong",variant:"destructive"})}},ds=async()=>{var s,a;try{const t=new FormData;t.append("projectAssignee",JSON.stringify(g.projectAssignee)),t.append("dailyTasks",JSON.stringify(g.dailyTasks)),t.append("supervisorCheck",JSON.stringify(g.supervisorCheck)),q&&t.append("actualImage",q),H&&t.append("plannedImage",H),A.forEach(i=>t.append("designPlanImages",i)),U.forEach(i=>t.append("siteImages",i));let l;n?l=await Pe({projectId:w,scheduleId:h,formData:t}):l=await Pe({projectId:w,formData:t}),Ms({src:l.downloadUrl,alt:l.fileName}),v({description:"Pdf Generated successfully",title:"Success"})}catch(t){v({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},Ie=(s,a)=>{if(!s)return;const t=Array.from(s);if(a==="design"){const l=t.map(i=>({file:i,url:URL.createObjectURL(i)}));r(i=>({...i,designPlanImages:[...i.designPlanImages,...l]})),P(i=>[...i,...t])}else if(a==="site"){const l=t.map(i=>({file:i,url:URL.createObjectURL(i)}));r(i=>({...i,siteImages:[...i.siteImages,...l]})),J(i=>[...i,...t])}},Ee=(s,a)=>{a==="design"?(r(t=>({...t,designPlanImages:t.designPlanImages.filter((l,i)=>i!==s)})),P(t=>t.filter((l,i)=>i!==s))):a==="site"&&(r(t=>({...t,siteImages:t.siteImages.filter((l,i)=>i!==s)})),J(t=>t.filter((l,i)=>i!==s)))},os=()=>{const s=JSON.stringify(g,null,2),a=new Blob([s],{type:"application/json"}),t=URL.createObjectURL(a),l=document.createElement("a");l.href=t,l.download=`work-schedule-${Date.now()}.json`,l.click(),URL.revokeObjectURL(t)},cs=s=>{var l;const a=(l=s.target.files)==null?void 0:l[0];if(!a)return;const t=new FileReader;t.onload=i=>{var c;try{const T=JSON.parse((c=i.target)==null?void 0:c.result);r(T)}catch{v({title:"Error",description:"Error importing JSON file",variant:"destructive"})}},t.readAsText(a)},[ms,Fe]=j.useState(null),[us,gs]=j.useState({}),{mutateAsync:hs,isPending:De}=Js(),{mutateAsync:ps,isPending:Ce}=Vs(),{mutateAsync:xs}=Ks(),{mutateAsync:fs}=Hs(),{mutateAsync:js,isPending:vs}=qs(),{mutateAsync:ys}=Ys(),Ns=s=>{u&&N(a=>a.includes(s)?a.filter(t=>t!==s):[...a,s])},bs=async()=>{var s,a;try{if(f.length===0)return;const t=f.map(i=>({...i})),l=await hs({projectId:w,scheduleId:h,formData:t});p(i=>[...i,l]),V(i=>!i),v({description:"Pdf Generated successfully",title:"Success"})}catch(t){v({title:"Error",description:((a=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to generate Pdf",variant:"destructive"})}},ks=async(s,a)=>{var l,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("files",c)});try{const c=await js({projectId:w,scheduleId:h,comparisonId:a,formData:t});p(c),V(T=>!T)}catch(c){v({title:"Error",description:((i=(l=c==null?void 0:c.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to upload corrected images",variant:"destructive"})}},Te=async(s,a)=>{var l,i;if(!s||s.length===0)return;const t=new FormData;Array.from(s).forEach(c=>{t.append("correctfiles",c)});try{const c=await ps({projectId:w,scheduleId:h,comparisonId:a,formData:t});p(c),V(T=>!T),I()}catch(c){v({title:"Error",description:((i=(l=c==null?void 0:c.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to upload images",variant:"destructive"})}},ws=async(s,a)=>{var t,l;try{const i=await ys({projectId:w,scheduleId:h,comparisonId:s,imageId:a});p(i),V(c=>!c),v({title:"Success",description:"Corrected image deleted successfully"})}catch(i){v({title:"Error",description:((l=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to delete corrected image",variant:"destructive"})}},Ss=async(s,a)=>{var t,l;try{const i=await fs({projectId:w,scheduleId:h,comparisonId:s,selectId:a});p(i),V(c=>!c),v({title:"Success",description:"image deleted successfully"})}catch(i){v({title:"Error",description:((l=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to delete corrected image",variant:"destructive"})}},Is=async(s,a,t)=>{var l,i;try{const c=await xs({projectId:w,scheduleId:h,comparisonId:s,selectedImageId:a,data:{comment:t}});p(c),Fe(""),V(T=>!T),v({title:"Success",description:"Comment updated successfully"})}catch(c){v({title:"Error",description:((i=(l=c==null?void 0:c.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to update comment",variant:"destructive"})}},Cs=s=>{const a=s.target.files[0];a&&(fe({name:a.name,url:URL.createObjectURL(a)}),z(a))},Ts=s=>{const a=s.target.files[0];a&&(je({name:a.name,url:URL.createObjectURL(a)}),me(a))},As=s=>{S(!0),s.preventDefault()},_s=s=>{if(!ge)return;const a=s.currentTarget.getBoundingClientRect(),t=s.clientX-a.left,l=Math.max(0,Math.min(100,t/a.width*100));se(l)},Oe=()=>{S(!1)},Ps=()=>{se(50)},Rs=()=>{fe({name:"",url:""}),z(null)},Es=()=>{je({name:"",url:""}),me(null)},Fs=s=>{const a=g.dailyTasks.find((t,l)=>s===l);return(a==null?void 0:a.status)||"planned"},Ds=()=>{const s=g.supervisorCheck.status;return s==="approved"?"Approved":s==="needs_changes"?"Changes Required":"Pending"};return W?e.jsx("div",{onClick:E,className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{onClick:s=>s.stopPropagation(),className:"bg-white rounded-lg max-w-[90%] max-h-[90vh] overflow-y-auto w-full mx-4",children:[e.jsx("div",{className:" bg-blue-600 text-white p-4 rounded-t-lg sticky top-0 z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"Vertical Living — Carpenter Work Schedule & Visual Approval"}),e.jsx("p",{className:"text-sm opacity-90",children:"RAMS TECH CIRCLE OPC Pvt. Ltd. • No. 22, 13th Main Road, Anna Nagar West, Chennai - 600040 • WhatsApp: +91 93639 93814"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{isLoading:_e.isPending||we.isPending,variant:"secondary",size:"sm",onClick:is,children:"Save"}),e.jsx(R,{variant:"secondary",size:"sm",onClick:os,children:"Export JSON"}),e.jsx("input",{id:"json-import",type:"file",accept:".json",className:"hidden",onChange:cs}),e.jsx(R,{variant:"secondary",size:"sm",onClick:()=>{var s;return(s=document.getElementById("json-import"))==null?void 0:s.click()},children:"Import JSON"}),e.jsx(R,{variant:"secondary",isLoading:es,onClick:ds,size:"sm",children:"Print / PDF"}),e.jsx(R,{variant:"secondary",size:"sm",onClick:E,children:e.jsx("i",{className:"fas fa-times"})})]})]})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs(ie,{children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-file-text"}),"Project & Assignee",e.jsx(R,{variant:"link",size:"sm",className:"ml-auto text-blue-600",children:"Single sheet for multiple days"})]})}),e.jsx(ce,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"projectName",children:"Project Name"}),e.jsx(O,{id:"projectName",placeholder:"e.g., Shankar Residence — Wardrobe & TV Unit",value:g.projectAssignee.projectName,onChange:s=>Z("projectName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"siteAddress",children:"Site Address"}),e.jsx(O,{id:"siteAddress",placeholder:"Full address",value:g.projectAssignee.siteAddress,onChange:s=>Z("siteAddress",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"designReferenceId",children:"Design Reference ID"}),e.jsx(O,{id:"designReferenceId",placeholder:"e.g., VL-KTN-2025-001",value:g.projectAssignee.designReferenceId,onChange:s=>Z("designReferenceId",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"carpenterName",children:"Carpenter Name"}),e.jsx("select",{className:"border-b px-2 py-1 text-sm w-[100%]",value:g.projectAssignee.carpenterUIName,onChange:s=>{const a=s.target.value,t=y==null?void 0:y.find(l=>l._id===a);Z("carpenterName",s.target.value),Z("carpenterUIName",t?t.workerName:"")},children:K?e.jsx("option",{disabled:!0,children:"Loading workers..."}):e.jsxs(e.Fragment,{children:[e.jsx("option",{disabled:!0,value:"",children:"Assign worker"}),Array.isArray(y)&&(y==null?void 0:y.length)>0?y==null?void 0:y.map(s=>e.jsxs("option",{value:s._id,children:[s.workerName," ",s.email&&`(${s.email})`]},s._id)):e.jsx("option",{disabled:!0,children:"No workers registered"})]})})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"supervisorName",children:"Supervisor Name"}),e.jsx(O,{id:"supervisorName",placeholder:"Site supervisor",value:g.projectAssignee.supervisorName,onChange:s=>Z("supervisorName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"plannedStartDate",children:"Planned Start Date"}),e.jsx(O,{id:"plannedStartDate",type:"date",value:g.projectAssignee.plannedStartDate,onChange:s=>Z("plannedStartDate",s.target.value)})]})]})})]}),e.jsxs(ie,{children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-calendar-days"}),"Daily Work Schedule"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(R,{variant:"outline",size:"sm",onClick:ns,children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Task"]}),e.jsx(R,{variant:"outline",onClick:rs,size:"sm",children:"Clear"})]})]})}),e.jsx(ce,{children:e.jsx("div",{className:"h-fit border overflow-y-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2 text-center",children:"DATE"}),e.jsx("th",{className:"border p-2 text-center",children:"ROOM / UNIT"}),e.jsx("th",{className:"border p-2 text-center",children:"WORK DESCRIPTION"}),e.jsx("th",{className:"border p-2 text-center",children:"START"}),e.jsx("th",{className:"border p-2 text-center",children:"END"}),e.jsx("th",{className:"border p-2 text-center",children:"MATERIALS NEEDED"}),e.jsx("th",{className:"border p-2 text-center",children:"MANPOWER"}),e.jsx("th",{className:"border p-2 text-center",children:"STATUS"}),e.jsx("th",{className:"border p-2 text-center",children:"ACTIONS"})]})}),e.jsx("tbody",{className:"",children:g.dailyTasks.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:e.jsx(O,{type:"date",value:ss(s.datePlanned),onChange:t=>G(a,"datePlanned",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(O,{placeholder:"Kitchen",value:s.room,onChange:t=>G(a,"room",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(He,{placeholder:"Base unit carcass fixing & levelling",value:s.workDescription,onChange:t=>G(a,"workDescription",t.target.value),rows:2})}),e.jsx("td",{className:"border p-2",children:e.jsx(O,{type:"time",value:s.startTime,onChange:t=>G(a,"startTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(O,{type:"time",value:s.endTime,onChange:t=>G(a,"endTime",t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(O,{placeholder:"Plywood, laminate, screws",value:ts[a]??"",onChange:t=>as(a,t.target.value)})}),e.jsx("td",{className:"border p-2",children:e.jsx(O,{type:"number",placeholder:"No of workers",value:s.manpower,onChange:t=>G(a,"manpower",Number.parseInt(t.target.value)||0)})}),e.jsx("td",{className:"border p-2",children:e.jsxs(qe,{value:s.status,onValueChange:t=>G(a,"status",t),children:[e.jsx(Ye,{children:e.jsx(Xe,{selectedValue:Fs(a)})}),e.jsxs(Qe,{children:[e.jsx(pe,{value:"planned",children:"Planned"}),e.jsx(pe,{value:"in-progress",children:"In Progress"}),e.jsx(pe,{value:"completed",children:"Completed"})]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{className:"flex gap-1",children:e.jsx(R,{variant:"danger",size:"sm",onClick:()=>ls(a),children:e.jsx("i",{className:"fas fa-trash"})})})})]},a))})]})})})]}),e.jsxs(ie,{className:"",children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Laminate/Design/Plan Images — for Explanation"}),e.jsx(R,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload reference plans, markups, sketches"})]})}),e.jsxs(ce,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${b?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=Y.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),C(!0)},onDragLeave:()=>C(!1),onDrop:s=>D(s,"design"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop plan/reference images here or"}),e.jsx(R,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Accepted: JPG/PNG/WebP • Images auto-saved locally"})]})}),e.jsx("input",{ref:Y,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>Ie(s.target.files,"design")}),g.designPlanImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:g.designPlanImages.map((s,a)=>e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),!s._id&&e.jsx("button",{type:"button",onClick:()=>Ee(a,"design"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"×"})]},a))})})]})]}),e.jsxs(ie,{children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Site / Actual Images — for Visual Confirmation"}),e.jsx(R,{variant:"outline",size:"sm",className:"text-blue-600 bg-transparent",children:"Upload daily progress photos"})]})}),e.jsxs(ce,{children:[e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${b?"border-blue-400 bg-blue-50":"border-gray-300"}`,onClick:()=>{var s;return(s=X.current)==null?void 0:s.click()},onDragOver:s=>{s.preventDefault(),C(!0)},onDragLeave:()=>C(!1),onDrop:s=>D(s,"site"),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium",children:"Drag & drop site/progress images here or"}),e.jsx(R,{variant:"outline",children:"Browse"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tip: Upload clear, well-lit photos with unit labels in frame"})]})}),e.jsx("input",{ref:X,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:s=>Ie(s.target.files,"site")}),e.jsx("div",{children:n&&e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("input",{type:"checkbox",id:"correctionMode",checked:u,onChange:s=>{x(s.target.checked),s.target.checked||N([])}}),e.jsx("label",{htmlFor:"correctionMode",className:"text-sm font-medium",children:"Select images for correction"}),u&&e.jsx(R,{size:"sm",className:"bg-green-600 text-white",disabled:f.length===0||De,onClick:bs,children:De?"Uploading...":"Upload Selected"})]})}),g.siteImages.length>0&&e.jsx("div",{className:"mt-4",children:e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:g.siteImages.map((s,a)=>{const t=f.includes(s);return e.jsxs("div",{className:"relative group w-32 h-32",children:[e.jsx("img",{onClick:()=>Ns(s),src:s.url||"",alt:s.originalName||`Image ${a+1}`,className:"w-full h-full object-cover rounded-lg border shadow-sm"}),t&&e.jsx("i",{className:"fa fa-check absolute top-1 right-1 text-green-600 bg-white rounded-full p-1 shadow-md"}),!u&&e.jsx("button",{type:"button",onClick:()=>Ee(a,"site"),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-700 transition-opacity",children:"×"})]},a)})})})]})]}),n&&e.jsxs(ie,{children:[e.jsx(de,{children:e.jsx(oe,{className:"",children:"Correction Section"})}),e.jsx(ce,{children:d&&d.length>0?e.jsxs(e.Fragment,{children:[d.map((s,a)=>e.jsx(j.Fragment,{children:e.jsx("div",{className:" border-b pb-6 last:border-b-0",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsxs("div",{className:"md:w-1/2 w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>Te(t.target.files,s._id)}),Ce&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Selected Images for Correction"]}),s.selectImage&&s.selectImage.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(Ae,{imageFiles:s==null?void 0:s.selectImage.map(t=>{const{_id:l,...i}=t.plannedImage||{};return{_id:t._id,...i,comment:t.comment,createdBy:t.createdBy,createModel:t.createModel,createdAt:t.createdAt}}),handleDeleteFile:t=>{Ss(s._id,t)},height:120,minWidth:120,maxWidth:140,isComments:!0,editingId:ms,tempComment:us,setEditingId:Fe,setTempComment:gs,onUpdateComment:(t,l)=>Is(s._id,t,l)})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No selected images available for this comparison."})]}),e.jsx("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Refactored Images (Stage ",a+1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:t=>ks(t.target.files,s._id)}),vs&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage ",a+1,": Refactored Outputs"]}),s.correctedImages&&s.correctedImages.length>0?e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(Ae,{imageFiles:s==null?void 0:s.correctedImages,handleDeleteFile:t=>ws(s._id,t),refetch:I,height:120,minWidth:120,maxWidth:140})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No refactored images uploaded yet."})]})]})})]})})},s._id||a)),e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"text-sm font-medium block mb-2",children:["Upload Select Images (Stage ",(d==null?void 0:d.length)+1||1,")"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>Te(s.target.files,null)}),Ce&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsxs("h3",{className:"text-md font-semibold mb-2",children:["Stage  ",d.length+1||1,": Select Outputs"]})})]})]}):e.jsxs("div",{className:"md:w-1/2 w-full flex flex-col justify-between",children:[e.jsx("div",{children:e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-sm font-medium block mb-2",children:"Upload Select Images (Stage 1)"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"border-2 border-dashed rounded-md p-2 w-full text-sm text-gray-600",onChange:s=>Te(s.target.files,null)}),Ce&&e.jsx("span",{className:"ml-2 text-gray-600 animate-spin",children:e.jsx("i",{className:"fas fa-spinner animate-spin"})})]})}),e.jsx("div",{children:e.jsx("h3",{className:"text-md font-semibold mb-2",children:"Stage 1: Select Outputs"})})]})})]}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Planned vs Actual — Slider Comparison"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("planned-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Planned"}),e.jsx("button",{onClick:()=>{var s;return(s=document.getElementById("actual-image"))==null?void 0:s.click()},className:"bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700",children:"Pick Actual"}),e.jsx("button",{onClick:Ps,className:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600",children:"Reset"})]})]}),e.jsx("div",{className:"relative w-[100%] h-96 bg-gray-100 rounded-lg overflow-hidden border",children:F.url||_.url?e.jsxs("div",{className:"relative w-full h-full cursor-col-resize",onMouseMove:_s,onMouseUp:Oe,onMouseLeave:Oe,children:[F.url&&e.jsxs("div",{className:"absolute top-0 left-0 h-full overflow-visible",style:{width:`${ue}%`},children:[e.jsx("img",{src:F.url,alt:"plannedimage",className:"absolute top-0 left-0 w-[100%] h-[100%] object-cover",style:{clipPath:"inset(0px 0% 0px 0px)"}}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Planned"}),e.jsx("button",{onClick:Rs,className:"absolute top-2 left-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),_.url&&e.jsxs("div",{className:"absolute top-0 right-0 h-full overflow-hidden",style:{width:`${100-ue}%`},children:[e.jsx("img",{src:_.url||"/placeholder.svg",alt:"Actual",className:"h-full object-cover",style:{width:"100%",maxWidth:"none"}}),e.jsx("div",{className:"absolute bottom-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-sm",children:"Actual"}),e.jsx("button",{onClick:Es,className:"absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700",children:e.jsx("i",{className:"fas fa-times"})})]}),e.jsx("div",{className:"absolute top-0 h-full w-1 bg-white shadow-lg cursor-col-resize z-10",style:{left:`${ue}%`,transform:"translateX(-50%)"},children:e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white rounded-full shadow-lg border-2 border-gray-300 cursor-col-resize flex items-center justify-center",onMouseDown:As,children:e.jsx("i",{className:"fas fa-arrows-alt-h text-gray-600 text-xs"})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-images text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"Upload planned and actual images to compare"}),e.jsx("p",{className:"text-sm",children:"Use the buttons above to select images"})]})})}),e.jsx("p",{className:"text-sm text-gray-600 mt-2 text-center",children:"Drag the circle to reveal differences"}),e.jsx("input",{id:"planned-image",type:"file",accept:"image/*",onChange:Cs,className:"hidden"}),e.jsx("input",{id:"actual-image",type:"file",accept:"image/*",onChange:Ts,className:"hidden"})]}),e.jsxs(ie,{children:[e.jsx(de,{children:e.jsxs(oe,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Supervisor Visual Check & Approval"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"}),e.jsx("span",{className:"text-sm",children:Ds()})]})]})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"reviewerName",children:"Reviewer Name"}),e.jsx(O,{id:"reviewerName",placeholder:"Staff doing the check",value:g.supervisorCheck.reviewerName,onChange:s=>ee("reviewerName",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"reviewDateTime",children:"Review Date & Time"}),e.jsx(O,{id:"reviewDateTime",type:"datetime-local",value:g.supervisorCheck.reviewDateTime,onChange:s=>ee("reviewDateTime",s.target.value)})]})]}),e.jsx("div",{className:"flex gap-4 mb-4",children:e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"pending",name:"status",value:"pending",checked:g.supervisorCheck.status==="pending",onChange:s=>ee("status",s.target.value),className:"hidden peer"}),e.jsx(M,{htmlFor:"pending",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${g.supervisorCheck.status==="pending"?"border-gray-500 bg-gray-100 text-gray-900 font-semibold":"border-gray-300 text-gray-600 hover:border-gray-400 hover:bg-gray-50"}`,children:"Pending"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"approved",name:"status",value:"approved",checked:g.supervisorCheck.status==="approved",onChange:s=>ee("status",s.target.value),className:"hidden peer"}),e.jsx(M,{htmlFor:"approved",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${g.supervisorCheck.status==="approved"?"border-green-600 bg-green-100 text-green-800 font-semibold":"border-gray-300 text-green-700 hover:border-green-400 hover:bg-green-50"}`,children:"Approve"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:"needs_changes",name:"status",value:"needs_changes",checked:g.supervisorCheck.status==="needs_changes",onChange:s=>ee("status",s.target.value),className:"hidden peer"}),e.jsx(M,{htmlFor:"needs_changes",className:`px-4 py-2 rounded-xl cursor-pointer border-2 transition-colors
        ${g.supervisorCheck.status==="needs_changes"?"border-orange-600 bg-orange-100 text-orange-800 font-semibold":"border-gray-300 text-orange-700 hover:border-orange-400 hover:bg-orange-50"}`,children:"Changes Required"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"remarks",children:"Remarks / Observations"}),e.jsx(He,{id:"remarks",placeholder:"Note deviations, rework needed, or greenlight to proceed",value:g.supervisorCheck.remarks,onChange:s=>ee("remarks",s.target.value),rows:3})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"gatekeeping",children:"Gatekeeping (Workflow Interlock)"}),e.jsxs(qe,{value:g.supervisorCheck.gatekeeping,onValueChange:s=>ee("gatekeeping",s),children:[e.jsx(Ye,{selectedValue:g.supervisorCheck.gatekeeping,children:e.jsx(Xe,{selectedValue:g.supervisorCheck.gatekeeping==="block"?"BLOCK work to start with Supervisor Watch":"ALLOW work to start with Supervisor Watch"})}),e.jsxs(Qe,{children:[e.jsx(pe,{value:"block",children:"BLOCK work to start with Supervisor Watch"}),e.jsx(pe,{value:"allow_with_watch",children:"ALLOW work to start with Supervisor Watch"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Matches CRM philosophy used in Material Arrival stage — prevent next step until approval."})]})]})]})]})]})]})}):null},ot=()=>{var g;const{projectId:w,organizationId:W}=Ze(),[E,n]=j.useState(!1),[L,B]=j.useState([]),[h,I]=j.useState(null),[xe,Y]=j.useState(null),[X,m]=j.useState(new Date),[o,y]=j.useState(null),[K,Se]=j.useState([]),[V,F]=j.useState(!1),fe=Ls(),{data:_,isLoading:je,error:H,refetch:z}=Xs(w),{mutateAsync:q}=Qs(),me=Zs(),ue=Gs();j.useEffect(()=>{(()=>{const u=X.getFullYear(),x=X.getMonth(),f=new Date(u,x,1),N=new Date(f);N.setDate(N.getDate()-f.getDay());const d=[],p=new Date(N);for(let b=0;b<42;b++)d.push({date:new Date(p),isCurrentMonth:p.getMonth()===x}),p.setDate(p.getDate()+1);B(d)})()},[X]);const se=j.useCallback(()=>{if(!h)return;const r=new Date(h);r.setDate(r.getDate()-1),te(r)},[h]),ge=j.useCallback(()=>{if(!h)return;const r=new Date(h);r.setDate(r.getDate()+1),te(r)},[h]);j.useEffect(()=>{const r=u=>{h&&(u.key==="Escape"?(I(null),y(null),F(!1)):u.key==="ArrowRight"?ge():u.key==="ArrowLeft"&&se())};return document.addEventListener("keydown",r),()=>{document.removeEventListener("keydown",r)}},[ge,se]);const S=Ge();j.useEffect(()=>{if(!k||!W)return;const r=d=>{const{createdBy:p}=d;console.log("workinged created form teh socket 1294"),p!==(S==null?void 0:S.id)&&(z(),v({title:"New Task Created",description:`New work schedule created by ${d.createdByRole}`}))},u=d=>{const{updatedBy:p}=d;if(console.log("🔥 WebSocket Event Received:",d),console.log("👤 Current User ID:",S==null?void 0:S.id),p!==(S==null?void 0:S.id)&&(console.log("✅ Refetching data... in weebsocket useEffect"),z(),v({title:"Task Updated",description:`Work schedule updated by ${d.updatedByRole}`}),o&&o.scheduleId===d.taskId)){const b=_==null?void 0:_.find(C=>C._id===d.taskId);if(b){const C=b.dailyTasks.find(D=>D._id===o._id);C&&y({...C,scheduleId:d.taskId})}}},x=d=>{const{taskId:p,deletedBy:b}=d;b!==(S==null?void 0:S.id)&&(z(),v({title:"Task Deleted",description:`Task deleted by ${d.deletedByRole}`}),o&&o._id===p&&(y(null),I(null),F(!1)))},f=d=>{const{taskId:p,date:b,newImages:C,uploadedBy:D}=d;D!==(S==null?void 0:S.id)&&(o&&o._id===p&&y(A=>{if(!A)return A;const P=[...A.uploadedImages||[]],U=new Date(b),J=P.findIndex(we=>new Date(we.date).toDateString()===U.toDateString());return J!==-1?P[J]={...P[J],uploads:[...P[J].uploads,...C]}:P.push({date:U.toISOString(),uploads:C}),{...A,uploadedImages:P}}),v({title:"Images Uploaded",description:`New images uploaded by ${d.uploadedByRole}`}))},N=d=>{const{taskId:p,date:b,remainingImages:C,deletedBy:D}=d;D!==(S==null?void 0:S.id)&&(o&&o._id===p&&y(A=>{var U;if(!A)return A;const P=(U=A.uploadedImages)==null?void 0:U.map(J=>J.date.split("T")[0]===b?{...J,uploads:C}:J);return{...A,uploadedImages:P}}),v({title:"Image Deleted",description:`Image deleted by ${d.deletedByRole}`}))};return k.on("workSchedule:task_created",r),k.on("workSchedule:task_updated",u),k.on("workSchedule:task_deleted",x),k.on("workSchedule:image_uploaded",f),k.on("workSchedule:image_deleted",N),()=>{k.off("workSchedule:task_created",r),k.off("workSchedule:task_updated",u),k.off("workSchedule:task_deleted",x),k.off("workSchedule:image_uploaded",f),k.off("workSchedule:image_deleted",N)}},[W,S==null?void 0:S.id,o,_,V]),j.useEffect(()=>{k.on("workSchedule:task_created",r=>{console.log("🎯 Received task_created:",r),v({title:"success",description:"created task for socket chekcing in the chrom "})})},[]);const ve=r=>`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}`,he=r=>{const u=ve(r);return _.flatMap(x=>(x.dailyTasks||[]).filter(N=>(typeof N.datePlanned=="string"?N.datePlanned.split("T")[0]:new Date(N.datePlanned).toISOString().split("T")[0])===u).map(N=>({...N,scheduleId:x._id})))},te=r=>{const u=he(r);I(r),Se(u),u.length===1?(y(u[0]),F(!1)):u.length>1&&(F(!0),y(null))},ae=r=>{switch(r){case"completed":return"bg-green-200 text-green-800";case"in_progress":return"bg-yellow-200 text-yellow-800";case"planned":return"bg-blue-200 text-blue-800";default:return"bg-gray-200 text-gray-800"}},ye=r=>{const u=_.find(x=>x._id===r);u&&(Y(u),n(!0))},Ne=async r=>{var u,x;try{await q({scheduleId:r.scheduleId,taskId:r._id,projectId:w}),I(null),y(null),z(),v({title:"Success",description:"deleted successfully"})}catch(f){v({title:"Error",description:((x=(u=f==null?void 0:f.response)==null?void 0:u.data)==null?void 0:x.message)||"failed to delete",variant:"destructive"})}},be=async(r,u)=>{var x,f,N;if(h)try{const d=(x=_==null?void 0:_.find(p=>p.dailyTasks.some(b=>b._id===u._id)))==null?void 0:x._id;if(d){const p=await me.mutateAsync({scheduleId:d,taskId:u._id,date:h.toISOString().split("T")[0],projectId:w,files:r});z(),y(b=>{var D;if(!b)return b;const C=(D=b.uploadedImages)==null?void 0:D.find(A=>new Date(A.date).toDateString()===h.toDateString());return C?(C.uploads.push(...p.uploads),{...b,uploadedImages:[...b.uploadedImages]}):{...b,uploadedImages:[...b.uploadedImages||[],p]}}),v({title:"Success",description:"image uploaded successfully"})}}catch(d){v({title:"Error",description:((N=(f=d==null?void 0:d.response)==null?void 0:f.data)==null?void 0:N.message)||"failed to upload",variant:"destructive"})}},ke=async(r,u)=>{var x,f,N;try{const d=(x=_==null?void 0:_.find(p=>p.dailyTasks.some(b=>b._id===u._id)))==null?void 0:x._id;if(d){const p=await ue.mutateAsync({scheduleId:d,taskId:u._id,date:(h==null?void 0:h.toISOString().split("T")[0])||"",projectId:w,imageId:r});console.log("upladsImages",p),z();const b=(h==null?void 0:h.toISOString().split("T")[0])||"";y(C=>{var A;if(!C)return C;const D=(A=C.uploadedImages)==null?void 0:A.map(P=>P.date.split("T")[0]===b?{...P,uploads:P.uploads.filter(U=>U._id!==r)}:P);return{...C,uploadedImages:D}}),v({title:"Success",description:"deleted successfully"})}}catch(d){v({title:"Error",description:((N=(f=d==null?void 0:d.response)==null?void 0:f.data)==null?void 0:N.message)||"failed to delete",variant:"destructive"})}},Q=r=>{m(u=>{const x=new Date(u);return x.setMonth(u.getMonth()+r),x})};return je?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading schedule..."})]})}):H?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-exclamation-triangle text-4xl text-red-600 mb-4"}),e.jsx("p",{className:"text-red-600",children:"Error loading schedule data"})]})}):e.jsx("div",{className:"max-h-full overflow-y-auto bg-gray-50",children:e.jsx("div",{className:" mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("button",{className:"bg-gray-100 rounded-lg px-2 py-1 cursor-pointer",onClick:()=>{fe(-1)},children:[e.jsx("i",{className:"fas fa-arrow-left mr-1 "}),"back"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Work Schedule Calendar"}),e.jsxs("button",{onClick:()=>n(!0),className:"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-plus"}),"Add Events"]})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("button",{onClick:()=>Q(-1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsx("h2",{className:"text-xl font-semibold",children:X.toLocaleDateString("en-US",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>Q(1),className:"p-2 hover:bg-gray-100 rounded",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-1 mb-4",children:[["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(r=>e.jsx("div",{className:"p-3 text-center font-semibold text-gray-600 bg-gray-100",children:r},r)),L.map((r,u)=>{const x=he(r.date);return e.jsxs("div",{className:`min-h-[120px] p-2 border border-gray-200 cursor-pointer hover:bg-gray-50 ${r.isCurrentMonth?"bg-white":"bg-gray-50"}`,onClick:()=>te(r.date),children:[e.jsx("div",{className:"font-medium text-sm mb-1",children:r.date.getDate()}),x.length===0?e.jsx("div",{className:"text-xs text-gray-400 italic",children:"No tasks assigned"}):e.jsxs("div",{className:"space-y-1",children:[x.slice(0,2).map((f,N)=>e.jsx("div",{className:`text-xs p-1 rounded truncate ${ae(f.status)}`,children:f.workDescription||f.room},N)),x.length>2&&e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["+",x.length-2," more"]})]})]},u)})]}),h&&e.jsxs("div",{onClick:()=>{Y(null),I(null),y(null),F(!1)},className:"fixed inset-0 bg-black/70 bg-opacity-50 flex items-center justify-around z-50",children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),se()},className:"p-2 text-gray-600 bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-left"})}),e.jsxs("div",{onClick:r=>r.stopPropagation(),className:"bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold",children:["Tasks for ",h.toLocaleDateString()]}),e.jsx("button",{onClick:()=>{Y(null),I(null),y(null),F(!1)},className:"text-gray-500 hover:text-gray-700",children:e.jsx("i",{className:"fas fa-times text-xl"})})]}),K.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fas fa-calendar-times text-4xl mb-4"}),e.jsx("p",{className:"text-lg",children:"No tasks assigned for this date"})]}):V&&K.length>1?e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Select a task to view details:"}),K.map((r,u)=>e.jsx("div",{className:"border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors",onClick:()=>{y(r),F(!1)},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-lg",children:r.workDescription}),e.jsxs("p",{className:"text-gray-600",children:["Room: ",r.room]}),e.jsxs("p",{className:"text-gray-600",children:["Time: ",r.startTime," - ",r.endTime]})]}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${ae(r.status)}`,children:r.status})]})},u))]}):o?e.jsxs("div",{className:"space-y-6",children:[K.length>1&&e.jsxs("button",{onClick:()=>{F(!0),y(null)},className:"text-blue-600 hover:text-blue-800 mb-4",children:[e.jsx("i",{className:"fas fa-arrow-left mr-2"}),"Back to task list"]}),e.jsxs("div",{className:"border rounded-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h4",{className:"text-xl font-bold",children:o.workDescription}),e.jsx("span",{className:`px-3 py-1 rounded text-sm ${ae(o.status)}`,children:o.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6 text-gray-700 mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Room/Unit:"})," ",o.room]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Time:"})," ",o.startTime," - ",o.endTime]})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Materials:"})," ",((g=o.materialsNeeded)==null?void 0:g.join(", "))||"None"]}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Manpower:"})," ",o.manpower]})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"text-lg font-semibold",children:"Task Images"}),e.jsxs("label",{className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded cursor-pointer transition-colors",children:[me.isPending&&e.jsx("span",{className:"animate-spin fas fa-spinner mr-1"}),e.jsx("i",{className:"fas fa-upload mr-2"}),"Upload Images",e.jsx("input",{type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:r=>{r.target.files&&be(Array.from(r.target.files),o)}})]})]}),o!=null&&o.uploadedImages&&(o==null?void 0:o.uploadedImages.length)>0?e.jsx("div",{className:"",children:(()=>{const r=((o==null?void 0:o.uploadedImages)||[]).reduce((x,f)=>{if(!Array.isArray(f==null?void 0:f.uploads)||f.uploads.length===0)return x;let N="Unknown Date";if(f!=null&&f.date){const d=new Date(f.date);N=isNaN(d.getTime())?String(f.date):d.toISOString().split("T")[0]}return x[N]||(x[N]=[]),x[N].push(...f.uploads),x},{}),u=Object.keys(r);return u.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]}):u.map(x=>e.jsx("div",{className:"mb-4",children:e.jsx(Ae,{imageFiles:r[x],handleDeleteFile:f=>ke(f,o),refetch:z,height:120,minWidth:120,maxWidth:140})},x))})()}):e.jsxs("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-lg",children:[e.jsx("i",{className:"fas fa-images text-3xl mb-2"}),e.jsx("p",{children:"No images uploaded for this task"})]})]}),e.jsxs("div",{className:"mt-6 flex gap-3 pt-4 border-t",children:[e.jsxs("button",{onClick:()=>Ne(o),className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors",children:[e.jsx("i",{className:"fas fa-trash mr-2"}),"Delete Task"]}),e.jsx(R,{onClick:()=>ye(o.scheduleId),children:"Edit Task"})]})]})]}):K.length===1?(y(K[0]),null):null]}),e.jsx("button",{onClick:r=>{r.stopPropagation(),ge()},className:"p-2 text-gray-600  bg-gray-50 hover:text-gray-900",children:e.jsx("i",{className:"fas fa-chevron-right"})})]}),E&&e.jsx(et,{projectId:w,isOpen:E,onClose:()=>{n(!1),Y(null)},onSave:()=>{n(!1)},refetch:z,scheduleId:xe?o.scheduleId:null,editData:xe,onUpdate:()=>{I(null),y(null),F(!1)}})]})})})};export{ot as default};
