import{j as e,L as R,u as E,r as f,s as j,q as A}from"./index-B0GkKy4g.js";import{u as L,a as M,b as _}from"./notificationApi-DbKQ8ZPb.js";import{B as $}from"./Button-BiqmKnns.js";import B from"./MaterialOverviewLoading-C65kwR1W.js";import{u as F}from"./useCurrentSupervisor-Liwy0rwN.js";import"./useQuery-Y36MjM7d.js";import"./useMutation-BZsHp3-C.js";import"./useInfiniteQuery-WWOOGr2-.js";import"./roleCheck-BEAfMS_i.js";import"./Skeleton-FIUxrwm8.js";const S=({deleteMutation:v,notification:s,onDelete:i,frontendUrl:x})=>{var N;const n=(o=>{switch(o){case"warning":return{icon:"fa-exclamation-triangle",bgColor:"bg-amber-50",borderColor:"border-l-amber-400",badgeBg:"bg-amber-100",badgeText:"text-amber-700"};case"assignment":return{icon:"fa-tasks",bgColor:"bg-blue-50",borderColor:"border-l-blue-400",badgeBg:"bg-blue-100",badgeText:"text-blue-700"};case"info":default:return{icon:"fa-info-circle",bgColor:"bg-slate-50",borderColor:"border-l-slate-400",badgeBg:"bg-slate-100",badgeText:"text-slate-700"}}})(s.type),p=o=>{const r=new Date(o),u=new Date,g=u.getTime()-r.getTime(),h=Math.floor(g/6e4),c=Math.floor(g/36e5),y=Math.floor(g/864e5);return h<1?"Just now":h<60?`${h}m ago`:c<24?`${c}h ago`:y<7?`${y}d ago`:r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:r.getFullYear()!==u.getFullYear()?"numeric":void 0})},m=(()=>{var u;if(!((u=s.navigation)!=null&&u.url))return null;const o=x.endsWith("/")?x.slice(0,-1):x,r=s.navigation.url.startsWith("/")?s.navigation.url:`/${s.navigation.url}`;return`${o}${r}`})();return e.jsx("div",{className:`${n.bgColor} border-l-4 ${n.borderColor} rounded-lg p-4 mb-3 transition-all duration-200 hover:shadow-md ${s.isRead?"":"ring-1 ring-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 pt-1",children:e.jsx("i",{className:`fas ${n.icon} text-lg ${n.badgeText}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 leading-relaxed",children:s.message}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:p(s.createdAt)})]})}),m&&e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsxs(R,{to:m,className:"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors",onClick:()=>i(s._id),children:[((N=s.navigation)==null?void 0:N.label)||"View Details",e.jsx("i",{className:"fas fa-arrow-right text-xs"})]})})]}),e.jsx("div",{className:"flex-shrink-0 flex gap-2",children:e.jsx($,{variant:"danger",isLoading:v.isPending&&v.variables.notificationId===s._id,onClick:()=>i(s._id),className:"!p-1 px-2  bg-red-600 !text-white hover:bg-red-600 transition-colors rounded",title:"Delete notification",size:"sm",children:e.jsx("i",{className:"fas fa-xmark text-sm"})})})]})})},J=()=>{var C,T;const v=E(),s=F(),{data:i,fetchNextPage:x,hasNextPage:w,isFetchingNextPage:n,isLoading:p,isError:k,error:m}=L(20),{mutateAsync:N}=M(),o=_(),r=f.useRef(null),u=f.useRef(null),g=f.useRef(!0),h=f.useRef(0);f.useEffect(()=>{const t=s==null?void 0:s.id;if(!t)return;j.emit("join_notifications",{userId:t});const l=a=>{console.log("ðŸ”” New notification received:",a);const d=r.current,H=d?d.scrollHeight-d.scrollTop-d.clientHeight<100:!1;A.invalidateQueries({queryKey:["notifications","infinite"]}),H&&setTimeout(()=>{d==null||d.scrollTo({top:d.scrollHeight,behavior:"smooth"})},100)},b=a=>{console.log("ðŸ“Š Unread count updated:",a==null?void 0:a.count),A.invalidateQueries({queryKey:["notifications","unread-count"]})};return j.on("new_notification",l),j.on("unread_count_update",b),()=>{j.off("new_notification",l),j.off("unread_count_update",b)}},[s==null?void 0:s.id]);const c=((T=(C=i==null?void 0:i.pages)==null?void 0:C.flatMap(t=>t==null?void 0:t.notifications))==null?void 0:T.sort((t,l)=>{var b,a;return((b=new Date(t.createdAt))==null?void 0:b.getTime())-((a=new Date(l.createdAt))==null?void 0:a.getTime())}))??[];f.useEffect(()=>{if(g.current&&c.length>0&&!p){const t=r.current;t&&(t.scrollTop=t.scrollHeight,g.current=!1)}},[c.length,p]),f.useEffect(()=>{const t=r.current;if(!t)return;const l=()=>{t.scrollTop<100&&w&&!n&&(console.log("ðŸ“œ Loading older notifications..."),h.current=t.scrollHeight,x().then(()=>{requestAnimationFrame(()=>{const a=t.scrollHeight-h.current;t.scrollTop=a})}))};return t.addEventListener("scroll",l),()=>t.removeEventListener("scroll",l)},[w,n,x]),f.useEffect(()=>{i&&(async()=>{await N()})()},[i,N]);const y="https://houseofram.in",D=async t=>{try{await o.mutateAsync({notificationId:t})}catch(l){console.error("Error deleting notification:",l)}};return p?e.jsx(B,{}):k?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-exclamation-circle"}),e.jsxs("span",{children:["Error loading notifications: ",(m==null?void 0:m.message)||"Unknown error"]})]})})}):e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col bg-white",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white border-b border-slate-200 flex-shrink-0",children:e.jsx("div",{className:"px-4 md:px-6 py-2 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{onClick:()=>v(-1),className:"cursor-pointer w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-arrow-left text-blue-600 text-lg"})}),e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-bell text-blue-600 text-lg"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-slate-900",children:"Notifications"})})]})})}),e.jsx("div",{ref:r,className:"flex-1 overflow-y-auto p-4 md:p-6",style:{scrollBehavior:"auto"},children:c.length===0?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-8 text-center",children:[e.jsx("i",{className:"fas fa-bell text-4xl text-slate-300 mb-3 block"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No notifications yet"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"You're all caught up! Check back later for updates."})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:u,className:"flex justify-center py-2",children:[n&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Loading earlier notifications..."})]}),!w&&c.length>0&&e.jsx("p",{className:"text-slate-400 text-xs font-medium",children:"Beginning of notifications"})]}),e.jsx("div",{className:"space-y-3",children:c.map(t=>e.jsx(S,{notification:t,onDelete:D,deleteMutation:o,frontendUrl:y},t._id))})]})})]})};export{J as default};
