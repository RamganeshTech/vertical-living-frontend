import{q as ee,f as P,d as G,r as h,j as r}from"./index-g9v5L7eS.js";import{u as D}from"./useQuery-BlDIWKCM.js";import{u as Q}from"./useMutation-CAsfcLt-.js";import{ORDERMATERIAL_UNIT_OPTIONS as U}from"./OrderMaterialOverview-6fOP1xqC.js";import{B as J}from"./Button-DXzmpjtA.js";import{t as q}from"./toast-BSC5QTk1.js";import{I as B}from"./Input-BX0V0pOd.js";import{u as re}from"./shopLibDetailApi-qpdMsTrY.js";import{S as se}from"./SearchSelectNew-J6owvRRK.js";const T="https://houseofram.in/api",te=async({projectId:s})=>{const{data:c}=await P.get(`${T}/publicordermaterial/${s}/getpublicsubitems`);if(!c.ok)throw new Error(c.message);return c.data},ae=s=>D({queryKey:["public-ordering-material",s],queryFn:async()=>await te({projectId:s}),enabled:!!s,retry:!1,refetchOnMount:!1}),ce=async({projectId:s,subItemName:c,quantity:e,unit:u})=>{const{data:n}=await P.post(`${T}/publicordermaterial/${s}/addsubitem`,{subItemName:c,quantity:e,unit:u});if(!n.ok)throw new Error(n.message);return n.data},ne=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemName:e,quantity:u,unit:n})=>await ce({projectId:c,subItemName:e,quantity:u,unit:n}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},ue=async({projectId:s,subItemId:c})=>{const{data:e}=await P.delete(`${T}/publicordermaterial/${s}/deletesubitem/${c}`);if(!e.ok)throw new Error(e.message);return e.data},ie=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemId:e})=>await ue({projectId:c,subItemId:e}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},de=async({projectId:s,subItemId:c,subItemName:e,quantity:u,unit:n})=>{const{data:t}=await P.put(`${T}/publicordermaterial/${s}/updatesubitem/${c}`,{subItemName:e,quantity:u,unit:n});if(!t.ok)throw new Error(t.message);return t.data},oe=()=>{const s=G();return Q({mutationFn:async({projectId:c,subItemId:e,subItemName:u,quantity:n,unit:t})=>await de({projectId:c,subItemId:e,subItemName:u,quantity:n,unit:t}),onSuccess:(c,e)=>{s.invalidateQueries({queryKey:["public-ordering-material",e.projectId]}),s.invalidateQueries({queryKey:["inventory",e.projectId],refetchType:"active"})}})},le=async({projectId:s,organizationId:c})=>{const{data:e}=await P.patch(`${T}/publicordermaterial/generatelink/${s}/${c}`);if(!e.ok)throw new Error(e.message);return e.data},_e=()=>Q({mutationFn:async({projectId:s,organizationId:c})=>await le({projectId:s,organizationId:c}),onSuccess:(s,{projectId:c})=>{ee.invalidateQueries({queryKey:["public-ordering-material",c]})}}),me=async({orgsId:s})=>{try{let{data:c}=await P.get(`https://houseofram.in/api/publicordermaterial/getprojects/${s}`);return c.ok?c.data:[]}catch(c){throw c}},ke=s=>D({queryKey:["publicproject"],queryFn:async()=>await me({orgsId:s}),refetchOnWindowFocus:!1,retry:!1}),pe=async(s,c)=>{const{data:e}=await P.put(`https://houseofram.in/api/publicordermaterial/${s}/shop`,c);if(!e.ok)throw new Error(e.message);return e.data},fe=()=>{const s=G();return Q({mutationFn:async({projectId:c,updates:e})=>await pe(c,e),onSuccess:(c,{projectId:e})=>{s.invalidateQueries({queryKey:["public-ordering-material",e]})}})},he=({label:s="",options:c,value:e,onChange:u,onSelectOption:n,placeholder:t="Type or select...",name:i,mode:l="simple",onKeyDown:j,onBlur:v,autoFocus:x=!1})=>{var O;const[I,b]=h.useState(!1),[p,a]=h.useState(""),[N,k]=h.useState(c),$=h.useRef(null),g=h.useRef(null);h.useEffect(()=>{x&&g.current&&g.current.focus()},[x]),h.useEffect(()=>{l==="object"&&e&&typeof e=="object"?a(e.value):l==="simple"&&typeof e=="string"?a(e):e||a("")},[e,l]),h.useEffect(()=>{if(p){const d=c.filter(y=>(typeof y=="string"?y:y.value).toLowerCase().includes(p.toLowerCase()));k(d)}else k(c)},[p,c]),h.useEffect(()=>{const d=y=>{$.current&&!$.current.contains(y.target)&&b(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[]);const W=d=>{const y=d.target.value;a(y),b(!0),u(l==="simple"?y:{_id:"",value:y})},z=d=>{const y=typeof d=="string"?d:d.value;a(y),b(!1),typeof d=="string"?(u(d),n==null||n(d)):(u(d),n==null||n(d.value))},X=()=>{b(!0)},Y=()=>{setTimeout(()=>{v==null||v()},200)},H=d=>{d.key==="Escape"&&b(!1),j==null||j(d)},K=d=>typeof d=="string"?d:d.value;return r.jsxs("div",{className:"relative w-full",ref:$,children:[s&&r.jsx("label",{htmlFor:i,className:"block text-sm font-medium text-gray-700 mb-2",children:s}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{ref:g,id:i,type:"text",value:p,onChange:W,onFocus:X,onBlur:Y,onKeyDown:H,placeholder:t,className:"w-full px-4 py-2.5 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all",autoComplete:"off"}),r.jsx("button",{type:"button",onClick:()=>b(!I),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",tabIndex:-1,children:r.jsx("i",{className:`fas fa-chevron-down transition-transform duration-200 ${I?"rotate-180":""}`})})]}),I&&r.jsx("div",{className:"fixed z-[9999] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto",style:{width:((O=g.current)==null?void 0:O.offsetWidth)||"auto",top:g.current?g.current.getBoundingClientRect().bottom+window.scrollY:0,left:g.current?g.current.getBoundingClientRect().left+window.scrollX:0},children:N.length>0?r.jsx("ul",{className:"py-1",children:N.map((d,y)=>{const L=K(d),S=typeof d=="object"?d._id:y;return r.jsx("li",{onMouseDown:()=>z(d),className:"px-4 py-2.5 hover:bg-blue-50 cursor-pointer transition-colors text-gray-700 hover:text-blue-600",children:L},S)})}):r.jsx("div",{className:"px-4 py-3 text-sm text-gray-500",children:r.jsxs("p",{className:"flex items-center gap-2",children:[r.jsx("i",{className:"fas fa-info-circle"}),'No matches found. Current value: "',p,'"']})})})]})},E=["Cement","Steel Rods","Bricks","Sand","Gravel","Concrete Mix","Paint","Wood Planks","Tiles","Glass","Nails","Screws"],C=({item:s,isNewRow:c=!1,newRowData:e,setNewRowData:u,editingCell:n,setEditingCell:t,onSave:i,onNewRowSave:l,onDelete:j,isDeleting:v,isAdding:x})=>{const I=h.useRef(null),[b,p]=h.useState("");return h.useEffect(()=>{n&&I.current&&I.current.focus()},[n]),c?r.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-green-50 border-b border-gray-100",children:[r.jsx("div",{className:"col-span-3 border-r border-gray-200 px-4 py-3 text-gray-400 text-sm",children:"Auto"}),r.jsx("div",{className:"col-span-8 border-r border-gray-200",children:r.jsx(V,{value:(e==null?void 0:e.name)||"",options:E,placeholder:"Enter material name...",onChange:a=>{u==null||u({...e,name:a})},onSelectOption:a=>{u==null||u({...e,name:a}),e!=null&&e.unit&&(l==null||l({...e,name:a}))},onEnter:()=>{var a;(a=e==null?void 0:e.name)!=null&&a.trim()&&(e!=null&&e.unit)&&(l==null||l(e))}})}),r.jsx("div",{className:"col-span-2 border-r border-gray-200",children:r.jsx("input",{type:"number",placeholder:"Qty",min:"0",value:(e==null?void 0:e.quantity)||1,onChange:a=>{u==null||u({...e,quantity:Number(a.target.value)||1})},className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),r.jsx("div",{className:"col-span-3 border-r border-gray-200",children:r.jsx(V,{value:(e==null?void 0:e.unit)||"",options:U,placeholder:"Select unit...",onChange:a=>{u==null||u({...e,unit:a})},onSelectOption:async a=>{var k;const N={...e,unit:a};u==null||u(N),(k=N.name)!=null&&k.trim()&&await(l==null?void 0:l(N))},onEnter:async()=>{var a;(a=e==null?void 0:e.name)!=null&&a.trim()&&(e!=null&&e.unit)&&await(l==null?void 0:l(e))}})}),r.jsx("div",{className:"col-span-1 flex items-center justify-center",children:x&&r.jsx("i",{className:"fas fa-spinner fa-spin text-green-600"})})]}):r.jsxs("div",{className:"grid grid-cols-17 gap-0 border-b border-gray-100 hover:bg-gray-50",children:[r.jsx("div",{className:"col-span-3 border-r border-blue-200 px-4 py-3 text-sm text-gray-600",children:(s==null?void 0:s.refId)||"N/A"}),r.jsx("div",{className:"col-span-8 border-r border-blue-200",children:(n==null?void 0:n.subItemId)===s._id&&(n==null?void 0:n.field)==="name"?r.jsx(V,{value:b||s.subItemName,options:E,onChange:a=>{p(a)},onSelectOption:a=>{i==null||i(s._id,"name",a),t==null||t(null),p("")},onEnter:()=>{i==null||i(s._id,"name",b||s.subItemName),t==null||t(null),p("")},onBlur:()=>{t==null||t(null),p("")},autoFocus:!0}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{t==null||t({subItemId:s._id,field:"name"}),p(s.subItemName)},children:s.subItemName})}),r.jsx("div",{className:"col-span-2 border-r border-blue-200",children:(n==null?void 0:n.subItemId)===s._id&&(n==null?void 0:n.field)==="quantity"?r.jsx("input",{ref:I,type:"number",defaultValue:s.quantity,min:"0",className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:a=>{i==null||i(s._id,"quantity",a.target.value),t==null||t(null)},onKeyDown:a=>{a.key==="Enter"&&(i==null||i(s._id,"quantity",a.currentTarget.value),t==null||t(null)),a.key==="Escape"&&(t==null||t(null))}}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>t==null?void 0:t({subItemId:s._id,field:"quantity"}),children:s.quantity})}),r.jsx("div",{className:"col-span-3 border-r border-blue-200",children:(n==null?void 0:n.subItemId)===s._id&&(n==null?void 0:n.field)==="unit"?r.jsx(V,{value:b||s.unit,options:U,onChange:a=>{p(a)},onSelectOption:a=>{i==null||i(s._id,"unit",a),t==null||t(null),p("")},onEnter:()=>{i==null||i(s._id,"unit",b||s.unit),t==null||t(null),p("")},onBlur:()=>{t==null||t(null),p("")},autoFocus:!0}):r.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{t==null||t({subItemId:s._id,field:"unit"}),p(s.unit)},children:s.unit})}),r.jsx("div",{className:"col-span-1 flex items-center justify-center",children:r.jsx(J,{variant:"danger",onClick:()=>j==null?void 0:j(s._id),disabled:v,className:"p-2 bg-red-600 text-white hover:bg-red-700 rounded transition-colors disabled:opacity-50",title:"Delete item",children:v?r.jsx("i",{className:"fas fa-spinner fa-spin text-sm"}):r.jsx("i",{className:"fa fa-trash text-sm"})})})]})},V=({value:s,options:c,placeholder:e,onChange:u,onSelectOption:n,onBlur:t,onEnter:i,autoFocus:l})=>{const j=x=>{typeof x=="string"?u(x):x&&typeof x=="object"?u(x.value):x===null&&u("")},v=x=>{x.key==="Enter"&&(i==null||i())};return r.jsx("div",{className:"w-full",children:r.jsx(he,{label:"",name:"field",value:s,onChange:j,onSelectOption:n,options:c,mode:"simple",placeholder:e,onKeyDown:v,onBlur:t,autoFocus:l})})},Ae=({selectedProjectId:s,organizationId:c})=>{var K,O,d,y,L,S,Z;const{data:e}=re(c),[u,n]=h.useState(!1),[t,i]=h.useState({}),[l,j]=h.useState({selectedId:null,shopName:null});h.useEffect(()=>{if(l.selectedId){const o=e==null?void 0:e.find(m=>m._id===l.selectedId);o&&i(o)}},[l.selectedId,e]);const v=(K=e||[])==null?void 0:K.map(o=>({value:o._id,label:o.shopName})),[x,I]=h.useState({name:"",quantity:1,unit:""}),[b,p]=h.useState(null),{data:a,isLoading:N}=ae(s),k=ne(),$=oe(),g=ie(),W=async(o,m,f)=>{var _,F,M;try{const A=(_=a==null?void 0:a.subItems)==null?void 0:_.find(w=>w._id===o);if(!A)return;const R={projectId:s,subItemId:o,subItemName:m==="name"?f:A.subItemName,quantity:m==="quantity"?Number(f)||1:A.quantity,unit:m==="unit"?f:A.unit};await $.mutateAsync(R),q({title:"Success",description:"Item updated successfully"})}catch(A){q({title:"Error",description:((M=(F=A==null?void 0:A.response)==null?void 0:F.data)==null?void 0:M.message)||"Failed to update item",variant:"destructive"})}},z=async o=>{var f,_,F;const m=o;if(!((f=m==null?void 0:m.name)!=null&&f.trim()))return q({title:"Error",description:"Material Name is mandatory",variant:"destructive"});if(!(m!=null&&m.unit))return q({title:"Error",description:"Unit is mandatory",variant:"destructive"});try{await k.mutateAsync({projectId:s,unitId:"",subItemName:m.name,quantity:m.quantity||1,unit:m.unit}),I({name:"",quantity:1,unit:""}),q({title:"Success",description:"Item created successfully"})}catch(M){q({title:"Error",description:((F=(_=M==null?void 0:M.response)==null?void 0:_.data)==null?void 0:F.message)||"Failed to create item",variant:"destructive"})}},X=async o=>{var m,f;try{await g.mutateAsync({projectId:s,subItemId:o}),q({title:"Success",description:"Item deleted successfully"})}catch(_){q({title:"Error",description:((f=(m=_==null?void 0:_.response)==null?void 0:m.data)==null?void 0:f.message)||"Failed to delete item",variant:"destructive"})}},{mutateAsync:Y}=fe(),H=async()=>{var o,m;try{if(t.phoneNumber&&!/^\d{10}$/.test(t.phoneNumber.trim()))throw new Error("Phone number should contain exactly 10 digit numbers");await Y({projectId:s,updates:t}),q({title:"Success",description:"Shop Details Updated"}),n(!1)}catch(f){q({variant:"destructive",title:"Error",description:((m=(o=f==null?void 0:f.response)==null?void 0:o.data)==null?void 0:m.message)||(f==null?void 0:f.message)||"Update failed"})}};return r.jsxs("div",{className:"bg-white rounded-lg border-2 border-gray-200 overflow-hidden shadow-lg",children:[r.jsxs("div",{className:"border rounded-lg p-4 mb-6 bg-white  shadow-sm",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsxs("h2",{className:"text-lg font-semibold text-blue-700 flex items-center gap-2",children:[r.jsx("i",{className:"fa-solid fa-store text-blue-600"}),"Shop Details"]}),u?r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Shop Selection"}),r.jsx(se,{options:v,placeholder:"Select Shop",searchPlaceholder:"Search by shop name...",value:l.selectedId||"",onValueChange:o=>{const m=e==null?void 0:e.find(f=>f._id===o);j({selectedId:m._id,shopName:m.shopName})},searchBy:"name",displayFormat:"detailed",className:"w-full"})]}):r.jsxs("button",{onClick:()=>{i(a==null?void 0:a.shopDetails),n(!0)},className:"text-blue-600 text-sm font-medium flex items-center gap-1 hover:underline",children:[r.jsx("i",{className:"fa-solid fa-pen-to-square"}),"Edit"]})]}),u?r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r.jsx(B,{placeholder:"Shop Name",value:(t==null?void 0:t.shopName)||"",onChange:o=>i({...t,shopName:o.target.value})}),r.jsx(B,{placeholder:"Contact Person",value:(t==null?void 0:t.contactPerson)||"",onChange:o=>i({...t,contactPerson:o.target.value})}),r.jsx(B,{placeholder:"Phone Number",value:(t==null?void 0:t.phoneNumber)||"",type:"tel",maxLength:10,onChange:o=>i({...t,phoneNumber:o.target.value})}),r.jsx(B,{placeholder:"Address",value:(t==null?void 0:t.address)||"",onChange:o=>i({...t,address:o.target.value})}),r.jsxs("div",{className:"flex gap-3 justify-end sm:col-span-2 mt-4",children:[r.jsxs(J,{onClick:H,className:"bg-blue-600 hover:bg-blue-700 text-white",children:[r.jsx("i",{className:"fa-solid fa-save mr-2"}),"Save"]}),r.jsxs(J,{variant:"outline",onClick:()=>n(!1),children:[r.jsx("i",{className:"fa-solid fa-times mr-2"}),"Cancel"]})]})]}):r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-y-2 text-gray-700 text-sm sm:text-base",children:[r.jsxs("p",{children:[r.jsx("strong",{children:"Shop Name:"})," ",((O=a==null?void 0:a.shopDetails)==null?void 0:O.shopName)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Contact Person:"})," ",((d=a==null?void 0:a.shopDetails)==null?void 0:d.contactPerson)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Phone Number:"})," ",((y=a==null?void 0:a.shopDetails)==null?void 0:y.phoneNumber)||"-"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"Address:"})," ",((L=a==null?void 0:a.shopDetails)==null?void 0:L.address)||"-"]})]})]}),r.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-gradient-to-r from-blue-100 to-blue-100 border-b-2 border-blue-200",children:[r.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Ref ID"}),r.jsx("div",{className:"col-span-8 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Material Name"}),r.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Quantity"}),r.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Unit"}),r.jsx("div",{className:"col-span-1 px-4 py-3 text-sm font-medium text-gray-700",children:"Action"})]}),N&&r.jsxs("div",{className:"p-8 text-center",children:[r.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-blue-600 mb-3"}),r.jsx("p",{className:"text-gray-600",children:"Loading materials..."})]}),!N&&((S=a==null?void 0:a.subItems)==null?void 0:S.map(o=>r.jsx(C,{item:o,editingCell:b,setEditingCell:p,onSave:W,onDelete:X,isDeleting:g.isPending},o._id))),r.jsx(C,{isNewRow:!0,newRowData:x,setNewRowData:I,onNewRowSave:z,isAdding:k.isPending}),!N&&((Z=a==null?void 0:a.subItems)==null?void 0:Z.length)===0&&r.jsxs("div",{className:"text-center py-12 text-gray-500",children:[r.jsx("i",{className:"fa-solid fa-inbox text-4xl mb-3 text-gray-300"}),r.jsx("p",{className:"text-sm",children:"No materials yet. Start typing in the row above to add items."})]})]})};export{Ae as P,_e as a,ke as u};
