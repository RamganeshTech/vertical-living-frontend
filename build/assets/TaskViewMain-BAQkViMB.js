import{j as e,u as ie,a as le,b as re,r as T}from"./index-4xXsHyrq.js";import{B as p}from"./Button-BmD7QJLN.js";import{I as L}from"./Input-Dg780vof.js";import{C as _,c as A,a as B,b as q,d as ne}from"./Card-CJaK8Drj.js";import{S as E,a as U,b as F,c as P,d as M}from"./Select-CmC_df5y.js";import{e as ce,f as de,h as oe,i as me,j as xe,k as ue}from"./staffTaskApi-YEwpp3qS.js";import{D as he,a as pe,b as ge,c as je,e as Ne,d as fe}from"./Dialog-Da8h3kyD.js";import{t as m}from"./toast-BSC5QTk1.js";import{a as ve,d as V,f as z}from"./dateFormator-B0AlGPNQ.js";import be from"./MaterialOverviewLoading-CX4w9Avf.js";import{L as o}from"./Label-DzCIp4JP.js";import{S as D}from"./SearchSelectNew-C7Z4-qIE.js";import{u as ye}from"./getAllUsersApi-DeJq67KM.js";import{u as Se}from"./projectApi-BQGHIg75.js";import{T as H}from"./TextArea-D9zDrWeg.js";import{B as $}from"./Badge-DAHnll1j.js";import"./roleCheck-DDX7kp9U.js";import"./useQuery-CnKlDwE3.js";import"./useMutation-DAR9sTyS.js";import"./Skeleton-CZeX8ICI.js";const we=({isOpen:d,onClose:h,task:u,mainTaskId:r,subtasks:g,role:a})=>{const{mutateAsync:y,isPending:j}=ce(),t=async(n,I,S)=>{var N,w;try{if(G(u==null?void 0:u.dependentTaskId,a))return;await y({mainTaskId:r,subTaskId:n,status:I,subTask:S}),m({description:"Updated Successfully",title:"Success"})}catch(f){m({title:"Error",description:((w=(N=f==null?void 0:f.response)==null?void 0:N.data)==null?void 0:w.message)||"Failed to update completion status",variant:"destructive"})}};return e.jsx("div",{className:"px-2 bg-white ",children:e.jsx(he,{open:d,onOpenChange:h,children:e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Manage Subtask Status"}),e.jsx(Ne,{children:"Update status of each subtask and log changes."})]}),e.jsx("div",{className:"divide-y divide-gray-200 px-5",children:g.map(n=>e.jsxs("div",{className:"py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:(n==null?void 0:n.taskName)||"-"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{onClick:()=>t(n._id,"start",n.taskName),className:"bg-blue-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-play mr-1"})," Start"]}),e.jsxs(p,{onClick:()=>t(n._id,"paused",n.taskName),className:"bg-yellow-500 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-pause mr-1"})," Pause"]}),e.jsxs(p,{onClick:()=>t(n._id,"done",n.taskName),className:"bg-green-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-check mr-1"})," Done"]})]})]},n._id))}),e.jsx(fe,{children:e.jsx(p,{onClick:h,variant:"secondary",className:"",children:"Close"})})]})})})},ke=["queued","in_progress","paused","done"],Ce=["low","medium","high"],Te=["site","procurement","design","accounts"],G=(d,h)=>{const u=h==="staff",r=d&&Array.isArray(d)&&(d==null?void 0:d.length)>0,g=d&&Array.isArray(d)&&(d==null?void 0:d.some(a=>(a==null?void 0:a.status)!=="done"));return u&&r&&g?(m({title:"Not Allowed",description:"You cannot update status until all dependent tasks are marked as done",variant:"destructive"}),!0):!1},Je=()=>{var O;const{id:d,organizationId:h}=ie(),{role:u}=le(),r=u==="staff",g=re(),{data:a,isLoading:y,refetch:j}=de(d),[t,n]=T.useState({images:[],title:"",description:"",due:"",status:"queued",department:"site",priority:"medium",assigneeId:"",assigneeName:"",projectId:"",projectName:"",dependentTaskId:void 0}),[I,S]=T.useState(!1),{mutateAsync:N}=oe(),{mutateAsync:w}=me(),{mutateAsync:f}=xe(),{mutateAsync:R,isPending:K}=ue(),{data:k}=Se(h),{data:C}=ye(h,"staff"),Y=(k||[]).map(s=>({value:s._id,label:s.projectName})),J=(C||[]).map(s=>({value:s._id,label:s.staffName,email:s.email}));T.useEffect(()=>{var s,i,l,c;a&&n({images:a.images?a.images:[],title:(a==null?void 0:a.title)||"",description:(a==null?void 0:a.description)||"",due:ve(new Date(a==null?void 0:a.due)),department:a.department,priority:a.priority,status:a.status,assigneeId:((s=a==null?void 0:a.assigneeId)==null?void 0:s._id)||"",assigneeName:((i=a==null?void 0:a.assigneeId)==null?void 0:i.staffName)||"",projectId:((l=a==null?void 0:a.projectId)==null?void 0:l._id)||"",projectName:((c=a==null?void 0:a.projectId)==null?void 0:c.projectName)||"",dependentTaskId:(a==null?void 0:a.dependentTaskId)||void 0})},[a]);const v=(s,i)=>{n(l=>({...l,[s]:i}))},Q=(s,i)=>{if(!i)return;const l=i.filter((c,x)=>x!==s);n(c=>({...c,dependentTaskId:l.length>0?l:void 0}))},W=async(s,i)=>{var c,x;n(b=>({...b,[s]:i}));let l={...t};if(l.status=i,!G(a==null?void 0:a.dependentTaskId,u))try{if(!a)return;await N({mainTaskId:a._id,updates:l}),j(),m({description:"Updated Successfully",title:"Success"})}catch(b){m({title:"Error",description:((x=(c=b==null?void 0:b.response)==null?void 0:c.data)==null?void 0:x.message)||"Failed to update task",variant:"destructive"})}},X=s=>{const i=C==null?void 0:C.find(l=>l._id===s);n(l=>({...l,assigneeId:s||"",assigneeName:(i==null?void 0:i.staffName)||""}))},Z=s=>{const i=k==null?void 0:k.find(l=>l._id===s);n(l=>({...l,projectId:s||"",projectName:(i==null?void 0:i.projectName)||""}))},ee=async()=>{var s,i;try{if(!a)return;await N({mainTaskId:a._id,updates:t}),j(),m({description:"Updated Successfully",title:"Success"})}catch(l){m({title:"Error",description:((i=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:i.message)||"Failed to update task",variant:"destructive"})}},se=async(s,i)=>{var l,c;try{if(!a)return;await w({mainTaskId:a._id,subTaskId:s,taskName:i}),m({description:"Updated Successfully",title:"Success"})}catch(x){m({title:"Error",description:((c=(l=x==null?void 0:x.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to update subtask",variant:"destructive"})}},ae=async s=>{var i,l;try{if(!a)return;await f({mainTaskId:a._id,subTaskId:s}),m({description:"Subtask deleted",title:"Success"})}catch(c){m({title:"Error",description:((l=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:l.message)||"Failed to delete subtask",variant:"destructive"})}},te=async({subtaskId:s,comment:i})=>{var l,c;try{if(!a)return;await R({mainTaskId:a._id,subTaskId:s,comment:i}),m({description:"Subtask deleted",title:"Success"})}catch(x){m({title:"Error",description:((c=(l=x==null?void 0:x.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to delete subtask",variant:"destructive"})}};return!y&&!a?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-clipboard text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Tasks Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no tasks created yet."})]}):y?e.jsx(be,{}):e.jsxs("div",{className:"p-2 overflow-y-auto max-h-full",children:[e.jsxs("section",{className:"flex items-start justify-between border-b border-gray-300 pb-3",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{onClick:()=>g(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-center w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("h1",{className:"text-xl sm:text-3xl font-bold text-blue-800",children:r?t==null?void 0:t.title:"View And Edit Task"})]}),r&&e.jsxs("div",{children:[e.jsx(o,{children:"Update Status of Task"}),e.jsxs(E,{value:t.status==="in_progress"?"In progress":t.status,onValueChange:s=>W("status",s),children:[e.jsx(U,{className:"bg-white",children:e.jsx(F,{selectedValue:t.status==="in_progress"?"In progress":t.status,placeholder:"Department"})}),e.jsx(P,{children:ke.map(s=>e.jsx(M,{value:s,children:s==="in_progress"?"In progress":s},s))})]})]})]}),(t==null?void 0:t.dependentTaskId)&&Array.isArray(t==null?void 0:t.dependentTaskId)&&t.dependentTaskId.length>0&&e.jsxs("div",{className:"!mt-3",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Dependent Tasks"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.dependentTaskId.map((s,i)=>{var l;return e.jsxs("div",{className:"p-4 relative border border-gray-200 rounded-lg bg-gray-50 shadow-sm",children:[!r&&e.jsx(p,{size:"sm",variant:"danger",className:"absolute top-[10px] !right-[10px] bg-red-600 text-white",onClick:()=>Q(i,t.dependentTaskId),children:e.jsx("i",{className:"fas fa-trash-alt"})}),e.jsxs("p",{className:"font-semibold text-gray-900 text-sm mb-1 truncate w-[95%]",children:["Title: ",s.title||"Untitled Task"]}),e.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[e.jsx("div",{className:"flex items-center gap-2 ",children:e.jsxs($,{variant:"default",className:"",children:["Assigned to: ",((l=s==null?void 0:s.assigneeId)==null?void 0:l.staffName)||"Unassigned"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx($,{variant:(s==null?void 0:s.status)==="done"?"success":(s==null?void 0:s.status)==="queued"?"secondary":(s==null?void 0:s.status)==="in_progress"||(s==null?void 0:s.status)==="paused"?"default":"secondary",className:"",children:(s==null?void 0:s.status)==="in_progress"?"In progress":s.status||"N/A"})})]}),e.jsxs("div",{className:"text-sm text-gray-700",children:["Due:"," ",e.jsx("span",{className:"font-medium text-gray-800",children:s.due?`${V(s.due)} - ${z(s.due)}`:"N/A"})]})]},s._id)})})]}),(a==null?void 0:a.images)&&a.images.length>0&&e.jsxs("section",{className:"ml-6 my-4 text-2xl text-gray-800",children:[e.jsx("h3",{className:""}),e.jsx(o,{className:"!mb-3 !text-2xl font-semibold",children:"Images"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:a.images.map((s,i)=>e.jsx("div",{className:" size-50 relative aspect-square rounded-lg overflow-hidden border border-gray-200 shadow-sm group",children:e.jsx("img",{src:(s==null?void 0:s.url)||"",alt:`Task image ${i+1}`,className:"w-full h-full object-cover transition group-hover:opacity-80"})},i))})]}),e.jsx(_,{className:"mt-4",children:e.jsxs(A,{className:"grid md:grid-cols-2 gap-4",children:[!r&&e.jsxs("div",{children:[e.jsx(o,{children:"Task Title"}),e.jsx(L,{value:t.title,onChange:s=>v("title",s.target.value),placeholder:"Task Title"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx("p",{className:"text-blue-800 font-medium",children:t!=null&&t.due?e.jsxs(e.Fragment,{children:[V(t.due)," - ",z(t.due)]}):"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx(L,{value:t.due,onChange:s=>v("due",s.target.value),type:"datetime-local"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Project"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(t==null?void 0:t.projectName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Project"}),e.jsx(D,{options:Y,placeholder:"Select project",searchPlaceholder:"Search projects...",value:(t==null?void 0:t.projectId)||void 0,onValueChange:s=>Z(s),searchBy:"name",displayFormat:"simple",className:"w-full"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Assignee"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(t==null?void 0:t.assigneeName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Assignee"}),e.jsx(D,{options:J,placeholder:"Select assignee",searchPlaceholder:"Search by name...",value:(t==null?void 0:t.assigneeId)||void 0,onValueChange:s=>X(s),searchBy:"name",displayFormat:"detailed",className:"w-full"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:t==null?void 0:t.priority})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsxs(E,{value:t==null?void 0:t.priority,onValueChange:s=>v("priority",s),children:[e.jsx(U,{className:"bg-white",children:e.jsx(F,{selectedValue:t==null?void 0:t.priority,placeholder:"Priority"})}),e.jsx(P,{children:Ce.map(s=>e.jsx(M,{value:s,children:s},s))})]})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:t==null?void 0:t.department})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsxs(E,{value:t==null?void 0:t.department,onValueChange:s=>v("department",s),children:[e.jsx(U,{className:"bg-white",children:e.jsx(F,{selectedValue:t==null?void 0:t.department,placeholder:"Department"})}),e.jsx(P,{children:Te.map(s=>e.jsx(M,{value:s,children:s},s))})]})]}),r?e.jsxs("div",{className:"md:col-span-1 ",children:[e.jsx(o,{children:"Description"}),e.jsx("p",{className:"text-blue-800",children:(t==null?void 0:t.description)||"N/A"})]}):e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(o,{children:"Description"}),e.jsx(H,{value:t==null?void 0:t.description,onChange:s=>v("description",s.target.value),placeholder:"Description"})]}),!r&&e.jsx("div",{className:"md:col-span-2 flex justify-end w-full",children:e.jsxs(p,{onClick:ee,className:"mt-2 bg-blue-600 text-white hover:bg-blue-700",children:[e.jsx("i",{className:"fa-solid fa-save mr-2"})," Save Main Task"]})})]})}),e.jsxs(_,{className:"mt-6",children:[e.jsxs(B,{children:[e.jsx(q,{children:"Subtasks"}),e.jsxs(ne,{children:[((O=a.tasks)==null?void 0:O.length)||0," subtasks"]})]}),e.jsx(A,{className:"space-y-4",children:e.jsx("ul",{className:"mt-4 space-y-4",children:a.tasks.map(s=>r?e.jsxs("div",{children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border text-blue-800 font-medium",children:["• ",s.taskName]}),e.jsxs("div",{children:[e.jsxs(o,{className:"text-sm font-medium text-gray-600",children:["Comments  "," ",e.jsxs("span",{className:"!text-[12px] font-normal",children:["(Press Ctrl + Enter to save and for new line press Enter key)",K&&e.jsxs("span",{className:"!bg-gray-100 py-[3px] !px-[5px] !ml-2 rounded-md",children:[" ",e.jsx("i",{className:"fa fa-spinner animate-spin"})," Loading "]})]})]}),e.jsx(H,{placeholder:"Enter reason if not completed...",defaultValue:(s==null?void 0:s.comments)||"",onKeyDown:async i=>{if(i.key==="Enter"&&i.ctrlKey){i.preventDefault();const l=i.target.value.trim();await te({subtaskId:s._id,comment:l})}},className:"mt-1"})]})]},s._id):e.jsxs("li",{className:"flex items-start gap-3 bg-gray-50 border border-gray-200 rounded-md p-4",children:[e.jsx("div",{className:"mt-4 h-2 w-2 border rounded-full bg-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(Ie,{subtask:s,onSave:i=>se(s._id,i),onDelete:()=>ae(s._id)}),e.jsxs("div",{className:"",children:[e.jsx("p",{className:"text-md font-medium text-blue-800",children:"Note:"}),e.jsx("p",{className:"text-gray-900 text-sm mt-1 !ml-3 whitespace-pre-wrap text-nowrap break-words",children:(s==null?void 0:s.comments)||e.jsx("span",{className:"text-gray-400 italic",children:"No comments"})})]})]})]},s._id))})})]}),e.jsx(we,{isOpen:I,onClose:()=>S(!1),mainTaskId:a._id,task:a,subtasks:a.tasks,history:a.history,role:u}),e.jsxs(_,{className:"mt-6",children:[e.jsxs(B,{className:"flex justify-between items-center",children:[e.jsx(q,{children:"Task History"}),e.jsxs(p,{onClick:()=>S(!0),className:"bg-blue-700 text-white mt-2",children:[e.jsx("i",{className:"fa fa-bolt mr-1"}),"Update Subtask Status"]})]}),e.jsx(A,{className:"space-y-3 text-sm text-gray-700",children:a.history.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-history text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No History Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no changes made"})]}):a.history.map((s,i)=>{const l={queued:"bg-gray-200 text-gray-800",in_progress:"bg-blue-100 text-blue-800",paused:"bg-yellow-100 text-yellow-800",done:"bg-green-100 text-green-800",start:"bg-purple-100 text-purple-800"};return e.jsxs("div",{className:"border-l-4 border-blue-200 pl-4 py-3 bg-gray-50 rounded-md shadow-sm",children:[e.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-semibold ${l[s.status]||"bg-gray-100 text-gray-700"}`,children:s.status.replace("_"," ").toUpperCase()}),s.subTask&&e.jsx("span",{className:"text-sm text-blue-600 font-medium italic",children:s.subTask})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500 pl-1",children:["Changed on: ",V(new Date(s==null?void 0:s.changedAt).toLocaleString())," - ",new Date(s==null?void 0:s.changedAt).toLocaleString().slice(11)]})]},i)})})]})]})},Ie=({subtask:d,onSave:h,onDelete:u})=>{const[r,g]=T.useState(d.taskName);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{value:r,onChange:a=>g(a.target.value),className:"flex-1"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{onClick:()=>h(r),className:"bg-green-600 text-white hover:bg-green-700",children:[e.jsx("i",{className:"fa-solid fa-check mr-1"})," Save"]}),e.jsxs(p,{onClick:u,className:"bg-red-600 text-white hover:bg-red-700",children:[e.jsx("i",{className:"fa-solid fa-trash mr-1"})," Delete"]})]})]})};export{Je as TaskViewMain,Je as default,G as isBlockedByDependencies};
