import{a as Z,b as ee,r as a,j as e}from"./index-By5P0A7l.js";import{B as v}from"./Button-DLUK8O0t.js";import{L as i}from"./Label-TAdUzpu-.js";import{S as m}from"./SearchSelectNew-B6SBCGTt.js";import{u as se}from"./projectApi-_duyp5-I.js";import{t as c}from"./toast-BSC5QTk1.js";import{b as te,c as ae,d as re,u as oe,e as le,f as ne}from"./toolOtpApi-Cj-5bnMm.js";import{u as ie}from"./getAllUsersApi-CvFDPW6g.js";import{B as de}from"./Breadcrumb-CBhb_ayJ.js";import"./useQuery-Cc7pLKfK.js";import"./useMutation-7YLqc7VE.js";import"./roleCheck-YGaMnK_P.js";import"./useInfiniteQuery-DQF0m-E9.js";const Te=()=>{var O,D,$,B;const{organizationId:r}=Z(),F=ee(),[t,w]=a.useState("issue"),[l,g]=a.useState(null),[h,G]=a.useState(null),[d,T]=a.useState(null),[u,S]=a.useState(null),[I,L]=a.useState(new Date(Date.now()+864e5).toISOString().split("T")[0]),[b,M]=a.useState("good"),[R,_]=a.useState(""),[f,U]=a.useState([]),[x,p]=a.useState({issue:null,return:null}),[n,k]=a.useState(0),P=te(),C=ae();a.useEffect(()=>{let s;return n>0&&(s=setInterval(()=>k(o=>o-1),1e3)),()=>clearInterval(s)},[n]);const E=()=>k(180),{data:j=[]}=re(r),{data:W=[]}=oe(r),y=le(),N=ne(),{data:z=[]}=ie(r,"worker"),{data:V=[]}=se(r),H=j.filter(s=>t==="issue"?s.availabilityStatus==="available":s.availabilityStatus==="issued").map(s=>({value:s._id,label:`${s.toolName} â€” ${s.toolCode}`,subLabel:s.brand})),q=W.map(s=>({value:s._id,label:`${s.toolRoomName}`})),J=s=>{const o=j.find(Y=>Y._id===s);g(s),t==="return"&&o&&(T(o.currentWorkerId||null),S(o.currentProjectId||null))},K=s=>{G(s)},Q=[{label:"Tools & Hardware",path:`/organizations/${r}/projects/toolhub`},{label:"Handover Hub",path:`/organizations/${r}/projects/issueotp`}],X=async()=>{try{if(t==="issue"){const s=x.issue;if(!s||!s.tempTransactionId)return;const o=await P.mutateAsync({transactionId:s.tempTransactionId,organizationId:r});p(()=>({return:null,issue:{tempTransactionId:o._id,showButton:!0}}))}else await C.mutateAsync({toolId:l,organizationId:r,toolWorkerId:d}),p(()=>({issue:null,return:{showButton:!0}}));E(),c({title:"OTP Resent",description:"A fresh security code has been dispatched."})}catch(s){c({title:"Resend Failed",description:s.message,variant:"destructive"})}},A=async()=>{if(!l)return c({title:"Error",description:"Select a tool",variant:"destructive"});try{if(t==="issue"){if(!d||!u)return c({title:"Error",description:"Select a Worker and the Project",variant:"destructive"});const s=await y.mutateAsync({toolId:l,toolWorkerId:d,projectId:u,organizationId:r,expectedReturnDate:I});p(()=>({return:null,issue:{tempTransactionId:s._id,showButton:!0}}))}else{const s=new FormData;s.append("toolId",l),s.append("organizationId",r),s.append("returnCondition",b),s.append("damageNotes",R),u&&s.append("projectId",u),h&&s.append("toolRoomId",h),d&&s.append("toolWorkerId",d),f.forEach(o=>s.append("photos",o)),await N.mutateAsync(s),p(()=>({issue:null,return:{showButton:!0}}))}E(),c({title:"Success",description:"OTP generated successfully."})}catch(s){c({title:"Action Failed",description:s.message,variant:"destructive"})}};return e.jsxs("div",{className:"flex flex-col h-full w-full bg-gray-50/50",children:[e.jsxs("header",{className:"w-full bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between sticky top-0 z-10",children:[e.jsx("div",{className:"flex items-center gap-6",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx("span",{className:`w-3 h-3 rounded-full animate-pulse ${t==="issue"?"bg-blue-500":"bg-orange-500"}`}),"Tool Management Protocol"]}),e.jsx(de,{paths:Q})]})}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-4 bg-gray-100 p-1.5 rounded-2xl border border-gray-200",children:[e.jsxs("button",{onClick:()=>{w("issue"),g(null)},className:`px-8 py-2.5 cursor-pointer  rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${t==="issue"?"bg-blue-600 text-white shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"fas fa-sign-out-alt"})," ISSUE ASSET"]}),e.jsxs("button",{onClick:()=>{w("return"),g(null)},className:`px-8 py-2.5 cursor-pointer  rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${t==="return"?"bg-orange-600 text-white shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"fas fa-sign-in-alt"})," COLLECT RETURN"]})]}),e.jsx("div",{className:"h-8 w-[1px] bg-gray-200 mx-2"}),e.jsx("div",{className:"flex items-center gap-4 bg-gray-100 p-1.5 rounded-2xl border border-gray-200",children:e.jsxs("button",{onClick:()=>F("../enterotp"),className:`px-8 cursor-pointer  py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 \r
                   text-gray-500 hover:text-gray-700 hover:bg-white`,children:[e.jsx("i",{className:"fas fa-key text-blue-500"}),"TOOL HANDOVER",e.jsx("i",{className:"fas fa-external-link-alt text-[10px] opacity-50"})]})})]})]}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-8 grid grid-cols-12 gap-8",children:[e.jsx("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-200 p-8 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 mb-6 flex items-center gap-2",children:[e.jsx("i",{className:`fas fa-search ${t==="issue"?"text-blue-500":"text-orange-500"}`})," Tool Identification"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Search Tool"}),e.jsx(m,{options:H,placeholder:"Enter Tool ID or Name...",value:l||"",onValueChange:J,displayFormat:"detailed",className:"w-full"})]}),l&&e.jsxs("div",{className:`p-5 rounded-2xl border-2 border-dashed ${t==="issue"?"bg-blue-50/50 border-blue-100":"bg-orange-50/50 border-orange-100"}`,children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase mb-2",children:"Selected Asset Status"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-bold text-gray-900",children:(O=j.find(s=>s._id===l))==null?void 0:O.toolName}),e.jsx("span",{className:`px-3 py-1 rounded-full text-[10px] font-bold uppercase ${t==="issue"?"bg-blue-100 text-blue-700":"bg-orange-100 text-orange-700"}`,children:t==="issue"?"Ready to Issue":"Awaiting Return"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-200 p-8 shadow-sm grid grid-cols-2 gap-8",children:[e.jsx("div",{className:"col-span-2",children:e.jsxs("h3",{className:"text-lg font-bold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:`fas fa-users ${t==="issue"?"text-blue-500":"text-orange-500"}`})," Operational Context"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Tool Taker"}),e.jsx(m,{options:z.map(s=>({value:s._id,label:s.workerName,subLabel:s.phone})),placeholder:"Choose field worker...",value:d||"",onValueChange:T})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Project"}),e.jsx(m,{options:V.map(s=>({value:s._id,label:s.projectName})),placeholder:"Select Project...",value:u||"",onValueChange:S})]}),t==="return"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Search Room"}),e.jsx(m,{options:q,placeholder:"Enter Tool Room Name...",value:h||"",onValueChange:K,displayFormat:"detailed",className:"w-full"})]})]}),e.jsxs("div",{className:`bg-white rounded-3xl border-2 p-8 transition-all ${t==="issue"?"border-blue-50 bg-blue-50/10":"border-orange-50 bg-orange-50/10"}`,children:[t==="issue"?e.jsx("div",{className:"flex items-center justify-between",children:!((D=x.issue)!=null&&D.showButton)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 w-1/3",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Target Return Date"}),e.jsx("input",{type:"date",value:I,onChange:s=>L(s.target.value),className:"w-full p-3 bg-white border border-gray-200 rounded-xl font-bold shadow-sm"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4 max-w-xs",children:"A security code will be dispatched to the worker's device immediately."}),e.jsx(v,{onClick:A,disabled:y.isPending,className:"px-12 py-7 bg-blue-600 hover:bg-blue-700 text-white text-lg rounded-2xl shadow-xl shadow-blue-200 transition-all transform hover:-translate-y-1",children:y.isPending?e.jsx("i",{className:"fas fa-spinner fa-spin"}):"GENERATE ISSUE OTP"})]})]})}):e.jsx("div",{className:"space-y-8",children:!(($=x.return)!=null&&$.showButton)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-12",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Condition Assessment"}),e.jsxs("select",{value:b,onChange:s=>M(s.target.value),className:"w-full p-4 border border-gray-200 rounded-2xl bg-white font-bold text-gray-700 shadow-sm focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"good",children:"Good"}),e.jsx("option",{value:"damaged",children:"Damaged"})]}),b==="damaged"&&e.jsx("textarea",{placeholder:"Describe physical damages in detail...",value:R,onChange:s=>_(s.target.value),className:"w-full p-4 border border-red-100 rounded-2xl h-24 text-sm bg-red-50/30"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Physical Evidence"}),e.jsxs("div",{className:"h-40 border-2 border-dashed border-gray-200 rounded-3xl flex flex-col items-center justify-center bg-gray-50 hover:bg-orange-50 transition-colors relative cursor-pointer group",children:[e.jsx("input",{type:"file",multiple:!0,className:"absolute inset-0 opacity-0 cursor-pointer",onChange:s=>U(Array.from(s.target.files||[]))}),e.jsx("i",{className:"fas fa-camera text-3xl text-gray-300 group-hover:text-orange-500 transition-colors"}),e.jsx("p",{className:"text-xs font-bold text-gray-500 mt-3",children:f.length>0?`${f.length} Photos Added`:"Upload Site Photos"})]})]})]}),e.jsx("div",{className:"flex justify-end pt-6 border-t border-gray-100",children:e.jsx(v,{onClick:A,disabled:N.isPending,className:"px-12 py-7 bg-orange-600 hover:bg-orange-700 text-white text-lg rounded-2xl shadow-xl shadow-orange-200 transition-all transform hover:-translate-y-1",children:N.isPending?e.jsx("i",{className:"fas fa-spinner fa-spin"}):"GENERATE RETURN OTP"})})]})}),e.jsx("div",{className:"flex items-center justify-end gap-4 border-t border-gray-100 pt-6",children:((B=x[t])==null?void 0:B.showButton)&&e.jsxs(v,{onClick:X,disabled:n>0||P.isPending||C.isPending,className:"px-6 py-7 border-2 border-gray-200  text-gray-600 font-bold rounded-2xl transition-all",children:[e.jsx("i",{className:`fas fa-sync-alt mr-2 ${n>0?"":"fa-spin"}`}),n>0?`Resend in ${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`:"Resend OTP"]})})]})]})]})]})};export{Te as default};
