import{u as ge,a as be,d as ye,k as fe,r as x,e as je,n as we,o as ve,p as Ne,q as ke,j as e,M as Ce,O as Se,B as h,t as N}from"./index-BAM0eJUz.js";import{I}from"./Input-1UBXZqEj.js";import{S as G,a as H,b as J,c as Q,d as W}from"./Select-C6lfB9t-.js";import{materialTypeOptions as Le}from"./RateConfigSub-DPkKtDX1.js";function Me(){var _,B,K;const{organizationId:z,id:w}=ge(),O=be(),X=ye(),{role:E,permission:m}=fe(),V=E==="owner"||((_=m==null?void 0:m.presalesmaterialrateconfig)==null?void 0:_.create),Y=E==="owner"||((B=m==null?void 0:m.presalesmaterialrateconfig)==null?void 0:B.delete),P=E==="owner"||((K=m==null?void 0:m.presalesmaterialrateconfig)==null?void 0:K.edit),[D,F]=x.useState(null),{data:k}=je(z),{data:R,isLoading:Z,refetch:q}=we(w),{mutateAsync:ee,isPending:se}=ve(),{mutateAsync:te,isPending:ae}=Ne(),{mutateAsync:re,isPending:ne}=ke(),[b,C]=x.useState([{data:{}}]),[ce,A]=x.useState(null),[g,S]=x.useState({}),[L,le]=x.useState(""),[y,oe]=x.useState("All"),[v,$]=x.useState(""),c=k==null?void 0:k.find(s=>s._id===w),f=x.useMemo(()=>c!=null&&c.fields?[...((c==null?void 0:c.fields)||[]).filter(r=>{const a=r.visibleIn,t=a==null?void 0:a.includes("presales"),n=!a||!Array.isArray(a)||a.length===0;return t||n})].sort((r,a)=>{var l,o;const t=(l=r.key)==null?void 0:l.toLowerCase(),n=(o=a.key)==null?void 0:o.toLowerCase();return t==="image"?-1:n==="image"?1:0}):[],[c]),M=x.useMemo(()=>(c==null?void 0:c.isProductSpecific)||!1,[c]),T=x.useMemo(()=>{if(!R)return[];let s=[...R];if(M&&y!=="all"&&(s=s.filter(a=>{var t;return((t=a.materialType)==null?void 0:t.toLowerCase())===y.toLowerCase()})),!L.trim())return s;const r=v;return s.filter(a=>{var n;return(((n=a.data[r])==null?void 0:n.toString().toLowerCase())||"").includes(L.toLowerCase())})},[R,L,v,y,M]);if(x.useEffect(()=>{var s,r;(r=(s=c==null?void 0:c.fields)==null?void 0:s[0])!=null&&r.key&&$(c.fields[0].key)},[c]),Z||!k)return e.jsx(Ce,{});if(!c)return e.jsx("p",{children:"Category not found"});const ie=s=>{A(s._id),S({...s.data})},de=()=>{A(null),S({})},xe=(s,r,a)=>{var i,p;const t=[...b];t[s].data[r]=a;const n=(p=(i=c.fields)==null?void 0:i[0])==null?void 0:p.key,l=s===t.length-1,o=r===n,d=(a==null?void 0:a.toString().trim())!=="",j=t.length>0&&Object.values(t[t.length-1].data).every(u=>u===void 0||u==="");if(l&&o&&d&&!j&&t.push({data:{}}),!d&&o&&b.length>1){const u=t[t.length-1];Object.values(u.data).every(U=>U===void 0||U==="")&&t.pop()}C(t)},me=()=>C([...b,{data:{}}]),ue=s=>{const r=[...b];r.splice(s,1),C(r)},pe=async()=>{var s,r,a,t;try{const n=(r=(s=c.fields)==null?void 0:s[0])==null?void 0:r.key,l=c.fields.find(i=>i.type==="file"),o=b.map(i=>i.data).filter(i=>{const p=i[n];return p!=null&&p.toString().trim()!==""});if(o.length===0)return N({title:"Error",description:"Nothing to save",variant:"destructive"});const d=new FormData,j=o.map((i,p)=>{const u={...i};return l&&u[l.key]instanceof File&&(d.append(`file-${p}`,u[l.key]),delete u[l.key]),u});d.append("items",JSON.stringify(j)),d.append("materialType",y),await ee({categoryId:w,items:d,organizationId:z}),N({title:"Success",description:"Items created successfully"}),C([{data:{}}]),q()}catch(n){N({title:"Error",description:((t=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:t.message)||(n==null?void 0:n.message)||"Operation failed",variant:"destructive"})}},he=async s=>{var r,a;try{const t=new FormData,n=c.fields.find(l=>l.type==="file");Object.keys(g).forEach(l=>{const o=g[l];n&&l===n.key&&o instanceof File?t.append("file",o):t.append(l,o)}),await re({itemId:s,body:t,categoryId:w}),N({title:"Success",description:"Item updated successfully"}),A(null),q()}catch(t){N({title:"Error",description:((a=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:a.message)??"Update failed",variant:"destructive"})}};return X.pathname.includes("description")?e.jsx(Se,{}):e.jsxs("div",{className:"space-y-4 max-h-full overflow-y-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center sticky top-0 bg-white z-10 py-4 border-b",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{onClick:()=>O(-1),className:"bg-slate-50 hover:bg-slate-300 flex items-center justify-between w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:c.name}),M&&e.jsx("div",{className:"w-full sm:w-56",children:e.jsxs(G,{value:y,onValueChange:oe,children:[e.jsx(H,{className:"h-10 border-amber-100 bg-white rounded-xl focus:ring-amber-400 px-0 overflow-hidden shadow-sm",children:e.jsxs("div",{className:"flex items-center h-full w-full",children:[e.jsx("div",{className:"bg-amber-50 h-full px-3 flex items-center border-r border-amber-100 shrink-0",children:e.jsx("span",{className:"text-[9px] font-black text-amber-600 uppercase tracking-tighter",children:"Material Type"})}),e.jsx("div",{className:"px-3 truncate text-[13px] font-bold text-slate-700",children:e.jsx(J,{placeholder:"Select Type",selectedValue:y})})]})}),e.jsx(Q,{className:"rounded-xl border-amber-100 p-1 shadow-2xl",children:Le.map(s=>{const r=s.length<=5?s.toUpperCase():s.charAt(0).toUpperCase()+s.slice(1).toLowerCase();return e.jsx(W,{value:s,className:"text-[12px] font-semibold py-2.5 px-3 cursor-pointer rounded-lg hover:bg-amber-50 focus:bg-amber-50 transition-all border-b border-slate-50 last:border-0",children:r},s)})})]})})]}),e.jsxs("div",{className:"flex gap-2 mt-3 sm:mt-0",children:[e.jsx("div",{className:"w-full sm:w-56",children:e.jsxs(G,{value:v,onValueChange:s=>$(s),children:[e.jsx(H,{className:"h-10 border-blue-100 bg-white rounded-xl focus:ring-blue-400 px-0 overflow-hidden",children:e.jsxs("div",{className:"flex items-center h-full w-full",children:[e.jsx("div",{className:"bg-blue-50 h-full px-3 flex items-center border-r border-blue-100 shrink-0",children:e.jsx("span",{className:"text-[9px] font-black text-blue-500 uppercase tracking-tighter",children:"Search By"})}),e.jsx("div",{className:"px-3 truncate text-[13px] font-bold text-slate-700",children:e.jsx(J,{placeholder:"Field",selectedValue:v})})]})}),e.jsx(Q,{className:"rounded-xl border-blue-100 p-1 shadow-2xl",children:f.map(s=>e.jsx(W,{value:s.key,className:"text-[12px] font-semibold py-2.5 px-3 cursor-pointer rounded-lg hover:bg-blue-50 focus:bg-blue-50 transition-all border-b border-slate-50 last:border-0",children:s.key==="manufacturCostPerSqft"?"MFG Cost / Sqft":s.key},s.key))})]})}),e.jsxs("div",{className:"relative w-full sm:w-64",children:[e.jsx(I,{placeholder:`Search ${v}...`,value:L,onChange:s=>le(s.target.value),className:"pl-9 h-10 border-blue-100 focus:border-blue-400 rounded-xl text-[11px]"}),e.jsx("i",{className:"fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"})]}),(P||V)&&e.jsx(h,{onClick:me,variant:"primary",className:"",children:"+ Add Row"}),(P||V)&&e.jsxs(h,{onClick:pe,isLoading:se,className:"bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx("i",{className:"fas fa-file mr-2"})," Save Items"]}),e.jsxs(h,{onClick:()=>O("description"),className:"bg-indigo-600 hover:bg-indigo-700 text-white h-10 rounded-xl text-[11px] font-bold shadow-sm px-4 shrink-0",children:[e.jsx("i",{className:"fas fa-file-alt mr-2"})," Scope"]})]})]}),e.jsx("div",{className:"overflow-x-auto min-h-[450px]",children:e.jsxs("table",{className:"min-w-full bg-white text-sm",children:[e.jsx("thead",{className:"bg-blue-50 text-sm font-semibold text-gray-600 px-6 py-1 sm:py-3",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-center w-[50px] px-2 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"S.NO"}),f.map(s=>{var t,n;const r=(s==null?void 0:s.key)==="manufacturCostPerSqft",a=((t=s==null?void 0:s.key)==null?void 0:t.toLowerCase().includes("description"))||((n=s==null?void 0:s.key)==null?void 0:n.toLowerCase().includes("notes"));return e.jsx("th",{className:`text-center px-2 py-3 text-xs font-medium text-gray-500 tracking-wider ${a?"min-w-[200px]":"min-w-[70px] max-w-[80px]"}`,children:r?"Mfg Cost / Sqft":s.key},s.key)}),e.jsx("th",{className:"text-center px-6 py-1 sm:py-3  text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsxs("tbody",{children:[T==null?void 0:T.map((s,r)=>{const a=ce===s._id;return e.jsxs("tr",{className:`group border-b border-gray-100 transition-all duration-200 ${a?"bg-blue-50/50":"hover:bg-gray-50"}`,children:[e.jsx("td",{className:" w-[50px] p-2 font-medium text-center text-sm text-gray-700",children:r+1}),f==null?void 0:f.map(t=>{var l,o;const n=((l=t==null?void 0:t.key)==null?void 0:l.toLowerCase().includes("description"))||((o=t==null?void 0:t.key)==null?void 0:o.toLowerCase().includes("notes"));return e.jsx("td",{className:`p-1 border border-gray-100 text-center ${n?"min-w-[10px] !max-w-[100px]":"min-w-[80px] max-w-[100px]"}`,children:a?t.type==="file"?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx(I,{type:"file",accept:"image/*",className:"w-full h-9 text-[10px] px-1",onChange:d=>{var i;const j=(i=d.target.files)==null?void 0:i[0];j&&S({...g,[t.key]:j})}}),typeof g[t.key]=="string"&&e.jsxs("span",{className:"text-[9px] text-blue-600 truncate max-w-[100px]",children:["Current: ",g[t.key].split("/").pop()]})]}):e.jsx(I,{type:t.type==="number"?"number":"text",value:g[t.key]||"",onChange:d=>S({...g,[t.key]:t.type==="number"?Math.max(0,Number(d.target.value)):d.target.value}),className:"w-full h-10 text-sm"}):t.type==="file"?s!=null&&s.data[t.key]?e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:s==null?void 0:s.data[t==null?void 0:t.key],alt:t==null?void 0:t.key,onClick:()=>F(s==null?void 0:s.data[t==null?void 0:t.key]),className:"w-20 h-20 rounded-md object-cover border-2 border-blue-100 cursor-pointer hover:scale-110 transition-transform shadow-sm",title:"Click to preview"})}):e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"w-20 h-20 rounded-md bg-slate-50 flex items-center justify-center border border-dashed border-slate-200",children:e.jsx("i",{className:"fas fa-image text-slate-300 text-[10px]"})})}):e.jsx("span",{className:"text-sm text-gray-700",children:(s==null?void 0:s.data[t==null?void 0:t.key])||"—"})},t==null?void 0:t.key)}),e.jsx("td",{className:"text-center p-4 border border-gray-100",children:e.jsx("div",{className:"flex justify-center gap-2",children:a?e.jsxs(e.Fragment,{children:[e.jsx(h,{size:"sm",variant:"primary",className:"text-white !w-4 h-7",onClick:()=>he(s._id),isLoading:ne,children:e.jsx("i",{className:"fas fa-check"})}),e.jsx(h,{size:"sm",variant:"secondary",className:"!w-4 h-7",onClick:de,children:e.jsx("i",{className:"fas fa-x"})})]}):e.jsxs(e.Fragment,{children:[P&&e.jsx(h,{size:"sm",variant:"ghost",className:"text-blue-600 hover:bg-blue-50 h-8",onClick:()=>ie(s),children:e.jsx("i",{className:"fas fa-pen-to-square"})}),Y&&e.jsx(h,{size:"sm",variant:"danger",isLoading:ae,className:"bg-red-600 text-white h-8",onClick:()=>te({itemId:s==null?void 0:s._id,categoryId:w}),children:e.jsx("i",{className:"fas fa-trash"})})]})})})]},`existing-${s==null?void 0:s._id}`)}),b.map((s,r)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-all duration-200",children:[e.jsx("td",{className:"p-4 text-center text-gray-400",children:"—"}),f.map(a=>e.jsx("td",{className:"p-2 border border-gray-100",children:e.jsx(I,{type:a.type==="number"?"number":"text",placeholder:a.key,className:"w-full h-8 text-xs",value:s.data[a.key]||"",onChange:t=>xe(r,a.key,a.type==="number"?Math.max(0,Number(t.target.value)):t.target.value)})},a.key)),e.jsx("td",{className:"text-center p-4",children:e.jsxs(h,{size:"sm",variant:"ghost",className:"group text-white bg-red-600 hover:bg-red-600",onClick:()=>ue(r),children:[e.jsx("i",{className:"fas fa-xmark mr-2"})," Remove"]})})]},`new-${r}`))]})]})}),D&&e.jsxs("section",{className:"fixed inset-0 z-[999] flex items-center justify-center p-0 animate-in fade-in duration-200",children:[e.jsx("div",{className:"absolute inset-0 bg-black/90 cursor-zoom-out",onClick:()=>F(null)}),e.jsxs("div",{className:"relative z-[1000] flex flex-col items-center",children:[e.jsx("button",{onClick:()=>F(null),className:"absolute -top-10 right-0 text-white/70 hover:text-white transition-colors p-2",children:e.jsx("i",{className:"fas fa-times text-2xl"})}),e.jsx("img",{src:D,alt:"Preview",className:"max-w-screen max-h-screen object-contain pointer-events-auto",onClick:s=>s.stopPropagation()})]})]})]})}export{Me as default};
