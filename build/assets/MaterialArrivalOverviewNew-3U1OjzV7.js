import{r as C,j as e,I as _,B as $,t as g,b as U,u as R,p as z,a as B,M as W}from"./index-MXS_gbde.js";import{C as J}from"./Card-L4jLwmC3.js";import{A as H,S as Y}from"./AssignStaff-BvCba0Ct.js";import{R as q}from"./ResetStageButton-C8k6xykj.js";import{S as K}from"./ShareDocumentWhatsapp-BD-efZD6.js";import{u as X,a as Z,b as G,c as ee,d as se,e as ae,f as te}from"./materialArrivalNewApi-kLbNMi_L.js";import{d as ie}from"./dateFormator-BGKi5rfZ.js";import{u as le}from"./useDebounce-D0G-FEVR.js";import{S as re}from"./StageGuide-DLy2p25i.js";import"./getAllUsersApi-Gbc98a74.js";import"./documentationApi-cFQEq_vS.js";import"./requirementFormApi-R6rJrFKn.js";const ne=({enableCreate:s,projectId:N,context:o,label:b,generateLink:h,isPending:a,data:c})=>{const[l,p]=C.useState(""),[x,f]=C.useState(!1);C.useEffect(()=>{typeof c=="string"&&p(c)},[c]);const v=async()=>{try{await navigator.clipboard.writeText(l),f(!0),setTimeout(()=>f(!1),1500)}catch{g({title:"Error",description:"Failed to copy link",variant:"destructive"})}},P=()=>{const r=encodeURIComponent(`Hey, please check this ${o} link:\`${l}`);window.open(`https://wa.me/?text=${r}`,"_blank")},I=async()=>{var r,j;try{const t=await h({projectId:N});t!=null&&t.shareableUrl&&(p(t.shareableUrl),g({title:"Link generated",description:"You can now share the link",variant:"default"}))}catch(t){g({title:"Error",description:((j=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:j.message)||(t==null?void 0:t.message)||"Failed to generate link",variant:"destructive"})}};return e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm w-full max-w-xl",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsxs("h3",{className:"text-lg font-semibold text-blue-800 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-link"})," ",b||"Generate Shareable Link"]})}),l?e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-center",children:[e.jsx(_,{readOnly:!0,value:l,className:"flex-1 text-sm cursor-default"}),e.jsxs($,{onClick:v,variant:"outline",className:"flex gap-2",children:[e.jsx("i",{className:`fas ${x?"fa-check-circle":"fa-copy"}`}),x?"Copied":"Copy"]}),e.jsxs($,{onClick:P,className:"bg-green-500 hover:bg-green-600 text-white flex gap-2",children:[e.jsx("i",{className:"fab fa-whatsapp"}),"Share"]})]}):e.jsx(e.Fragment,{children:s&&e.jsx($,{onClick:I,disabled:a,className:"bg-blue-600 hover:bg-blue-700 text-white",children:a?"Generating...":"Generate Link"})})]})},ce=({orderGroup:s,projectId:N})=>{var l,p;const[o,b]=C.useState(!0),h=((l=s.subItems)==null?void 0:l.length)||0,a=((p=s.subItems)==null?void 0:p.filter(x=>x.isVerified).length)||0,c=h>0&&h===a;return e.jsxs("div",{className:`border border-gray-200 rounded-xl bg-white shadow-sm mb-6 transition-all duration-200 overflow-hidden ${o?"ring-1 ring-gray-200":""}`,children:[e.jsxs("div",{onClick:()=>b(!o),className:"flex items-center justify-between p-5 cursor-pointer bg-white hover:bg-gray-50 transition-colors border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center text-lg shadow-sm border ${c?"bg-green-50 border-green-200 text-green-600":"bg-blue-50 border-blue-200 text-blue-600"}`,children:e.jsx("i",{className:`fa-solid ${c?"fa-clipboard-check":"fa-clipboard-list"}`})}),e.jsxs("div",{className:"flex flex-col",children:[(s==null?void 0:s.materialArrivalDeptNumber)&&e.jsx("h4",{className:"font-bold text-gray-900 text-base sm:text-lg tracking-tight leading-none",children:s.materialArrivalDeptNumber}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-400 font-medium",children:"Order Material (Order Id):"}),e.jsx("span",{className:"text-xs font-mono font-semibold text-gray-600 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100",children:s.orderMaterialDeptNumber||"Unknown"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2.5",children:[e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-gray-100 border border-gray-200 text-[10px] font-bold text-gray-600 uppercase tracking-wide",children:[e.jsx("i",{className:"fa-solid fa-layer-group text-gray-400"}),h," Items"]}),e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md border text-[10px] font-bold uppercase tracking-wide ${c?"bg-green-50 border-green-200 text-green-700":"bg-orange-50 border-orange-200 text-orange-700"}`,children:[e.jsx("i",{className:`fa-solid ${c?"fa-circle-check":"fa-clock"}`}),c?"All Verified":`${a}/${h} Verified`]})]})]})]}),e.jsx("div",{className:"text-gray-400",children:e.jsx("i",{className:`fa-solid fa-chevron-down transition-transform duration-300 ${o?"rotate-180":""}`})})]}),o&&e.jsx("div",{className:"bg-white w-full overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto w-full",children:e.jsxs("table",{className:"w-full text-left border-collapse min-w-[800px]",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-[50px] text-center",children:"#"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider min-w-[200px]",children:"Material Name"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center min-w-[120px]",children:"Ordered"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center min-w-[120px]",children:"Unit"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center min-w-[120px]",children:"Arrived"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center min-w-[150px]",children:"Image"}),e.jsx("th",{className:"px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-center min-w-[140px]",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:s==null?void 0:s.subItems.map((x,f)=>e.jsx(de,{item:x,idx:f,projectId:N,orderNumber:s.orderMaterialDeptNumber},x._id||f))})]})})})]})},de=({item:s,idx:N,projectId:o,orderNumber:b})=>{var F,n;const{mutateAsync:h,isPending:a}=X(),{mutateAsync:c}=Z(),{mutateAsync:l,isPending:p}=G(),[x,f]=C.useState(!1),[v,P]=C.useState((s==null?void 0:s.arrivedQuantity)||0),{role:I,permission:r}=U(),j=I==="owner"||((F=r==null?void 0:r.materialarrival)==null?void 0:F.create),t=I==="owner"||((n=r==null?void 0:r.materialarrival)==null?void 0:n.edit),d=s.images&&s.images.length>0?s.images[s.images.length-1]:null,V=async()=>{try{await h({projectId:o,orderNumber:b,subItemId:s._id,toggle:!s.isVerified}),g({title:"Success",description:"Status updated"})}catch(i){g({title:"Error",description:(i==null?void 0:i.message)||"Failed",variant:"destructive"})}},S=le(v,500);C.useEffect(()=>{if(S===s.arrivedQuantity)return;(async()=>{try{await c({projectId:o,orderNumber:b,subItemId:s._id,arrivedQuantity:S}),g({title:"Success",description:"Quantity updated"})}catch(y){g({title:"Error",description:(y==null?void 0:y.message)||"Failed",variant:"destructive"})}})()},[S]);const m=async i=>{var y,w,M,Q;try{const u=(w=(y=i.target)==null?void 0:y.files)==null?void 0:w[0];if(!u)return;if(!u.type.startsWith("image/")){g({title:"Invalid file",description:"Only JPEG, PNG, JPG images are allowed",variant:"destructive"});return}const E=new FormData;E.append("upload",u),await l({projectId:o,orderNumber:b,subItemId:s._id,formData:E}),g({description:"Successfully uploaded images",title:"Success"})}catch(u){g({title:"Error",description:((Q=(M=u==null?void 0:u.response)==null?void 0:M.data)==null?void 0:Q.message)||u.message||"Failed to upload images",variant:"destructive"})}};return e.jsxs("tr",{className:`group transition-colors align-middle ${s.isVerified?"bg-green-50/40":"hover:bg-gray-50"}`,children:[e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"text-gray-400 font-mono text-sm",children:N+1})}),e.jsx("td",{className:"px-6 py-4 align-middle",children:e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsx("span",{className:"font-semibold text-gray-800 text-sm md:text-base leading-tight",children:s.subItemName}),s.refId&&e.jsxs("span",{className:"text-[11px] text-gray-400 mt-1 font-mono",children:["ID: ",s.refId]})]})}),e.jsx("td",{className:"px-6 py-4 text-center align-middle",children:e.jsx("div",{className:"inline-flex flex-col items-center justify-center bg-gray-100 rounded px-3 py-1.5 min-w-[70px]",children:e.jsx("span",{className:"font-bold text-gray-700 text-sm",children:s.orderedQuantity})})}),e.jsx("td",{className:"px-6 py-4 text-center align-middle",children:e.jsx("div",{className:"inline-flex flex-col items-center justify-center bg-gray-100 rounded px-3 py-1.5 min-w-[70px]",children:e.jsx("span",{className:"text-[10px] uppercase text-gray-500 font-medium",children:s.unit})})}),e.jsx("td",{className:"px-6 py-4 text-center align-middle",children:e.jsxs("div",{className:`
            flex flex-col items-center justify-center rounded px-3 py-1.5 !border-black 
            ${v<s.orderedQuantity?"bg-orange-50 border-orange-200":"bg-green-50 border-green-200"}
        `,children:[e.jsx("input",{type:"number",value:v,disabled:!j&&!t,onChange:i=>P(Number(i.target.value)),className:`
                            disabled:cursor-not-allowed
                w-full text-center font-semibold text-sm rounded-md 
                bg-white outline-none border px-2 py-1 transition
                ${v<s.orderedQuantity?"text-orange-600 border-orange-300":"text-green-600 border-green-300"}
                focus:ring-2 focus:ring-blue-400
            `}),e.jsx("span",{className:"text-[10px] uppercase text-gray-400 mt-1 font-medium",children:"Arrived"})]})}),e.jsx("td",{className:"px-6 py-4 text-center align-middle",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{onClick:()=>f(!0),className:"relative h-20 w-28 mx-auto rounded-lg border border-gray-200 overflow-hidden cursor-pointer shadow-sm hover:shadow-md hover:ring-2 hover:ring-blue-400 transition-all bg-white group-hover:scale-105 duration-200",children:[e.jsx("img",{src:d.url,alt:"Proof",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 hover:bg-black/10 transition-colors flex items-center justify-center",children:e.jsx("i",{className:"fa-solid fa-magnifying-glass-plus text-white opacity-0 hover:opacity-100 shadow-lg"})})]}),(j||t)&&e.jsxs("label",{className:"mt-2 block text-xs text-blue-600  cursor-pointer text-center hover:bg-blue-200 bg-blue-50 rounded-2xl w-fit mx-auto px-3",children:["Change Image",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:m})]})]}):e.jsxs("div",{onClick:()=>{var i;return(i=document.getElementById(`img-upload-${s._id}`))==null?void 0:i.click()},className:"h-20 cursor-pointer w-28 mx-auto rounded-lg bg-gray-100 border border-gray-200 border-dashed flex flex-col items-center justify-center text-gray-400",children:[p?e.jsx("div",{children:e.jsx("i",{className:"fas fa-spinner animate-spin text-xl mb-1"})}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fa-regular fa-image text-xl mb-1"}),e.jsx("span",{className:"text-[12px]",children:"No Image"}),e.jsx("span",{className:"text-[10px]",children:"Click to upload"})]}),(j||t)&&e.jsx("input",{id:`img-upload-${s._id}`,type:"file",multiple:!1,accept:"image/*",className:"hidden",onChange:m})]})}),e.jsx("td",{className:"px-6 py-4 text-center align-middle",children:(j||t)&&e.jsx($,{onClick:V,disabled:a,variant:"primary",size:"sm",className:`w-full py-2 px-4 text-xs font-semibold rounded-md shadow-sm transition-all ${s.isVerified?"!bg-green-600":""} `,children:a?e.jsx("i",{className:"fa-solid fa-spinner fa-spin"}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("i",{className:`fa-solid ${s.isVerified?"fa-check-circle":"fa-shield-halved"}`}),e.jsx("span",{children:s.isVerified?"Verified":"Verify"})]})})}),x&&d&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4 backdrop-blur-sm",onClick:()=>f(!1),children:e.jsxs("div",{className:"relative max-w-4xl w-full bg-white rounded-xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-200",onClick:i=>i.stopPropagation(),children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 z-10",children:e.jsx("button",{onClick:()=>f(!1),className:"bg-black/50 hover:bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center transition-colors",children:e.jsx("i",{className:"fa-solid fa-times"})})}),e.jsx("div",{className:"bg-gray-900 flex items-center justify-center min-h-[400px]",children:e.jsx("img",{src:d.url,alt:"Full view",className:"max-w-full max-h-[80vh] object-contain"})}),e.jsxs("div",{className:"p-4 bg-white border-t flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-bold text-gray-800",children:s.subItemName}),e.jsx("p",{className:"text-sm text-gray-500",children:d.originalName||"Uploaded Image"})]}),e.jsx("span",{className:"text-xs text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded",children:ie(d.uploadedAt)})]})]})})]})},ve=()=>{var E,L,O,T;const{projectId:s,organizationId:N}=R(),{isMobile:o,openMobileSidebar:b}=z(),h=B(),{data:a,isLoading:c,error:l,isError:p,refetch:x}=ee(s),{mutateAsync:f,isPending:v}=se(),{mutateAsync:P,isPending:I}=ae(),{mutateAsync:r,isPending:j}=te(),{role:t,permission:d}=U(),V=t==="owner"||((E=d==null?void 0:d.materialarrival)==null?void 0:E.create),S=t==="owner"||((L=d==null?void 0:d.materialarrival)==null?void 0:L.edit);if(c)return e.jsx(W,{});const{timer:m,generatedLink:F,materialArrivalList:n}=a||{};console.log("materialArrivalList",n);const i=async()=>{var k,D;try{await r({projectId:s}),g({description:"Completion status updated successfully",title:"Success"}),h("../installation")}catch(A){g({title:"Error",description:((D=(k=A==null?void 0:A.response)==null?void 0:k.data)==null?void 0:D.message)||(A==null?void 0:A.message)||"Failed to update status",variant:"destructive"})}},y=(n==null?void 0:n.flatMap(k=>k.subItems||[]))||[],w=y.length,M=y.filter(k=>k.isVerified).length,Q=w-M,u=w>0?Math.round(M/w*100):0;return e.jsxs("div",{className:"w-full h-full flex flex-col p-2",children:[e.jsxs("div",{className:"flex-shrink-0 flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 pb-3",children:[e.jsxs("h2",{className:"text-2xl sm:text-2xl lg:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[o&&e.jsx("button",{onClick:b,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fa-solid fa-receipt mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Material Checking"}),e.jsx("span",{className:"sm:hidden",children:"Material Check"})]}),(V||S)&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs($,{isLoading:j,onClick:i,className:"bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto whitespace-nowrap",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark as Complete"]}),e.jsx(q,{projectId:s,stageNumber:9,stagePath:"materialarrivalcheck"}),!l&&e.jsx(K,{projectId:s,stageNumber:"9",className:"w-full sm:w-fit",isStageCompleted:a==null?void 0:a.status}),e.jsx(H,{stageName:"MaterialArrivalModel",projectId:s,organizationId:N,currentAssignedStaff:(a==null?void 0:a.assignedTo)||null})]}),e.jsx("div",{className:"w-full sm:w-auto flex justify-end sm:block",children:e.jsx(re,{organizationId:N,stageName:"materialarrival"})})]}),p&&e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"max-w-xl p-4 bg-red-50 border border-red-200 rounded-lg shadow text-center",children:[e.jsx("div",{className:"text-red-600 font-semibold mb-2",children:"⚠️ Error Occurred"}),e.jsx("p",{className:"text-red-500 text-sm mb-4",children:((T=(O=l==null?void 0:l.response)==null?void 0:O.data)==null?void 0:T.message)||"Failed to load data"}),e.jsx($,{onClick:()=>x(),className:"bg-red-600 text-white hover:bg-red-700",children:"Retry"})]})}),!p&&e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto space-y-4 sm:space-y-6",children:[e.jsxs(J,{className:"p-4 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(Y,{stageName:"materialarrivalcheck",completedAt:m==null?void 0:m.completedAt,projectId:s,formId:a==null?void 0:a._id,deadLine:m==null?void 0:m.deadLine,startedAt:m==null?void 0:m.startedAt,refetchStageMutate:x,deadLineMutate:P,isPending:I})]}),e.jsxs("section",{className:"w-full rounded-xl shadow-lg border border-gray-200 overflow-hidden bg-white",children:[e.jsxs("div",{className:"bg-gradient-to-r from-slate-800 to-gray-900 p-6 text-white",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-opacity-10 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fa-solid fa-boxes-stacked text-2xl text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold",children:"Material Verification Center"}),e.jsx("p",{className:"text-gray-300 text-sm mt-1",children:"Review arrival status per order"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold",children:w}),e.jsx("div",{className:"text-gray-300 text-sm",children:"Total Items"})]})]}),w>0&&e.jsxs("div",{className:"mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-slate-700 bg-opacity-50 rounded-lg p-3 backdrop-blur-sm flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-emerald-500/20 rounded-full flex items-center justify-center text-emerald-400",children:e.jsx("i",{className:"fa-solid fa-check"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold",children:M}),e.jsx("div",{className:"text-xs text-gray-300",children:"Verified"})]})]}),e.jsxs("div",{className:"bg-slate-700 bg-opacity-50 rounded-lg p-3 backdrop-blur-sm flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400",children:e.jsx("i",{className:"fa-solid fa-clock"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-lg font-bold",children:Q}),e.jsx("div",{className:"text-xs text-gray-300",children:"Pending"})]})]}),e.jsxs("div",{className:"bg-slate-700 bg-opacity-50 rounded-lg p-3 backdrop-blur-sm flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-indigo-500/20 rounded-full flex items-center justify-center text-indigo-400",children:e.jsx("i",{className:"fa-solid fa-chart-pie"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-bold",children:[u,"%"]}),e.jsx("div",{className:"text-xs text-gray-300",children:"Complete"})]})]})]})]}),e.jsx("div",{className:"p-4 bg-gray-50",children:n&&(n==null?void 0:n.length)>0?e.jsx("div",{className:"space-y-4",children:n==null?void 0:n.map((k,D)=>e.jsx(ce,{orderGroup:k,projectId:s},D))}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-400",children:[e.jsx("i",{className:"fa-solid fa-box-open text-4xl mb-3 opacity-50"}),e.jsx("p",{children:"No material orders synced yet."})]})})]}),e.jsx("section",{className:"mt-4",children:e.jsx(ne,{enableCreate:V||S,projectId:s,context:"Material",stage:"materialarrival",data:F,isPending:v,generateLink:f})})]})]})};export{ve as default};
