import{d as f,f as X,m as b,e as y,q as M,g,a as Z,n as ee,r as N,j as e,B as u,t as p}from"./index-Bp58Hj9Q.js";import{C as R}from"./Card-CcBYg6qB.js";import{A as se,S as te}from"./AssignStaff--dWpVw8S.js";import re from"./MaterialOverviewLoading-DJzlKxep.js";import{d as _}from"./downloadFile-Du65bAj5.js";import{S as ae}from"./ShareDocumentWhatsapp-D5J7m5cD.js";import"./getAllUsersApi-DLOj95NN.js";import"./Skeleton-OQa7E2V5.js";import"./documentationApi-Bzf-WBuk.js";import"./requirementFormApi-D2YIsqAi.js";const ie=async(t,a,i)=>{const{data:n}=await i.post(`/projectdelivery/${t}/upload`,a);if(!n.ok)throw new Error(n.message);return n.data},ne=()=>{const{role:t}=f(),a=g(t),i=["owner","CTO","staff"],n=b();return y({mutationFn:async({projectId:o,formData:l})=>{if(!t||!i.includes(t))throw new Error("Not allowed.");if(!a)throw new Error("API instance missing");return await ie(o,l,a)},onSuccess:(o,{projectId:l})=>{n.invalidateQueries({queryKey:["project-delivery",l]})}})},oe=async(t,a,i)=>{const{data:n}=await i.delete(`/projectdelivery/${t}/upload/${a}`);if(!n.ok)throw new Error(n.message);return n.data},le=()=>{const{role:t}=f(),a=g(t),i=["owner","CTO","staff"],n=b();return y({mutationFn:async({projectId:o,fileId:l})=>{if(!t||!i.includes(t))throw new Error("Not allowed.");if(!a)throw new Error("API instance missing");return await oe(o,l,a)},onSuccess:(o,{projectId:l})=>{n.invalidateQueries({queryKey:["project-delivery",l]})}})},ce=async(t,a,i)=>{const{data:n}=await i.put(`/projectdelivery/${t}/client-confirmation`,{confirmed:a});if(!n.ok)throw new Error(n.message);return n.data},de=()=>{const{role:t}=f(),a=g(t),i=["client"],n=b();return y({mutationFn:async({projectId:o,confirm:l})=>{if(!t||!i.includes(t))throw new Error("Not allowed.");if(!a)throw new Error("API instance missing");return await ce(o,l,a)},onSuccess:(o,{projectId:l})=>{n.invalidateQueries({queryKey:["project-delivery",l]})}})},me=async(t,a,i)=>{const{data:n}=await i.put(`/projectdelivery/${t}/owner-confirmation`,{confirmed:a});if(!n.ok)throw new Error(n.message);return n.data},ue=()=>{const{role:t}=f(),a=g(t),i=["owner"],n=b();return y({mutationFn:async({projectId:o,confirm:l})=>{if(!t||!i.includes(t))throw new Error("Not allowed.");if(!a)throw new Error("API instance missing");return await me(o,l,a)},onSuccess:(o,{projectId:l})=>{n.invalidateQueries({queryKey:["project-delivery",l]})}})},pe=async(t,a)=>{const{data:i}=await a.get(`/projectdelivery/${t}`);if(!i.ok)throw new Error(i.message);return i.data},xe=t=>{const{role:a}=f(),i=g(a),n=["owner","CTO","client","staff"];return X({queryKey:["project-delivery",t],queryFn:async()=>{if(!a||!n.includes(a))throw new Error("Not allowed.");if(!i)throw new Error("API instance missing");return await pe(t,i)},enabled:!!t&&!!a,retry:!1,refetchOnMount:!1})},fe=async({formId:t,deadLine:a,projectId:i,api:n})=>{const{data:o}=await n.put(`/projectdelivery/deadline/${i}/${t}`,{deadLine:a});if(!o.ok)throw new Error(o.message);return o.data},ge=async({projectId:t,api:a})=>{const{data:i}=await a.put(`/projectdelivery/completionstatus/${t}`);if(!i.ok)throw new Error(i.message);return i.data},we=()=>{const t=["owner","staff","CTO"],{role:a}=f(),i=g(a);return y({mutationFn:async({formId:n,deadLine:o,projectId:l})=>{if(!a||!t.includes(a))throw new Error("not allowed to make this api call");if(!i)throw new Error("API instance missing");return await fe({formId:n,projectId:l,deadLine:o,api:i})},onSuccess:()=>{M.invalidateQueries({queryKey:["project-delivery"]})}})},he=()=>{const t=["owner","staff","CTO"],{role:a}=f(),i=g(a);return y({mutationFn:async({projectId:n})=>{if(!a||!t.includes(a))throw new Error("not allowed to make this api call");if(!i)throw new Error("API instance missing");return await ge({projectId:n,api:i})},onSuccess:(n,{projectId:o})=>{M.invalidateQueries({queryKey:["project-delivery",o]})}})};function Se(){var I,$,q,O,L;const{projectId:t,organizationId:a}=Z(),{isMobile:i,openMobileSidebar:n}=ee(),[o,l]=N.useState(null),{data:s,isLoading:C,error:x,refetch:w}=xe(t),{mutateAsync:Q,isPending:T}=ne(),{mutateAsync:z,isPending:A,variables:h}=le(),{mutateAsync:K}=de(),{mutateAsync:U}=ue(),{mutateAsync:B,isPending:G}=we(),{mutateAsync:V,isPending:W}=he(),[k,F]=N.useState([]),v=N.useRef(null),Y=async()=>{var r,m;try{await V({projectId:t}),p({description:"Project Delivery marked as complete.",title:"Success"}),w()}catch(d){p({title:"Error",description:((m=(r=d==null?void 0:d.response)==null?void 0:r.data)==null?void 0:m.message)||d.message||"Failed to update status",variant:"destructive"})}},H=r=>{r.target.files&&F(Array.from(r.target.files))},J=async()=>{var m,d;if(!k.length){p({title:"Error",description:"Please select at least one file.",variant:"destructive"});return}const r=new FormData;k.forEach(c=>{r.append("files",c)});try{await Q({projectId:t,formData:r}),p({title:"Success",description:"Files uploaded successfully."}),w(),F([]),v.current&&(v.current.value="")}catch(c){p({title:"Error",description:((d=(m=c==null?void 0:c.response)==null?void 0:m.data)==null?void 0:d.message)||c.message||"Upload failed",variant:"destructive"})}},P=async r=>{var m,d;try{await z({projectId:t,fileId:r}),p({title:"Success",description:"File deleted."}),w()}catch(c){p({title:"Error",description:((d=(m=c==null?void 0:c.response)==null?void 0:m.data)==null?void 0:d.message)||c.message||"Deletion failed",variant:"destructive"})}},S=async r=>{var d,c;const m=r==="client"?K:U;try{await m({projectId:t,confirm:!(s!=null&&s[`${r}Confirmation`])}),p({title:"Success",description:`${r==="client"?"Client":"Owner"} confirmation updated.`}),w()}catch(j){p({title:"Error",description:((c=(d=j==null?void 0:j.response)==null?void 0:d.data)==null?void 0:c.message)||j.message||"Failed to update confirmation",variant:"destructive"})}};let D=((s==null?void 0:s.uploads)||[]).filter(r=>r.type==="pdf"),E=((s==null?void 0:s.uploads)||[]).filter(r=>r.type==="image");return C?e.jsx(re,{}):e.jsxs("div",{className:"w-full sm:min-h-full sm:overflow-y-auto space-y-6 py-1 sm:py-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start lg:items-center gap-4pb-4",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-semibold text-blue-600 flex items-center",children:[i&&e.jsx("button",{onClick:n,className:"mr-3 p-2 rounded-md border border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-handshake mr-2"}),"Project Delivery"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs(u,{isLoading:W,onClick:Y,className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark as Complete"]}),!x&&e.jsx(ae,{projectId:t,stageNumber:"14",className:"w-full sm:w-fit",isStageCompleted:s==null?void 0:s.status}),e.jsx(se,{projectId:t,organizationId:a,stageName:"ProjectDeliveryModel",currentAssignedStaff:(s==null?void 0:s.assignedTo)||null,className:"w-full sm:w-auto"})]})]}),x?e.jsxs("div",{className:"max-w-xl mx-auto bg-red-50 border border-red-200 rounded-lg shadow p-6 text-center",children:[e.jsx("div",{className:"text-red-600 text-xl font-bold mb-2",children:"⚠️ Error Loading Data"}),e.jsx("p",{className:"text-sm text-red-500 mb-4",children:(($=(I=x==null?void 0:x.response)==null?void 0:I.data)==null?void 0:$.message)||(x==null?void 0:x.message)||"Something went wrong while fetching project delivery details."}),e.jsx(u,{onClick:()=>w(),isLoading:C,className:"bg-red-600 hover:bg-red-700 text-white",children:"Retry"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(R,{className:"p-4 border-l-[4px] border-blue-600 shadow w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(te,{completedAt:(q=s==null?void 0:s.timer)==null?void 0:q.completedAt,stageName:"projectdelivery",projectId:t,formId:s==null?void 0:s._id,deadLine:(O=s==null?void 0:s.timer)==null?void 0:O.deadLine,startedAt:(L=s==null?void 0:s.timer)==null?void 0:L.startedAt,refetchStageMutate:w,deadLineMutate:B,isPending:G})]}),e.jsxs(R,{className:"p-6 border-2 border-blue-200 shadow w-full flex flex-col gap-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-bold text-blue-800 mb-3",children:[e.jsx("i",{className:"fas fa-paperclip mr-2 text-blue-600"}),"Upload Files"]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-end",children:[e.jsx("input",{multiple:!0,ref:v,type:"file",onChange:H,accept:".pdf,image/*",className:"w-full sm:w-[300px] border border-blue-300 px-3 py-2 rounded text-sm"}),e.jsx(u,{onClick:J,isLoading:T,className:"bg-blue-600 text-white hover:bg-blue-700",children:"Upload Files"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"min-h-[220px] sm:max-h-[150px] sm:min-h-[150px]  lg:min-h-[220px] overflow-y-auto custom-scrollbar",children:[e.jsxs("h3",{className:"font-semibold text-blue-700 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-file-pdf"}),"PDF Files"]}),D.length===0?e.jsx("div",{className:"h-[85%] shadow rounded bg-blue-50 flex items-center justify-center",children:e.jsx("p",{className:"text-sm font-medium text-gray-500 px-4 text-center",children:"No PDF files uploaded."})}):e.jsx("ul",{className:"space-y-2",children:D.map(r=>e.jsxs("li",{className:"flex justify-between items-center bg-blue-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"truncate text-sm",children:r.originalName}),e.jsxs("div",{className:"flex gap-3 items-center text-blue-600",children:[e.jsx(u,{size:"sm",variant:"primary",onClick:()=>_({src:r==null?void 0:r.url,alt:(r==null?void 0:r.originalName)||"file.pdf"}),children:e.jsx("i",{className:"fa-solid fa-download"})}),e.jsx(u,{size:"sm",isLoading:(h==null?void 0:h.fileId)===r._id&&A,onClick:()=>P(r._id),className:"text-red-600",children:e.jsx("i",{className:"fas fa-trash"})})]})]},r._id))})]}),e.jsxs("div",{className:" min-h-[220px] sm:max-h-[150px]  sm:min-h-[150px] lg:min-h-[220px] overflow-y-auto custom-scrollbar",children:[e.jsxs("h3",{className:"font-semibold text-blue-700 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-image"}),"Image Files"]}),E.length===0?e.jsx("div",{className:"h-[85%] shadow rounded bg-blue-50 flex items-center justify-center",children:e.jsx("p",{className:"text-sm font-medium text-gray-500 px-4 text-center",children:"No images uploaded."})}):e.jsx("ul",{className:"space-y-2",children:E.map(r=>e.jsxs("li",{className:"flex justify-between items-center bg-blue-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"truncate text-sm",children:r.originalName}),e.jsxs("div",{className:"flex gap-3 items-center text-blue-600",children:[e.jsx(u,{size:"sm",variant:"primary",onClick:()=>l(r==null?void 0:r.url),children:e.jsx("i",{className:"fas fa-eye"})}),e.jsx(u,{size:"sm",variant:"primary",onClick:()=>_({src:r==null?void 0:r.url,alt:(r==null?void 0:r.originalName)||"file.pdf"}),children:e.jsx("i",{className:"fa-solid fa-download"})}),e.jsx(u,{size:"sm",isLoading:(h==null?void 0:h.fileId)===r._id&&A,onClick:()=>P(r._id),className:"text-red-600",children:e.jsx("i",{className:"fas fa-trash"})})]})]},r._id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-3 gap-4",children:[e.jsxs(u,{onClick:()=>S("client"),className:`w-full ${s!=null&&s.clientConfirmation?"bg-blue-600":"bg-red-600"} text-white`,children:[e.jsx("i",{className:`fas ${s!=null&&s.clientConfirmation?"fa-check":"fa-xmark"} mr-2`})," ",s!=null&&s.clientConfirmation?"Client Confirmed":"Client not confirmed"]}),e.jsxs(u,{onClick:()=>S("owner"),className:`w-full ${s!=null&&s.ownerConfirmation?"bg-blue-600":"bg-red-600"} text-white`,children:[e.jsx("i",{className:`fas ${s!=null&&s.ownerConfirmation?"fa-check":"fa-xmark"} mr-2`})," ",s!=null&&s.ownerConfirmation?"Owner Confirmed":"Owner not confirmed"]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded px-4 py-3 flex items-center gap-3 text-sm text-blue-800",children:[e.jsx("i",{className:"fas fa-user-check text-blue-600 text-base"}),e.jsxs("p",{className:"font-medium",children:["Client Confirmed At:"," ",e.jsx("span",{className:"font-semibold text-blue-900",children:s!=null&&s.clientAcceptedAt?new Date(s.clientAcceptedAt).toLocaleDateString():"Not Confirmed Yet"})]})]})]}),o&&e.jsx("div",{onClick:()=>l(null),className:"fixed inset-0 z-50 bg-black/70 bg-opacity-60 flex items-center justify-center",children:e.jsxs("div",{onClick:r=>r.stopPropagation(),className:"relative bg-white rounded py-8 px-4 max-w-[90vw] max-h-[80vh] shadow-lg",children:[e.jsx("i",{className:"fas fa-times absolute top-2 right-3 text-xl text-gray-700 hover:text-red-500 cursor-pointer",onClick:()=>l(null)}),e.jsx("img",{src:o,alt:"Full View",className:"max-h-[70vh] w-auto object-contain rounded"})]})})]})]})}export{Se as default};
