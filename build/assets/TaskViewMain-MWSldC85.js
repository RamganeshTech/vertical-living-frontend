import{p as se,j as e,B as h,t as x,u as ae,q as te,d as ie,s as le,r as U,v as ne,w as re,x as ce,g as de,h as oe,y as ue,M as xe,L as o,S as T,i as _,k as I,l as A,m as F,z as V,A as B,C as E,a as P,I as O,n as q,T as me,b as z,c as D,D as he}from"./index-CKvTvGhg.js";import{D as pe,a as ge,b as je,c as Ne,d as ve,e as fe}from"./Dialog-D0ajlzFA.js";import{B as H}from"./Badge-BUDRIX_H.js";const be=({isOpen:c,onClose:m,task:u,mainTaskId:n,subtasks:g,role:t})=>{const{mutateAsync:y,isPending:j}=se(),a=async(r,M,S)=>{var v,w;try{if(R(u==null?void 0:u.dependentTaskId,t))return;await y({mainTaskId:n,subTaskId:r,status:M,subTask:S}),x({description:"Updated Successfully",title:"Success"})}catch(f){x({title:"Error",description:((w=(v=f==null?void 0:f.response)==null?void 0:v.data)==null?void 0:w.message)||"Failed to update completion status",variant:"destructive"})}};return e.jsx("div",{className:"px-2 bg-white ",children:e.jsx(pe,{open:c,onOpenChange:m,children:e.jsxs(ge,{children:[e.jsxs(je,{children:[e.jsx(Ne,{children:"Manage Subtask Status"}),e.jsx(ve,{children:"Update status of each subtask and log changes."})]}),e.jsx("div",{className:"divide-y divide-gray-200 px-5",children:g.map(r=>e.jsxs("div",{className:"py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:(r==null?void 0:r.taskName)||"-"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>a(r._id,"start",r.taskName),className:"bg-blue-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-play mr-1"})," Start"]}),e.jsxs(h,{onClick:()=>a(r._id,"paused",r.taskName),className:"bg-yellow-500 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-pause mr-1"})," Pause"]}),e.jsxs(h,{onClick:()=>a(r._id,"done",r.taskName),className:"bg-green-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-check mr-1"})," Done"]})]})]},r._id))}),e.jsx(fe,{children:e.jsx(h,{onClick:m,variant:"secondary",className:"",children:"Close"})})]})})})},G=["queued","in_progress","paused","done"],ye=["low","medium","high"],Se=["site","procurement","design","accounts"],R=(c,m)=>{const u=m==="staff",n=c&&Array.isArray(c)&&(c==null?void 0:c.length)>0,g=c&&Array.isArray(c)&&(c==null?void 0:c.some(t=>(t==null?void 0:t.status)!=="done"));return u&&n&&g?(x({title:"Not Allowed",description:"You cannot update status until all dependent tasks are marked as done",variant:"destructive"}),!0):!1},_e=()=>{var L;const{id:c,organizationId:m}=ae(),{role:u}=te(),n=u==="staff",g=ie(),{data:t,isLoading:y,refetch:j}=le(c),[a,r]=U.useState({title:"",description:"",due:"",status:"queued",department:"site",priority:"medium",assigneeId:"",assigneeName:"",projectId:"",projectName:"",dependentTaskId:void 0}),[M,S]=U.useState(!1),{mutateAsync:v}=ne(),{mutateAsync:w}=re(),{mutateAsync:f}=ce(),{data:k}=de(m),{data:C}=oe(m,"staff"),$=(k||[]).map(s=>({value:s._id,label:s.projectName})),Y=(C||[]).map(s=>({value:s._id,label:s.staffName,email:s.email}));U.useEffect(()=>{var s,l,i,d;t&&r({title:(t==null?void 0:t.title)||"",description:(t==null?void 0:t.description)||"",due:ue(new Date(t==null?void 0:t.due)),department:t.department,priority:t.priority,status:t.status,assigneeId:((s=t==null?void 0:t.assigneeId)==null?void 0:s._id)||"",assigneeName:((l=t==null?void 0:t.assigneeId)==null?void 0:l.staffName)||"",projectId:((i=t==null?void 0:t.projectId)==null?void 0:i._id)||"",projectName:((d=t==null?void 0:t.projectId)==null?void 0:d.projectName)||"",dependentTaskId:(t==null?void 0:t.dependentTaskId)||void 0})},[t]);const N=(s,l)=>{r(i=>({...i,[s]:l}))},J=(s,l)=>{if(!l)return;const i=l.filter((d,p)=>p!==s);r(d=>({...d,dependentTaskId:i.length>0?i:void 0}))},K=async(s,l)=>{var d,p;r(b=>({...b,[s]:l}));let i={...a};if(i.status=l,!R(t==null?void 0:t.dependentTaskId,u))try{if(!t)return;await v({mainTaskId:t._id,updates:i}),j(),x({description:"Updated Successfully",title:"Success"})}catch(b){x({title:"Error",description:((p=(d=b==null?void 0:b.response)==null?void 0:d.data)==null?void 0:p.message)||"Failed to update task",variant:"destructive"})}},Q=s=>{const l=C==null?void 0:C.find(i=>i._id===s);r(i=>({...i,assigneeId:s||"",assigneeName:(l==null?void 0:l.staffName)||""}))},W=s=>{const l=k==null?void 0:k.find(i=>i._id===s);r(i=>({...i,projectId:s||"",projectName:(l==null?void 0:l.projectName)||""}))},X=async()=>{var s,l;try{if(!t)return;await v({mainTaskId:t._id,updates:a}),j(),x({description:"Updated Successfully",title:"Success"})}catch(i){x({title:"Error",description:((l=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:l.message)||"Failed to update task",variant:"destructive"})}},Z=async(s,l)=>{var i,d;try{if(!t)return;await w({mainTaskId:t._id,subTaskId:s,taskName:l}),x({description:"Updated Successfully",title:"Success"})}catch(p){x({title:"Error",description:((d=(i=p==null?void 0:p.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to update subtask",variant:"destructive"})}},ee=async s=>{var l,i;try{if(!t)return;await f({mainTaskId:t._id,subTaskId:s}),x({description:"Subtask deleted",title:"Success"})}catch(d){x({title:"Error",description:((i=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to delete subtask",variant:"destructive"})}};return!y&&!t?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-clipboard text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Tasks Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no tasks created yet."})]}):y?e.jsx(xe,{}):e.jsxs("div",{className:"p-2 overflow-y-auto max-h-full",children:[e.jsxs("section",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{onClick:()=>g(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-center w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("h1",{className:"text-xl sm:text-3xl font-bold text-blue-800",children:n?a==null?void 0:a.title:"View And Edit Task"})]}),n&&e.jsxs("div",{children:[e.jsx(o,{children:"Update Status of Task"}),e.jsxs(T,{value:a.status==="in_progress"?"In progress":a.status,onValueChange:s=>K("status",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:a.status==="in_progress"?"In progress":a.status,placeholder:"Department"})}),e.jsx(A,{children:G.map(s=>e.jsx(F,{value:s,children:s==="in_progress"?"In progress":s},s))})]})]})]}),(a==null?void 0:a.dependentTaskId)&&Array.isArray(a==null?void 0:a.dependentTaskId)&&a.dependentTaskId.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Dependent Tasks"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.dependentTaskId.map((s,l)=>{var i;return e.jsxs("div",{className:"p-4 relative border border-gray-200 rounded-lg bg-gray-50 shadow-sm",children:[!n&&e.jsx(h,{size:"sm",variant:"danger",className:"absolute top-[10px] !right-[10px] bg-red-600 text-white",onClick:()=>J(l,a.dependentTaskId),children:e.jsx("i",{className:"fas fa-trash-alt"})}),e.jsxs("p",{className:"font-semibold text-gray-900 text-sm mb-1 truncate w-[95%]",children:["Title: ",s.title||"Untitled Task"]}),e.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[e.jsx("div",{className:"flex items-center gap-2 ",children:e.jsxs(H,{variant:"default",className:"",children:["Assigned to: ",((i=s==null?void 0:s.assigneeId)==null?void 0:i.staffName)||"Unassigned"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(H,{variant:(s==null?void 0:s.status)==="done"?"success":(s==null?void 0:s.status)==="queued"?"secondary":(s==null?void 0:s.status)==="in_progress"||(s==null?void 0:s.status)==="paused"?"default":"secondary",className:"",children:(s==null?void 0:s.status)==="in_progress"?"In progress":s.status||"N/A"})})]}),e.jsxs("div",{className:"text-sm text-gray-700",children:["Due:"," ",e.jsx("span",{className:"font-medium text-gray-800",children:s.due?`${V(s.due)} - ${B(s.due)}`:"N/A"})]})]},s._id)})})]}),e.jsx(E,{className:"mt-4",children:e.jsxs(P,{className:"grid md:grid-cols-2 gap-4",children:[!n&&e.jsxs("div",{children:[e.jsx(o,{children:"Task Title"}),e.jsx(O,{value:a.title,onChange:s=>N("title",s.target.value),placeholder:"Task Title"})]}),n?e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx("p",{className:"text-blue-800 font-medium",children:a!=null&&a.due?e.jsxs(e.Fragment,{children:[V(a.due)," - ",B(a.due)]}):"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx(O,{value:a.due,onChange:s=>N("due",s.target.value),type:"datetime-local"})]}),n?e.jsxs("div",{children:[e.jsx(o,{children:"Project"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(a==null?void 0:a.projectName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Project"}),e.jsx(q,{options:$,placeholder:"Select project",searchPlaceholder:"Search projects...",value:(a==null?void 0:a.projectId)||void 0,onValueChange:s=>W(s),searchBy:"name",displayFormat:"simple",className:"w-full"})]}),n?e.jsxs("div",{children:[e.jsx(o,{children:"Assignee"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(a==null?void 0:a.assigneeName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Assignee"}),e.jsx(q,{options:Y,placeholder:"Select assignee",searchPlaceholder:"Search by name...",value:(a==null?void 0:a.assigneeId)||void 0,onValueChange:s=>Q(s),searchBy:"name",displayFormat:"detailed",className:"w-full"})]}),!n&&e.jsxs("div",{children:[e.jsx(o,{children:"Status"}),e.jsxs(T,{value:a.status==="in_progress"?"In progress":a.status,onValueChange:s=>N("status",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:a.status==="in_progress"?"In progress":a.status,placeholder:"Department"})}),e.jsx(A,{children:G.map(s=>e.jsx(F,{value:s,children:s==="in_progress"?"In progress":s},s))})]})]}),n?e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:a==null?void 0:a.priority})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsxs(T,{value:a==null?void 0:a.priority,onValueChange:s=>N("priority",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:a==null?void 0:a.priority,placeholder:"Priority"})}),e.jsx(A,{children:ye.map(s=>e.jsx(F,{value:s,children:s},s))})]})]}),n?e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:a==null?void 0:a.department})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsxs(T,{value:a==null?void 0:a.department,onValueChange:s=>N("department",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:a==null?void 0:a.department,placeholder:"Department"})}),e.jsx(A,{children:Se.map(s=>e.jsx(F,{value:s,children:s},s))})]})]}),n?e.jsxs("div",{className:"md:col-span-1 ",children:[e.jsx(o,{children:"Description"}),e.jsx("p",{className:"text-blue-800",children:(a==null?void 0:a.description)||"N/A"})]}):e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(o,{children:"Description"}),e.jsx(me,{value:a==null?void 0:a.description,onChange:s=>N("description",s.target.value),placeholder:"Description"})]}),!n&&e.jsx("div",{className:"md:col-span-2 flex justify-end w-full",children:e.jsxs(h,{onClick:X,className:"mt-2 bg-blue-600 text-white hover:bg-blue-700",children:[e.jsx("i",{className:"fa-solid fa-save mr-2"})," Save Main Task"]})})]})}),e.jsxs(E,{className:"mt-6",children:[e.jsxs(z,{children:[e.jsx(D,{children:"Subtasks"}),e.jsxs(he,{children:[((L=t.tasks)==null?void 0:L.length)||0," subtasks"]})]}),e.jsx(P,{className:"space-y-4",children:t.tasks.map(s=>n?e.jsxs("div",{className:"p-3 bg-gray-50 rounded border text-blue-800 font-medium",children:["• ",s.taskName]},s._id):e.jsx(we,{subtask:s,onSave:l=>Z(s._id,l),onDelete:()=>ee(s._id)},s._id))})]}),e.jsx(be,{isOpen:M,onClose:()=>S(!1),mainTaskId:t._id,task:t,subtasks:t.tasks,history:t.history,role:u}),e.jsxs(E,{className:"mt-6",children:[e.jsxs(z,{className:"flex justify-between items-center",children:[e.jsx(D,{children:"Task History"}),e.jsxs(h,{onClick:()=>S(!0),className:"bg-blue-700 text-white mt-2",children:[e.jsx("i",{className:"fa fa-bolt mr-1"}),"Update Subtask Status"]})]}),e.jsx(P,{className:"space-y-3 text-sm text-gray-700",children:t.history.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-history text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No History Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no changes made"})]}):t.history.map((s,l)=>{const i={queued:"bg-gray-200 text-gray-800",in_progress:"bg-blue-100 text-blue-800",paused:"bg-yellow-100 text-yellow-800",done:"bg-green-100 text-green-800",start:"bg-purple-100 text-purple-800"};return e.jsxs("div",{className:"border-l-4 border-blue-200 pl-4 py-3 bg-gray-50 rounded-md shadow-sm",children:[e.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-semibold ${i[s.status]||"bg-gray-100 text-gray-700"}`,children:s.status.replace("_"," ").toUpperCase()}),s.subTask&&e.jsx("span",{className:"text-sm text-blue-600 font-medium italic",children:s.subTask})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500 pl-1",children:["Changed on: ",V(new Date(s==null?void 0:s.changedAt).toLocaleString())," - ",new Date(s==null?void 0:s.changedAt).toLocaleString().slice(11)]})]},l)})})]})]})},we=({subtask:c,onSave:m,onDelete:u})=>{const[n,g]=U.useState(c.taskName);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:n,onChange:t=>g(t.target.value),className:"flex-1"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>m(n),className:"bg-green-600 text-white hover:bg-green-700",children:[e.jsx("i",{className:"fa-solid fa-check mr-1"})," Save"]}),e.jsxs(h,{onClick:u,className:"bg-red-600 text-white hover:bg-red-700",children:[e.jsx("i",{className:"fa-solid fa-trash mr-1"})," Delete"]})]})]})};export{_e as TaskViewMain,_e as default,R as isBlockedByDependencies};
