import{k as y,q as E,b as ae,d as te,r as f,j as e,B as x,I as S,g as Q,t as g}from"./index-B7U0voEN.js";import{u as ne}from"./useQuery-B4RrmMvA.js";import{u as h,g as p}from"./roleCheck-DCYFBDfO.js";import{c as le}from"./Card-CInTFOVP.js";import{A as ie,S as re}from"./AssignStaff-s8Id0Omb.js";import{R as oe}from"./ResetStageButton-Br8Vm6ww.js";import ce from"./MaterialOverviewLoading-BCZy2_Zm.js";import{d as de}from"./downloadFile-BOh4X7Gv.js";import{B as me}from"./Badge-CUJvPubV.js";import{S as ue}from"./ShareDocumentWhatsapp-Cgazew4b.js";import"./getAllUsersApi-CWX5sC3d.js";import"./Skeleton-DbVjxyY1.js";import"./documentationApi-D-pWxgHG.js";const xe=async({projectId:n,formData:l,api:t})=>{const{data:r}=await t.post(`/technicalconsultation/createmessage/${n}`,l);if(!r.ok)throw new Error(r.message);return r.data},fe=async({projectId:n,api:l})=>{const{data:t}=await l.get(`/technicalconsultation/getmessages/${n}`);if(!t.ok)throw new Error(t.message);return t.data},ge=async({projectId:n,messageId:l,message:t,senderId:r,senderRole:o,api:m})=>{const{data:d}=await m.put(`/technicalconsultation/editmessage/${n}/${l}`,{message:t,senderId:r,senderRole:o});if(!d.ok)throw new Error(d.message);return d.data},he=async({formId:n,projectId:l,deadLine:t,api:r})=>{const{data:o}=await r.put(`/technicalconsultation/deadline/${l}/${n}`,{deadLine:t});if(!o.ok)throw new Error(o.message);return o.data},pe=async({projectId:n,api:l})=>{const{data:t}=await l.put(`/technicalconsultation/completionstatus/${n}`);if(!t.ok)throw new Error(t.message);return t.data},we=n=>{const l=["owner","staff","CTO","worker"],{role:t}=h(),r=p(t);return ne({queryKey:["consultationMessages",n],queryFn:async()=>{if(!t||!l.includes(t))throw new Error("Not allowed");if(!r)throw new Error("API not found");return await fe({projectId:n,api:r})},enabled:!!n,retry:!1,refetchOnMount:!1,refetchOnWindowFocus:!1})},ye=()=>{const n=["owner","staff","CTO","worker"],{role:l}=h(),t=p(l);return y({mutationFn:async({projectId:r,formData:o})=>{if(!l||!n.includes(l))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await xe({projectId:r,formData:o,api:t})},onSuccess:()=>{E.invalidateQueries({queryKey:["consultationMessages"]})}})},je=()=>{const n=["owner","staff","CTO","worker"],{role:l}=h(),t=p(l);return y({mutationFn:async({projectId:r,messageId:o,message:m,senderId:d})=>{if(!l||!n.includes(l))throw new Error("Not allowed");if(!t)throw new Error("API not found");return await ge({projectId:r,messageId:o,message:m,senderId:d,senderRole:l,api:t})},onSuccess:()=>{E.invalidateQueries({queryKey:["consultationMessages"]})}})},Ne=()=>{const n=["owner","staff","CTO"],{role:l}=h(),t=p(l);return y({mutationFn:async({projectId:r})=>{if(!l||!n.includes(l))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await pe({projectId:r,api:t})},onSuccess:(r,{projectId:o})=>{E.invalidateQueries({queryKey:["consultationMessages",o]})}})},ve=()=>{const n=["owner","staff","CTO"],{role:l}=h(),t=p(l);return y({mutationFn:async({formId:r,projectId:o,deadLine:m})=>{if(!l)throw new Error("not authorized");if(!n.includes(l))throw new Error("you  dont have the access to make this api");if(!t)throw new Error("api is null");return await he({formId:r,projectId:o,deadLine:m,api:t})}})},Oe=()=>{var $,q,z,_,B,K;const{projectId:n,organizationId:l}=ae(),{isMobile:t,openMobileSidebar:r}=te(),{role:o,_id:m}=h(),[d,k]=f.useState(""),[A,M]=f.useState([]),[j,N]=f.useState(null),[v,w]=f.useState(""),[T,b]=f.useState(null),[I,L]=f.useState(!1);let{data:W,isLoading:P,error:u,isError:G,refetch:F}=we(n);const i=W,{mutateAsync:U,isPending:Y}=ye(),{mutateAsync:H,isPending:J}=je(),{mutateAsync:V,isPending:X}=ve(),R=Ne(),Z=async()=>{var a,c;try{await R.mutateAsync({projectId:n}),g({description:"Completion status updated successfully",title:"Success"})}catch(s){g({title:"Error",description:((c=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:c.message)||s.message||"Failed to update completion status",variant:"destructive"})}},O=async()=>{var a,c;try{if(!d&&A.length===0)throw new Error("please write anything");const s=new FormData;d&&s.append("message",d),o&&s.append("senderRole",o),s.append("sender",m),A.forEach(C=>s.append("attachments",C)),await U({projectId:n,formData:s}),k(""),M([]),g({description:"message sent successfully",title:"Success"})}catch(s){g({title:"Error",description:((c=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:c.message)||(s==null?void 0:s.message)||"Failed to send the message",variant:"destructive"})}},D=(a,c)=>{N(a),w(c)},ee=()=>{N(null),w("")},se=async()=>{var a,c;try{if(!j||!v)throw new Error("please write anything");await H({projectId:n,messageId:j,message:v,senderId:m}),N(null),w(""),g({description:"message edited successfully",title:"Success"})}catch(s){g({title:"Error",description:((c=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:c.message)||(s==null?void 0:s.message)||"Failed to edit the message",variant:"destructive"})}};return P?e.jsx(ce,{}):e.jsxs("div",{className:"container mx-auto  max-w-full max-h-full",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-2",children:[e.jsxs("h2",{className:"text-xl sm:text-2xl xl:text-3xl font-semibold text-blue-600 flex items-center",children:[t&&e.jsx("button",{onClick:r,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-comments mr-2"})," Technical Consultation"]}),e.jsxs("div",{className:"w-full lg:w-[60%]  flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(x,{isLoading:R.isPending,onClick:Z,className:"bg-green-600 hover:bg-green-700 text-white flex-1 sm:flex-initial min-w-max",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsxs("div",{className:"flex flex-wrap sm:flex-nowrap gap-2 justify-end",children:[e.jsx(oe,{projectId:n,stageNumber:4,stagePath:"technicalconsultation",className:"flex-1 sm:flex-initial min-w-max"}),!u&&e.jsx(ue,{projectId:n,stageNumber:"4",className:"w-full sm:w-fit",isStageCompleted:i==null?void 0:i.status}),e.jsx(ie,{stageName:"TechnicalConsultationModel",projectId:n,organizationId:l,currentAssignedStaff:(i==null?void 0:i.assignedTo)||null,className:"flex-1 sm:flex-initial min-w-max"})]})]})]}),e.jsxs(le,{className:"p-4 mb-3 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(re,{stageName:"technicalconsultation",completedAt:($=i==null?void 0:i.timer)==null?void 0:$.completedAt,projectId:n,formId:i==null?void 0:i._id,deadLine:(q=i==null?void 0:i.timer)==null?void 0:q.deadLine,startedAt:(z=i==null?void 0:i.timer)==null?void 0:z.startedAt,refetchStageMutate:F,deadLineMutate:V,isPending:X})]}),e.jsx("div",{className:" flex flex-col bg-white rounded-xl p-2 shadow-md border custom-scrollbar min-h-[200px] sm:min-h-[170px] md:min-h-[190px] lg:min-h-[300px] border-gray-200 mb-2 flex-grow max-h-[70vh] sm:!max-h-[30vh] md:!max-h-[30vh] lg:!max-h-[42vh] xl:!max-h-[49vh] overflow-y-auto ",children:e.jsxs("div",{className:"flex flex-col-reverse overflow-y-auto custom-scrollbar  flex-grow p-2  md:!max-h-full space-y-reverse space-y-4",children:[(G||u)&&e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-ban text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:((B=(_=u==null?void 0:u.response)==null?void 0:_.data)==null?void 0:B.message)||(u==null?void 0:u.message)||"Failed to load messages, please try again"}),e.jsxs(x,{onClick:()=>F(),className:"mt-4 bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx("i",{className:"fas fa-redo mr-2"})," Retry"]})]})}),P?e.jsxs("div",{className:"flex h-full items-center justify-center py-10",children:[e.jsx("i",{className:"fas fa-spinner fa-spin text-blue-600 text-2xl"}),e.jsx("span",{className:"ml-3 text-blue-600 font-medium",children:"Loading messages..."})]}):(i==null?void 0:i.messages.length)===0?e.jsx("div",{className:"flex h-full items-center justify-center py-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("i",{className:"fas fa-envelope text-6xl text-blue-300 mb-4"}),e.jsx("p",{className:"text-lg text-gray-700",children:"No messages have been posted yet."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Start the conversation using the box below."})]})}):e.jsx("div",{className:"overflow-y-auto custom-scrollbar flex flex-col-reverse space-y-reverse space-y-4",children:(K=i==null?void 0:i.messages)==null?void 0:K.slice().sort((a,c)=>new Date(c.createdAt).getTime()-new Date(a.createdAt).getTime()).map(a=>{var c;return e.jsxs("div",{className:"bg-blue-50 w-full group px-4 py-[5px] rounded-lg shadow flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-xs sm:text-[10px] text-gray-600",children:[a.senderRole.toUpperCase()," - ",new Date(a.createdAt).toLocaleString(),a.isEdited&&e.jsxs(me,{className:"sm:ml-2 my-1 sm:my-0",children:[" ",e.jsxs("p",{className:"hidden sm:inline-block",children:["message is  "," "," "]})," Â  edited by ",a.senderRole]})]}),e.jsx("div",{className:"opacity-0 scale-95 group-hover:opacity-100 transition-all duration-300",children:(a.sender===m||o==="owner"||o==="CTO")&&e.jsx("div",{className:"flex gap-2",children:e.jsx(x,{variant:"secondary",onClick:()=>D(a._id,a.message),className:"text-blue-600 text-sm",children:e.jsx("i",{className:"fas fa-edit"})})})})]}),j===a._id?e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-center mt-2",children:[e.jsx(S,{value:v,onChange:s=>w(s.target.value),className:"flex-grow"}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(x,{isLoading:J,onClick:se,className:"w-full sm:w-auto",children:"Save"}),e.jsx(x,{variant:"danger",className:"w-full sm:w-auto border-red-200 hover:bg-red-700 bg-red-600 text-white",onClick:ee,children:"Cancel"})]})]}):e.jsx("p",{className:"text-gray-900 text-sm",children:a.message}),e.jsx("div",{className:"flex flex-wrap gap-3 mt-3",children:(c=a.attachments)==null?void 0:c.map((s,C)=>e.jsxs("div",{className:"flex items-center gap-2 bg-white border px-3 py-2 rounded shadow-sm w-full max-w-[280px]",children:[e.jsx("i",{className:`fas ${s.type==="pdf"?"fa-file-pdf text-red-500":"fa-image text-blue-500"}`}),e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 truncate flex-grow min-w-0",children:s.originalName}),s.type==="image"&&e.jsx(x,{size:"sm",variant:"primary",onClick:()=>{b(s.url),L(!0)},children:e.jsx("i",{className:"fas fa-eye"})}),e.jsx(x,{onClick:()=>de({src:s==null?void 0:s.url,alt:(s==null?void 0:s.originalName)||"file.pdf"}),size:"sm",className:"text-sm",children:e.jsx("i",{className:"fa-solid fa-download"})})]},C))})]},a._id)})})]})}),e.jsxs("div",{className:"bg-white px-4 py-2 rounded-xl shadow-md",children:[e.jsx(Q,{htmlFor:"message",children:"Your Message"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 mb-3",children:[e.jsx(S,{id:"message",placeholder:"Write something...",value:d,onChange:a=>k(a.target.value),onKeyDown:a=>{a.key==="Enter"&&O()},className:"flex-grow"}),e.jsxs(x,{isLoading:Y,onClick:O,className:"w-full sm:w-auto",children:["Send ",e.jsx("i",{className:"ml-2 fa-solid fa-paper-plane"})]})]}),e.jsx(Q,{children:"Attach Files (PDF or Image)"}),e.jsx(S,{type:"file",multiple:!0,accept:".pdf,image/*",onChange:a=>M(Array.from(a.target.files||[])),className:""})]}),T&&e.jsx("div",{onClick:()=>b(null),className:"fixed inset-0 z-50 bg-black/60 flex items-center justify-center",children:e.jsxs("div",{onClick:a=>a.stopPropagation(),className:"bg-white p-2 sm:p-4 rounded-lg shadow-lg max-w-[90%] max-h-[90%] overflow-auto relative",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{onClick:()=>b(null),className:"text-red-500 text-xl",children:e.jsx("i",{className:"fas fa-times"})})}),e.jsxs("div",{className:"relative min-w-80 ",children:[I&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-white/70 backdrop-blur-sm",children:e.jsx("i",{className:"fas fa-spinner fa-spin text-3xl text-gray-600"})}),e.jsx("img",{src:T,onLoad:()=>L(!1),loading:"lazy",alt:"Preview",className:`max-h-[80vh] rounded transition duration-500 ${I?"blur-sm scale-105":""}`})]})]})})]})};export{Oe as default};
