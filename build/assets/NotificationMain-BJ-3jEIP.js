import{u as A,q as N,j as e,L as _,a as B,r as g,s as w}from"./index-CZlH018n.js";import{u as T}from"./useMutation-CuPLhNle.js";import{u as S}from"./useInfiniteQuery-CMUqhhOA.js";import{g as $}from"./roleCheck-CWG0FluA.js";import q from"./MaterialOverviewLoading-BStlmrQG.js";import{B as L}from"./Badge-B-A_U1Rw.js";import{u as U}from"./useCurrentSupervisor-C2VwNl6a.js";import"./useBaseQuery-B18wTrwv.js";import"./Skeleton-Bn0S57L0.js";const H=async({page:t=1,limit:o=20,api:a})=>{const{data:s}=await a.get(`/notification/getAllNotificaiton?page=${t}&limit=${o}`);if(!s.ok)throw new Error(s.message);return{notifications:s.data.notifications,total:s.data.total,page:s.data.page,totalPages:s.data.totalPages,ok:s.ok,message:s.message}},O=async({notificationId:t,api:o})=>{const{data:a}=await o.patch(`/notification/${t}/read`);if(!a.ok)throw new Error(a.message);return a.data},K=async({notificationId:t,api:o})=>{const{data:a}=await o.delete(`/notification/${t}`);if(!a.ok)throw new Error(a.message);return a},y=["owner","staff","CTO"],Q=(t=20)=>{const{role:o}=A(),a=$(o);return S({queryKey:["notifications","infinite",t],enabled:!!o&&!!a&&y.includes(o),initialPageParam:1,queryFn:async({pageParam:s=1})=>{if(!o||!y.includes(o))throw new Error("Not allowed to make this API call");if(!a)throw new Error("API instance not found for role");return console.log("ğŸ”” Fetching notifications page:",s),await H({page:s,limit:t,api:a})},getNextPageParam:s=>{console.log("ğŸ” Last page received:",s),console.log("ğŸ” Available properties:",Object.keys(s));const l=s.page,n=s.totalPages;console.log("ğŸ” Pagination calculation:",{currentPage:l,totalPages:n,notificationsCount:s.notifications.length,total:s.total,condition:`${l} < ${n}`,result:l<n});const c=l<n?l+1:void 0;return console.log("ğŸ” Next page will be:",c),c},retry:!1,refetchOnWindowFocus:!1,staleTime:1e3*60*2})},W=()=>{const{role:t}=A(),o=$(t);return T({mutationFn:async({notificationId:a})=>{if(!t||!y.includes(t))throw new Error("Not allowed to make this API call");if(!o)throw new Error("API instance not found for role");return await O({notificationId:a,api:o})},onSuccess:()=>{N.invalidateQueries({queryKey:["notifications"]})}})},Y=()=>{const{role:t}=A(),o=$(t);return T({mutationFn:async({notificationId:a})=>{if(!t||!y.includes(t))throw new Error("Not allowed to make this API call");if(!o)throw new Error("API instance not found for role");return await K({notificationId:a,api:o})},onSuccess:()=>{N.invalidateQueries({queryKey:["notifications"]})}})},V=({notification:t,onMarkAsRead:o,onDelete:a,frontendUrl:s})=>{var k;const n=(d=>{switch(d){case"warning":return{icon:"fa-exclamation-triangle",bgColor:"bg-amber-50",borderColor:"border-l-amber-400",badgeBg:"bg-amber-100",badgeText:"text-amber-700"};case"assignment":return{icon:"fa-tasks",bgColor:"bg-blue-50",borderColor:"border-l-blue-400",badgeBg:"bg-blue-100",badgeText:"text-blue-700"};case"info":default:return{icon:"fa-info-circle",bgColor:"bg-slate-50",borderColor:"border-l-slate-400",badgeBg:"bg-slate-100",badgeText:"text-slate-700"}}})(t.type),c=d=>{const f=new Date(d),m=new Date,b=m.getTime()-f.getTime(),u=Math.floor(b/6e4),p=Math.floor(b/36e5),v=Math.floor(b/864e5);return u<1?"Just now":u<60?`${u}m ago`:p<24?`${p}h ago`:v<7?`${v}d ago`:f.toLocaleDateString("en-US",{month:"short",day:"numeric",year:f.getFullYear()!==m.getFullYear()?"numeric":void 0})},h=(()=>{var m;if(!((m=t.navigation)!=null&&m.url))return null;const d=s.endsWith("/")?s.slice(0,-1):s,f=t.navigation.url.startsWith("/")?t.navigation.url:`/${t.navigation.url}`;return`${d}${f}`})();return e.jsx("div",{className:`${n.bgColor} border-l-4 ${n.borderColor} rounded-lg p-4 mb-3 transition-all duration-200 hover:shadow-md ${t.isRead?"":"ring-1 ring-blue-200"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 pt-1",children:e.jsx("i",{className:`fas ${n.icon} text-lg ${n.badgeText}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-start justify-between gap-2",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 leading-relaxed",children:t.message}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:c(t.createdAt)})]})}),h&&e.jsx("div",{className:"mt-3 flex gap-2",children:e.jsxs(_,{to:h,className:"inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors",onClick:()=>o(t._id),children:[((k=t.navigation)==null?void 0:k.label)||"View Details",e.jsx("i",{className:"fas fa-arrow-right text-xs"})]})})]}),e.jsx("div",{className:"flex-shrink-0 flex gap-2",children:e.jsx("button",{onClick:()=>a(t._id),className:"p-1.5 text-slate-400 hover:text-red-600 transition-colors rounded hover:bg-white",title:"Delete notification",children:e.jsx("i",{className:"fas fa-trash text-sm"})})})]})})},re=()=>{var P,R;const t=B(),o=U(),{data:a,fetchNextPage:s,hasPreviousPage:l,isFetchingPreviousPage:n,isLoading:c,isError:E,error:h}=Q(20),[k,d]=g.useState(!0),f=W(),m=Y(),b=g.useRef(null),u=g.useRef(null),p=g.useRef(null);g.useEffect(()=>{const r=o==null?void 0:o.id;if(!r)return;w.emit("join_notifications",{userId:r});const j=x=>{console.log("ğŸ”” New notification received:",x),N.invalidateQueries({queryKey:["notifications","infinite"]}),d(!0)},i=x=>{console.log("ğŸ“Š Unread count updated:",x==null?void 0:x.count),N.invalidateQueries({queryKey:["notifications","unread-count"]})};return w.on("new_notification",j),w.on("unread_count_update",i),()=>{w.off("new_notification",j),w.off("unread_count_update",i)}},[N]),g.useEffect(()=>{const r=new IntersectionObserver(j=>{if(j[0].isIntersecting&&l&&!n){console.log("ğŸ“œ Loading older notifications...");const i=b.current,x=(i==null?void 0:i.scrollHeight)||0,M=(i==null?void 0:i.scrollTop)||0;s().then(()=>{setTimeout(()=>{if(i){const F=i.scrollHeight-x;i.scrollTop=M+F}},100)})}},{threshold:.1});return u.current&&r.observe(u.current),()=>{u.current&&r.unobserve(u.current)}},[l,n,s]);const v="https://houseofram.in",C=((R=(P=a==null?void 0:a.pages)==null?void 0:P.flatMap(r=>r==null?void 0:r.notifications))==null?void 0:R.reverse())??[];g.useEffect(()=>{p.current&&!c&&(p.current.scrollIntoView({behavior:"auto"}),d(!1))},[C.length,c]);const I=r=>{f.mutate({notificationId:r})},D=r=>{m.mutate({notificationId:r})};return c?e.jsx(q,{}):E?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-exclamation-circle"}),e.jsxs("span",{children:["Error loading notifications: ",(h==null?void 0:h.message)||"Unknown error"]})]})})}):e.jsx("div",{className:"w-full min-h-full max-h-full overflow-y-auto bg-white",children:e.jsxs("div",{className:"max-w-full mx-auto",children:[e.jsx("div",{className:"sticky top-0 z-50 bg-white border-b border-slate-200",children:e.jsx("div",{className:"px-4 md:px-6 py-4 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{onClick:()=>t(-1),className:"cursor-pointer w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-arrow-left text-blue-600 text-lg"})}),e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:"fas fa-bell text-blue-600 text-lg"})}),e.jsx("div",{children:e.jsxs("h1",{className:"text-xl md:text-2xl font-bold text-slate-900",children:["Notifications",e.jsxs(L,{className:"ml-2",children:[e.jsx("i",{className:"fa-solid fa-flask mr-2"}),"In Development"]})]})})]})})}),C.length===0?e.jsx("div",{className:"w-full max-w-2xl mx-auto p-4",children:e.jsxs("div",{className:"bg-slate-50 border border-slate-200 rounded-lg p-8 text-center",children:[e.jsx("i",{className:"fas fa-bell text-4xl text-slate-300 mb-3 block"}),e.jsx("p",{className:"text-slate-600 font-medium",children:"No notifications yet"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"You're all caught up! Check back later for updates."})]})}):e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("div",{ref:b,className:"mb-0 flex justify-center",children:n&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-600",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Loading earlier notifications..."})]})}),e.jsx("div",{className:"space-y-3",children:C.map(r=>e.jsx(V,{notification:r,onMarkAsRead:I,onDelete:D,frontendUrl:v},r._id))}),e.jsx("div",{ref:p})]})]})})};export{re as default};
