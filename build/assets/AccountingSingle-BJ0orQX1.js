import{b as O,u as z,r as f,j as e}from"./index-DLaY3p7d.js";import{C as V,c as B}from"./Card-BHri7Z1r.js";import{B as N}from"./Button-B7O4a2pZ.js";import{I as h}from"./Input-BQ5STK_N.js";import{b as G,c as Y,d as q,e as H}from"./accountingApi-C7m4EMcE.js";import{t as o}from"./toast-BSC5QTk1.js";import J from"./MaterialOverviewLoading-DdlXekwW.js";import"./useQuery-CsoXJJPn.js";import"./useMutation-BqZ7KIEa.js";import"./roleCheck-BlurDUv2.js";import"./Skeleton-DyzXtmm3.js";const K=g=>{switch(g){case"paid":return{bg:"bg-green-100",text:"text-green-700",icon:"fa-check-circle",badge:"bg-green-100 text-green-700"};case"processing":return{bg:"bg-blue-100",text:"text-blue-700",icon:"fa-spinner fa-spin",badge:"bg-blue-100 text-blue-700"};case"failed":return{bg:"bg-red-100",text:"text-red-700",icon:"fa-times-circle",badge:"bg-red-100 text-red-700"};case"cancelled":return{bg:"bg-gray-100",text:"text-gray-700",icon:"fa-ban",badge:"bg-gray-100 text-gray-700"};default:return{bg:"bg-orange-100",text:"text-orange-700",icon:"fa-clock",badge:"bg-orange-100 text-orange-700"}}},re=()=>{var v,w,A,C,I,D;const{id:g}=O(),{data:s,isLoading:P,refetch:b}=G(g),{mutateAsync:k}=Y(),{mutateAsync:M}=q(),{mutateAsync:E,isPending:R}=H(),T=z(),[r,m]=f.useState(s||{}),[i,x]=f.useState(!1),[d,u]=f.useState([]),[F,j]=f.useState(new Set),L=async()=>{var a,t;try{await k({id:g,payload:r}),o({title:"success",description:"shipment has generated"}),x(!1)}catch(l){o({title:"Error",description:((t=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:t.message)||"Operation Failed",variant:"destructive"})}},U=async()=>{var a,t;try{if(d.length===0){o({title:"Info",description:"No new installments to add",variant:"default"});return}await M({id:g,installments:d}),o({title:"Success",description:`${d.length} new installment(s) added successfully`}),x(!1),u([]),b()}catch(l){o({title:"Error",description:((t=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:t.message)||"Operation Failed",variant:"destructive"})}},y=async(a,t)=>{var l,c;try{if(!s.upiId){o({title:"Error",description:"Vendor UPI ID not configured",variant:"destructive"});return}j(n=>new Set(n).add(a)),await E({accountingId:g,installmentId:a}),o({title:"Success",description:`Payout of ₹${t.toLocaleString()} initiated successfully`}),setTimeout(()=>{b(),j(n=>{const p=new Set(n);return p.delete(a),p})},3e3)}catch(n){j(p=>{const S=new Set(p);return S.delete(a),S}),o({title:"Error",description:((c=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:c.message)||"Payout failed",variant:"destructive"})}},$=()=>{var a,t;s&&m({transactionType:s.transactionType,fromDept:s.fromDept,totalAmount:{amount:((a=s.totalAmount)==null?void 0:a.amount)??0,taxAmount:((t=s.totalAmount)==null?void 0:t.taxAmount)??0},upiId:s==null?void 0:s.upiId,status:s.status,dueDate:s.dueDate?new Date(s.dueDate).toISOString().split("T")[0]:"",notes:s.notes??"",installMents:(s==null?void 0:s.installMents)||[]})},_=()=>{i||$(),x(a=>!a)};return P?e.jsx("p",{className:"p-6",children:e.jsx(J,{})}):e.jsxs("div",{className:"p-4 max-h-full overflow-y-auto max-w-full space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center border-b border-gray-200 pb-4",children:[e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx("div",{onClick:()=>T(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-center w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-blue-800",children:["Transaction: ",(s==null?void 0:s.transactionNumber)??"N/A"]})]}),!i&&e.jsxs(N,{size:"md",variant:"primary",onClick:_,children:[e.jsx("i",{className:"fas fa-edit mr-1"}),i?"Cancel":"Edit"]})]}),e.jsx(V,{className:"shadow-none",children:e.jsxs(B,{className:"p-6 space-y-6 ",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Amount"}),i?e.jsx(h,{value:(v=r==null?void 0:r.totalAmount)==null?void 0:v.amount,type:"number",onChange:a=>{const t=+a.target.value;t>=0&&m(l=>({...l,totalAmount:{...l.totalAmount,amount:t||0}}))}}):e.jsxs("p",{className:"text-lg text-gray-900 font-medium",children:["₹ ",(w=s==null?void 0:s.totalAmount)==null?void 0:w.amount]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Tax"}),i?e.jsx(h,{value:(A=r==null?void 0:r.totalAmount)==null?void 0:A.taxAmount,type:"number",onChange:a=>{const t=+a.target.value;t>=0&&m(l=>({...l,totalAmount:{...l.totalAmount,taxAmount:t||0}}))}}):e.jsxs("p",{className:"text-lg text-gray-900 font-medium",children:["₹ ",(C=s==null?void 0:s.totalAmount)==null?void 0:C.taxAmount]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Upi ID"}),i?e.jsx(h,{value:r.upiId,type:"text",onChange:a=>m(t=>({...t,upiId:a.target.value}))}):e.jsx("p",{className:"text-lg text-gray-800",children:(s==null?void 0:s.upiId)||"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Status"}),i?e.jsxs("select",{value:r.status,onChange:a=>m(t=>({...t,status:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"paid",children:"Paid"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}):e.jsx("p",{className:"text-sm font-medium text-blue-700 capitalize",children:s.status})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Due Date"}),i?e.jsx(h,{value:r==null?void 0:r.dueDate,type:"date",onChange:a=>m(t=>({...t,dueDate:a.target.value}))}):e.jsx("p",{className:"text-sm text-gray-800",children:s!=null&&s.dueDate?new Date(s==null?void 0:s.dueDate).toLocaleDateString():"-"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Notes"}),i?e.jsx("textarea",{className:"w-full px-3 py-2 border rounded-lg",value:r.notes||"",onChange:a=>m(t=>({...t,notes:a.target.value}))}):e.jsx("p",{className:"text-sm text-gray-800",children:s.notes||"-"})]}),e.jsxs("div",{className:"mt-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("i",{className:"fas fa-calendar-check text-2xl text-blue-600"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Installments"})]}),!i&&e.jsxs("button",{onClick:()=>x(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-plus"}),"Add New Installments"]})]}),!i&&(!(s!=null&&s.installMents)||((I=s==null?void 0:s.installMents)==null?void 0:I.length)===0)&&e.jsxs("div",{className:"text-center p-12 border-2 border-dashed border-gray-300 rounded-xl bg-gradient-to-br from-gray-50 to-blue-50",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4",children:e.jsx("i",{className:"fas fa-receipt text-3xl text-blue-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"No installments created yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Start by adding installment plans for this agreement"}),e.jsxs("button",{onClick:()=>x(!0),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2 mx-auto",children:[e.jsx("i",{className:"fas fa-plus-circle"}),"Add Installments"]})]}),!i&&(s==null?void 0:s.installMents)&&((D=s==null?void 0:s.installMents)==null?void 0:D.length)>0&&e.jsxs("div",{className:"border border-gray-200 rounded-xl overflow-hidden shadow-sm",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-blue-700 text-white",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-6 py-4 font-semibold text-sm",children:[e.jsx("div",{className:"col-span-1",children:"#"}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("i",{className:"fas fa-indian-rupee-sign mr-2"}),"Amount"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("i",{className:"fas fa-calendar-alt mr-2"}),"Due Date"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("i",{className:"fas fa-info-circle mr-2"}),"Status"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("i",{className:"fas fa-receipt mr-2"}),"Payment Info"]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("i",{className:"fas fa-money-bill-wave mr-2"}),"UTR / Fees"]}),e.jsx("div",{className:"col-span-1 text-center",children:e.jsx("i",{className:"fas fa-cog"})})]})}),e.jsx("div",{className:"bg-white divide-y divide-gray-200",children:s.installMents.map((a,t)=>{var n;const l=K(a.status),c=F.has(a._id);return e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-6 py-4 hover:bg-gray-50 transition-colors items-center",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("div",{className:`inline-flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm ${l.bg} ${l.text}`,children:t+1})}),e.jsx("div",{className:"col-span-2",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-blue-600 font-bold",children:"₹"}),e.jsx("span",{className:"text-lg font-bold text-gray-900",children:(n=a.amount)==null?void 0:n.toLocaleString()})]}),a.fees&&a.fees>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Fee: ₹",a.fees.toFixed(2)]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-calendar text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:new Date(a.dueDate).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"})})]}),a.paidAt&&e.jsxs("span",{className:"text-xs text-green-600",children:[e.jsx("i",{className:"fas fa-check mr-1"}),"Paid: ",new Date(a.paidAt).toLocaleDateString("en-IN")]})]})}),e.jsx("div",{className:"col-span-2",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${l.badge}`,children:[e.jsx("i",{className:`fas ${l.icon} mr-2`}),a.status.charAt(0).toUpperCase()+a.status.slice(1)]}),a.failureReason&&e.jsx("span",{className:"text-xs text-red-600",children:a.failureReason})]})}),e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:"space-y-1",children:a.paymentId?e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"ID: "}),e.jsxs("span",{className:"font-mono bg-gray-100 px-2 py-1 rounded",children:[a.paymentId.substring(0,10),"..."]})]}):e.jsx("span",{className:"text-xs text-gray-400 italic",children:"No payment ID"})})}),e.jsx("div",{className:"col-span-2",children:a.transactionId?e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"UTR: "}),e.jsx("span",{className:"font-mono bg-green-50 text-green-700 px-2 py-1 rounded font-semibold",children:a.transactionId})]})}):e.jsx("span",{className:"text-xs text-gray-400 italic",children:"Pending"})}),e.jsxs("div",{className:"col-span-1 flex justify-center",children:[a.status==="pending"&&!c&&e.jsxs("button",{onClick:()=>y(a._id,a.amount),disabled:R,className:"bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors text-xs font-medium flex items-center gap-1 disabled:opacity-50",title:"Pay to Vendor",children:[e.jsx("i",{className:"fas fa-money-bill-wave"}),"Pay"]}),(a.status==="processing"||c)&&e.jsxs("span",{className:"text-blue-600 text-xs font-semibold flex items-center gap-1",children:[e.jsx("i",{className:"fas fa-spinner fa-spin"}),"Processing"]}),a.status==="paid"&&e.jsxs("span",{className:"text-green-600 text-xs font-semibold flex items-center gap-1",children:[e.jsx("i",{className:"fas fa-check-double"}),"Paid"]}),a.status==="failed"&&e.jsxs("button",{onClick:()=>y(a._id,a.amount),className:"bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg transition-colors text-xs font-medium flex items-center gap-1",title:"Retry Payment",children:[e.jsx("i",{className:"fas fa-redo"}),"Retry"]})]})]},a._id)})}),e.jsx("div",{className:"bg-gray-50 border-t border-gray-200 px-6 py-3",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:[e.jsx("i",{className:"fas fa-list-ol mr-2"}),"Total: ",e.jsx("span",{className:"font-semibold text-gray-800",children:s.installMents.length})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("span",{className:"text-green-600",children:[e.jsx("i",{className:"fas fa-check-circle mr-1"}),"Paid: ",e.jsx("span",{className:"font-semibold",children:s.installMents.filter(a=>a.status==="paid").length})]}),e.jsxs("span",{className:"text-blue-600",children:[e.jsx("i",{className:"fas fa-spinner mr-1"}),"Processing: ",e.jsx("span",{className:"font-semibold",children:s.installMents.filter(a=>a.status==="processing").length})]}),e.jsxs("span",{className:"text-orange-600",children:[e.jsx("i",{className:"fas fa-clock mr-1"}),"Pending: ",e.jsx("span",{className:"font-semibold",children:s.installMents.filter(a=>a.status==="pending").length})]}),e.jsxs("span",{className:"text-red-600",children:[e.jsx("i",{className:"fas fa-times-circle mr-1"}),"Failed: ",e.jsx("span",{className:"font-semibold",children:s.installMents.filter(a=>a.status==="failed").length})]})]})]})})]}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("i",{className:"fas fa-info-circle text-blue-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900 mb-1",children:"Add New Installments"}),e.jsx("p",{className:"text-sm text-blue-800",children:"Existing installments cannot be edited. You can only add new installments here."})]})]})}),e.jsxs("div",{className:"border border-gray-200 rounded-xl overflow-hidden shadow-sm",children:[e.jsx("div",{className:"bg-gradient-to-r from-green-600 to-green-700 text-white",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-6 py-4 font-semibold text-sm",children:[e.jsx("div",{className:"col-span-1",children:"#"}),e.jsxs("div",{className:"col-span-4",children:[e.jsx("i",{className:"fas fa-indian-rupee-sign mr-2"}),"Amount"]}),e.jsxs("div",{className:"col-span-4",children:[e.jsx("i",{className:"fas fa-calendar-alt mr-2"}),"Due Date"]}),e.jsxs("div",{className:"col-span-3 text-center",children:[e.jsx("i",{className:"fas fa-trash-alt mr-2"}),"Action"]})]})}),e.jsx("div",{className:"bg-white divide-y divide-gray-200",children:d.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fas fa-inbox text-4xl mb-3"}),e.jsx("p",{children:"No new installments added yet"})]}):d.map((a,t)=>{var l;return e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-gray-50",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"font-bold text-green-600 text-sm",children:(((l=s==null?void 0:s.installMents)==null?void 0:l.length)||0)+t+1})})}),e.jsx("div",{className:"col-span-4",children:e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold",children:"₹"}),e.jsx(h,{type:"number",placeholder:"Enter amount",value:a.amount||"",onChange:c=>{const n=[...d];n[t].amount=Number(c.target.value),u(n)},className:"pl-8 border-gray-300 focus:border-green-500 focus:ring-green-500"})]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(h,{type:"date",value:a.dueDate||"",onChange:c=>{const n=[...d];n[t].dueDate=c.target.value,u(n)},className:"border-gray-300 focus:border-green-500 focus:ring-green-500"})}),e.jsx("div",{className:"col-span-3 text-center",children:e.jsxs("button",{onClick:()=>{u(c=>c.filter((n,p)=>p!==t))},className:"text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors inline-flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-trash-alt"}),"Remove"]})})]},t)})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsxs("button",{onClick:()=>{u(a=>[...a,{amount:0,dueDate:"",status:"pending"}])},className:"px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium flex items-center gap-2 border-2 border-gray-300",children:[e.jsx("i",{className:"fas fa-plus-circle"}),"Add Row"]}),e.jsxs("button",{onClick:U,disabled:d.length===0,className:"px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("i",{className:"fas fa-save"}),"Save ",d.length," New Installment(s)"]}),e.jsxs("button",{onClick:()=>{x(!1),u([])},className:"px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-times"}),"Cancel"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block font-medium text-gray-700",children:"From Department"}),e.jsx("span",{className:"text-gray-800 capitalize",children:(s==null?void 0:s.fromDept)||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block font-medium text-gray-700",children:"Paid At"}),e.jsx("span",{className:"text-gray-800",children:s!=null&&s.paidAt?new Date(s==null?void 0:s.paidAt).toLocaleString():"-"})]})]}),i&&e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(N,{onClick:L,children:[e.jsx("i",{className:"fas fa-save mr-1"})," Save Changes"]}),e.jsxs(N,{variant:"secondary",onClick:()=>x(!1),children:[e.jsx("i",{className:"fas fa-save mr-1"}),"  Cancel"]})]})]})})]})};export{re as default};
