import{j as e,c as se,d as te,e as ae,a as U}from"./index-ftjmZ4WH.js";import{B as h}from"./Button-BhpUbe89.js";import{I as O}from"./Input-sieJTkC7.js";import{C as M,a as E,b as B,c as H,d as ie}from"./Card-BB2WhPtT.js";import{S as T,a as _,b as I,c as A,d as F}from"./Select--aVvXKPg.js";import{d as le,e as re,f as ne,h as ce,i as de}from"./staffTaskApi-Bwrp31mW.js";import{D as oe,a as me,b as ue,c as xe,d as he,e as pe}from"./Dialog-KWaY4M9H.js";import{t as u}from"./toast-BSC5QTk1.js";import{a as ge,d as P,f as q}from"./dateFormator-B0AlGPNQ.js";import je from"./MaterialOverviewLoading-D7Qp4omS.js";import{L as o}from"./Label-De7Bg4nO.js";import{S as z}from"./SearchSelectNew-DpNEUat6.js";import{u as Ne}from"./getAllUsersApi-DNZ8rMMS.js";import{u as fe}from"./projectApi-DV972SNS.js";import{T as ve}from"./TextArea-CJKjua8R.js";import{B as D}from"./Badge-VDfVH_-Q.js";import"./roleCheck-BuedAs3v.js";import"./useQuery-DmDT-v30.js";import"./useMutation-CSGCjuCw.js";import"./Skeleton-DF3ynh9X.js";const be=({isOpen:c,onClose:x,task:m,mainTaskId:r,subtasks:g,role:a})=>{const{mutateAsync:y,isPending:j}=le(),t=async(n,V,S)=>{var f,w;try{if(R(m==null?void 0:m.dependentTaskId,a))return;await y({mainTaskId:r,subTaskId:n,status:V,subTask:S}),u({description:"Updated Successfully",title:"Success"})}catch(v){u({title:"Error",description:((w=(f=v==null?void 0:v.response)==null?void 0:f.data)==null?void 0:w.message)||"Failed to update completion status",variant:"destructive"})}};return e.jsx("div",{className:"px-2 bg-white ",children:e.jsx(oe,{open:c,onOpenChange:x,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Manage Subtask Status"}),e.jsx(he,{children:"Update status of each subtask and log changes."})]}),e.jsx("div",{className:"divide-y divide-gray-200 px-5",children:g.map(n=>e.jsxs("div",{className:"py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-sm font-medium text-gray-800",children:(n==null?void 0:n.taskName)||"-"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>t(n._id,"start",n.taskName),className:"bg-blue-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-play mr-1"})," Start"]}),e.jsxs(h,{onClick:()=>t(n._id,"paused",n.taskName),className:"bg-yellow-500 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-pause mr-1"})," Pause"]}),e.jsxs(h,{onClick:()=>t(n._id,"done",n.taskName),className:"bg-green-600 text-white",isLoading:j,children:[e.jsx("i",{className:"fa fa-check mr-1"})," Done"]})]})]},n._id))}),e.jsx(pe,{children:e.jsx(h,{onClick:x,variant:"secondary",className:"",children:"Close"})})]})})})},G=["queued","in_progress","paused","done"],ye=["low","medium","high"],Se=["site","procurement","design","accounts"],R=(c,x)=>{const m=x==="staff",r=c&&Array.isArray(c)&&(c==null?void 0:c.length)>0,g=c&&Array.isArray(c)&&(c==null?void 0:c.some(a=>(a==null?void 0:a.status)!=="done"));return m&&r&&g?(u({title:"Not Allowed",description:"You cannot update status until all dependent tasks are marked as done",variant:"destructive"}),!0):!1},Re=()=>{var L;const{id:c,organizationId:x}=se(),{role:m}=te(),r=m==="staff",g=ae(),{data:a,isLoading:y,refetch:j}=re(c),[t,n]=U.useState({title:"",description:"",due:"",status:"queued",department:"site",priority:"medium",assigneeId:"",assigneeName:"",projectId:"",projectName:"",dependentTaskId:void 0}),[V,S]=U.useState(!1),{mutateAsync:f}=ne(),{mutateAsync:w}=ce(),{mutateAsync:v}=de(),{data:k}=fe(x),{data:C}=Ne(x,"staff"),$=(k||[]).map(s=>({value:s._id,label:s.projectName})),Y=(C||[]).map(s=>({value:s._id,label:s.staffName,email:s.email}));U.useEffect(()=>{var s,l,i,d;a&&n({title:(a==null?void 0:a.title)||"",description:(a==null?void 0:a.description)||"",due:ge(new Date(a==null?void 0:a.due)),department:a.department,priority:a.priority,status:a.status,assigneeId:((s=a==null?void 0:a.assigneeId)==null?void 0:s._id)||"",assigneeName:((l=a==null?void 0:a.assigneeId)==null?void 0:l.staffName)||"",projectId:((i=a==null?void 0:a.projectId)==null?void 0:i._id)||"",projectName:((d=a==null?void 0:a.projectId)==null?void 0:d.projectName)||"",dependentTaskId:(a==null?void 0:a.dependentTaskId)||void 0})},[a]);const N=(s,l)=>{n(i=>({...i,[s]:l}))},J=(s,l)=>{if(!l)return;const i=l.filter((d,p)=>p!==s);n(d=>({...d,dependentTaskId:i.length>0?i:void 0}))},K=async(s,l)=>{var d,p;n(b=>({...b,[s]:l}));let i={...t};if(i.status=l,!R(a==null?void 0:a.dependentTaskId,m))try{if(!a)return;await f({mainTaskId:a._id,updates:i}),j(),u({description:"Updated Successfully",title:"Success"})}catch(b){u({title:"Error",description:((p=(d=b==null?void 0:b.response)==null?void 0:d.data)==null?void 0:p.message)||"Failed to update task",variant:"destructive"})}},Q=s=>{const l=C==null?void 0:C.find(i=>i._id===s);n(i=>({...i,assigneeId:s||"",assigneeName:(l==null?void 0:l.staffName)||""}))},W=s=>{const l=k==null?void 0:k.find(i=>i._id===s);n(i=>({...i,projectId:s||"",projectName:(l==null?void 0:l.projectName)||""}))},X=async()=>{var s,l;try{if(!a)return;await f({mainTaskId:a._id,updates:t}),j(),u({description:"Updated Successfully",title:"Success"})}catch(i){u({title:"Error",description:((l=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:l.message)||"Failed to update task",variant:"destructive"})}},Z=async(s,l)=>{var i,d;try{if(!a)return;await w({mainTaskId:a._id,subTaskId:s,taskName:l}),u({description:"Updated Successfully",title:"Success"})}catch(p){u({title:"Error",description:((d=(i=p==null?void 0:p.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to update subtask",variant:"destructive"})}},ee=async s=>{var l,i;try{if(!a)return;await v({mainTaskId:a._id,subTaskId:s}),u({description:"Subtask deleted",title:"Success"})}catch(d){u({title:"Error",description:((i=(l=d==null?void 0:d.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to delete subtask",variant:"destructive"})}};return!y&&!a?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-clipboard text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No Tasks Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no tasks created yet."})]}):y?e.jsx(je,{}):e.jsxs("div",{className:"p-2 overflow-y-auto max-h-full",children:[e.jsxs("section",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{onClick:()=>g(-1),className:"bg-blue-50 hover:bg-slate-300 flex items-center justify-center w-8 h-8 border border-[#a6aab8] text-sm cursor-pointer rounded-md px-2 ",children:e.jsx("i",{className:"fas fa-arrow-left"})}),e.jsx("h1",{className:"text-xl sm:text-3xl font-bold text-blue-800",children:r?t==null?void 0:t.title:"View And Edit Task"})]}),r&&e.jsxs("div",{children:[e.jsx(o,{children:"Update Status of Task"}),e.jsxs(T,{value:t.status==="in_progress"?"In progress":t.status,onValueChange:s=>K("status",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:t.status==="in_progress"?"In progress":t.status,placeholder:"Department"})}),e.jsx(A,{children:G.map(s=>e.jsx(F,{value:s,children:s==="in_progress"?"In progress":s},s))})]})]})]}),(t==null?void 0:t.dependentTaskId)&&Array.isArray(t==null?void 0:t.dependentTaskId)&&t.dependentTaskId.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Dependent Tasks"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.dependentTaskId.map((s,l)=>{var i;return e.jsxs("div",{className:"p-4 relative border border-gray-200 rounded-lg bg-gray-50 shadow-sm",children:[!r&&e.jsx(h,{size:"sm",variant:"danger",className:"absolute top-[10px] !right-[10px] bg-red-600 text-white",onClick:()=>J(l,t.dependentTaskId),children:e.jsx("i",{className:"fas fa-trash-alt"})}),e.jsxs("p",{className:"font-semibold text-gray-900 text-sm mb-1 truncate w-[95%]",children:["Title: ",s.title||"Untitled Task"]}),e.jsxs("div",{className:"flex gap-2 items-center mb-2",children:[e.jsx("div",{className:"flex items-center gap-2 ",children:e.jsxs(D,{variant:"default",className:"",children:["Assigned to: ",((i=s==null?void 0:s.assigneeId)==null?void 0:i.staffName)||"Unassigned"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(D,{variant:(s==null?void 0:s.status)==="done"?"success":(s==null?void 0:s.status)==="queued"?"secondary":(s==null?void 0:s.status)==="in_progress"||(s==null?void 0:s.status)==="paused"?"default":"secondary",className:"",children:(s==null?void 0:s.status)==="in_progress"?"In progress":s.status||"N/A"})})]}),e.jsxs("div",{className:"text-sm text-gray-700",children:["Due:"," ",e.jsx("span",{className:"font-medium text-gray-800",children:s.due?`${P(s.due)} - ${q(s.due)}`:"N/A"})]})]},s._id)})})]}),e.jsx(M,{className:"mt-4",children:e.jsxs(E,{className:"grid md:grid-cols-2 gap-4",children:[!r&&e.jsxs("div",{children:[e.jsx(o,{children:"Task Title"}),e.jsx(O,{value:t.title,onChange:s=>N("title",s.target.value),placeholder:"Task Title"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx("p",{className:"text-blue-800 font-medium",children:t!=null&&t.due?e.jsxs(e.Fragment,{children:[P(t.due)," - ",q(t.due)]}):"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Due"}),e.jsx(O,{value:t.due,onChange:s=>N("due",s.target.value),type:"datetime-local"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Project"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(t==null?void 0:t.projectName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Project"}),e.jsx(z,{options:$,placeholder:"Select project",searchPlaceholder:"Search projects...",value:(t==null?void 0:t.projectId)||void 0,onValueChange:s=>W(s),searchBy:"name",displayFormat:"simple",className:"w-full"})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Assignee"}),e.jsx("p",{className:"text-blue-800 font-medium",children:(t==null?void 0:t.assigneeName)||"N/A"})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Select Assignee"}),e.jsx(z,{options:Y,placeholder:"Select assignee",searchPlaceholder:"Search by name...",value:(t==null?void 0:t.assigneeId)||void 0,onValueChange:s=>Q(s),searchBy:"name",displayFormat:"detailed",className:"w-full"})]}),!r&&e.jsxs("div",{children:[e.jsx(o,{children:"Status"}),e.jsxs(T,{value:t.status==="in_progress"?"In progress":t.status,onValueChange:s=>N("status",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:t.status==="in_progress"?"In progress":t.status,placeholder:"Department"})}),e.jsx(A,{children:G.map(s=>e.jsx(F,{value:s,children:s==="in_progress"?"In progress":s},s))})]})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:t==null?void 0:t.priority})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Priority"}),e.jsxs(T,{value:t==null?void 0:t.priority,onValueChange:s=>N("priority",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:t==null?void 0:t.priority,placeholder:"Priority"})}),e.jsx(A,{children:ye.map(s=>e.jsx(F,{value:s,children:s},s))})]})]}),r?e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsx("p",{className:"text-blue-800 font-medium capitalize",children:t==null?void 0:t.department})]}):e.jsxs("div",{children:[e.jsx(o,{children:"Department"}),e.jsxs(T,{value:t==null?void 0:t.department,onValueChange:s=>N("department",s),children:[e.jsx(_,{className:"bg-white",children:e.jsx(I,{selectedValue:t==null?void 0:t.department,placeholder:"Department"})}),e.jsx(A,{children:Se.map(s=>e.jsx(F,{value:s,children:s},s))})]})]}),r?e.jsxs("div",{className:"md:col-span-1 ",children:[e.jsx(o,{children:"Description"}),e.jsx("p",{className:"text-blue-800",children:(t==null?void 0:t.description)||"N/A"})]}):e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(o,{children:"Description"}),e.jsx(ve,{value:t==null?void 0:t.description,onChange:s=>N("description",s.target.value),placeholder:"Description"})]}),!r&&e.jsx("div",{className:"md:col-span-2 flex justify-end w-full",children:e.jsxs(h,{onClick:X,className:"mt-2 bg-blue-600 text-white hover:bg-blue-700",children:[e.jsx("i",{className:"fa-solid fa-save mr-2"})," Save Main Task"]})})]})}),e.jsxs(M,{className:"mt-6",children:[e.jsxs(B,{children:[e.jsx(H,{children:"Subtasks"}),e.jsxs(ie,{children:[((L=a.tasks)==null?void 0:L.length)||0," subtasks"]})]}),e.jsx(E,{className:"space-y-4",children:a.tasks.map(s=>r?e.jsxs("div",{className:"p-3 bg-gray-50 rounded border text-blue-800 font-medium",children:["• ",s.taskName]},s._id):e.jsx(we,{subtask:s,onSave:l=>Z(s._id,l),onDelete:()=>ee(s._id)},s._id))})]}),e.jsx(be,{isOpen:V,onClose:()=>S(!1),mainTaskId:a._id,task:a,subtasks:a.tasks,history:a.history,role:m}),e.jsxs(M,{className:"mt-6",children:[e.jsxs(B,{className:"flex justify-between items-center",children:[e.jsx(H,{children:"Task History"}),e.jsxs(h,{onClick:()=>S(!0),className:"bg-blue-700 text-white mt-2",children:[e.jsx("i",{className:"fa fa-bolt mr-1"}),"Update Subtask Status"]})]}),e.jsx(E,{className:"space-y-3 text-sm text-gray-700",children:a.history.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[300px] w-full bg-white rounded-xl text-center p-6",children:[e.jsx("i",{className:"fas fa-history text-5xl text-blue-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-1",children:"No History Found"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Looks like there are no changes made"})]}):a.history.map((s,l)=>{const i={queued:"bg-gray-200 text-gray-800",in_progress:"bg-blue-100 text-blue-800",paused:"bg-yellow-100 text-yellow-800",done:"bg-green-100 text-green-800",start:"bg-purple-100 text-purple-800"};return e.jsxs("div",{className:"border-l-4 border-blue-200 pl-4 py-3 bg-gray-50 rounded-md shadow-sm",children:[e.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-semibold ${i[s.status]||"bg-gray-100 text-gray-700"}`,children:s.status.replace("_"," ").toUpperCase()}),s.subTask&&e.jsx("span",{className:"text-sm text-blue-600 font-medium italic",children:s.subTask})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500 pl-1",children:["Changed on: ",P(new Date(s==null?void 0:s.changedAt).toLocaleString())," - ",new Date(s==null?void 0:s.changedAt).toLocaleString().slice(11)]})]},l)})})]})]})},we=({subtask:c,onSave:x,onDelete:m})=>{const[r,g]=U.useState(c.taskName);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:r,onChange:a=>g(a.target.value),className:"flex-1"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{onClick:()=>x(r),className:"bg-green-600 text-white hover:bg-green-700",children:[e.jsx("i",{className:"fa-solid fa-check mr-1"})," Save"]}),e.jsxs(h,{onClick:m,className:"bg-red-600 text-white hover:bg-red-700",children:[e.jsx("i",{className:"fa-solid fa-trash mr-1"})," Delete"]})]})]})};export{Re as TaskViewMain,Re as default,R as isBlockedByDependencies};
