import{h as f,i as K,k as I,q as k,l as b,r as C,j as e,B as S,t as $}from"./index-D4FmOK8C.js";import{L as y}from"./Label-C6cPQDjk.js";import{I as p}from"./Input-BFPVqyVD.js";import{u as R}from"./projectApi-YsJD414B.js";const V=async({projectId:s,organizationId:n,payload:a,projectName:l,api:u})=>{const{data:c}=await u.post(`/department/logistics/shipment/create/${s}/${n}/${l}`,a);if(!c.ok)throw new Error(c.message);return c.data},W=async({projectId:s,organizationId:n,shipmentId:a,payload:l,api:u})=>{const{data:c}=await u.put(`/department/logistics/shipment/update/${s}/${n}/${a}`,l);if(!c.ok)throw new Error(c.message);return c.data},G=async({shipmentId:s,organizationId:n,api:a})=>{const{data:l}=await a.delete(`/department/logistics/shipment/delete/${n}/${s}`);if(!l.ok)throw new Error(l.message);return l.message},O=async({api:s,organizationId:n,status:a,projectId:l,scheduledDate:u})=>{const c=new URLSearchParams({organizationId:n});a&&c.append("status",a),l&&c.append("projectId",l),u&&c.append("scheduledDate",u);const{data:v}=await s.get(`/department/logistics/shipment/getshipment?${c.toString()}`);if(!v.ok)throw new Error(v.message);return v==null?void 0:v.data},M=async({api:s,shipmentId:n})=>{const{data:a}=await s.get(`/department/logistics/shipment/getsingle/${n}`);if(!a.ok)throw new Error(a.message);return a==null?void 0:a.data},P=["owner","CTO","staff"],H=()=>{const{role:s}=f(),n=b(s);return I({mutationFn:async({projectId:a,organizationId:l,payload:u,projectName:c})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await V({projectId:a,organizationId:l,payload:u,projectName:c,api:n})},onSuccess:()=>{k.invalidateQueries({queryKey:["logistics","shipments"]})}})},Y=()=>{const{role:s}=f(),n=b(s);return I({mutationFn:async({projectId:a,organizationId:l,shipmentId:u,payload:c})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await W({projectId:a,organizationId:l,shipmentId:u,payload:c,api:n})},onSuccess:()=>{k.invalidateQueries({queryKey:["logistics","shipments"]})}})},se=()=>{const{role:s}=f(),n=b(s);return I({mutationFn:async({organizationId:a,shipmentId:l})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await G({shipmentId:l,organizationId:a,api:n})},onSuccess:()=>{k.invalidateQueries({queryKey:["logistics","shipments"]})}})},ne=(s,n)=>{const{role:a}=f(),l=b(a);return K({queryKey:["logistics","shipments",n],queryFn:async()=>{if(!a||!P.includes(a))throw new Error("Not allowed");if(!l)throw new Error("API instance not found for role");return await O({api:l,organizationId:s,status:n==null?void 0:n.status,projectId:n==null?void 0:n.projectId,scheduledDate:n==null?void 0:n.scheduledDate})},retry:!1,enabled:!!s})},ie=s=>{const{role:n}=f(),a=b(n);return K({queryKey:["logistics","single"],queryFn:async()=>{if(!n||!P.includes(n))throw new Error("Not allowed");if(!a)throw new Error("API instance not found for role");return await M({api:a,shipmentId:s})},retry:!1,enabled:!!s})},ae=()=>{const{role:s}=f(),n=b(s);return I({mutationFn:async({organizationId:a,projectId:l,fromDept:u,totalCost:c,upiId:v})=>{if(!s||!P.includes(s))throw new Error("Not allowed");if(!n)throw new Error("API instance not found for role");return await z({organizationId:a,projectId:l,fromDept:u,totalCost:c,api:n,upiId:v})},onSuccess:()=>{k.invalidateQueries({queryKey:["logistics","shipments"]})}})},z=async({api:s,organizationId:n,projectId:a,fromDept:l,totalCost:u,upiId:c})=>{const{data:v}=await s.post(`/department/logistics/syncaccounting/${n}/${a}`,{totalCost:u,fromDept:l,upiId:c});return v},T=s=>{if(!s)return"";const n=new Date(s),a=g=>String(g).padStart(2,"0"),l=n.getFullYear(),u=a(n.getMonth()+1),c=a(n.getDate()),v=a(n.getHours()),w=a(n.getMinutes());return`${l}-${u}-${c}T${v}:${w}`},le=({shipment:s,onClose:n,organizationId:a})=>{var q;const{mutateAsync:l,isPending:u}=H(),{mutateAsync:c,isPending:v}=Y(),{data:w}=R(a),g=w==null?void 0:w.map(t=>({_id:t._id,projectName:t.projectName})),[N,E]=C.useState({_id:"",projectName:""}),[r,j]=C.useState({status:"pending",vehicleDetails:{vehicleNumber:"",vehicleType:"truck",driverCharge:0,driver:{name:"",phone:"",licenseNumber:""},driverUpiId:""},origin:{address:"",contactPerson:"",contactPhone:""},destination:{address:"",contactPerson:"",contactPhone:""},items:[{name:"",quantity:0}],scheduledDate:"",actualPickupTime:"",actualDeliveryTime:"",notes:""});C.useEffect(()=>{s&&(j({...r,...s,scheduledDate:s.scheduledDate?T(s.scheduledDate):"",actualPickupTime:s.actualPickupTime?T(s.actualPickupTime):"",actualDeliveryTime:s.actualDeliveryTime?T(s.actualDeliveryTime):""}),E(()=>{const t=g==null?void 0:g.find(i=>i._id===(s==null?void 0:s.projectId));return{_id:s.projectId,projectName:t==null?void 0:t.projectName}}))},[s]),C.useEffect(()=>{s||g&&g.length>0&&(console.log("projects",g),E(()=>{var t,i;return{_id:(t=g[0])==null?void 0:t._id,projectName:(i=g[0])==null?void 0:i.projectName}}))},[w]);const m=t=>{const{name:i,value:o}=t.target;if(i.startsWith("origin.")){const h=i.split(".")[1];j(d=>({...d,origin:{...d.origin,[h]:o}}))}else if(i.startsWith("destination.")){const h=i.split(".")[1];j(d=>({...d,destination:{...d.destination,[h]:o}}))}else if(i.startsWith("vehicleDetails.driver.")){const h=i.split(".")[2];j(d=>({...d,vehicleDetails:{...d.vehicleDetails,driver:{...d.vehicleDetails.driver,[h]:o}}}))}else if(i.startsWith("vehicleDetails.")){const h=i.split(".")[1];j(d=>({...d,vehicleDetails:{...d.vehicleDetails,[h]:o}}))}else j(h=>({...h,[i]:o}))},Q=t=>{var o,h,d,x,_,A,D,L;const i=[];return(o=t==null?void 0:t.origin)!=null&&o.contactPhone&&!/^\d{10}$/.test((h=t==null?void 0:t.origin)==null?void 0:h.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(d=t==null?void 0:t.destination)!=null&&d.contactPhone&&!/^\d{10}$/.test((x=t==null?void 0:t.destination)==null?void 0:x.contactPhone)&&i.push("Phone number must be exactly 10 digits."),(A=(_=t==null?void 0:t.vehicleDetails)==null?void 0:_.vehicleNumber)!=null&&A.trim()||i.push("vehicle number is required."),((D=t==null?void 0:t.items)==null?void 0:D.length)>0&&((L=t==null?void 0:t.items)==null||L.forEach((F,U)=>{F.name||i.push(`Item ${U+1} is missing a name.`),F.quantity<0&&i.push(`Item ${U+1} has invalid quantity.`)})),i},B=async()=>{var t,i;try{const o=Q(r);if(o.length>0){o.forEach(h=>{$({title:"Validation Error",description:h,variant:"destructive"})});return}s?await c({shipmentId:s._id,organizationId:a,projectId:N==null?void 0:N._id,payload:r}):await l({organizationId:a,projectId:N._id,payload:r,projectName:N.projectName}),$({title:"success",description:"shipment has generated"}),n()}catch(o){$({title:"Error",description:((i=(t=o==null?void 0:o.response)==null?void 0:t.data)==null?void 0:i.message)||"Operation Failed",variant:"destructive"})}};return e.jsx("div",{onClick:n,className:"fixed inset-0 bg-black/60 flex justify-center items-center z-50",children:e.jsxs("div",{onClick:t=>t.stopPropagation(),className:"bg-white rounded-xl p-6 shadow-lg w-[90vw] max-w-[1300px] h-[90vh] flex flex-col",children:[e.jsx("h3",{className:"text-xl font-bold mb-3",children:s?"Edit Shipment":"Create Shipment"}),e.jsxs("div",{className:"max-h-[80vh] overflow-y-auto p-2 sm:p-4 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-blue-700",children:"Shipment Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Select Project"}),e.jsx("select",{className:"w-full px-3 py-2 border rounded-xl",name:"projectID",value:N._id,onChange:t=>{const i=g==null?void 0:g.find(o=>o._id===t.target.value);i&&E({_id:i._id,projectName:i.projectName})},children:g==null?void 0:g.map(t=>e.jsx("option",{value:t._id,children:t.projectName},t._id))})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Status"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded-xl",name:"status",value:r.status,onChange:m,children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"assigned",children:"Assigned"}),e.jsx("option",{value:"in_transit",children:"In Transit"}),e.jsx("option",{value:"delivered",children:"Delivered"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Scheduled Date"}),e.jsx(p,{type:"datetime-local",name:"scheduledDate",value:r.scheduledDate,onChange:m})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-2 text-green-700",children:"Vehicle Info"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx(p,{name:"vehicleDetails.vehicleNumber",placeholder:"Vehicle Number",required:!0,value:r.vehicleDetails.vehicleNumber,onChange:m}),e.jsxs("select",{name:"vehicleDetails.vehicleType",value:r.vehicleDetails.vehicleType,onChange:m,className:"w-full px-3 py-2 border rounded-xl",children:[e.jsx("option",{value:"truck",children:"Truck"}),e.jsx("option",{value:"van",children:"Van"}),e.jsx("option",{value:"car",children:"Car"}),e.jsx("option",{value:"bike",children:"Bike"}),e.jsx("option",{value:"tempo",children:"Tempo"}),e.jsx("option",{value:"container",children:"Container"})]}),e.jsx(p,{name:"vehicleDetails.driver.name",placeholder:"Driver Name",value:r.vehicleDetails.driver.name,onChange:m}),e.jsx(p,{name:"vehicleDetails.driver.phone",type:"tel",maxLength:10,placeholder:"Driver Phone",value:r.vehicleDetails.driver.phone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}}),e.jsx(p,{name:"vehicleDetails.driver.licenseNumber",placeholder:"License Number",value:r.vehicleDetails.driver.licenseNumber,onChange:m}),e.jsx(p,{name:"vehicleDetails.driverCharge",type:"number",placeholder:"Driver Charge",value:(q=r==null?void 0:r.vehicleDetails)==null?void 0:q.driverCharge,onChange:t=>{const i=t.target.value;(i===""||Number(i)>=0)&&m(t)}}),e.jsx(p,{name:"vehicleDetails.driverUpiId",type:"text",placeholder:"Driver Upi",value:r.vehicleDetails.driverUpiId||"",onChange:t=>{m(t)}})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-yellow-700 mb-2",children:"Origin & Destination"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Origin"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"origin.address",placeholder:"Address",value:r.origin.address,onChange:m}),e.jsx(p,{name:"origin.contactPerson",placeholder:"Contact Person",value:r.origin.contactPerson,onChange:m}),e.jsx(p,{name:"origin.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:r.origin.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Destination"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{name:"destination.address",placeholder:"Address",value:r.destination.address,onChange:m}),e.jsx(p,{name:"destination.contactPerson",placeholder:"Contact Person",value:r.destination.contactPerson,onChange:m}),e.jsx(p,{name:"destination.contactPhone",placeholder:"Contact Phone",type:"tel",maxLength:10,value:r.destination.contactPhone,onChange:t=>{const i=t.target.value;/^\d*$/.test(i)&&m(t)}})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-700 mb-2",children:"Timing Schedule"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(y,{children:"Actual Pickup Time"}),e.jsx(p,{type:"datetime-local",name:"actualPickupTime",value:r.actualPickupTime,onChange:m})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Actual Delivery Time"}),e.jsx(p,{type:"datetime-local",name:"actualDeliveryTime",value:r.actualDeliveryTime,onChange:m})]})]})]}),e.jsxs("div",{children:[e.jsx(y,{children:"Notes"}),e.jsx("textarea",{name:"notes",className:"w-full px-3 py-2 border rounded-xl",rows:3,value:r.notes,onChange:m})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-pink-700 mb-2",children:"Shipment Items"}),e.jsxs("div",{className:"space-y-4",children:[r.items.map((t,i)=>e.jsxs("div",{className:"grid grid-cols-12  items-center gap-2 sm:gap-4",children:[e.jsxs("div",{className:"col-span-6 sm:col-span-5",children:[e.jsx(y,{children:"Item Name"}),e.jsx(p,{name:`item-name-${i}`,value:t.name,placeholder:"e.g. Wooden Pallets",onChange:o=>{const h=o.target.value;j(d=>{const x=[...d.items];return x[i].name=h,i===x.length-1&&h.trim()!==""&&x.push({name:"",quantity:0}),h.trim()===""&&i<x.length-1&&x.splice(i,1),{...d,items:x}})}})]}),e.jsxs("div",{className:"col-span-4 sm:col-span-3",children:[e.jsx(y,{children:"Quantity"}),e.jsx(p,{type:"number",name:`item-qty-${i}`,value:t.quantity,placeholder:"e.g. 10",onChange:o=>{const h=parseInt(o.target.value)||0;Number(h)>=0&&j(d=>{const x=[...d.items];return x[i].quantity=h,{...d,items:x}})}})]}),e.jsx("div",{className:"col-span-2 sm:col-span-2 flex mt-5 place-items-center h-full",children:e.jsx(S,{variant:"danger",size:"md",type:"button",className:"text-white bg-red-600",onClick:()=>{j(o=>({...o,items:o.items.filter((h,d)=>d!==i)}))},children:e.jsx("i",{className:"fas fa-trash"})})})]},i)),e.jsx("div",{children:e.jsxs(S,{variant:"outline",size:"sm",type:"button",onClick:()=>j(t=>({...t,items:[...t.items,{name:"",quantity:0}]})),children:[e.jsx("i",{className:"fas fa-plus mr-1"}),"Add Item"]})})]})]})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-3 border-t mt-5",children:[e.jsx(S,{variant:"outline",onClick:n,children:"Cancel"}),e.jsx(S,{isLoading:v||u,onClick:()=>B(),children:s?"Update":"Create"})]})]})})};export{le as L,ne as a,ie as b,ae as c,T as f,se as u};
