import{u as oe,a as le,b as ne,r as a,j as e,B as S,t as u}from"./index-MXS_gbde.js";import{L as i}from"./Label-BYfdMzSb.js";import{S as g}from"./SearchSelectNew-C8k-FWEO.js";import{u as ie}from"./projectApi-BH0dGL_K.js";import{b as de,c as ce,d as ue,u as xe,e as pe,f as me}from"./toolOtpApi-BXrWxUiY.js";import{u as ge}from"./getAllUsersApi-Gbc98a74.js";import{B as he}from"./Breadcrumb-BaXmUmlW.js";const Se=()=>{var F,G,L,M,_,U;const{organizationId:r}=oe(),W=le(),{role:I,permission:d}=ne(),h=I==="owner"||((F=d==null?void 0:d.toolhardware)==null?void 0:F.create),b=I==="owner"||((G=d==null?void 0:d.toolhardware)==null?void 0:G.edit),[t,R]=a.useState("issue"),[l,f]=a.useState(null),[j,z]=a.useState(null),[c,k]=a.useState(null),[x,C]=a.useState(null),[E,V]=a.useState(new Date(Date.now()+864e5).toISOString().split("T")[0]),[y,H]=a.useState("good"),[P,q]=a.useState(""),[N,J]=a.useState([]),[p,m]=a.useState({issue:null,return:null}),[n,A]=a.useState(0),O=de(),D=ce();a.useEffect(()=>{let s;return n>0&&(s=setInterval(()=>A(o=>o-1),1e3)),()=>clearInterval(s)},[n]);const $=()=>A(180),{data:v=[]}=ue(r),{data:K=[]}=xe(r),w=pe(),T=me(),{data:Q=[]}=ge(r,"worker"),{data:X=[]}=ie(r),Y=v.filter(s=>t==="issue"?s.availabilityStatus==="available":s.availabilityStatus==="issued").map(s=>({value:s._id,label:`${s.toolName} â€” ${s.toolCode}`,subLabel:s.brand})),Z=K.map(s=>({value:s._id,label:`${s.toolRoomName}`})),ee=s=>{const o=v.find(re=>re._id===s);f(s),t==="return"&&o&&(k(o.currentWorkerId||null),C(o.currentProjectId||null))},se=s=>{z(s)},te=[{label:"Tools & Hardware",path:`/organizations/${r}/projects/toolhub`},{label:"Handover Hub",path:`/organizations/${r}/projects/issueotp`}],ae=async()=>{try{if(t==="issue"){const s=p.issue;if(!s||!s.tempTransactionId)return;const o=await O.mutateAsync({transactionId:s.tempTransactionId,organizationId:r});m(()=>({return:null,issue:{tempTransactionId:o._id,showButton:!0}}))}else await D.mutateAsync({toolId:l,organizationId:r,toolWorkerId:c}),m(()=>({issue:null,return:{showButton:!0}}));$(),u({title:"OTP Resent",description:"A fresh security code has been dispatched."})}catch(s){u({title:"Resend Failed",description:s.message,variant:"destructive"})}},B=async()=>{if(!l)return u({title:"Error",description:"Select a tool",variant:"destructive"});try{if(t==="issue"){if(!c||!x)return u({title:"Error",description:"Select a Worker and the Project",variant:"destructive"});const s=await w.mutateAsync({toolId:l,toolWorkerId:c,projectId:x,organizationId:r,expectedReturnDate:E});m(()=>({return:null,issue:{tempTransactionId:s._id,showButton:!0}}))}else{const s=new FormData;s.append("toolId",l),s.append("organizationId",r),s.append("returnCondition",y),s.append("damageNotes",P),x&&s.append("projectId",x),j&&s.append("toolRoomId",j),c&&s.append("toolWorkerId",c),N.forEach(o=>s.append("photos",o)),await T.mutateAsync(s),m(()=>({issue:null,return:{showButton:!0}}))}$(),u({title:"Success",description:"OTP generated successfully."})}catch(s){u({title:"Action Failed",description:s.message,variant:"destructive"})}};return e.jsxs("div",{className:"flex flex-col h-full w-full bg-gray-50/50",children:[e.jsxs("header",{className:"w-full bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between sticky top-0 z-10",children:[e.jsx("div",{className:"flex items-center gap-6",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900 flex items-center gap-3",children:[e.jsx("span",{className:`w-3 h-3 rounded-full animate-pulse ${t==="issue"?"bg-blue-500":"bg-orange-500"}`}),"Tool Management Protocol"]}),e.jsx(he,{paths:te})]})}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex items-center gap-4 bg-gray-100 p-1.5 rounded-2xl border border-gray-200",children:[e.jsxs("button",{onClick:()=>{R("issue"),f(null)},className:`px-8 py-2.5 cursor-pointer  rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${t==="issue"?"bg-blue-600 text-white shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"fas fa-sign-out-alt"})," ISSUE ASSET"]}),e.jsxs("button",{onClick:()=>{R("return"),f(null)},className:`px-8 py-2.5 cursor-pointer  rounded-xl text-sm font-bold transition-all flex items-center gap-2 ${t==="return"?"bg-orange-600 text-white shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx("i",{className:"fas fa-sign-in-alt"})," COLLECT RETURN"]})]}),e.jsx("div",{className:"h-8 w-[1px] bg-gray-200 mx-2"}),e.jsx("div",{className:"flex items-center gap-4 bg-gray-100 p-1.5 rounded-2xl border border-gray-200",children:e.jsxs("button",{onClick:()=>W("../enterotp"),className:`px-8 cursor-pointer  py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 \r
                   text-gray-500 hover:text-gray-700 hover:bg-white`,children:[e.jsx("i",{className:"fas fa-key text-blue-500"}),"TOOL HANDOVER",e.jsx("i",{className:"fas fa-external-link-alt text-[10px] opacity-50"})]})})]})]}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-8 grid grid-cols-12 gap-8",children:[e.jsx("div",{className:"col-span-12 lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-200 p-8 shadow-sm",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-800 mb-6 flex items-center gap-2",children:[e.jsx("i",{className:`fas fa-search ${t==="issue"?"text-blue-500":"text-orange-500"}`})," Tool Identification"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Search Tool"}),e.jsx(g,{options:Y,placeholder:"Enter Tool ID or Name...",value:l||"",onValueChange:ee,displayFormat:"detailed",className:"w-full"})]}),l&&e.jsxs("div",{className:`p-5 rounded-2xl border-2 border-dashed ${t==="issue"?"bg-blue-50/50 border-blue-100":"bg-orange-50/50 border-orange-100"}`,children:[e.jsx("p",{className:"text-[10px] font-bold text-gray-400 uppercase mb-2",children:"Selected Asset Status"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-bold text-gray-900",children:(L=v.find(s=>s._id===l))==null?void 0:L.toolName}),e.jsx("span",{className:`px-3 py-1 rounded-full text-[10px] font-bold uppercase ${t==="issue"?"bg-blue-100 text-blue-700":"bg-orange-100 text-orange-700"}`,children:t==="issue"?"Ready to Issue":"Awaiting Return"})]})]})]})]})}),e.jsxs("div",{className:"col-span-12 lg:col-span-8 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-200 p-8 shadow-sm grid grid-cols-2 gap-8",children:[e.jsx("div",{className:"col-span-2",children:e.jsxs("h3",{className:"text-lg font-bold text-gray-800 mb-2 flex items-center gap-2",children:[e.jsx("i",{className:`fas fa-users ${t==="issue"?"text-blue-500":"text-orange-500"}`})," Operational Context"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Tool Taker"}),e.jsx(g,{options:Q.map(s=>({value:s._id,label:s.workerName,subLabel:s.phone})),placeholder:"Choose field worker...",value:c||"",onValueChange:k})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Project"}),e.jsx(g,{options:X.map(s=>({value:s._id,label:s.projectName})),placeholder:"Select Project...",value:x||"",onValueChange:C})]}),t==="return"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Search Room"}),e.jsx(g,{options:Z,placeholder:"Enter Tool Room Name...",value:j||"",onValueChange:se,displayFormat:"detailed",className:"w-full"})]})]}),e.jsxs("div",{className:`bg-white rounded-3xl border-2 p-8 transition-all ${t==="issue"?"border-blue-50 bg-blue-50/10":"border-orange-50 bg-orange-50/10"}`,children:[t==="issue"?e.jsx("div",{className:"flex items-center justify-between",children:!((M=p.issue)!=null&&M.showButton)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2 w-1/3",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Target Return Date"}),e.jsx("input",{type:"date",value:E,onChange:s=>V(s.target.value),className:"w-full p-3 bg-white border border-gray-200 rounded-xl font-bold shadow-sm"})]}),(h||b)&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4 max-w-xs",children:"A security code will be dispatched to the worker's device immediately."}),e.jsx(S,{onClick:B,disabled:w.isPending,className:"px-12 py-7 bg-blue-600 hover:bg-blue-700 text-white text-lg rounded-2xl shadow-xl shadow-blue-200 transition-all transform hover:-translate-y-1",children:w.isPending?e.jsx("i",{className:"fas fa-spinner fa-spin"}):"GENERATE ISSUE OTP"})]})]})}):e.jsx("div",{className:"space-y-8",children:!((_=p.return)!=null&&_.showButton)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-12",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Condition Assessment"}),e.jsxs("select",{value:y,onChange:s=>H(s.target.value),className:"w-full p-4 border border-gray-200 rounded-2xl bg-white font-bold text-gray-700 shadow-sm focus:ring-2 focus:ring-orange-500",children:[e.jsx("option",{value:"good",children:"Good"}),e.jsx("option",{value:"damaged",children:"Damaged"})]}),y==="damaged"&&e.jsx("textarea",{placeholder:"Describe physical damages in detail...",value:P,onChange:s=>q(s.target.value),className:"w-full p-4 border border-red-100 rounded-2xl h-24 text-sm bg-red-50/30"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(i,{className:"text-[10px] uppercase font-black text-gray-400",children:"Physical Evidence"}),e.jsxs("div",{className:"h-40 border-2 border-dashed border-gray-200 rounded-3xl flex flex-col items-center justify-center bg-gray-50 hover:bg-orange-50 transition-colors relative cursor-pointer group",children:[e.jsx("input",{type:"file",multiple:!0,className:"absolute inset-0 opacity-0 cursor-pointer",onChange:s=>J(Array.from(s.target.files||[]))}),e.jsx("i",{className:"fas fa-camera text-3xl text-gray-300 group-hover:text-orange-500 transition-colors"}),e.jsx("p",{className:"text-xs font-bold text-gray-500 mt-3",children:N.length>0?`${N.length} Photos Added`:"Upload Site Photos"})]})]})]}),(h||b)&&e.jsx("div",{className:"flex justify-end pt-6 border-t border-gray-100",children:e.jsx(S,{onClick:B,disabled:T.isPending,className:"px-12 py-7 bg-orange-600 hover:bg-orange-700 text-white text-lg rounded-2xl shadow-xl shadow-orange-200 transition-all transform hover:-translate-y-1",children:T.isPending?e.jsx("i",{className:"fas fa-spinner fa-spin"}):"GENERATE RETURN OTP"})})]})}),(h||b)&&e.jsx("div",{className:"flex items-center justify-end gap-4 border-t border-gray-100 pt-6",children:((U=p[t])==null?void 0:U.showButton)&&e.jsxs(S,{onClick:ae,disabled:n>0||O.isPending||D.isPending,className:"px-6 py-7 border-2 border-gray-200  text-gray-600 font-bold rounded-2xl transition-all",children:[e.jsx("i",{className:`fas fa-sync-alt mr-2 ${n>0?"":"fa-spin"}`}),n>0?`Resend in ${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`:"Resend OTP"]})})]})]})]})]})};export{Se as default};
