import{f as Q,b as H,h as $,s as k,i as S,u as J,k as W,r as q,j as e,B as U,M as X,t as f,af as Y}from"./index-BAM0eJUz.js";import{O as V}from"./OrderMaterialOverview-6X9CUgR9.js";import{S as Z}from"./StageGuide-e28gQ0h1.js";import"./Card-CdxfjEr-.js";import"./AssignStaff-Bt6qrEbL.js";import"./Input-1UBXZqEj.js";import"./getAllUsersApi-O0JEgRtZ.js";import"./ResetStageButton-DaUxSSZv.js";import"./orderMaterialHistoryApi-CM4FQ_Il.js";import"./downloadFile-BbGV_BaX.js";import"./SearchSelectNew-IGAHiELy.js";import"./ImageGalleryMain-B3g6b13d.js";import"./index-C8BdbktQ.js";import"./ShortListMain-CkHPlJB3.js";import"./vendorAccApi-m3R96_-K.js";import"./useInfiniteQuery-BGz0VllC.js";import"./dateFormator-BGKi5rfZ.js";const z=async({projectId:s,payload:r,api:t})=>{console.log("paylod from creating",r);const{data:a}=await t.post(`/inventory/create/${s}`,r);if(!a.ok)throw new Error(a.message);return a.data},ee=async({projectId:s,subItemId:r,payload:t,api:a})=>{console.log("paylod from updating",t);const{data:o}=await a.put(`/inventory/update/${s}/${r}`,t);if(!o.ok)throw new Error(o.message);return o.data},te=async({projectId:s,subItemId:r,api:t})=>{const{data:a}=await t.delete(`/inventory/delete/${s}/${r}`);if(!a.ok)throw new Error(a.message);return a.data},re=async({projectId:s,api:r})=>{const{data:t}=await r.get(`/inventory/get/${s}`);if(!t.ok)throw new Error(t.message);return t.data},ae=()=>{const s=["owner","staff","CTO"],{role:r}=Q(),t=S(r);return $({mutationFn:async({projectId:a,payload:o})=>{if(!r||!s.includes(r))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await z({projectId:a,payload:o,api:t})},onSuccess:(a,{projectId:o})=>{k.invalidateQueries({queryKey:["inventory",o]})}})},ne=()=>{const s=["owner","staff","CTO"],{role:r}=Q(),t=S(r);return $({mutationFn:async({projectId:a,subItemId:o,payload:u})=>{if(!r||!s.includes(r))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await ee({projectId:a,subItemId:o,payload:u,api:t})},onSuccess:(a,{projectId:o})=>{k.invalidateQueries({queryKey:["inventory",o]})}})},se=()=>{const s=["owner","staff","CTO"],{role:r}=Q(),t=S(r);return $({mutationFn:async({projectId:a,subItemId:o})=>{if(!r||!s.includes(r))throw new Error("not allowed to make this api call");if(!t)throw new Error("API instance not found for role");return await te({projectId:a,subItemId:o,api:t})},onSuccess:(a,{projectId:o})=>{k.invalidateQueries({queryKey:["inventory",o]})}})},oe=s=>{const r=["owner","staff","CTO","worker"],{role:t}=Q(),a=S(t);return H({queryKey:["inventory",s],queryFn:async()=>{if(!t||!r.includes(t))throw new Error("not allowed to make this api call");if(!a)throw new Error("API instance not found for role");return await re({projectId:s,api:a})},enabled:!!s&&!!t,retry:!1})},ie=async({organizationId:s,projectId:r,api:t})=>{const{data:a}=await t.put(`/recyclematerial/updaterecyclemanually/${s}/${r}`);if(!a.ok)throw new Error(a.message);return a.data},le=async({organizationId:s,projectId:r,itemId:t,quantity:a,api:o})=>{const{data:u}=await o.patch(`/recyclematerial/updatequantity/${s}/${r}/${t}`,{quantity:a});if(!u.ok)throw new Error(u.message);return u.data},ce=async({organizationId:s,projectId:r,api:t})=>{const{data:a}=await t.get(`/recyclematerial/getsingleprojectmaterial/${s}/${r}`);if(!a.ok)throw new Error(a.message);return a.data},de=()=>{const s=["owner","staff","CTO"],{role:r}=Q(),t=S(r);return $({mutationFn:async({organizationId:a,projectId:o})=>{if(!r||!s.includes(r))throw new Error("Not allowed to make this API call");if(!t)throw new Error("API instance not found for role");return await ie({organizationId:a,projectId:o,api:t})},onSuccess:(a,{projectId:o,organizationId:u})=>{k.invalidateQueries({queryKey:["recycle-materials",u,o]}),k.invalidateQueries({queryKey:["recycle-materials","global",u]})}})},ue=()=>{const s=["owner","staff","CTO"],{role:r}=Q(),t=S(r);return $({mutationFn:async({organizationId:a,projectId:o,itemId:u,quantity:P})=>{if(!r||!s.includes(r))throw new Error("Not allowed to make this API call");if(!t)throw new Error("API instance not found for role");return await le({organizationId:a,projectId:o,quantity:P,itemId:u,api:t})},onSuccess:(a,{projectId:o,organizationId:u})=>{k.invalidateQueries({queryKey:["recycle-materials",u,o]}),k.invalidateQueries({queryKey:["recycle-materials","global",u]})}})},me=(s,r)=>{const t=["owner","staff","CTO","worker"],{role:a}=Q(),o=S(a);return H({queryKey:["recycle-materials",s,r],queryFn:async()=>{if(!a||!t.includes(a))throw new Error("Not allowed to make this API call");if(!o)throw new Error("API instance not found for role");return await ce({organizationId:s,projectId:r,api:o})},enabled:!!s&&!!r&&!!o})},ye=()=>{var m,c,E,w,j,N;const{projectId:s,organizationId:r}=J(),{data:t,isLoading:a,error:o,refetch:u}=me(r,s),{mutateAsync:P,isPending:D}=de(),{mutateAsync:K}=ue(),{role:O,permission:v}=W(),C=O==="owner"||((m=v==null?void 0:v.inventory)==null?void 0:m.create),_=O==="owner"||((c=v==null?void 0:v.inventory)==null?void 0:c.edit),[b,M]=q.useState(null),A=d=>{(C||_)&&M(d)},R=async()=>{var d,p;try{await P({organizationId:r,projectId:s}),f({title:"Success",description:"Sync successfull."})}catch(g){f({title:"Error",description:((p=(d=g==null?void 0:g.response)==null?void 0:d.data)==null?void 0:p.message)||g.message||"Failed to update material",variant:"destructive"})}},l=async(d,p)=>{var g,F;try{await K({organizationId:r,projectId:s,itemId:d,quantity:p}),f({title:"Success",description:"Updated successfully."})}catch(I){f({title:"Error",description:((F=(g=I==null?void 0:I.response)==null?void 0:g.data)==null?void 0:F.message)||I.message||"Failed to update material",variant:"destructive"})}};return console.log("daata",t),o&&((w=(E=o==null?void 0:o.response)==null?void 0:E.data)!=null&&w.message,U),e.jsxs("div",{className:"max-w-full w-full mx-auto bg-white border border-blue-200 rounded-lg shadow-sm px-6 py-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 ",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-700  flex items-center gap-2",children:[e.jsx("i",{className:"fas fa-recycle text-blue-600"}),"Project Recycled Materials"]}),(C||_)&&e.jsx(U,{isLoading:D,onClick:R,children:"Sync Recycle Materiasl"})]}),a?e.jsx("p",{className:"text-gray-500",children:e.jsx(X,{})}):t===null||((j=t==null?void 0:t.subItems)==null?void 0:j.length)==0?e.jsx("div",{className:"h-30  flex justify-center items-center",children:e.jsx("p",{className:"text-gray-500",children:"No recycled materials found for this project."})}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-0 bg-gray-100 border-b border-gray-200",children:[e.jsx("div",{className:" px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Material Name"}),e.jsx("div",{className:" px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Remaining Quantity"})]}),(N=t==null?void 0:t.subItems)==null?void 0:N.map(d=>e.jsxs("div",{className:"grid grid-cols-2 gap-0 border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("div",{className:"border-r border-gray-200 px-4 py-3 hover:bg-blue-50 transition-colors",children:d.itemName}),e.jsx("div",{className:" border-r border-gray-200",children:b===d._id?e.jsx("input",{type:"number",defaultValue:d.remainingQuantity,min:"0",autoFocus:!0,className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:p=>{l(d._id,+p.target.value),M(null)},onKeyDown:p=>{p.key==="Enter"&&(l(d._id,+p.target.value),M(null)),p.key==="Escape"&&M(null)}}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>A(d._id),children:d.remainingQuantity})})]},d._id))]})]})},Ae=()=>{var g,F,I;const{projectId:s,organizationId:r}=J(),{data:t,isLoading:a,isError:o,error:u}=oe(s),P=ae(),D=ne(),K=se(),{isMobile:O,openMobileSidebar:v,projectName:C}=Y(),{role:_,permission:b}=W(),M=_==="owner"||((g=b==null?void 0:b.inventory)==null?void 0:g.delete),A=_==="owner"||((F=b==null?void 0:b.inventory)==null?void 0:F.create),R=_==="owner"||((I=b==null?void 0:b.inventory)==null?void 0:I.edit),[l,m]=q.useState(null),[c,E]=q.useState({name:"",totalQuantity:1,unit:""}),w=q.useRef(null),j=(t==null?void 0:t.subItems)||[];q.useEffect(()=>{l&&w.current&&(w.current.focus(),w.current.select())},[l]);const N=async(n,i,y)=>{var x,T,B,L,G;try{await D.mutateAsync({projectId:s,subItemId:n,payload:{itemName:i==="name"?y:(x=j.find(h=>h._id===n))==null?void 0:x.itemName,totalQuantity:i==="totalQuantity"?Number(y)?Number(y):1:(T=j.find(h=>h._id===n))==null?void 0:T.totalQuantity,unit:i==="unit"?y:(B=j.find(h=>h._id===n))==null?void 0:B.unit,note:""}}),f({title:"Success",description:"Item updated successfully"})}catch(h){f({title:"Error",description:((G=(L=h==null?void 0:h.response)==null?void 0:L.data)==null?void 0:G.message)||"Failed to update item",variant:"destructive"})}},d=async n=>{var i,y;if(!A||!R){f({description:"you dont have the permission to edit or create",variant:"destructive",title:"Error"});return}if(!n.name.trim()||!n.unit)return f({title:"Error",description:"Material Name and Unit are mandatory",variant:"destructive"});try{const{name:x,...T}=n;await P.mutateAsync({projectId:s,payload:{...T,itemName:x,note:""}}),E({name:"",totalQuantity:1,unit:""}),f({title:"Success",description:"Item created successfully"})}catch(x){f({title:"Error",description:((y=(i=x==null?void 0:x.response)==null?void 0:i.data)==null?void 0:y.message)||"Failed to create item",variant:"destructive"})}},p=async n=>{var i,y;try{await K.mutateAsync({projectId:s,subItemId:n}),f({title:"Success",description:"Item deleted successfully"})}catch(x){f({title:"Error",description:((y=(i=x==null?void 0:x.response)==null?void 0:i.data)==null?void 0:y.message)||"Failed to delete item",variant:"destructive"})}};return a?e.jsx("div",{children:e.jsx(X,{})}):o?e.jsxs("div",{children:["Error: ",u.message]}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"w-full max-h-full overflow-y-auto flex flex-col p-2 min-h-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-semibold mb-1 text-blue-600 flex items-center",children:[O&&e.jsx("button",{onClick:v,className:"mr-3 p-2 rounded-md border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fa-solid fa-boxes-stacked mr-2"}),"Inventory Items ",C?`for ${C}`:""]}),e.jsx("p",{className:"text-gray-400",children:"Manage and track project materials in one place"})]}),e.jsx("div",{className:"w-full sm:w-auto flex justify-end sm:block",children:e.jsx(Z,{organizationId:r,stageName:"inventory"})})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("i",{className:"fa-solid fa-list text-blue-600"}),e.jsx("h4",{className:"font-semibold text-gray-800",children:"Material Items"}),e.jsx("span",{className:"text-sm text-gray-500",children:"(Click to edit, changes save by clicking Enter)"})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-gray-100 border-b border-gray-200",children:[e.jsx("div",{className:"col-span-8 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Material Name"}),e.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Total Quantity"}),e.jsx("div",{className:"col-span-2 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Remaining Quantity"}),e.jsx("div",{className:"col-span-3 px-4 py-3 text-sm font-medium text-gray-700 border-r border-gray-200",children:"Unit"}),e.jsx("div",{className:"col-span-1 px-4 py-3 text-sm font-medium text-gray-700",children:"Action"})]}),j.map(n=>e.jsxs("div",{className:"grid grid-cols-17 gap-0 border-b border-gray-100 hover:bg-gray-50",children:[e.jsx("div",{className:"col-span-8 border-r border-gray-200",children:(l==null?void 0:l.subItemId)===n._id&&(l==null?void 0:l.field)==="name"?e.jsx("input",{ref:w,type:"text",defaultValue:n.itemName,className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:i=>{var y;(y=c==null?void 0:c.name)!=null&&y.trim()&&(c!=null&&c.unit)&&N(n._id,"name",i.target.value),m(null)},onKeyDown:i=>{i.key==="Enter"&&(N(n._id,"name",i.target.value),m(null)),i.key==="Escape"&&m(null)}}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{(R||A)&&m({subItemId:n._id,field:"name"})},children:n.itemName})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:(l==null?void 0:l.subItemId)===n._id&&(l==null?void 0:l.field)==="totalQuantity"?e.jsx("input",{ref:w,type:"number",defaultValue:n.totalQuantity,min:"0",className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",onBlur:i=>{N(n._id,"totalQuantity",i.target.value),m(null)},onKeyDown:i=>{i.key==="Enter"&&(N(n._id,"totalQuantity",i.target.value),m(null)),i.key==="Escape"&&m(null)}}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{(R||A)&&m({subItemId:n._id,field:"totalQuantity"})},children:n.totalQuantity})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>m({subItemId:n._id,field:"totalQuantity"}),children:n.remainingQuantity})}),e.jsx("div",{className:"col-span-3 border-r border-gray-200",children:(l==null?void 0:l.subItemId)===n._id&&(l==null?void 0:l.field)==="unit"?e.jsxs("select",{defaultValue:n.unit,onChange:i=>{N(n._id,"unit",i.target.value),m(null)},className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",children:[e.jsx("option",{value:"",disabled:!0,children:"Selected unit"}),V.map(i=>e.jsx("option",{value:i,children:i},i))]}):e.jsx("div",{className:"px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors",onClick:()=>{(R||A)&&m({subItemId:n._id,field:"unit"})},children:n.unit})}),e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:M&&e.jsx(U,{variant:"danger",isLoading:K.isPending,onClick:()=>p(n._id),className:"p-2 bg-red-600 text-white hover:bg-red-50 rounded transition-colors",title:"Delete item",children:e.jsx("i",{className:"fa fa-trash text-sm"})})})]},n._id)),e.jsxs("div",{className:"grid grid-cols-17 gap-0 bg-green-50 border-b border-gray-100",children:[e.jsx("div",{className:"col-span-8 border-r border-gray-200",children:e.jsx("input",{type:"text",placeholder:"Enter material name...",value:c.name,onChange:n=>E({...c,name:n.target.value}),onBlur:()=>{c.name.trim()&&c.unit&&d(c)},onKeyDown:n=>{n.key==="Enter"&&d(c)},className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("input",{type:"number",placeholder:"Qty",min:"0",value:c.totalQuantity,onChange:n=>E({...c,totalQuantity:Number(n.target.value)||0}),className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-2 border-r border-gray-200",children:e.jsx("input",{type:"number",placeholder:"Remaining Quanitity",disabled:!0,min:"0",value:c.totalQuantity,className:"w-full px-4 py-3 bg-transparent border-none outline-none placeholder-gray-400"})}),e.jsx("div",{className:"col-span-3 border-r border-gray-200",children:e.jsxs("select",{value:c.unit,onChange:async n=>{E({...c,unit:n.target.value});const i={...c,unit:n.target.value};await d(i)},className:"w-full px-4 py-3 border-none outline-none focus:bg-blue-50",children:[e.jsx("option",{value:"",disabled:!0,children:"Selected unit"}),V.map(n=>e.jsx("option",{value:n,children:n},n))]})})]}),j.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-inbox text-2xl mb-2"}),e.jsx("p",{className:"text-sm",children:"No sub-items yet. Start typing in the row above to add items."})]})]})]}),e.jsx("section",{className:"mt-4",children:e.jsx(ye,{})})]})})};export{Ae as default};
