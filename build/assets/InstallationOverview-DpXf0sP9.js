import{f,b as B,h as y,g as V,s as L,i as h,u as U,d as W,a as Y,af as z,k as H,j as e,M as J,O as X,B as R,t as g}from"./index-BAM0eJUz.js";import{R as Z}from"./ResetStageButton-DaUxSSZv.js";import{C as F}from"./Card-CdxfjEr-.js";import{A as ee,S as se}from"./AssignStaff-Bt6qrEbL.js";import{S as te,a as ae,b as le,c as ne,d as j}from"./Select-C6lfB9t-.js";import{I as ie}from"./ImageGalleryMain-B3g6b13d.js";import{S as re}from"./StageGuide-e28gQ0h1.js";import"./Input-1UBXZqEj.js";import"./getAllUsersApi-O0JEgRtZ.js";import"./downloadFile-BbGV_BaX.js";import"./index-C8BdbktQ.js";import"./ShortListMain-CkHPlJB3.js";const oe=async(t,a,s,r)=>{const{data:i}=await r.put(`/installation/${t}/${a}/status`,{status:s});if(!i.ok)throw new Error(i.message);return i.data},ce=async(t,a)=>{const{data:s}=await a.get(`/installation/${t}/getalldetail`);if(!s.ok)throw new Error(s.message);return s.data},de=t=>{const a=["CTO","owner","staff","worker","client"],{role:s}=f(),r=h(s);return B({queryKey:["installation-details",t],queryFn:async()=>{if(!s||!a.includes(s))throw new Error("Not allowed to make this API call.");if(!r)throw new Error("API instance not found.");return await ce(t,r)},enabled:!!s&&!!t&&!!r,retry:!1,refetchOnMount:!1})},me=()=>{const t=["CTO","owner","staff","worker"],{role:a}=f(),s=h(a),r=V();return y({mutationFn:async({projectId:i,taskId:c,status:p})=>{if(!a||!t.includes(a))throw new Error("Not allowed to make this API call.");if(!s)throw new Error("API instance not found.");return await oe(i,c,p,s)},onSuccess:(i,{projectId:c})=>{r.invalidateQueries({queryKey:["installation-details",c]})}})},ue=async({formId:t,projectId:a,deadLine:s,api:r})=>{const{data:i}=await r.put(`/installation/deadline/${a}/${t}`,{deadLine:s});if(!i.ok)throw new Error(i.message);return i.data},xe=async({projectId:t,api:a})=>{const{data:s}=await a.put(`/installation/completionstatus/${t}`);if(!s.ok)throw new Error(s.message);return s.data},ge=()=>{const t=["owner","staff","CTO"],{role:a}=f(),s=h(a);return y({mutationFn:async({formId:r,projectId:i,deadLine:c})=>{if(!a||!t.includes(a))throw new Error("not allowed to make this api call");if(!s)throw new Error("API instance missing");return await ue({formId:r,projectId:i,deadLine:c,api:s})},onSuccess:(r,{projectId:i})=>{L.invalidateQueries({queryKey:["installation-details",i]})}})},fe=()=>{const t=["owner","staff","CTO"],{role:a}=f(),s=h(a);return y({mutationFn:async({projectId:r})=>{if(!a||!t.includes(a))throw new Error("not allowed to make this api call");if(!s)throw new Error("API instance missing");return await xe({projectId:r,api:s})},onSuccess:(r,{projectId:i})=>{L.invalidateQueries({queryKey:["installation-details",i]})}})};function Pe(){var A,P,E,k,O,T,M;const{projectId:t,organizationId:a}=U(),s=W(),r=Y(),{isMobile:i,openMobileSidebar:c}=z(),p=s.pathname.includes("/installationroom"),{role:N,permission:m}=H(),v=N==="owner"||((A=m==null?void 0:m.installation)==null?void 0:A.create),S=N==="owner"||((P=m==null?void 0:m.installation)==null?void 0:P.edit),{data:l,isLoading:I,isError:q,refetch:w,error:u}=de(t),{mutateAsync:$,isPending:G}=fe(),{mutateAsync:Q,isPending:_}=ge(),D=async()=>{var n,d;try{await $({projectId:t}),g({title:"Success",description:"Completion status updated successfully"}),r("../qualitycheck")}catch(o){g({title:"Error",description:((d=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:d.message)||o.message||"Failed to update status",variant:"destructive"})}},C=me(),K=async(n,d)=>{var o,x;try{await C.mutateAsync({projectId:t,taskId:n,status:d}),g({title:"Success",description:"Task status updated successfully"}),w()}catch(b){g({title:"Error",description:((x=(o=b==null?void 0:b.response)==null?void 0:o.data)==null?void 0:x.message)||"Failed to update task status",variant:"destructive"})}};return I?e.jsx(J,{}):e.jsx("main",{className:"w-full overflow-y-auto h-full",children:p?e.jsx(X,{}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6",children:[e.jsxs("h2",{className:"text-2xl sm:text-3xl font-semibold text-blue-600 flex items-center",children:[i&&e.jsx("button",{onClick:c,className:"mr-3 p-2 rounded-md border border-gray-300 hover:bg-gray-100",title:"Open Menu",children:e.jsx("i",{className:"fa-solid fa-bars"})}),e.jsx("i",{className:"fas fa-tools mr-2"})," Installation Overview"]}),(S||v)&&e.jsxs("div",{className:"w-full sm:w-auto flex flex-col sm:flex-row gap-2",children:[e.jsxs(R,{isLoading:G,onClick:D,className:"bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto",children:[e.jsx("i",{className:"fa-solid fa-circle-check mr-2"}),"Mark Complete"]}),e.jsx(Z,{projectId:t,stageNumber:11,stagePath:"installation",className:"w-full sm:w-auto"}),e.jsx(ee,{stageName:"InstallationModel",projectId:t,organizationId:a,currentAssignedStaff:(l==null?void 0:l.assignedTo)||null,className:"w-full sm:w-auto"})]}),e.jsx("div",{className:"w-full sm:w-auto flex justify-end sm:block",children:e.jsx(re,{organizationId:a,stageName:"installation"})})]}),q?e.jsxs("div",{className:"max-w-xl mx-auto p-6 bg-red-50 border border-red-200 rounded-lg shadow text-center",children:[e.jsx("div",{className:"text-red-600 text-xl font-semibold mb-2",children:"⚠️ Oops! An Error Occurred"}),e.jsx("p",{className:"text-red-500 text-sm mb-4",children:((k=(E=u==null?void 0:u.response)==null?void 0:E.data)==null?void 0:k.message)||(u==null?void 0:u.message)||"Something went wrong"}),e.jsx(R,{isLoading:I,onClick:()=>w(),className:"bg-red-600 text-white hover:bg-red-700",children:"Retry"})]}):l&&e.jsxs(e.Fragment,{children:[e.jsxs(F,{className:"p-4 mb-6 w-full shadow border-l-4 border-blue-600 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-sm font-medium mb-2",children:[e.jsx("i",{className:"fa-solid fa-clock text-blue-500 text-lg"}),e.jsx("span",{children:"Stage Timings"})]}),e.jsx(se,{completedAt:(O=l==null?void 0:l.timer)==null?void 0:O.completedAt,stageName:"installation",projectId:t,formId:l==null?void 0:l._id,deadLine:(T=l==null?void 0:l.timer)==null?void 0:T.deadLine,startedAt:(M=l==null?void 0:l.timer)==null?void 0:M.startedAt,refetchStageMutate:w,deadLineMutate:Q,isPending:_})]}),l!=null&&l.tasks&&(l==null?void 0:l.tasks.length)>0?e.jsxs(F,{className:"p-2 mb-6 w-full shadow  bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3 text-blue-700 text-lg font-semibold mb-6",children:[e.jsx("i",{className:"fa-solid fa-images text-blue-500 text-xl"}),e.jsx("span",{children:"Installation Progress Gallery"})]}),e.jsx("div",{className:"space-y-8",children:l.tasks.map((n,d)=>{var o;return e.jsxs("div",{className:"p-3 border-b-1 border-b-gray-300 border-l-4 border-blue-600 rounded-2xl pb-6 last:border-b-0 last:pb-0",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("i",{className:"fa-solid fa-hammer text-blue-600 text-sm"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:n.workName||`Installation Task ${d+1}`}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${n.status==="completed"?"bg-green-100 text-green-800":n.status==="pending"?"bg-yellow-100 text-yellow-800":n.status==="inprogress"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:n.status}),e.jsxs("span",{className:"text-sm text-gray-500",children:[n.images.length," image",n.images.length!==1?"s":""]})]})]})]}),(v||S)&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Update Status"}),e.jsxs(te,{onValueChange:x=>K(n._id,x),value:n.status||"",children:[e.jsx(ae,{className:"w-40 rounded-xl border-gray-200 focus:ring-2 focus:ring-blue-500 bg-white",children:e.jsx(le,{placeholder:"Select status",selectedValue:n.status||""})}),e.jsxs(ne,{className:"!min-w-[120px] border-black",children:[e.jsx(j,{value:"pending",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-yellow-500 rounded-full"}),"Pending"]})}),e.jsx(j,{value:"inprogress",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full"}),"In Progress"]})}),e.jsx(j,{value:"submitted",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-500 rounded-full"}),"Submitted"]})})]})]})]}),C.isPending&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"})})]})]}),e.jsx("h2",{className:"text-lg text-gray-500 font-semibold ",children:"Images"}),e.jsx(ie,{imageFiles:n==null?void 0:n.images,height:80,minWidth:98,maxWidth:100}),((o=n==null?void 0:n.images)==null?void 0:o.length)===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-image text-3xl mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No images uploaded for this task yet"})]})]},d)})}),l.tasks.every(n=>!n.images||n.images.length===0)&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-images text-4xl mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Installation Images Yet"}),e.jsx("p",{className:"text-sm",children:"Images will appear here once they are uploaded to installation tasks"})]})]}):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("i",{className:"fa-solid fa-images text-4xl mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Installation Images Yet"}),e.jsx("p",{className:"text-sm",children:"Images will appear here once they are uploaded to installation tasks"})]})]})]})})}export{Pe as default};
