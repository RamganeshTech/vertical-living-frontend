import{g as w,h as E,K as Q,L as $,M as D,N as I,P as K,Q as U,T as M,b as Y,r as f,j as e}from"./index-Dkf7SbMA.js";import{u as V}from"./useQuery-h0LZ4b8f.js";import{u as k}from"./useMutation-DtRxugN4.js";import{g as y}from"./roleCheck-CXq1v0D5.js";import{t as b}from"./toast-BSC5QTk1.js";const W=async({organizationId:a,stageName:s,api:r})=>{const{data:t}=await r.get(`/guideline/${a}/${s}`);if(!t.ok)throw new Error(t.message);return t.data},B=async({organizationId:a,stageName:s,tipText:r,tipId:t,api:o})=>{const i={organizationId:a,stageName:s,tipText:r,tipId:t},{data:l}=await o.post("/guideline",i);if(!l.ok)throw new Error(l.message);return l.data},H=async({organizationId:a,stageName:s,tipId:r,api:t})=>{const{data:o}=await t.delete("/guideline/delete",{data:{organizationId:a,stageName:s,tipId:r}});if(!o.ok)throw new Error(o.message);return o},J=async({isGuideRequired:a,organizationId:s,api:r})=>{const{data:t}=await r.patch(`/guideline/preference/${s}`,{isGuideRequired:a});if(!t.ok)throw new Error(t.message);return t},X=(a,s)=>{const{role:r}=w(),t=y(r);return V({queryKey:["guidelines",a,s],queryFn:async()=>{if(!t)throw new Error("API instance not found");return await W({organizationId:a,stageName:s,api:t})},enabled:!!a&&!!s&&!!t})},Z=()=>{const a=["owner","CTO"],{role:s}=w(),r=y(s),t=E();return k({mutationFn:async({organizationId:o,stageName:i,tipText:l,tipId:p})=>{if(!s||!a.includes(s))throw new Error("You are not authorized to add or update tips.");if(!r)throw new Error("API instance not found");return await B({organizationId:o,stageName:i,tipText:l,tipId:p,api:r})},onSuccess:(o,{organizationId:i,stageName:l})=>{t.invalidateQueries({queryKey:["guidelines",i,l]})}})},z=()=>{const a=["owner"],{role:s}=w(),r=y(s),t=E();return k({mutationFn:async({organizationId:o,stageName:i,tipId:l})=>{if(!s||!a.includes(s))throw new Error("You are not authorized to delete tips.");if(!r)throw new Error("API instance not found");return await H({organizationId:o,stageName:i,tipId:l,api:r})},onSuccess:(o,{organizationId:i,stageName:l})=>{t.invalidateQueries({queryKey:["guidelines",i,l]})}})},ee=()=>{const{role:a}=w(),s=y(a),r=Q();return k({mutationFn:async({isGuideRequired:t,organizationId:o})=>{if(!a)throw new Error("Role not found");if(!s)throw new Error("API not found");return await J({isGuideRequired:t,organizationId:o,api:s})},onSuccess:(t,o)=>{const i=o.isGuideRequired;switch(a){case"owner":r(U(i));break;case"CTO":r(K(i));break;case"staff":r(I(i));break;case"worker":r(D(i));break;case"client":r($(i));break}r(M(i))}})},ne=({organizationId:a,stageName:s})=>{var T;const{role:r,isGuideRequired:t,loading:o}=Y();if(r==="client")return null;const i=r==="owner"||r==="CTO",[l,p]=f.useState(!1),[C,x]=f.useState(!1),[j,m]=f.useState(""),[G,v]=f.useState(null),{data:u,isLoading:g,refetch:A}=X(a,s),{mutate:R,isPending:S}=Z(),{mutateAsync:F}=z(),{mutateAsync:q}=ee(),N=f.useRef(null);f.useEffect(()=>{if(!u||o||g)return;const n=u.guidelines&&u.guidelines.length>0;t!==void 0&&t===!0&&(n||i)&&p(!0)},[u,t,i,o,g]),f.useEffect(()=>{function n(c){l&&N.current&&!N.current.contains(c.target)&&p(!1)}return document.addEventListener("mousedown",n),()=>{document.removeEventListener("mousedown",n)}},[l]);const P=()=>{j.trim()&&R({organizationId:a,stageName:s,tipText:j,tipId:G||void 0},{onSuccess:()=>{m(""),v(null),x(!1)}})},O=n=>{m(n.tips),v(n._id),x(!0)},L=async n=>{var c,d;try{await F({organizationId:a,stageName:s,tipId:n}),A(),b({description:"deleted successfully",title:"Success"})}catch(h){b({title:"Error",description:((d=(c=h==null?void 0:h.response)==null?void 0:c.data)==null?void 0:d.message)||(h==null?void 0:h.message)||" Failed to delete",variant:"destructive"})}},_=async()=>{var n,c;try{console.log("isGuideRequired",t),console.log("!isGuideRequired",!t),await q({isGuideRequired:!t,organizationId:a}),b({description:"updated successfully",title:"Success"})}catch(d){b({title:"Error",description:((c=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:c.message)||(d==null?void 0:d.message)||" Failed to update",variant:"destructive"})}};return e.jsxs("div",{ref:N,className:"relative  z-50 font-sans",children:[e.jsx("button",{onClick:()=>p(!l),className:`flex items-center !cursor-pointer justify-center w-9 h-9 rounded-full transition-all shadow-md 
                ${l?"bg-blue-600 text-white rotate-180":"bg-white text-blue-600 hover:bg-blue-50"}`,title:"Stage Guidelines",children:e.jsx("i",{className:`fa-solid ${l?"fa-times":"fa-lightbulb"} text-lg`})}),l&&e.jsxs("div",{className:"absolute top-12 right-0 w-80 max-w-[calc(100vw-20px)] bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden animate-fade-in-up origin-top-right",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-blue-500 p-3 px-4 flex justify-between items-center text-white shadow-sm",children:[e.jsxs("h4",{className:"font-bold text-sm flex items-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-book-open"}),e.jsx("span",{children:"Stage Guidelines"})]}),e.jsx("button",{onClick:()=>p(!1),className:"text-white/80 cursor-pointer hover:text-white transition-colors",children:e.jsx("i",{className:"fa-solid fa-times text-sm"})})]}),e.jsxs("div",{className:"p-4 max-h-[60vh] overflow-y-auto custom-scrollbar bg-gray-50/50",children:[g&&e.jsxs("div",{className:"text-center text-gray-400 py-2",children:[e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin mr-2"})," Loading..."]}),e.jsx("div",{className:"space-y-3",children:((T=u==null?void 0:u.guidelines)==null?void 0:T.length)>0?u.guidelines.map((n,c)=>e.jsxs("div",{className:"bg-white p-3 rounded-lg border border-gray-100 shadow-sm group relative hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"mt-0.5",children:e.jsx("i",{className:"fa-solid fa-info-circle text-blue-500 text-sm"})}),e.jsx("p",{className:"text-sm text-gray-700 leading-relaxed break-words w-full",children:n.tips})]}),i&&e.jsxs("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white pl-1 rounded",children:[e.jsx("button",{onClick:()=>O(n),className:"w-6 h-6 flex items-center justify-center rounded-full hover:bg-blue-50 text-blue-600 transition-colors",title:"Edit",children:e.jsx("i",{className:"fa-solid fa-pen text-xs"})}),e.jsx("button",{onClick:()=>L(n._id),className:"w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 text-red-500 transition-colors",title:"Delete",children:e.jsx("i",{className:"fa-solid fa-trash text-xs"})})]})]},n._id||c)):!g&&e.jsxs("div",{className:"text-center py-6 flex flex-col items-center text-gray-400",children:[e.jsx("i",{className:"fa-regular fa-clipboard text-2xl mb-2 opacity-50"}),e.jsx("p",{className:"text-xs",children:"No tips added for this stage yet."})]})}),i&&e.jsx("div",{className:"mt-4 pt-3 border-t border-gray-200",children:C?e.jsxs("div",{className:"space-y-2 bg-white p-2 rounded border border-blue-100",children:[e.jsx("textarea",{value:j,onChange:n=>m(n.target.value),placeholder:"Enter tip guidelines...",className:"w-full text-sm p-2 border border-gray-200 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none",rows:3,autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{x(!1),m(""),v(null)},className:"text-xs text-gray-500 hover:text-gray-700 px-3 py-1.5",children:"Cancel"}),e.jsx("button",{onClick:P,disabled:S,className:"text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 flex items-center gap-1 shadow-sm transition-transform active:scale-95",children:S?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fa-solid fa-circle-notch fa-spin"})," Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fa-solid fa-check"})," Save Tip"]})})]})]}):e.jsxs("button",{onClick:()=>x(!0),className:"w-full py-2.5 border border-dashed border-gray-300 rounded-lg text-xs font-medium text-gray-500 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all flex items-center justify-center gap-2",children:[e.jsx("i",{className:"fa-solid fa-plus"})," Add New Guideline"]})})]}),e.jsx("div",{className:"bg-gray-100/80 p-3 border-t border-gray-200 flex items-center justify-between backdrop-blur-sm",children:e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer group w-full",children:[e.jsxs("div",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:!t,onChange:_}),e.jsx("div",{className:`w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer \r
                                    peer-checked:after:translate-x-full peer-checked:after:border-white \r
                                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] \r
                                    after:bg-white after:border-gray-300 after:border after:rounded-full \r
                                    after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600`})]}),e.jsx("span",{className:"text-[11px] text-gray-600 font-medium group-hover:text-blue-700 transition-colors select-none",children:"Don't show automatically"})]})})]})]})};export{ne as S};
