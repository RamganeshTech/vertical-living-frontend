import{r as i,b as ae,j as e}from"./index-Dkf7SbMA.js";import{C as S,a as A,b as G,d as H}from"./Card-BI-_ii1r.js";import{B as p}from"./Button-ClgICMLF.js";import{L as x}from"./Label-DXAdVnik.js";import{I as y}from"./Input-BRDEoxOp.js";import{u as le}from"./projectApi-DzFbt4lZ.js";import{S as oe}from"./SearchSelectNew-DPrs09Io.js";import{I as R}from"./ImageGalleryMain-DWzO9-7s.js";import{t as m}from"./toast-BSC5QTk1.js";import{e as ce,f as ne,g as de}from"./subContractNewApi-CzH8jLWx.js";const Ce=({organizationId:V,mode:o,initialData:t,onSubmit:b,isLoading:j,onCancel:I,refetch:c})=>{var T,L,_,M;const[f,g]=i.useState(o==="create"),[n,u]=i.useState({projectId:"",projectName:"",workerName:"",workName:"",dateOfCommencement:"",dateOfCompletion:"",labourCost:0,materialCost:0,totalCost:0,filesBeforeWork:[],filesAfterWork:[]}),{role:$,permission:k}=ae(),q=$==="owner"||((T=k==null?void 0:k.subcontract)==null?void 0:T.edit),[B,z]=i.useState({}),{data:J}=le(V),h=(L=J||[])==null?void 0:L.map(s=>({value:s._id,label:s.projectName})),v=i.useCallback(()=>{var s,a;o!=="create"&&t&&u({projectId:((s=t.projectId)==null?void 0:s._id)||"",projectName:((a=t.projectId)==null?void 0:a.projectName)||"",workName:t.workName||"",workerName:t.workerName||"",dateOfCommencement:t.dateOfCommencement?new Date(t.dateOfCommencement).toISOString().split("T")[0]:"",dateOfCompletion:t.dateOfCompletion?new Date(t.dateOfCompletion).toISOString().split("T")[0]:"",labourCost:t.labourCost||0,materialCost:t.materialCost||0,totalCost:t.totalCost||0,filesBeforeWork:[],filesAfterWork:[]})},[t,o]);i.useEffect(()=>{v()},[v]);const[F,U]=i.useState([]),[w,O]=i.useState([]),N=ce(),C=ne(),{mutateAsync:K,isPending:P}=de(),Q=async()=>{var s,a;try{if(w.length===0){m({title:"No files selected",description:"Please select at least one file to upload.",variant:"destructive"});return}await C.mutateAsync({subContractId:t==null?void 0:t._id,files:w}),c==null||c(),m({title:"Success",description:"After-work files uploaded successfully."}),O([])}catch(r){m({title:"Upload Error",description:((a=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:a.message)||(r==null?void 0:r.message)||"Failed to upload files.",variant:"destructive"})}},X=async()=>{var s,a;try{if(F.length===0){m({title:"Error",description:"Please upload at least one file",variant:"destructive"});return}await N.mutateAsync({subContractId:t==null?void 0:t._id,files:F}),c==null||c(),m({title:"Success",description:"Before work files uploaded successfully"}),U([])}catch(r){m({title:"Error",description:((a=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:a.message)||(r==null?void 0:r.message)||"Failed to upload files",variant:"destructive"})}},Y=async s=>{var a,r;try{s.preventDefault(),await K({subContractId:t==null?void 0:t._id,workerData:n}),c==null||c(),g(!1),m({title:"Success",description:"Updated successfully"})}catch(l){m({title:"Error",description:((r=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:r.message)||(l==null?void 0:l.message)||"Failed to upload files",variant:"destructive"})}},Z=s=>{const a=h==null?void 0:h.find(r=>r.value===s);u(r=>({...r,projectId:s||"",projectName:(a==null?void 0:a.label)||""}))},D=(s,a)=>{u(r=>{const l={...r,[s]:a};if(s==="labourCost"||s==="materialCost"){const W=Number(l.labourCost)||0,d=Number(l.materialCost)||0;l.totalCost=W+d}return l}),B[s]&&z(r=>({...r,[s]:""}))},ee=(s,a)=>{u(r=>({...r,[s]:[...r[s].filter(l=>typeof l=="string"),...a]}))},se=s=>{s.preventDefault(),b==null||b(n),u({projectId:"",projectName:"",workerName:"",workName:"",dateOfCommencement:"",dateOfCompletion:"",labourCost:0,materialCost:0,totalCost:0,filesBeforeWork:[],filesAfterWork:[]}),o==="view"&&g(!1)},E=()=>{o==="view"?(g(!1),v()):I&&I()},te=[{name:"workerName",label:"Worker Name",type:"text"},{name:"workName",label:"Work Name",type:"text"},{name:"dateOfCommencement",label:"Date of Commencement",type:"date"},{name:"dateOfCompletion",label:"Date of Completion",type:"date"},{name:"labourCost",label:"Labour Cost",type:"number"},{name:"materialCost",label:"Material Cost",type:"number"},{name:"totalCost",label:"Total Cost",type:"number"}];return e.jsx(S,{className:"w-full max-w-full !shadow-none",children:e.jsx(A,{className:"p-6",children:e.jsxs("form",{onSubmit:o==="create"?se:Y,children:[e.jsx("div",{children:o==="view"&&!f&&q&&e.jsxs("div",{className:"flex justify-between items-center mb-6 pb-4 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Contract Details"}),e.jsxs(p,{type:"button",variant:"outline",onClick:()=>g(!0),children:[e.jsx("i",{className:"fas fa-edit mr-2"}),"Edit Details"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:col-span-2 gap-x-8 gap-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Project"}),f?e.jsx(oe,{options:h,value:n.projectId||void 0,onValueChange:Z,placeholder:"Select a project..."}):e.jsx("p",{className:"text-gray-800 font-medium p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:n.projectName||"N/A"})]}),te.map(({name:s,label:a,type:r})=>{const l=s,W=s==="totalCost";return e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:s,children:a}),f?W?e.jsx("p",{className:"p-2 bg-gray-100 text-gray-900 rounded-md font-semibold",children:(n==null?void 0:n.totalCost)??0}):e.jsx(y,{id:s,type:r,value:n[l],onChange:d=>D(s,d.target.value),className:B[s]?"border-red-500":""}):e.jsx("p",{className:"text-gray-800 font-medium p-2 bg-gray-50 rounded-md min-h-[40px] flex items-center",children:(()=>{const d=n[l];return s.includes("date")&&typeof d=="string"?new Date(d).toLocaleDateString():Array.isArray(d)?d.map(re=>re.name).join(", ")||"No files":d||"N/A"})()})]},s)}),o==="create"&&e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3 pt-4",children:[e.jsx(x,{htmlFor:"filesBeforeWork",children:"Files Before Work"}),f&&e.jsx(y,{id:"filesBeforeWork",type:"file",multiple:!0,onChange:s=>ee("filesBeforeWork",Array.from(s.target.files||[]))})]}),f&&o==="view"&&e.jsxs("div",{className:"flex justify-end gap-4 pt-8 mt-4",children:[e.jsxs(p,{type:"button",variant:"outline",onClick:E,children:[e.jsx("i",{className:"fas fa-times mr-2"}),"Cancel"]}),e.jsx(p,{type:"submit",isLoading:j||P,children:j?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-save mr-2"}),"Save Changes"]})})]}),o!=="create"&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{className:"col-span-3 !shadow-xs",children:[e.jsx(G,{children:e.jsxs(H,{className:"flex items-center text-lg",children:[e.jsx("i",{className:"fas fa-camera-retro mr-3 text-purple-600"}),"Upload Before-Work Pictures"]})}),e.jsxs(A,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Before the work is getting started, upload pictures here."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"afterWorkUpload",children:"Select Files"}),e.jsx(y,{id:"beforeFiles",type:"file",multiple:!0,onChange:s=>U(Array.from(s.target.files||[]))})]}),(t==null?void 0:t.filesBeforeWork.some(s=>s.type==="image"))&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("i",{className:"fas fa-images text-purple-600"}),e.jsx("h4",{className:"font-semibold text-gray-800 text-sm",children:"Images"}),e.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full",children:t==null?void 0:t.filesBeforeWork.filter(s=>s.type==="image").length})]}),e.jsx(R,{imageFiles:(_=t==null?void 0:t.filesBeforeWork)==null?void 0:_.filter(s=>s.type==="image"),height:150,minWidth:150,maxWidth:200})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(p,{onClick:X,isLoading:N.isPending,disabled:N.isPending||F.length===0,children:N.isPending?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-2"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-cloud-upload-alt mr-2"}),"Upload Files"]})})})]})]}),e.jsxs(S,{className:"col-span-3 !shadow-xs",children:[e.jsx(G,{children:e.jsxs(H,{className:"flex items-center text-lg",children:[e.jsx("i",{className:"fas fa-camera-retro mr-3 text-purple-600"}),"Upload After-Work Pictures"]})}),e.jsxs(A,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Once the work is completed, upload pictures here for verification."}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"afterWorkUpload",children:"Select Files"}),e.jsx(y,{id:"afterWorkUpload",type:"file",multiple:!0,onChange:s=>O(Array.from(s.target.files||[]))})]}),(t==null?void 0:t.filesAfterWork.some(s=>s.type==="image"))&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("i",{className:"fas fa-images text-purple-600"}),e.jsx("h4",{className:"font-semibold text-gray-800 text-sm",children:"Images"}),e.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full",children:t==null?void 0:t.filesAfterWork.filter(s=>s.type==="image").length})]}),e.jsx(R,{imageFiles:(M=t==null?void 0:t.filesAfterWork)==null?void 0:M.filter(s=>s.type==="image"),height:150,minWidth:150,maxWidth:200})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(p,{onClick:Q,isLoading:C.isPending,disabled:C.isPending||w.length===0,children:C.isPending?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-2"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-cloud-upload-alt mr-2"}),"Upload Files"]})})})]})]})]})]}),f&&o==="create"&&e.jsxs("div",{className:"flex justify-end gap-4 pt-8 mt-4",children:[o!=="create"&&e.jsxs(p,{type:"button",variant:"outline",onClick:E,children:[e.jsx("i",{className:"fas fa-times mr-2"}),"Cancel"]}),e.jsx(p,{type:"submit",isLoading:j||P,children:j?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-2"}),o==="create"?"Creating...":"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:`fas ${o==="create"?"fa-check":"fa-save"} mr-2`}),o==="create"?"Create Contract":"Save Changes"]})})]})]})})})};export{Ce as S};
