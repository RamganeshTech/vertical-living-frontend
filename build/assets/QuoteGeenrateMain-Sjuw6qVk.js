import{q as F,F as Q,G as E,H as P,j as e,C as H,a as J,z as Y,A as W,B as b,t as v,u as _,r as N,g as O,M as X,S as Z,i as ee,k as te,l as ae,m as se}from"./index-CKvTvGhg.js";import{F as re}from"./FurnitureForm-e2KSNV0A.js";import{d as ne,e as le}from"./quoteVariantApi-Fh_le78z.js";const ie=async({api:s,organizationId:c,projectId:x,formData:m})=>{const{data:d}=await s.post(`/quote/quotegenerate/createquote/${c}/${x}`,m,{headers:{"Content-Type":"multipart/form-data"}});if(!d.ok)throw new Error(d.message||"Failed to create quote.");return d.data},oe=async({api:s,organizationId:c,id:x,projectId:m,formData:d})=>{const r=await s.put(`/quote/quotegenerate/editquote/${c}/${m}/${x}`,d);if(!r.data.ok)throw new Error(r.data.message||"Failed to create quote.");return r.data.data},ce=()=>{const s=["owner","staff","CTO"],{role:c}=F(),x=P(c);return Q({mutationFn:async({organizationId:m,projectId:d,formData:r})=>{if(!c||!s.includes(c))throw new Error("Not allowed to create quotes");if(!x)throw new Error("API instance for role not found");return await ie({api:x,organizationId:m,projectId:d,formData:r})},onSuccess:(m,{organizationId:d})=>{E.invalidateQueries({queryKey:["quote-material-items",d]})}})},de=()=>{const s=["owner","staff","CTO"],{role:c}=F(),x=P(c);return Q({mutationFn:async({organizationId:m,projectId:d,formData:r,id:o})=>{if(!c||!s.includes(c))throw new Error("Not allowed to create quotes");if(!x)throw new Error("API instance for role not found");return await oe({api:x,organizationId:m,projectId:d,formData:r,id:o})},onSuccess:(m,{organizationId:d})=>{E.invalidateQueries({queryKey:["quote-material-items",d]})}})},ue=({quote:s,organizationId:c,setFurnitures:x,setIsEditingId:m,setQuoteType:d,setEditQuoteNo:r,setFiltersMain:o})=>{var j,p;const{mutateAsync:w,isPending:h}=ne(),f=async y=>{var g,t;try{await w({id:y,organizationId:c}),v({title:"Success",description:"Items deleted successfully"})}catch(l){v({title:"Error",description:((t=(g=l==null?void 0:l.response)==null?void 0:g.data)==null?void 0:t.message)??"Operation failed"})}};return e.jsx(H,{className:"w-full border-l-4 border-blue-600 shadow-md bg-white hover:shadow-lg transition-all",children:e.jsxs(J,{className:"p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"my-1",children:[e.jsxs("h3",{className:"text-base font-bold text-blue-700 leading-[8px] ",children:["Project: ",e.jsx("span",{className:"text-black",children:((j=s==null?void 0:s.projectId)==null?void 0:j.projectName)||"Project"})]}),e.jsxs("span",{className:"text-[12px] font-semibold text-gray-500",children:["Quote No: ",e.jsx("span",{className:"text-black",children:s.quoteNo||"N/A"})]})]}),e.jsxs("p",{className:"text-xs text-gray-500 ",children:["Created on: ",Y(s.createdAt)," -  ",W(s.createdAt)]})]}),e.jsx("i",{className:"fas fa-file-alt text-gray-400 text-xl"})]}),e.jsxs("p",{className:"text-sm text-gray-500 italic",children:[e.jsx("strong",{children:"Furnitures: "})," ",((p=s.furnitures)==null?void 0:p.length)||0]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsxs(b,{size:"sm",variant:"secondary",onClick:()=>{const{furnitures:y}=s,g=y.map(t=>({furnitureName:t.furnitureName,coreMaterials:t.coreMaterials.map(l=>({itemName:(l==null?void 0:l.itemName)||"",plywoodNos:(l==null?void 0:l.plywoodNos)||{quantity:0,thickness:0},laminateNos:l.laminateNos||{quantity:0,thickness:0},carpenters:l.carpenters||0,days:l.days||0,profitOnMaterial:l.profitOnMaterial||0,profitOnLabour:l.profitOnLabour||0,rowTotal:l.rowTotal||0,remarks:l.remarks||"",imageUrl:l.imageUrl||"",previewUrl:l.imageUrl||""})),fittingsAndAccessories:t.fittingsAndAccessories||[],glues:t.glues||[],nonBrandMaterials:t.nonBrandMaterials||[],totals:{core:t.coreMaterialsTotal||0,fittings:t.fittingsAndAccessoriesTotal||0,glues:t.gluesTotal||0,nbms:t.nonBrandMaterialsTotal||0,furnitureTotal:t.furnitureTotal||0}}));console.log("parsedFurniture",g),r(s==null?void 0:s.quoteNo),x(g),m(s._id),d(()=>{var t;return((t=s==null?void 0:s.furnitures)==null?void 0:t.length)>1?"residential":"single"}),o({projectId:s.projectId._id,projectName:s.projectId.projectName})},children:[e.jsx("i",{className:"fas fa-eye mr-1"})," Edit"]}),e.jsxs(b,{size:"sm",isLoading:h,variant:"danger",className:"bg-red-600 text-white",onClick:()=>f(s._id),children:[e.jsx("i",{className:"fas fa-trash mr-1"})," Delete"]})]})]})})},me=({setFurnitures:s,setEditQuoteNo:c,setIsEditingId:x,setFiltersMain:m,setQuoteType:d})=>{const{organizationId:r}=_(),[o,w]=N.useState({projectId:"",projectName:"",createdAt:""}),{data:h}=O(r),f=h==null?void 0:h.map(t=>({_id:t._id,projectName:t.projectName})),{data:j,isLoading:p}=le(r,{createdAt:o.createdAt,projectId:o.projectId,quoteNo:""}),y=()=>{w({projectId:"",projectName:"",createdAt:""})},g=Object.values(o).filter(Boolean).length;return e.jsx("div",{children:e.jsxs("main",{className:"flex gap-2 !max-h-[80vh]",children:[e.jsx("div",{className:"xl:w-80 flex-shrink-0",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-filter mr-2 text-blue-600"}),"Filters"]}),g>0&&e.jsxs("button",{onClick:y,className:"text-sm text-blue-600 hover:text-blue-800 font-medium",children:["Clear All (",g,")"]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Created Date"}),e.jsx("input",{type:"date",onChange:t=>w(l=>({...l,createdAt:t.target.value})),value:o.createdAt,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Project"}),e.jsx("select",{value:(o==null?void 0:o.projectId)||"",onChange:t=>{const l=f==null?void 0:f.find(M=>M._id===t.target.value);l&&w(M=>({...M,projectId:l._id,projectName:l.projectName}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:f==null?void 0:f.map(t=>e.jsx("option",{value:t._id,children:t.projectName},t._id))})]})]})]})}),e.jsx("section",{className:"w-full max-h-full  gap-2  overflow-y-auto  min-h-full",children:p?e.jsx("p",{children:e.jsx(X,{})}):j!=null&&j.length?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:j.map(t=>e.jsx(e.Fragment,{children:e.jsx(ue,{setEditQuoteNo:c,setFurnitures:s,setIsEditingId:x,setQuoteType:d,setFiltersMain:m,quote:t,organizationId:r},t._id)}))}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-center text-gray-700",children:[e.jsx("i",{className:"fas fa-file-circle-exclamation text-gray-300 text-7xl mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold mb-2",children:"No Quotes Found"}),e.jsxs("p",{className:"text-base text-gray-500 leading-relaxed max-w-md",children:["You haven't generated any quote variants yet.",e.jsx("br",{}),"Please create a quote by clicking the + Product section to view brand-wise breakdowns here."]})]})})]})})},fe=()=>{const{organizationId:s}=_(),{data:c}=O(s),x=N.useMemo(()=>(c==null?void 0:c.map(a=>({_id:a._id,projectName:a.projectName})))||[],[c]),[m,d]=N.useState({projectId:"",projectName:""}),[r,o]=N.useState([]),[w,h]=N.useState(!1),[f,j]=N.useState(""),[p,y]=N.useState(null),[g,t]=N.useState(null),[l,M]=N.useState(null),{mutateAsync:B,isPending:U}=ce(),{mutateAsync:G,isPending:L}=de(),$=a=>{t(a)},D=()=>g==="single"?"Single Quote":g==="residential"?"Residential Quote":"";N.useEffect(()=>{g==="single"&&!p?(o([]),S("Common Category")):g==="residential"&&!p&&(o([]),h(!0))},[g]);const S=a=>{o(u=>[...u,{furnitureName:a,coreMaterials:[z()],fittingsAndAccessories:[k()],glues:[k()],nonBrandMaterials:[k()],totals:{core:0,fittings:0,glues:0,nbms:0,furnitureTotal:0}}])},R=a=>{o(u=>u.filter((i,n)=>n!==a))},z=()=>({itemName:"",plywoodNos:{quantity:0,thickness:0},laminateNos:{quantity:0,thickness:0},carpenters:0,days:0,profitOnMaterial:0,profitOnLabour:0,rowTotal:0,remarks:""}),k=()=>({itemName:"",description:"",quantity:0,cost:0,rowTotal:0}),I=r==null?void 0:r.reduce((a,u)=>a+u.totals.furnitureTotal,0),V=async()=>{var a,u;try{if(!m.projectId){v({title:"Error",description:"Please select a project",variant:"destructive"});return}const i=new FormData;i.append("furnitures",JSON.stringify(r.map(n=>({furnitureName:n.furnitureName,coreMaterials:n.coreMaterials.map(A=>{if(Object.values(A).some(C=>!!C)){const{imageUrl:C,previewUrl:T,...K}=A;return K}}),fittingsAndAccessories:n.fittingsAndAccessories,glues:n.glues,nonBrandMaterials:n.nonBrandMaterials,coreMaterialsTotal:n.totals.core,fittingsAndAccessoriesTotal:n.totals.fittings,gluesTotal:n.totals.glues,nonBrandMaterialsTotal:n.totals.nbms,furnitureTotal:n.totals.furnitureTotal})))),r.forEach((n,A)=>{n.coreMaterials.forEach((C,T)=>{C.imageUrl&&i.append(`images[${A}][${T}]`,C.imageUrl)})}),i.append("grandTotal",I.toString()),i.append("notes","Generated"),await B({organizationId:s,projectId:m.projectId,formData:i}),v({title:"Success",description:"Created Successfully, Visit in Quote Generator Section"}),o([]),t(null)}catch(i){v({title:"Error",description:((u=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:u.message)||(i==null?void 0:i.message)||"failed to generate the items",variant:"destructive"})}},q=async()=>{var a,u;try{if(!m.projectId){v({title:"Error",description:"Please select a project",variant:"destructive"});return}const i={furnitures:r.map(n=>({furnitureName:n.furnitureName,coreMaterials:n.coreMaterials.map(A=>{const{previewUrl:C,...T}=A;return{...T,imageUrl:A.imageUrl||null}}),fittingsAndAccessories:n.fittingsAndAccessories,glues:n.glues,nonBrandMaterials:n.nonBrandMaterials,coreMaterialsTotal:n.totals.core,fittingsAndAccessoriesTotal:n.totals.fittings,gluesTotal:n.totals.glues,nonBrandMaterialsTotal:n.totals.nbms,furnitureTotal:n.totals.furnitureTotal})),grandTotal:I,notes:"Updated via frontend",quoteNo:l};p&&(await G({organizationId:s,projectId:m.projectId,formData:i,id:p}),v({title:"Updated!",description:"Quote edited successfully."}),o([]),t(null),y(null))}catch(i){v({title:"Error",description:((u=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:u.message)||(i==null?void 0:i.message)||"Failed to Update the Quote",variant:"destructive"})}};return e.jsxs("div",{className:`h-full mx-auto max-h-full ${p?"overflow-y-auto":""} `,children:[e.jsxs("header",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 py-1 border-b-1 border-[#818283]",children:[e.jsx("div",{children:e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center",children:[e.jsx("i",{className:"fas fa-file mr-3 text-blue-600"}),"Internal Quote Entry"]})}),e.jsxs("div",{className:"flex gap-6 items-center ",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Select QuoteType"}),e.jsxs(Z,{onValueChange:a=>$(a),children:[e.jsx(ee,{className:"w-full",children:e.jsx(te,{placeholder:"Select Quote",selectedValue:g||""})}),e.jsx(ae,{children:["single","residential"].map(a=>e.jsx(se,{value:a.toString(),children:a},a))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Select Project *"}),e.jsxs("select",{value:m.projectId,onChange:a=>{const u=x.find(i=>i._id===a.target.value);u&&d({projectId:u._id,projectName:u.projectName})},className:" px-2 py-2 rounded-xl border border-blue-200 focus:border-blue-200 active:border-blue-200",children:[e.jsx("option",{value:"",children:"Select a project"}),x.map(a=>e.jsx("option",{value:a._id,children:a.projectName},a._id))]})]}),r.length>0&&e.jsxs("div",{className:"text-right flex gap-2 items-center",children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase tracking-widest",children:"Grand Total"}),e.jsxs("div",{className:"text-xl font-semibold text-green-600",children:["â‚¹",I.toLocaleString("en-IN")]})]}),e.jsxs(b,{className:"flex items-center",onClick:()=>{h(!0)},children:[e.jsx("i",{className:"fas fa-add mr-1",children:" "})," Product"]})]})]}),w&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70 bg-opacity-40 backdrop-blur-sm transition",children:e.jsxs("div",{className:"bg-white shadow-xl rounded-lg p-6 w-full max-w-md relative animate-scaleIn",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-800",children:"Add New Product"}),e.jsx("input",{className:"w-full border border-gray-300 rounded px-3 py-2 mb-4 outline-none focus:ring-2 focus:ring-blue-400",placeholder:"Enter Product Name",value:f,autoFocus:!0,onChange:a=>j(a.target.value),onKeyDown:a=>{if(a.key==="Enter"){if(!f.trim())return;S(f),j(""),h(!1)}}}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx(b,{variant:"secondary",onClick:()=>h(!1),children:"Cancel"}),e.jsx(b,{onClick:()=>{f.trim()&&(S(f),j(""),h(!1))},children:"Create"})]})]})}),r.length>0&&e.jsxs("section",{className:"shadow overflow-y-auto max-h-[86%]",children:[!p&&e.jsx("h1",{className:"text-2xl text-gray-500",children:D()}),r.map((a,u)=>e.jsx(re,{index:u,data:a,updateFurniture:i=>{const n=[...r];n[u]=i,o(n)},removeFurniture:()=>R(u)},u))]}),r.length!==0&&e.jsxs("div",{className:"mt-1 text-right flex gap-2 justify-end",children:[e.jsx(b,{variant:"primary",isLoading:U||L,onClick:p?q:V,className:"px-6 py-2 bg-blue-600 text-white rounded",children:"Save Quote"}),!p&&e.jsx(b,{variant:"secondary",onClick:()=>{o([]),t(null)},className:"",children:"Cancel"}),p&&e.jsx(b,{variant:"secondary",onClick:()=>{y(null),o([]),t(null),M(null)},className:"",children:"Cancel"})]}),!p&&(r==null?void 0:r.length)===0&&e.jsx("section",{className:"my-4",children:e.jsx(me,{setEditQuoteNo:M,setIsEditingId:y,setFurnitures:o,setQuoteType:t,setFiltersMain:d})})]})};export{fe as default};
